<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>TinySQL 实现总结 - OneStep</title><meta name=Description content="用尽全力，活成一个普通人"><meta property="og:title" content="TinySQL 实现总结"><meta property="og:description" content="TinySQL是PingCAP的另一个教学项目，聚焦在数据库计算层的一些操作，代码与TiDB基本相同，所以可以抄TiDB（bushi）。 项目"><meta property="og:type" content="article"><meta property="og:url" content="https://waruto.top/posts/tinysql-impl/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-06T11:20:13+08:00"><meta property="article:modified_time" content="2022-09-06T11:20:13+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="TinySQL 实现总结"><meta name=twitter:description content="TinySQL是PingCAP的另一个教学项目，聚焦在数据库计算层的一些操作，代码与TiDB基本相同，所以可以抄TiDB（bushi）。 项目"><meta name=application-name content="OneStep"><meta name=apple-mobile-web-app-title content="OneStep"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://waruto.top/posts/tinysql-impl/><link rel=prev href=https://waruto.top/posts/tinykv-impl/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"TinySQL 实现总结","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/waruto.top\/posts\/tinysql-impl\/"},"genre":"posts","wordcount":5114,"url":"https:\/\/waruto.top\/posts\/tinysql-impl\/","datePublished":"2022-09-06T11:20:13+08:00","dateModified":"2022-09-06T11:20:13+08:00","publisher":{"@type":"Organization","name":"waruto210"},"author":{"@type":"Person","name":"waruto210"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=OneStep><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/logo.jpeg data-srcset="/images/logo.jpeg, /images/logo.jpeg 1.5x, /images/logo.jpeg 2x" data-sizes=auto alt=/images/logo.jpeg title=/images/logo.jpeg>OneStep</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>首页 </a><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/friendlinks>友链 </a><a class=menu-item href=/about>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=OneStep><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/logo.jpeg data-srcset="/images/logo.jpeg, /images/logo.jpeg 1.5x, /images/logo.jpeg 2x" data-sizes=auto alt=/images/logo.jpeg title=/images/logo.jpeg>OneStep</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/ title>首页</a><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/friendlinks title>友链</a><a class=menu-item href=/about title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">TinySQL 实现总结</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/waruto210 title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>waruto210</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-09-06>2022-09-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5114 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 11 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=true><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#project1-关系代数>Project1 关系代数</a></li><li><a href=#project-2-parser>Project 2 Parser</a></li><li><a href=#project-3-online-ddl>Project 3 Online DDL</a></li><li><a href=#project4-优化>Project4 优化</a><ul><li><a href=#part-1>Part 1</a></li><li><a href=#part2-join-and-access-path-selection>Part2 Join and Access Path Selection</a><ul><li><a href=#count-min-sketch>Count-min Sketch</a></li><li><a href=#join-reorder>Join Reorder</a></li><li><a href=#access-path-selection>Access Path Selection</a></li></ul></li></ul></li><li><a href=#project5>Project5</a><ul><li><a href=#part1-火山模型和向量化>Part1 火山模型和向量化</a></li><li><a href=#part2-hash-join>Part2 Hash Join</a></li><li><a href=#part3-hash-aggregate>Part3 Hash Aggregate</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=content id=content><p>TinySQL是PingCAP的另一个教学项目，聚焦在数据库计算层的一些操作，代码与TiDB基本相同，所以可以抄TiDB（bushi）。</p><ul><li>项目原地址：https://github.com/talent-plan/tinysql</li><li>我的实现：https://github.com/waruto210/tinysql</li></ul><h2 id=project1-关系代数>Project1 关系代数</h2><p>这部分介绍一些SQL语法，关系代数，关系模型 -> K/V模型的映射。</p><p>要完成的代码就是将关系型数据->K/V数据的编/解码，很简单。</p><h2 id=project-2-parser>Project 2 Parser</h2><p>这一部分主要是让我们了解SQL被解析的过程。</p><p><a href=https://github.com/waruto210/tinysql/blob/course/courses/imgs/proj2-1.png target=_blank rel="noopener noreffer"><img class=lazyload src=/svg/loading.min.svg data-src=TinySQL-impl/proj2-1.png data-srcset="/TinySQL-impl/proj2-1.png, TinySQL-impl/proj2-1.png 1.5x, /TinySQL-impl/proj2-1.png 2x" data-sizes=auto alt=/TinySQL-impl/proj2-1.png title=SQL></a>
利用yacc补全一些join table的SQL parser，很简单。
<a href=https://github.com/waruto210/tinysql/blob/course/courses/imgs/proj2-3.png target=_blank rel="noopener noreffer">https://github.com/waruto210/tinysql/blob/course/courses/imgs/proj2-3.png</a></p><h2 id=project-3-online-ddl>Project 3 Online DDL</h2><p>TinySQL/TiDB支持异步Schema变更，其参照了 Google F1 中的 schema 变更的算法。可以参考</p><ul><li><a href=https://github.com/ngaut/builddatabase/blob/master/f1/schema-change.md target=_blank rel="noopener noreffer">F1中异步 schema 变更</a></li><li><a href=https://github.com/ngaut/builddatabase/blob/master/f1/schema-change-implement.md target=_blank rel="noopener noreffer">TiDB 的异步 schema 变更实现</a></li></ul><p>代码需要实现<code>Add Column</code>以及<code>Drop Column</code>的流程，核心过程就是：</p><ul><li>add：absent &ndash;> delete only &ndash;> write only &ndash;(reorg)&ndash;> public</li><li>delete：public &ndash;> write-only &ndash;> delete-only &ndash;> (reorg) &ndash;> absent</li></ul><p>在<code>reorg -> public</code>以及<code>public --> write-only</code>时需要调用<code>adjustColumnInfoInAddColumn</code>或<code>adjustColumnInfoInDropColumn</code>来修改被add/drop column的位置。</p><h2 id=project4-优化>Project4 优化</h2><h3 id=part-1>Part 1</h3><p>TiDB有两个优化器框架：System R和Cascades</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=c1>// Handle the logical plan statement, use cascades planner if enabled.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>sctx</span><span class=p>.</span><span class=nf>GetSessionVars</span><span class=p>().</span><span class=nx>EnableCascadesPlanner</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>finalPlan</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cascades</span><span class=p>.</span><span class=nx>DefaultOptimizer</span><span class=p>.</span><span class=nf>FindBestPlan</span><span class=p>(</span><span class=nx>sctx</span><span class=p>,</span> <span class=nx>logic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>finalPlan</span><span class=p>,</span> <span class=nx>names</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>finalPlan</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>plannercore</span><span class=p>.</span><span class=nf>DoOptimize</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>builder</span><span class=p>.</span><span class=nf>GetOptFlag</span><span class=p>(),</span> <span class=nx>logic</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>System R框架的总体流程如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// DoOptimize optimizes a logical plan to a physical plan.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>DoOptimize</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>flag</span> <span class=kt>uint64</span><span class=p>,</span> <span class=nx>logic</span> <span class=nx>LogicalPlan</span><span class=p>)</span> <span class=p>(</span><span class=nx>PhysicalPlan</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>logic</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>logicalOptimize</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>flag</span><span class=p>,</span> <span class=nx>logic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>physical</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>physicalOptimize</span><span class=p>(</span><span class=nx>logic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>finalPlan</span> <span class=o>:=</span> <span class=nf>postOptimize</span><span class=p>(</span><span class=nx>physical</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>finalPlan</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>依次调用了 <code>logicalOptimize</code>， <code>physicalOptimize</code> 和 <code>postOptimize</code>。</p><p>在逻辑优化中，依次遍历优化规则列表，并对当前的执行计划树尝试优化。</p><p>物理优化实际上是一个记忆化搜索的过程。如下图，一个logical plan，其中的每个Operator在转化为物理plan时，都可能有多种选项，因此，使用记忆化搜索来进行选择。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=TinySQL-impl/4_cc975657e1.jpeg data-srcset="/TinySQL-impl/4_cc975657e1.jpeg, TinySQL-impl/4_cc975657e1.jpeg 1.5x, /TinySQL-impl/4_cc975657e1.jpeg 2x" data-sizes=auto alt=/TinySQL-impl/4_cc975657e1.jpeg title="图 3"></p><p>伪代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// The OrderProp tells whether the output data should be ordered by some column or expression. (e.g. For select * from t order by a, we need to make the data ordered by column a, that is the exactly information that OrderProp should store)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>findBestTask</span><span class=p>(</span><span class=nx>p</span> <span class=nx>LogicalPlan</span><span class=p>,</span> <span class=nx>prop</span> <span class=nx>OrderProp</span><span class=p>)</span> <span class=nx>PhysicalPlan</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>retP</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>dpTable</span><span class=p>.</span><span class=nf>Find</span><span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=nx>prop</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span> <span class=c1>// 已经搜过了，直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>retP</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nx>selfPhysicalPlans</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>getPhysicalPlans</span><span class=p>()</span> <span class=c1>// 获取可能的 physical plan
</span></span></span><span class=line><span class=cl><span class=c1></span>	
</span></span><span class=line><span class=cl>	<span class=nx>bestPlanTree</span> <span class=o>:=</span> <span class=nx>a</span> <span class=nx>plan</span> <span class=nx>with</span> <span class=nx>maximum</span> <span class=nx>cost</span> 	<span class=c1>// 初始化bestPlanTree为最大cost
</span></span></span><span class=line><span class=cl><span class=c1></span>	
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pp</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>selfPhysicalPlans</span> <span class=p>{</span>  	<span class=c1>// 遍历当前节点可能的physical plan
</span></span></span><span class=line><span class=cl><span class=c1></span>	
</span></span><span class=line><span class=cl>		<span class=nx>childProps</span> <span class=o>:=</span> <span class=nx>pp</span><span class=p>.</span><span class=nf>GetChildProps</span><span class=p>(</span><span class=nx>prop</span><span class=p>)</span>		<span class=c1>// 根据当前operator的physical plan得出child需要的props
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>childPlans</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>PhysicalPlan</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>children</span><span class=p>))</span>	<span class=c1>// 记录ligical childPlan的最佳physical plan
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>cp</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>p</span><span class=p>.</span><span class=nx>children</span> <span class=p>{</span>	<span class=c1>// 对当前operator可能的physical实现，遍历找到每个logical child plan的最佳physical plan
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>childPlans</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>childPlans</span><span class=p>,</span> <span class=nf>findBestTask</span><span class=p>(</span><span class=nx>cp</span><span class=p>,</span> <span class=nx>childProps</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>physicalPlanTree</span><span class=p>,</span> <span class=nx>cost</span> <span class=o>:=</span> <span class=nf>connect</span><span class=p>(</span><span class=nx>pp</span><span class=p>,</span> <span class=nx>childPlans</span><span class=p>)</span>	<span class=c1>// 加上当前节点
</span></span></span><span class=line><span class=cl><span class=c1></span>		
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>physicalPlanTree</span><span class=p>.</span><span class=nx>cost</span> <span class=p>&lt;</span> <span class=nx>bestPlanTree</span><span class=p>.</span><span class=nx>cost</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>bestPlanTree</span> <span class=p>=</span> <span class=nx>physicalPlanTree</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>bestPlanTree</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先要实现<code>LogicalAggregation.PredicatePushDown</code>，将谓词逻辑下推到Agg函数以下。谓词如果涉及到Agg group by以外的列，那么不能下推， 因为它依赖了Agg计算出的列（如having mean(a) > 100）。</p><p>然后实现Cascades优化器的一些内容，参考阅读<a href=https://cn.pingcap.com/blog/tidb-cascades-planner target=_blank rel="noopener noreffer">揭秘 TiDB 新优化器：Cascades Planner 原理解析</a>。</p><p>在Cascades Optimizer定义了一些Rule以，每个Rule都有自己的pattern，Pattern 用于描述 Group Expression 的局部特征，只有满足了相应 Pattern 的 Group Expression 才能够应用该 Rule。如下图，调用<code>OnTransform</code>来添加逻辑等价的 Group Expression。</p><p>如下图，<code>Selection->Projection</code>命中Pattern，可以进行规则替换。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=TinySQL-impl/4_Pattern_c53614e357.png data-srcset="/TinySQL-impl/4_Pattern_c53614e357.png, TinySQL-impl/4_Pattern_c53614e357.png 1.5x, /TinySQL-impl/4_Pattern_c53614e357.png 2x" data-sizes=auto alt=/TinySQL-impl/4_Pattern_c53614e357.png title=4-Pattern></p><p>我们需要实现两个<code>OnTransform</code>：</p><ul><li><code>PushSelDownAggregation</code>：<em>transform</em> <code>sel->agg->x</code> to <code>agg->sel->x</code> or <code>sel->agg->sel->x</code><ul><li>如果sel中的列都位于group by列中，那么sel可以整个被下推到agg下</li><li>否则，下推一部分到agg下，保留上面的sel</li></ul></li><li><code>MergeAggregationProjection</code>：<em>ransform</em> <code>proj->proj->x</code> to <code>proj->x</code>，投影消除，可以参考<a href=https://cn.pingcap.com/blog/tidb-source-code-reading-7 target=_blank rel="noopener noreffer">TiDB 源码阅读系列文章（七）基于规则的优化</a><ul><li>agg会控制输出的列，projection是多余的，我们只需要把agg groug by的列与agg function参数需要的列进行映射变换，消除projection即可（由于projection的column alias）。</li></ul></li></ul><h3 id=part2-join-and-access-path-selection>Part2 Join and Access Path Selection</h3><h4 id=count-min-sketch>Count-min Sketch</h4><p>实现CM Sketch算法，用于等值查询，比直方图更好，包括新增key和查询key，参考<a href=https://cn.pingcap.com/blog/tidb-source-code-reading-12 target=_blank rel="noopener noreffer">TiDB 源码阅读系列文章（十二）统计信息(上)</a>。</p><p>CM Sketch返回的估计值总是不小于实际值，所以TinySQL/TiDB对CM Sketch做出了改进</p><ul><li>使用$(N - CM[i, j]) / (w-1)$作为噪音</li><li>每行估计值为，$CM[i,j] - (N - CM[i, j]) / (w-1)$，使用所有行估计值的中位数作为估计值</li></ul><h4 id=join-reorder>Join Reorder</h4><p>对join进行重新排序，核心算法是一个DP规则：</p><ul><li>使用数字的二进制表示来代表当前参与 Join 的节点情况。11（二进制表示为 1011）表示当前的 Join Group 包含了第 3 号节点，第 1 号节点和第 0 号节点（节点从 0 开始计数）。</li><li>f[11] 来表示包含了节点 <code>3, 1, 0</code> 的最优的 Join Tree。</li><li>转移方程则是 <code>f[group] = min{join{f[sub], f[group ^ sub])}</code> 这里 <code>sub</code> 是 <code>group</code> 二进制表示下的任意子集。</li></ul><p>实现中，主要顺序是：</p><ol><li>利用所有等值条件的边，构建join的邻接矩阵；</li><li>记录表示等值条件与不是等值条件的边；</li><li>从一个没有访问的点开始进行广度优先遍历，得到一个连通的 Join 节点序列。</li><li>使用动态规划算出这个Join序列的最低cost。</li><li>如果有还有没有访问节点则回到 3（无等值条件，如笛卡尔积会产生非连通图）。</li><li>将收集到的所有 Join 方案结合到一起作为结果。</li></ol><h4 id=access-path-selection>Access Path Selection</h4><p>Access Path的选择高度取决于统计信息，但统计信息可能过时，导致选择错误。参考<a href=https://github.com/pingcap/tidb/blob/master/docs/design/2019-01-25-skyline-pruning.md target=_blank rel="noopener noreffer">Proposal: Support Skyline Pruning</a>，实现Skyline Pruning，使用一些简单规则来修剪没必要的Access Path。</p><p>实现<code>compareCandidates</code>，比较x和y，如果x在所有方面都不差于x，并且总体上优于y，那么可以修剪掉y。</p><ul><li>比较两个path覆盖的column，更多的更好</li><li>比较两个path是否match physical property，match的更好</li><li>比较两个path是否需要二次扫描，不需要的更好</li></ul><h2 id=project5>Project5</h2><h3 id=part1-火山模型和向量化>Part1 火山模型和向量化</h3><p>在火山模型中，由不同的执行器组成，每个执行器对应的是 SQL 中的某个部分，例如过滤，聚合等；执行器与执行器之间组成了类似树状的关系，每个算子都实现了三个接口：</p><ul><li>Open，对当前执行器所需的资源进行初始化</li><li>Next，从孩子节点（如果存在）取必需的数据，计算并返回一条结果</li><li>Close，对执行器所需的资源进行释放</li></ul><p><a href=https://github.com/waruto210/tinysql/blob/course/courses/imgs/proj5-part1-1.png target=_blank rel="noopener noreffer"><img class=lazyload src=/svg/loading.min.svg data-src=TinySQL-impl/proj5-part1-1.png data-srcset="/TinySQL-impl/proj5-part1-1.png, TinySQL-impl/proj5-part1-1.png 1.5x, /TinySQL-impl/proj5-part1-1.png 2x" data-sizes=auto alt=/TinySQL-impl/proj5-part1-1.png title="Volcano Execution Model"></a></p><p>减小函数调用的一个直观想法就是每次 <code>Next</code> 返回一批数据，而不是只返回一行。为了支持返回多行的操作，TinySQL 还使用了 <code>Chunk</code> 来表示这些行，用于减小内存分配开销、降低内存占用以及实现内存使用量统计/控制。可以参考<a href="https://docs.google.com/document/d/1JKP9YS3wYsuXsYhDgVepJt5y72K6_WxhUVfOLyjpAjc/edit#heading=h.66r4twnr3b1c" target=_blank rel="noopener noreffer">向量化的进行计算</a>进行理解。</p><p>TinySQL/TiDB的向量化掉用都遵循如下形式：parent给出缓存空间chunk，传递给child的Next方法，child将其填满后返回给parent。</p><p>需要实现：</p><ul><li><p>向量化字符串长度函数：对一批string求长度</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Fill in the `req` util it is full or the `inputIter` is fully processed.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=p>;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputRow</span> <span class=o>!=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputIter</span><span class=p>.</span><span class=nf>End</span><span class=p>();</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputRow</span> <span class=p>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputIter</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Your code here.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nf>IsFull</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>e</span><span class=p>.</span><span class=nx>selected</span><span class=p>[</span><span class=nx>e</span><span class=p>.</span><span class=nx>inputRow</span><span class=p>.</span><span class=nf>Idx</span><span class=p>()]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>req</span><span class=p>.</span><span class=nf>AppendRow</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>inputRow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 先从child拿到一批数据
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>err</span> <span class=o>:=</span> <span class=nf>Next</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>children</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>e</span><span class=p>.</span><span class=nx>childResult</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// no more data.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>e</span><span class=p>.</span><span class=nx>childResult</span><span class=p>.</span><span class=nf>NumRows</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* Your code here.
</span></span></span><span class=line><span class=cl><span class=cm>		   Process and filter the child result using `expression.VectorizedFilter`.
</span></span></span><span class=line><span class=cl><span class=cm>		*/</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 因为e.inputRow != e.inputIter.End()，所以是先执行这里
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 先进行filter
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>e</span><span class=p>.</span><span class=nx>selected</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>expression</span><span class=p>.</span><span class=nf>VectorizedFilter</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>filters</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputIter</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>selected</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>e</span><span class=p>.</span><span class=nx>inputRow</span> <span class=p>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputIter</span><span class=p>.</span><span class=nf>Begin</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>实现向量化 selection 的 <code>Next</code> 函数：先从child拿到一批数据，然后filter，再将被选中的列放入到req中，如果req满了，则返回。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Fill in the `req` util it is full or the `inputIter` is fully processed.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=p>;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputRow</span> <span class=o>!=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputIter</span><span class=p>.</span><span class=nf>End</span><span class=p>();</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputRow</span> <span class=p>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputIter</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Your code here.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nf>IsFull</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>e</span><span class=p>.</span><span class=nx>selected</span><span class=p>[</span><span class=nx>e</span><span class=p>.</span><span class=nx>inputRow</span><span class=p>.</span><span class=nf>Idx</span><span class=p>()]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>req</span><span class=p>.</span><span class=nf>AppendRow</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>inputRow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 先从child拿到一批数据
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>err</span> <span class=o>:=</span> <span class=nf>Next</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>children</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>e</span><span class=p>.</span><span class=nx>childResult</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// no more data.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>e</span><span class=p>.</span><span class=nx>childResult</span><span class=p>.</span><span class=nf>NumRows</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* Your code here.
</span></span></span><span class=line><span class=cl><span class=cm>		   Process and filter the child result using `expression.VectorizedFilter`.
</span></span></span><span class=line><span class=cl><span class=cm>		*/</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 因为e.inputRow != e.inputIter.End()，所以是先执行这里
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 先进行filter
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>e</span><span class=p>.</span><span class=nx>selected</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>expression</span><span class=p>.</span><span class=nf>VectorizedFilter</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>filters</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputIter</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>selected</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>e</span><span class=p>.</span><span class=nx>inputRow</span> <span class=p>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>inputIter</span><span class=p>.</span><span class=nf>Begin</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=part2-hash-join>Part2 Hash Join</h3><p>TinySQL/TiDB先使用inner table构建一个hash表，然后读取outer table，使用多个线程并发地查询inner table hash表，做hash join。</p><p><a href=https://github.com/waruto210/tinysql/blob/course/courses/imgs/proj5-part2-1.png target=_blank rel="noopener noreffer"><img class=lazyload src=/svg/loading.min.svg data-src=TinySQL-impl/proj5-part2-1.png data-srcset="/TinySQL-impl/proj5-part2-1.png, TinySQL-impl/proj5-part2-1.png 1.5x, /TinySQL-impl/proj5-part2-1.png 2x" data-sizes=auto alt=/TinySQL-impl/proj5-part2-1.png title="Hash Join 1"></a></p><p>需要实现：</p><ul><li><p>fetchAndBuildHashTable：不断地读取table chunk，放入hash表即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>chk</span> <span class=o>:=</span> <span class=nx>chunk</span><span class=p>.</span><span class=nf>NewChunkWithCapacity</span><span class=p>(</span><span class=nx>allTypes</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>GetSessionVars</span><span class=p>().</span><span class=nx>MaxChunkSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=o>:=</span> <span class=nf>Next</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>innerSideExec</span><span class=p>,</span> <span class=nx>chk</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>chk</span><span class=p>.</span><span class=nf>NumRows</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>rowContainer</span><span class=p>.</span><span class=nf>PutChunk</span><span class=p>(</span><span class=nx>chk</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>runJoinWorker</p><p>要注意几个channel</p><ul><li><p><code>closeCh</code>：用于结束 loop 的</p></li><li><p><code>outerResultChs[workerID]</code>：outer fetcher 通过此通道来向 join worker 分发数据chunk</p></li><li><p><code>outerChkResourceCh</code>： worker消耗完chunk后， 向outer fetcher发送自己的<code>outerResultChs[workerID]</code>以及chunk，让outer fetch 填充chunk后通过<code>outerResultChs[workerID]</code>发送回来</p></li><li><p><code>joinChkResourceCh[i]</code>：worker用于获取存join结果的chunk</p></li><li><p><code>joinChkResourceCh</code>：每join完一个chunk，worker把自己的chunk及<code>joinChkResourceCh[i]</code>发送给main thread，main消耗完chunk后，再通过<code>joinChkResourceCh[i]</code>发回给worker</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=c1>// get a new join result chunk resource from main thread
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ok</span><span class=p>,</span> <span class=nx>joinResult</span> <span class=o>:=</span> <span class=nx>e</span><span class=p>.</span><span class=nf>getNewJoinResult</span><span class=p>(</span><span class=nx>workerID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=kc>true</span><span class=p>;</span> <span class=nx>ok</span><span class=p>;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>e</span><span class=p>.</span><span class=nx>closeCh</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=c1>// get outer result from `Outer Fetcher`s
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>case</span> <span class=nx>outerResult</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=o>&lt;-</span><span class=nx>e</span><span class=p>.</span><span class=nx>outerResultChs</span><span class=p>[</span><span class=nx>workerID</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// join outerResult to join result
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// if join result is full, runner will send it to main
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// then call `getNewJoinResult`
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>ok</span><span class=p>,</span> <span class=nx>joinResult</span> <span class=p>=</span> <span class=nx>e</span><span class=p>.</span><span class=nf>join2Chunk</span><span class=p>(</span><span class=nx>workerID</span><span class=p>,</span> <span class=nx>outerResult</span><span class=p>,</span> <span class=nx>hCtx</span><span class=p>,</span> <span class=nx>joinResult</span><span class=p>,</span> <span class=nx>selected</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>outerResult</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>emptyOuterResult</span><span class=p>.</span><span class=nx>chk</span> <span class=p>=</span> <span class=nx>outerResult</span>
</span></span><span class=line><span class=cl>		<span class=c1>// send chunk back to `Outer Fetcher`
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>e</span><span class=p>.</span><span class=nx>outerChkResourceCh</span> <span class=o>&lt;-</span> <span class=nx>emptyOuterResult</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>joinResult</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>joinResult</span><span class=p>.</span><span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=p>(</span><span class=nx>joinResult</span><span class=p>.</span><span class=nx>chk</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>joinResult</span><span class=p>.</span><span class=nx>chk</span><span class=p>.</span><span class=nf>NumRows</span><span class=p>()</span> <span class=p>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// send this join result to main
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// then main whill give back this chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>e</span><span class=p>.</span><span class=nx>joinResultCh</span> <span class=o>&lt;-</span> <span class=nx>joinResult</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>joinResult</span><span class=p>.</span><span class=nx>chk</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>joinResult</span><span class=p>.</span><span class=nx>chk</span><span class=p>.</span><span class=nf>NumRows</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// put that chunk resource back
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>e</span><span class=p>.</span><span class=nx>joinChkResourceCh</span><span class=p>[</span><span class=nx>workerID</span><span class=p>]</span> <span class=o>&lt;-</span> <span class=nx>joinResult</span><span class=p>.</span><span class=nx>chk</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><h3 id=part3-hash-aggregate>Part3 Hash Aggregate</h3><p>Hash Agg和Hash Join相似，这里主要是讲解下推及并行执行。</p><p>TinySQL/TiDB 对于聚合函数的计算阶段进行划分，相应定义了 4 种计算模式：CompleteMode，FinalMode，Partial1Mode，Partial2Mode。</p><table><thead><tr><th>AggFunctionMode</th><th>输入值</th><th>输出值</th></tr></thead><tbody><tr><td>CompleteMode</td><td>原始数据</td><td>最终结果</td></tr><tr><td>FinalMode</td><td>中间结果</td><td>最终结果</td></tr><tr><td>Partial1Mode</td><td>原始数据</td><td>中间结果</td></tr><tr><td>Partial2Mode</td><td>中间结果</td><td>进一步聚合的中间结果</td></tr></tbody></table><p>以<code>select avg(b) from t group by a</code>为例子:</p><ul><li>CompleteMode</li></ul><p>​ 此时 AVG 函数 的整个计算过程只有一个阶段，如图所示：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=TinySQL-impl/proj5-part3-1.png data-srcset="/TinySQL-impl/proj5-part3-1.png, TinySQL-impl/proj5-part3-1.png 1.5x, /TinySQL-impl/proj5-part3-1.png 2x" data-sizes=auto alt=/TinySQL-impl/proj5-part3-1.png title=img></p><ul><li>Partial1Mode &ndash;> FinalMode</li></ul><p>​ 此时我们将 AVG 函数的计算过程拆成两个阶段进行，如图所示：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=TinySQL-impl/proj5-part3-2.png data-srcset="/TinySQL-impl/proj5-part3-2.png, TinySQL-impl/proj5-part3-2.png 1.5x, /TinySQL-impl/proj5-part3-2.png 2x" data-sizes=auto alt=/TinySQL-impl/proj5-part3-2.png title=img></p><p>TiDB 的并行 Hash Aggregation 算子执行过程中的主要线程有：Main Thead，Data Fetcher，Partial Worker，和 Final Worker：</p><ul><li>Main Thread 一个：<ul><li>启动 Input Reader，Partial Workers 及 Final Workers</li><li>等待 Final Worker 的执行结果并返回</li></ul></li><li>Data Fetcher 一个：<ul><li>按 batch 读取子节点数据并分发给 Partial Worker</li></ul></li><li>Partial Worker 多 个：<ul><li>读取 Data Fetcher 发送来的数据，并做预聚合</li><li>将预聚合结果根据 Group 值 shuffle 给对应的 Final Worker</li></ul></li><li>Final Worker 多 个：<ul><li>读取 PartialWorker 发送来的数据，计算最终结果，发送给 Main Thread</li></ul></li></ul><p>Hash Aggregation 的执行阶段可分为如下图所示的 5 步：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=TinySQL-impl/proj5-part3-3.png data-srcset="/TinySQL-impl/proj5-part3-3.png, TinySQL-impl/proj5-part3-3.png 1.5x, /TinySQL-impl/proj5-part3-3.png 2x" data-sizes=auto alt=/TinySQL-impl/proj5-part3-3.png title=img></p><p>需要实现：</p><ul><li><p><code>shuffleIntermData</code>：将终结结果通过hash分配给final worker，因为partialResultsMap是只读共享，所以不需要分割</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=nx>groupKeysSlice</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([][]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>finalConcurrency</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>groupKey</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>w</span><span class=p>.</span><span class=nx>partialResultsMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>finalWorker</span> <span class=o>:=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>murmur3</span><span class=p>.</span><span class=nf>Sum32</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>groupKey</span><span class=p>)))</span> <span class=o>%</span> <span class=nx>finalConcurrency</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>groupKeysSlice</span><span class=p>[</span><span class=nx>finalWorker</span><span class=p>]</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>groupKeysSlice</span><span class=p>[</span><span class=nx>finalWorker</span><span class=p>]</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>w</span><span class=p>.</span><span class=nx>partialResultsMap</span><span class=p>)</span><span class=o>/</span><span class=nx>finalConcurrency</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>groupKeysSlice</span><span class=p>[</span><span class=nx>finalWorker</span><span class=p>]</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>groupKeysSlice</span><span class=p>[</span><span class=nx>finalWorker</span><span class=p>],</span> <span class=nx>groupKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>groupKeysSlice</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>groupKeysSlice</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>w</span><span class=p>.</span><span class=nx>outputChs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>&lt;-</span> <span class=o>&amp;</span><span class=nx>HashAggIntermData</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>groupKeys</span><span class=p>:</span>        <span class=nx>groupKeysSlice</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>				<span class=nx>partialResultMap</span><span class=p>:</span> <span class=nx>w</span><span class=p>.</span><span class=nx>partialResultsMap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><code>consumeIntermData</code>：获取中间数据，进行聚合。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>input</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>getPartialInput</span><span class=p>();</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>intermDataBuffer</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>intermDataBuffer</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([][]</span><span class=nx>aggfuncs</span><span class=p>.</span><span class=nx>PartialResult</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>w</span><span class=p>.</span><span class=nx>maxChunkSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>reachEnd</span> <span class=o>:=</span> <span class=kc>false</span><span class=p>;</span> <span class=p>!</span><span class=nx>reachEnd</span><span class=p>;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>intermDataBuffer</span><span class=p>,</span> <span class=nx>groupKeys</span><span class=p>,</span> <span class=nx>reachEnd</span> <span class=p>=</span> <span class=nx>input</span><span class=p>.</span><span class=nf>getPartialResultBatch</span><span class=p>(</span><span class=nx>sc</span><span class=p>,</span> <span class=nx>intermDataBuffer</span><span class=p>[:</span><span class=mi>0</span><span class=p>],</span> <span class=nx>w</span><span class=p>.</span><span class=nx>aggFuncs</span><span class=p>,</span> <span class=nx>w</span><span class=p>.</span><span class=nx>maxChunkSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>groupKey</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>groupKeys</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>w</span><span class=p>.</span><span class=nx>groupKeys</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>w</span><span class=p>.</span><span class=nx>groupKeys</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>groupKey</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>results</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>getPartialResult</span><span class=p>(</span><span class=nx>sc</span><span class=p>,</span> <span class=nx>w</span><span class=p>.</span><span class=nx>groupKeys</span><span class=p>,</span> <span class=nx>w</span><span class=p>.</span><span class=nx>partialResultMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>groupKey</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>groupKeys</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>!</span><span class=nx>w</span><span class=p>.</span><span class=nx>groupSet</span><span class=p>.</span><span class=nf>Exist</span><span class=p>(</span><span class=nx>groupKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>w</span><span class=p>.</span><span class=nx>groupSet</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>groupKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>prs</span> <span class=o>:=</span> <span class=nx>intermDataBuffer</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span> <span class=nx>j</span><span class=p>,</span> <span class=nx>af</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>w</span><span class=p>.</span><span class=nx>aggFuncs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>af</span><span class=p>.</span><span class=nf>MergePartialResult</span><span class=p>(</span><span class=nx>sctx</span><span class=p>,</span> <span class=nx>prs</span><span class=p>[</span><span class=nx>j</span><span class=p>],</span> <span class=nx>results</span><span class=p>[</span><span class=nx>i</span><span class=p>][</span><span class=nx>j</span><span class=p>]);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><p>project5有一个问题，就是在 <code>executor/aggregate_test.go</code> 的 <code>TestAggPushDown</code> 中第 4 条语句 <code>tk.MustExec("alter table t add index idx(a, b, c)")</code> （<code>executor/aggregate_test.go:56</code>）会一直卡住，注释掉这一句即可通过测试，参考了<a href=http://blog.rinchannow.top/tinysql-notes/#consumeIntermData target=_blank rel="noopener noreffer">RinChanNOW&rsquo;s blog</a>。</p><h2 id=总结>总结</h2><p>proj6做了一小部分，剩下感觉有点难以上手。TinySQL整个项目，我个人感觉是不如TinyKV的，有些地方介绍材料跟代码训练关系不大；对于会利用到的功能函数介绍不多，需要自己翻源代码理解。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-09-06</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/tinysql-impl/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://waruto.top/posts/tinysql-impl/ data-title="TinySQL 实现总结" data-via=Jason210314><i class="fab fa-twitter fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/tinykv-impl/ class=prev rel=prev title="TinyKV 实现总结"><i class="fas fa-angle-left fa-fw"></i>TinyKV 实现总结</a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.102.3">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/waruto210 target=_blank>waruto210</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=https://waruto.disqus.com/embed.js defer></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-164518488-1",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-164518488-1" async></script></body></html>