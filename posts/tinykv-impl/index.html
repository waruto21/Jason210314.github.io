<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>TinyKV å®ç°æ€»ç»“ - OneStep</title><meta name=Description content="ç”¨å°½å…¨åŠ›ï¼Œæ´»æˆä¸€ä¸ªæ™®é€šäºº"><meta property="og:title" content="TinyKV å®ç°æ€»ç»“"><meta property="og:description" content="TinyKVæ˜¯æ•™å­¦é¡¹ç›®ï¼Œç®—æ˜¯PingCAP TiKVçš„goè¯­è¨€ç®€åŒ–ç‰ˆï¼Œå®ç°äº†ä¸€ä¸ªå¸¦æœ‰è°ƒåº¦å™¨çš„åŸºäºmulti-raftçš„åˆ†å¸ƒå¼K/Vå­˜å‚¨ã€‚ é¡¹ç›®æº"><meta property="og:type" content="article"><meta property="og:url" content="https://waruto.top/posts/tinykv-impl/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-21T00:46:53+08:00"><meta property="article:modified_time" content="2022-05-21T00:46:53+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="TinyKV å®ç°æ€»ç»“"><meta name=twitter:description content="TinyKVæ˜¯æ•™å­¦é¡¹ç›®ï¼Œç®—æ˜¯PingCAP TiKVçš„goè¯­è¨€ç®€åŒ–ç‰ˆï¼Œå®ç°äº†ä¸€ä¸ªå¸¦æœ‰è°ƒåº¦å™¨çš„åŸºäºmulti-raftçš„åˆ†å¸ƒå¼K/Vå­˜å‚¨ã€‚ é¡¹ç›®æº"><meta name=application-name content="OneStep"><meta name=apple-mobile-web-app-title content="OneStep"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://waruto.top/posts/tinykv-impl/><link rel=prev href=https://waruto.top/posts/mit-6.830-lab6-rollback-and-recovery/><link rel=next href=https://waruto.top/posts/tinysql-impl/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"TinyKV å®ç°æ€»ç»“","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/waruto.top\/posts\/tinykv-impl\/"},"genre":"posts","wordcount":6081,"url":"https:\/\/waruto.top\/posts\/tinykv-impl\/","datePublished":"2022-05-21T00:46:53+08:00","dateModified":"2022-05-21T00:46:53+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"waruto210"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=OneStep><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/logo.jpeg data-srcset="/images/logo.jpeg, /images/logo.jpeg 1.5x, /images/logo.jpeg 2x" data-sizes=auto alt=/images/logo.jpeg title=/images/logo.jpeg width=610 height=610>OneStep</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>é¦–é¡µ </a><a class=menu-item href=/posts/>æ–‡ç«  </a><a class=menu-item href=/tags/>æ ‡ç­¾ </a><a class=menu-item href=/categories/>åˆ†ç±» </a><a class=menu-item href=/friendlinks>å‹é“¾ </a><a class=menu-item href=/about>å…³äº </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=OneStep><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/logo.jpeg data-srcset="/images/logo.jpeg, /images/logo.jpeg 1.5x, /images/logo.jpeg 2x" data-sizes=auto alt=/images/logo.jpeg title=/images/logo.jpeg width=610 height=610>OneStep</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/ title>é¦–é¡µ</a><a class=menu-item href=/posts/ title>æ–‡ç« </a><a class=menu-item href=/tags/ title>æ ‡ç­¾</a><a class=menu-item href=/categories/ title>åˆ†ç±»</a><a class=menu-item href=/friendlinks title>å‹é“¾</a><a class=menu-item href=/about title>å…³äº</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">TinyKV å®ç°æ€»ç»“</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/waruto210 title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>waruto210</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-05-21>2022-05-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;çº¦ 6081 å­—&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;é¢„è®¡é˜…è¯» 13 åˆ†é’Ÿ&nbsp;</div></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#project1-standalonekv>Project1 StandaloneKV</a></li><li><a href=#project2-raftkv>Project2 RaftKV</a><ul><li><a href=#part-a>Part A</a></li><li><a href=#part-b>Part B</a></li><li><a href=#part-c>Part C</a></li></ul></li><li><a href=#project3-multiraftkv>Project3 MultiRaftKV</a><ul><li><a href=#part-a-1>Part A</a></li><li><a href=#part-b-1>Part B</a><ul><li><a href=#leader-transferå’Œconf-change>leader transferå’Œconf change</a></li><li><a href=#split-region-in-raftstore>split region in raftstore</a></li></ul></li><li><a href=#part-c-1>Part C</a></li></ul></li><li><a href=#project-4-transactions>Project 4: Transactions</a><ul><li><a href=#part-a-2>Part A</a></li><li><a href=#part-b-2>Part B</a></li><li><a href=#part-b-3>Part B</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>TinyKVæ˜¯æ•™å­¦é¡¹ç›®ï¼Œç®—æ˜¯PingCAP TiKVçš„goè¯­è¨€ç®€åŒ–ç‰ˆï¼Œå®ç°äº†ä¸€ä¸ªå¸¦æœ‰è°ƒåº¦å™¨çš„åŸºäºmulti-raftçš„åˆ†å¸ƒå¼K/Vå­˜å‚¨ã€‚</p><p>é¡¹ç›®æºåœ°å€ï¼šhttps://github.com/tidb-incubator/tinykv</p><p>æˆ‘çš„å®ç°ï¼šhttps://github.com/waruto210/tinykv</p><h2 id=project1-standalonekv>Project1 StandaloneKV</h2><p>åŸºäºPingCAPä¿®æ”¹çš„badgerå®ç°ä¸€ä¸ªå•æœºçš„æ”¯æŒcolumn familyçš„K/Vå­˜å‚¨ã€‚è¿™ä¸ªéå¸¸ç®€å•ï¼Œå”¯ä¸€è®©æˆ‘è§‰å¾—ä¸èˆ’æœçš„å°±æ˜¯ï¼Œæ–‡æ¡£å’Œæ³¨é‡Šå¹¶æ²¡æœ‰æç¤ºåº”è¯¥æŸäº›æƒ…å†µæ˜¯å¦åº”è¯¥æŠ›å‡ºerrorï¼Œæ¯”å¦‚KeyNotFoundï¼Œè¦æŸ¥çœ‹æµ‹è¯•æ‰çŸ¥é“ã€‚</p><p>åŸºäºbadgerå®ç°<code>StandAloneStorage</code>ï¼Œè¦æ±‚å®ç°å¦‚ä¸‹çš„<code>Storage</code>æ¥å£ï¼Œè¿™ä¸ªæ¥å£ä¹Ÿæ˜¯åé¢çœŸæ­£çš„åˆ†å¸ƒå¼<code>RaftStorage</code>è¦å®ç°çš„æ¥å£ã€‚å¦å¤–è¿˜æœ‰ä¸€ä¸ª<code>MemStorage</code>å®ç°äº†è¯¥æ¥å£ï¼Œç”¨äºæµ‹è¯•ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Storage</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>Start</span><span class=p>()</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>Stop</span><span class=p>()</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>Write</span><span class=p>(</span><span class=nx>ctx</span> <span class=o>*</span><span class=nx>kvrpcpb</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>batch</span> <span class=p>[]</span><span class=nx>Modify</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>Reader</span><span class=p>(</span><span class=nx>ctx</span> <span class=o>*</span><span class=nx>kvrpcpb</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>(</span><span class=nx>StorageReader</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>StorageReader</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// When the key doesn&#39;t exist, return nil for the value
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>GetCF</span><span class=p>(</span><span class=nx>cf</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>key</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>IterCF</span><span class=p>(</span><span class=nx>cf</span> <span class=kt>string</span><span class=p>)</span> <span class=nx>engine_util</span><span class=p>.</span><span class=nx>DBIterator</span>
</span></span><span class=line><span class=cl>	<span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=project2-raftkv>Project2 RaftKV</h2><p>è¿™éƒ¨åˆ†è¦æ±‚å®ç°ä¸€ä¸ªå•ä¸ªregionçš„raft kvã€‚</p><h3 id=part-a>Part A</h3><p>åœ¨æœ€å†…éƒ¨çš„<code>Raft</code>ç»“æ„ä¸­ï¼Œä½¿ç”¨<code>RaftLog</code>æ¥ç®¡ç†æ—¥å¿—ã€‚å®ƒç»´æŠ¤ç€å„ç§indexï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>snapshot/first.....applied....committed....stabled.....last
</span></span></code></pre></td></tr></table></div></div><p>æ‰€æœ‰æœªå‹ç¼©çš„log entrieséƒ½ä¼šè¢«æ”¾åœ¨å†…å­˜ä¸­çš„<code>entries</code>æ•°ç»„ï¼ˆæ—¥å¿—å‹ç¼©åï¼Œåº”è¯¥æ›´æ–°ï¼‰ï¼Œä»<code>first</code>å¼€å§‹ï¼›<code>stable</code>è¡¨ç¤ºå·²ç»è¢«æŒä¹…åŒ–åˆ°<code>storage</code>ä¸­çš„æ—¥å¿—ï¼Œlastè¡¨ç¤ºå½“å‰æœ€æ–°æ—¥å¿—ã€‚</p><p>æ–°å»ºRaftæ—¶ï¼Œæ³¨æ„ä»<code>config.storage</code>å›å¤ä¹‹å‰çš„ä¿¡æ¯ï¼›é€‰ä¸¾æ—¶ï¼Œè¦æ³¨æ„å¤„ç†ä¸€äº›corner caseï¼Œä¾‹å¦‚åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p>å½“èŠ‚ç‚¹æˆä¸ºLeaderåï¼Œåº”è¯¥å…ˆAppendä¸€ä¸ªno-op entryï¼Œå¹¶å¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå› ä¸ºæ–°Leaderè™½ç„¶ä¸€å®šå…·æœ‰æœ€æ–°çš„æ—¥å¿—ï¼Œä½†commit indexä¸ä¸€å®šæ˜¯æœ€æ–°çš„ï¼Œè€Œä¸”Raftä¸å…è®¸Leaderç›´æ¥commitä¸å±äºè‡ªå·±ä»»æœŸçš„æ—¥å¿—ï¼Œè¿™æ ·å¯ä»¥å°½å¿«æ›´å¿«åœ°æ›´æ–°Leaderçš„commit indexåˆ°æœ€æ–°ã€‚åœ¨PingCAPçš„<a href=https://pingcap.com/zh/blog/lease-read target=_blank rel="noopener noreffer">TiKV åŠŸèƒ½ä»‹ç» - Lease Read</a>
ä¸­ä¹Ÿæåˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œetcdå’ŒTiKVåˆšå¼€å§‹éƒ½æ²¡æ³¨æ„åˆ°è¿™ä¸ªBugã€‚</p><p>ç„¶åè¦å®ç°<code>RawNode</code>çš„ä¸¤ä¸ªå…³é”®æ–¹æ³•:<code>HasReady()</code>å’Œ<code>Advance()</code>ã€‚å‰è€…è¿”å›ä¸€ä¸ª<code>Ready</code>ç»“æ„ä½“ï¼Œè®°å½•äº†Raftå®ä¾‹çš„çŠ¶æ€ï¼Œéœ€è¦è¢«æŒä¹…åŒ–çš„æ—¥å¿—ï¼Œéœ€è¦è¢«applyçš„æ—¥å¿—ï¼Œéœ€è¦è¢«applyçš„snapshotï¼Œéœ€è¦å‘é€åˆ°å…¶ä»–Raftå®ä¾‹çš„æ¶ˆæ¯ï¼›åè€…åœ¨å‰è€…è¿”å›çš„<code>Ready</code>è¢«å¤„ç†åï¼Œéœ€è¦æ›´æ–°<code>Raft</code>å®ä¾‹çš„ç›¸å…³çŠ¶æ€ã€‚</p><h3 id=part-b>Part B</h3><p>è¿™ä¸€éƒ¨åˆ†æ˜¯é©±åŠ¨Raft KVçš„æ ¸å¿ƒã€‚</p><p>ä¸»è¦æ­¥éª¤ä¸ºï¼š</p><ol><li>å¯¹TinyKVçš„æ“ä½œè¢«å‘é€ç»™Raft Leaderæ‰€åœ¨èŠ‚ç‚¹ï¼›</li><li>LeaderèŠ‚ç‚¹çš„<code>peerMsgHandler.proposeRaftCommand</code>è®°å½•proposalï¼Œå¹¶å°†æ“ä½œè½¬åŒ–ä¸ºRaft logï¼Œé©±åŠ¨Raftè¾¾æˆå…±è¯†ï¼›</li><li><code>peerMsgHandler.HandleRaftReady</code>ï¼šæ¯ä¸ªèŠ‚ç‚¹é€šè¿‡<code>RawNode</code>è·å–<code>Ready</code>ï¼Œå°†éœ€è¦è¢«æŒä¹…åŒ–çš„ä¿¡æ¯æŒä¹…åŒ–ï¼Œå°†éœ€è¦è¢«å‘é€çš„æ¶ˆæ¯å‘é€å‡ºå»ï¼Œç„¶åè°ƒç”¨<code>Advance</code>ï¼Œæ›´æ–°Raftå®ä¾‹çš„çŠ¶æ€ã€‚</li><li>LeaderèŠ‚ç‚¹è¿˜éœ€è¦å¤„ç†å½“åˆç•™ä¸‹çš„proposalï¼Œé€šè¿‡callbackå›å¤å®¢æˆ·ç«¯ã€‚</li></ol><p>å¯¹äºè¯»æ“ä½œï¼Œå¯ä»¥ç›´æ¥å°†å…¶è½¬åŒ–ä¸ºä¸€ä¸ªLogï¼Œç­‰åˆ°<code>HandleRaftReady</code>æ—¶å›å¤å®¢æˆ·ç«¯ï¼Œè¿™å»¶è¿Ÿä¼šå¾ˆé«˜ï¼›ä¹Ÿå¯ä»¥é‡‡ç”¨Raftè®ºæ–‡ section8çš„ä¼˜åŒ–æªæ–½ï¼ŒPingCAPçš„<a href=https://pingcap.com/zh/blog/lease-read target=_blank rel="noopener noreffer">TiKV åŠŸèƒ½ä»‹ç» - Lease Read</a>
ä¸­ä¹Ÿåšäº†è¯´æ˜ã€‚å¦å¤–ï¼Œapply logä¹Ÿå¯ä»¥å¼‚æ­¥æ‰§è¡Œï¼Œæå‡æ•ˆç‡ã€‚</p><h3 id=part-c>Part C</h3><p>å‚ç…§PingCAPçš„<a href=https://pingcap.com/zh/blog/tikv-source-code-reading-10 target=_blank rel="noopener noreffer">TiKV æºç è§£æç³»åˆ—æ–‡ç« ï¼ˆåï¼‰Snapshot çš„å‘é€å’Œæ¥æ”¶</a>
ã€‚</p><blockquote><p>åœ¨ Raft ä¸­ï¼ŒSnapshot æŒ‡çš„æ˜¯æ•´ä¸ª State Machine æ•°æ®çš„ä¸€ä»½å¿«ç…§ï¼Œå¤§ä½“ä¸Šæœ‰ä»¥ä¸‹è¿™å‡ ç§æƒ…å†µéœ€è¦ç”¨åˆ° Snapshotï¼š</p><ol><li>æ­£å¸¸æƒ…å†µä¸‹ leader ä¸ follower ä¹‹é—´æ˜¯é€šè¿‡ append log çš„æ–¹å¼è¿›è¡ŒåŒæ­¥çš„ï¼Œå‡ºäºç©ºé—´å’Œæ•ˆç‡çš„è€ƒè™‘ï¼Œleader ä¼šå®šæœŸæ¸…ç†è¿‡è€çš„ logã€‚å‡å¦‚ follower/learner å‡ºç°å®•æœºæˆ–è€…ç½‘ç»œéš”ç¦»ï¼Œæ¢å¤ä»¥åå¯èƒ½æ‰€ç¼ºçš„ log å·²ç»åœ¨ leader èŠ‚ç‚¹è¢«æ¸…ç†æ‰äº†ï¼Œæ­¤æ—¶åªèƒ½é€šè¿‡ Snapshot çš„æ–¹å¼è¿›è¡ŒåŒæ­¥ã€‚</li><li>Raft åŠ å…¥æ–°çš„èŠ‚ç‚¹çš„ï¼Œç”±äºæ–°èŠ‚ç‚¹æ²¡åŒæ­¥è¿‡ä»»ä½•æ—¥å¿—ï¼Œåªèƒ½é€šè¿‡æ¥æ”¶ Snapshot çš„æ–¹å¼æ¥åŒæ­¥ã€‚å®é™…ä¸Šè¿™ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ 1 çš„ä¸€ç§ç‰¹æ®Šæƒ…å½¢ã€‚</li><li>å‡ºäºå¤‡ä»½/æ¢å¤ç­‰éœ€æ±‚ï¼Œåº”ç”¨å±‚éœ€è¦ dump ä¸€ä»½ State Machine çš„å®Œæ•´æ•°æ®ã€‚</li></ol></blockquote><p>å®é™…ä¸Šä¸»è¦æ˜¯æƒ…å†µ1å’Œ2ã€‚</p><p>Snapshotä¸æ˜¯ä½œä¸ºæ™®é€šçš„RaftMessageå‘é€çš„ï¼Œå› ä¸ºå…¶Sizeå¤ªå¤§ã€‚</p><p>Raftstore æƒ³è¦gcæ—¶ï¼Œproposeä¸€ä¸ªAdminCmdType_CompactLogï¼Œç­‰åˆ°commitåï¼Œå¤„ç†readyæ—¶ï¼Œä¿®æ”¹RaftTruncatedStateï¼Œç„¶åè¿›è¡Œå®é™…çš„gcåˆ é™¤æ—¥å¿—ã€‚åç»­Raft Leaderå‘followerå‘é€æ—¥å¿—æ—¶ï¼Œå¦‚æœæ‰¾ä¸åˆ°nextæŒ‡é’ˆå¯¹åº”çš„logï¼Œé‚£ä¹ˆè¯¥logç”±äºcompactionå·²ç»è¢«ä¸¢å¼ƒäº†ï¼Œæ‰€ä»¥åªèƒ½å‘é€snapshotã€‚Leaderè°ƒç”¨<code>Storage.Snapshot()</code>ç”Ÿæˆsnapshotï¼Œå°±ç»ªåï¼ŒLeaderå‘å‡ºsnapshot messageï¼Œfollower æ”¶åˆ°snapshot messageåï¼Œfollowerè°ƒç”¨handleSnapshotå¤„ç†ï¼Œåœ¨<code>RaftLog</code>ä¸­è®°å½•<code>pendingSnapshot</code>ï¼Œç­‰<code>handleRaftReady</code>æ—¶ï¼Œæ ¹æ®snapshot messageçš„å†…ä¿¡æ¯ï¼Œæ–°å»ºtaskå»apply snapshotã€‚snapshotå…·ä½“çš„ä¼ è¾“åŠapplyç»†èŠ‚TinyKVæ¡†æ¶å·²ç»å®ç°å¥½äº†ï¼Œè¦äº†è§£çš„è¯ï¼Œå¯ä»¥æŸ¥çœ‹ğŸ‘†çš„æ–‡ç« ã€‚</p><h2 id=project3-multiraftkv>Project3 MultiRaftKV</h2><p>è¿™ä¸€ç‚¹ï¼Œè¦å®ç°å¤šregionå¤šRaft Groupçš„æœºåˆ¶ã€‚</p><h3 id=part-a-1>Part A</h3><p>å®ç°3Açš„leader transferå’Œconf changeéå¸¸ç®€å•ï¼Œæˆ‘è§‰å¾—è¿™é‡Œå®‰æ’ä¸åˆç†ï¼ŒæŠŠå¤ªå¤šå†…å®¹å®‰æ’åˆ°3Bäº†ï¼Œ3Açš„æµ‹è¯•ä¹Ÿä¸è¶³ï¼Œå¯¼è‡´å¾ˆå¤šå‘åœ¨3Bæ‰è¢«å‘ç°ã€‚</p><p>Raftå®ä¾‹ä½¿ç”¨<code>PendingConfIndex</code>æ¥è®°å½•æœ€æ–°çš„conf change entryçš„indexï¼Œå¦‚æœæœ‰æ›´æ–°çš„conf change entryï¼Œåº”è¯¥ä¿®æ”¹ä¸ºæœ€æ–°çš„ï¼Œå› ä¸ºå¯èƒ½æœ‰Leader proposeæ–°çš„conf changeä¹‹åï¼Œæ²¡æœ‰æ¥å¾—åŠå¤åˆ¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ï¼ŒLeaderå´©æºƒï¼Œé‡æ–°é€‰ä¸¾çš„Leaderæ²¡æœ‰è¯¥æ—¥å¿—ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å¯èƒ½ä¼šproposeæ–°çš„conf changeã€‚</p><h3 id=part-b-1>Part B</h3><h4 id=leader-transferå’Œconf-change>leader transferå’Œconf change</h4><p>è¿™éƒ¨åˆ†è¦å®ç°å¯¹<code>AdminCmdType_TransferLeader</code>å’Œ<code>AdminCmdType_ChangePeer</code>çš„å¤„ç†ã€‚</p><p>å½“<code>Raft.leadTransferee</code>ä¸ä¸ºNoneæ—¶ï¼Œä¸ºäº†ä½¿leader transferå°½å¿«æˆåŠŸï¼Œåº”è¯¥æ‹’ç»proposeæ–°çš„commandã€‚</p><p>å¯¹äºconf changeï¼Œæœ‰ä¸€äº›å‘ã€‚</p><p>é¦–å…ˆï¼Œæ–°å»ºpeerçš„Raftå®ä¾‹ï¼Œå…¶<code>Raft.Prs</code>æ˜¯ç©ºçš„ï¼Œè¦ç­‰åˆ°apply snapshotåï¼Œæ‰èƒ½è·å–åˆ°å½“å‰Groupçš„peersä¿¡æ¯ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œ<code>r.Prs[r.id]</code>ä¸å­˜åœ¨ï¼Œè€Œå¦ä¸€ç§æƒ…å†µï¼Œrç”±äºconf changeè¢«åˆ é™¤ï¼Œ<code>r.Prs[r.id]</code>ä¹Ÿä¸å­˜åœ¨ï¼Œå¦‚æœç›´æ¥è¿”å›ï¼Œä¾é åˆ¤æ–­<code>r.Prs[r.id]</code>æ¥å†³å®šæ˜¯å¦è¦å¤„ç†messageï¼Œæ˜¯ä¸è¡Œçš„ã€‚æ‰€ä»¥ï¼Œä½œå¦‚ä¸‹çš„åˆ¤æ–­ï¼Œè®©æ–°peerèƒ½å¤Ÿæ­£å¸¸æ¥æ”¶messageã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>Step</span><span class=p>(</span><span class=nx>m</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Message</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Your Code Here (2A).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// if r have been removed due to conf change
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// or new added node has no Prs but should step
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Prs</span><span class=p>[</span><span class=nx>r</span><span class=p>.</span><span class=nx>Id</span><span class=p>];</span> <span class=p>!</span><span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Prs</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%d do not exist and have other peers return, term %d, Prs %+v\n&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Prs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>r</span><span class=p>.</span><span class=nx>State</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>StateFollower</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>r</span><span class=p>.</span><span class=nf>stepFollower</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>StateCandidate</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>r</span><span class=p>.</span><span class=nf>stepCandidate</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>StateLeader</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>r</span><span class=p>.</span><span class=nf>stepLeader</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ­¤å¤–ï¼Œè€ƒè™‘åˆ°æ–°èŠ‚ç‚¹æ²¡æœ‰æ•°æ®ï¼Œä¸ºäº†é¿å…ä¸å¿…è¦çš„è¶…æ—¶é€‰ä¸¾ï¼ˆè€Œä¸”ç”±äº<code>Prs</code>ä¸ºç©ºï¼Œæ‰€ä»¥é€‰ä¸¾ä¼šç›´æ¥æˆåŠŸï¼Œé€ æˆè„‘è£‚ï¼‰ï¼Œå½“èŠ‚ç‚¹çš„termä¸º0æ—¶ï¼Œä¸è¿›è¡Œtickï¼›æ”¶åˆ°Leaderçš„å¿ƒè·³åï¼Œç«‹å³å°†è‡ªå·±å’ŒLeaderåŠ å…¥åˆ°<code>r.Prs</code>ä¸­ã€‚</p><p>è§£å†³å®Œä»¥ä¸Šé—®é¢˜åï¼Œè·‘æµ‹è¯•å‡ºç°è¶…æ—¶çš„æ¦‚ç‡è¿˜æ˜¯æ¯”è¾ƒå¤§ï¼Œé€šè¿‡æ‰“logå‘ç°ä»¥ä¸‹é—®é¢˜ï¼šæ‰§è¡Œå®Œ<code>Raft.addNode</code>åï¼ŒLeaderå‘æ–°peerå‘é€snapshotï¼Œä½†æ˜¯æœ‰æ—¶ä¼šå‡ºç°Leaderå…ˆå‘é€å®Œsnapshotåï¼Œæ–°çš„peeræ‰åˆ›å»ºå®Œæˆï¼Œå¼€å§‹æ¥å—æ¶ˆæ¯ï¼Œå¯¼è‡´è¿™ä¸ªsnapshotå°±æ¶ˆå¤±äº†ã€‚åœ¨æˆ‘çš„å®ç°ä¸­ï¼ŒLeaderå‘é€snapshotåï¼Œç›´æ¥è®¾ç½®è‡ªå·±çš„<code>r.Prs[to].Next = snapshot.Metadata.Index + 1</code>ï¼Œå› ä¸ºä¸è¿™æ ·åšï¼Œå¾ˆå¯èƒ½åœ¨æ–°peerçš„responseå›æ¥ä¹‹å‰ï¼Œåˆå› ä¸ºè§¦å‘<code>sendAppend</code>å‘å…¶å‘é€snapshotï¼Œè€Œç”Ÿæˆsnapshotæ˜¯æå…¶è´¹æ—¶çš„ï¼›ä½†æ˜¯åœ¨å‰é¢çš„é—®é¢˜ä¸‹ï¼Œç”±äºsnapshotä¸¢äº†ï¼Œé‚£ä¹ˆLeaderå‘é€åç»­æ—¥å¿—æ—¶ï¼Œæ–°peerä¼šæ‹’ç»ï¼ŒLeaderå°†Next -= 1ï¼Œç„¶åç»§ç»­ï¼Œç›´åˆ°Nextå°äºLeaderæ—¥å¿—çš„first indexï¼Œå¦‚æ­¤æ¥å›ï¼Œè€—è´¹äº†å¤§é‡æ—¶é—´ï¼Œè‡ªç„¶å°±è¶…æ—¶äº†ã€‚æ‰€ä»¥ï¼Œæœ€ååœ¨æˆ‘çš„å®ç°ä¸­ï¼Œfollowerä¼šå°†response messageçš„<code>m.Index</code>è®¾ç½®ä¸ºè‡ªå·±çš„last indexï¼Œleaderå‘ç°å…¶å°äºè‡ªå·±çš„first indexçš„è¯ï¼Œå°±ç«‹å³å‘é€snapshotï¼Œè§£å†³snapshotä¸¢å¤±çš„é—®é¢˜ã€‚</p><p>æ­¤å¤–ï¼Œconf changeæœ‰ä¸€ä¸ªç‰¹æ®Šcaseã€‚è€ƒè™‘ï¼šå½“å‰Raft groupæœ‰ä¸¤ä¸ªèŠ‚ç‚¹Leader Aã€Follower Bï¼Œconf changeè¦remove Aï¼Œé‚£ä¹ˆä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼ŒAæŠŠconf changeçš„logæˆåŠŸå¤åˆ¶ç»™Bä¹‹åï¼ŒA apply conf changeï¼ŒæŠŠè‡ªå·±åˆ é™¤ï¼Œæ²¡æ¥å¾—åŠæŠŠæ–°çš„commit indexå‘é€ç»™Bï¼›æ­¤æ—¶Bçš„commit indexä¸å¤Ÿæ–°ï¼Œæ— æ³•applyè¿™æ¡con changeï¼Œç„¶åBè¶…æ—¶ï¼Œå¼€å¯é€‰ä¸¾ï¼Œæ­¤æ—¶Bçš„<code>Prs</code>ä¸­è¿˜æœ‰Aï¼ŒBæ°¸è¿œæ— æ³•é€‰ä¸¾æˆåŠŸã€‚è¿™ç§é—®é¢˜æœ‰ä¸€ä¸ªè§£å†³åŠæ³•ï¼Œå°±æ˜¯removeè‡ªå·±æ—¶ï¼Œè®¡ç®—quorumä¸è¦æŠŠè‡ªå·±ç®—è¿›å»ã€‚ä½†æ˜¯TinyKVçš„æ¡†æ¶ä¸æ–¹ä¾¿å®ç°è¿™ä¸ªï¼Œåº•å±‚Raftå¹¶ä¸çŸ¥é“æ˜¯removeè¿˜æ˜¯addï¼Œæ›´ä¸çŸ¥é“removeè°ï¼Œè¦å®ç°çš„è¯ï¼Œéœ€è¦æ›´æ”¹ä¸€äº›ä»£ç ã€‚æ‰€ä»¥æˆ‘é€‰æ‹©ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç›´æ¥returnï¼Œä¸äºˆæ¥å—ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nx>ChangePeer</span><span class=p>.</span><span class=nx>ChangeType</span> <span class=o>==</span> <span class=nx>eraftpb</span><span class=p>.</span><span class=nx>ConfChangeType_RemoveNode</span> <span class=o>&amp;&amp;</span> <span class=nx>d</span><span class=p>.</span><span class=nf>IsLeader</span><span class=p>()</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>  	<span class=nb>len</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nf>Region</span><span class=p>().</span><span class=nx>Peers</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span> <span class=o>&amp;&amp;</span> <span class=nx>req</span><span class=p>.</span><span class=nx>ChangePeer</span><span class=p>.</span><span class=nx>Peer</span><span class=p>.</span><span class=nx>Id</span> <span class=o>==</span> <span class=nx>d</span><span class=p>.</span><span class=nf>PeerId</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//log.Infof(&#34;%s return corner case\n&#34;, d.Tag)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s return corner case\n&#34;</span><span class=p>,</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>cb</span><span class=p>.</span><span class=nf>Done</span><span class=p>(</span><span class=nf>ErrResp</span><span class=p>(</span><span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>err</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=split-region-in-raftstore>split region in raftstore</h4><p>è¿™é‡Œè¦å®ç°regionåˆ†è£‚ï¼Œå®ç°äº†è¿™ä¸ªï¼Œå°±çœŸçš„å®ç°äº†multi-raft K/V storeäº†ã€‚æµç¨‹æ¯”è¾ƒç®€å•ï¼ŒæŒ‰ç…§æ–‡æ¡£ç»™å‡ºçš„æµç¨‹å°±å¥½äº†ã€‚</p><p>ä¸è¿‡åœ¨æµ‹è¯•ä¸­é‡åˆ°äº†<code>no region</code>é—®é¢˜ï¼Œåœ¨<a href=https://asktug.com/t/topic/274159 target=_blank rel="noopener noreffer">asktug</a>
ä¸Šï¼Œå‘ç°è¿™ä¸ªé—®é¢˜æŒºæ™®éçš„ã€‚è¿™æ˜¯å› ä¸ºï¼šå‘PDè¯·æ±‚regionä¿¡æ¯æ—¶ï¼Œæ‰¾ä¸åˆ°å¯¹åº”çš„regionä¿¡æ¯ã€‚</p><p>regionåˆ†è£‚ä¸€èˆ¬çš„å®ç°æ˜¯ [A, B) -> [A, C) + [C, B)ï¼Œç°æœ‰regionåˆ†é…ä¸º[A, C)ï¼Œæ–°regionåˆ†é…ä¸º[C, B)ã€‚æ—§regionæ˜¯æ­£å¸¸çš„ï¼ŒLeaderåœ¨æŒç»­ç»™PDå‘é€å¿ƒè·³ï¼ŒPDèƒ½å¤ŸåŠæ—¶æ›´æ–°regionä¿¡æ¯ï¼Œè€Œæ–°regionè¿˜éœ€è¦ç­‰å¾…å¤šä¸ªpeeråˆ›å»ºå®Œæˆï¼Œè¶…æ—¶ï¼Œç„¶åé€‰å‡ºLeaderï¼Œå‘é€å¿ƒè·³ç»™PDã€‚å› ä¸ºï¼Œå‘PDæŸ¥æ–°regionä¿¡æ¯æ—¶ï¼Œæœ‰ä¸€æ®µæ—¶é—´æŸ¥ä¸åˆ°[C, B)çš„ä¿¡æ¯ã€‚</p><p>æˆ‘çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šé¦–å…ˆï¼Œå¯¹äºTermä¸º5çš„èŠ‚ç‚¹ï¼ˆregionåˆ†è£‚ï¼Œæ–°å»ºçš„æ­£å¸¸èŠ‚ç‚¹Termæ˜¯5ï¼‰ï¼Œç«‹å³å¼€å§‹é€‰ä¸¾ï¼Œä¸ºäº†é˜²æ­¢å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å¼€å§‹é€‰ä¸¾ï¼Œå¯¼è‡´å¤šæ¬¡é€‰ä¸¾å¤±è´¥ï¼Œå¯ä»¥ä»…è®©Idä¸ºå¶æ•°çš„èŠ‚ç‚¹å¼€å§‹é€‰ä¸¾ï¼›æ­¤å¤–ï¼Œç”±äºæµ‹è¯•ä¸­ï¼Œè¯·æ±‚çš„keyåœ¨å¢å¤§ï¼Œæ‰€ä»¥ä¸ºäº†å¯ä»¥è®©æ—§regionè´Ÿè´£[C, B)ï¼Œæ–°regionè´Ÿè´£[A, C)ï¼Œè¿™æ ·èƒ½å¤Ÿsplitå®Œæˆåï¼Œèƒ½å¤Ÿç«‹å³å“åº”æ–°çš„è¯·æ±‚ï¼Œä¸è¿‡è¿™ç§æ”¹è¿›æ„Ÿè§‰åªç®—æ˜¯ä¸ºäº†é€šè¿‡æµ‹è¯•çš„trickyã€‚</p><h3 id=part-c-1>Part C</h3><p>è¿™éƒ¨åˆ†æ˜¯å®ç°ä¸€ä¸ªå°å‹çš„PDï¼Œå®ç°æ”¶é›†å¿ƒè·³ä¸é›†ç¾¤å¹³è¡¡ï¼Œæ¯”è¾ƒç®€å•ï¼ŒæŒ‰ç…§æ–‡æ¡£å®ç°å³å¯ã€‚</p><p>ä¸è¿‡ï¼Œæ–‡æ¡£ä¸­å°‘äº†ä¸€ä¸ªé™åˆ¶æ¡ä»¶ï¼Œåœ¨æµ‹è¯•ä¸­ä½“ç°äº†ï¼Œè¢«è¿ç§»çš„regionï¼Œå…¶åˆ†å¸ƒçš„storeæ•°é‡è¦æ»¡è¶³é›†ç¾¤çš„<code>MaxReplicas</code>ã€‚è¿™åº”è¯¥æ˜¯ä¸ºäº†é˜²æ­¢è¿ç§»regionå¯¼è‡´é›†ç¾¤ä¸å¯ç”¨ï¼Œåšçš„ä¼˜åŒ–ã€‚</p><h2 id=project-4-transactions>Project 4: Transactions</h2><p>TinyKVé‡‡ç”¨çš„Percolatorç®—æ³•ï¼Œæä¾›äº†snapshotéš”ç¦»æ€§ï¼š å¿«ç…§éš”ç¦»ä¿è¯åœ¨äº‹åŠ¡Tè¿‡ç¨‹ä¸­çš„æ‰€æœ‰è¯»å–éƒ½ä¼šçœ‹åˆ°ä¸€ä¸ªä¸€è‡´çš„æ•°æ®åº“å¿«ç…§ï¼ˆäº‹åŠ¡çœ‹åˆ°çš„æ‰€æœ‰æ•°æ®ï¼Œéƒ½æ˜¯åœ¨äº‹åŠ¡<strong>å¼€å§‹çš„æ—¶é—´ç‚¹ä¹‹å‰ committed</strong> çš„æ•°æ®ï¼‰ï¼Œå¹¶ä¸”åªæœ‰åœ¨Tæ‰€åšçš„æ›´æ–°ä¸è¯¥å¿«ç…§ä¹‹åçš„ä»»ä½•å¹¶å‘æ›´æ–°æ²¡æœ‰å†²çªæ—¶ï¼Œäº‹åŠ¡æœ¬èº«æ‰èƒ½æˆåŠŸæäº¤ã€‚</p><p>Percolatorç®—æ³•æºè‡ª<a href=https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36726.pdf target=_blank rel="noopener noreffer">Large-scale Incremental Processing Using Distributed Transactions and Notifications</a>
ï¼Œå¯ä»¥å‚è€ƒPingCAPè¿™ç¯‡æ–‡ç« <a href=https://tikv.org/deep-dive/distributed-transaction/percolator/ target=_blank rel="noopener noreffer">Deep Dive TiKV - Percolator</a>
ï¼Œè¿˜æœ‰è¿™ä¸ªæ–‡ç« <a href=http://mysql.taobao.org/monthly/2018/11/02/ target=_blank rel="noopener noreffer">Google Percolator åˆ†å¸ƒå¼äº‹åŠ¡å®ç°åŸç†è§£è¯»</a>
ã€‚</p><h3 id=part-a-2>Part A</h3><p>è¿™éƒ¨åˆ†å°±æ˜¯å®ç°å¯¹MVCCåŸºç¡€ç»“æ„çš„å°è£…ï¼Œæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ä»£ç å¯èƒ½å†™èµ·æ¥æœ‰ç‚¹çƒ¦ã€‚</p><h3 id=part-b-2>Part B</h3><p>è¿™éƒ¨åˆ†å®ç°Percolatoräº‹åŠ¡æœ€å…³é”®çš„ä¸‰ä¸ªæ“ä½œï¼Œè¯»ï¼ŒPewwriteï¼Œå’Œcommitã€‚</p><ul><li><p>KvGetï¼š</p><ul><li>æ—¶é—´æˆ³ts</li><li>æŸ¥æ‰¾æ˜¯å¦æœ‰[0, ts]çš„é”ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸èƒ½ç¡®å®šè¯¥äº‹åŠ¡æ˜¯å¦åœ¨tså‰è¢«commitï¼ˆå·²ç»commitï¼Œé”è¿˜æ²¡é‡Šæ”¾å®Œï¼‰ï¼Œè¿”å›ï¼Œç¨åé‡è¯•ï¼›å¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥è¯»</li><li>ä»write CFè¯»å–[0, ts]èŒƒå›´å†…æœ€æ–°çš„writeè®°å½•ï¼Œä»ä¸­è·å–å¯¹åº”äº‹åŠ¡çš„start_ts</li><li>æ ¹æ®start_tsç„¶åè¯»å–default CF</li></ul></li><li><p>KvPrewrite</p><ul><li>æ—¶é—´æˆ³start_ts</li><li>å¯¹æ¯ä¸ªkeyï¼ŒåŠ ä¸€ä¸ªlockï¼Œç„¶åä»¥start_tsæŠŠæ•°æ®å†™å…¥default CFï¼Œé€‰æ‹©ä¸€ä¸ªlockä¸ºprimary lockï¼Œæ¯ä¸ªlockéƒ½åŒ…æ‹¬start_tsï¼›å¦‚æœkeyä¸Šå·²ç»æœ‰lockï¼Œå›æ»šäº‹åŠ¡</li></ul></li><li><p>Kv Commit</p><ul><li>æ—¶é—´æˆ³commit_ts</li><li>ç§»é™¤primary lockï¼ŒåŒæ—¶åœ¨write CFå†™å…¥ä¸€ä¸ªæ—¶é—´æˆ³ä¸ºcommit_tsï¼Œå€¼ä¸ºstart_tsçš„è®°å½•ï¼Œè¡¨æ˜æ•°æ®çš„æœ€æ–°ç‰ˆæœ¬æ˜¯ startTs å¯¹åº”çš„æ•°æ®ï¼›å¦‚æœprimary lockæ²¡æœ‰äº†ï¼ˆè¶…æ—¶ï¼Œè¢«å…¶ä»–äº‹åŠ¡ç§»é™¤äº†ï¼‰ï¼Œäº‹åŠ¡å¤±è´¥</li><li>ç§»é™¤æ‰€æœ‰secondary lock</li></ul><p>åªè¦primary lockè¢«ç§»é™¤ï¼Œäº‹åŠ¡å°±ç®—æˆåŠŸã€‚</p></li></ul><p>æœ‰ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„åœ°æ–¹ï¼ŒåŸPercolatorç³»ç»ŸåŸºäºBigTableï¼Œå®ƒæ˜¯æ”¯æŒå•è¡Œäº‹åŠ¡çš„ï¼Œlockï¼Œwriteï¼Œdataåªä¸è¿‡æ˜¯å•è¡Œçš„ä¸€ä¸ªåˆ—ï¼›è€ŒTinyKVè¿™é‡Œï¼Œæ˜¯3ä¸ªCFï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥åŸå­æ€§çš„å†™å…¥3ä¸ªCFï¼Œä½†æ˜¯è€ƒè™‘ï¼šå¦‚æœä¸¤ä¸ªäº‹åŠ¡åŒæ—¶æ£€æŸ¥Keyæ˜¯å¦åŠ é”ï¼Œç„¶åå‘ç°æ²¡æœ‰é”ï¼Œåœ¨åŒæ—¶å†™å…¥é”ï¼Œè¿™ä¸­é—´å¹¶ä¸ä¼šæœ‰ä»»ä½•é˜»ç¢ã€‚æ‰€ä»¥ï¼Œæ¡†æ¶æä¾›äº†Latchï¼Œæ³¨é‡Šå†™é“:</p><blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Only one thread can hold a latch at a time and all keys that a command might write must be locked
</span></span><span class=line><span class=cl>// at once.
</span></span></code></pre></td></tr></table></div></div></blockquote><h3 id=part-b-3>Part B</h3><p>è¿™éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œå®ç°å››ä¸ªæ“ä½œï¼Œä¸»è¦æ˜¯ç”¨äºæ£€æŸ¥äº‹åŠ¡çŠ¶æ€ï¼Œå†³å®šå›æ»šè¿˜æ˜¯æäº¤ã€‚</p><ul><li><p><code>KvScan</code>ï¼šç”¨äºæŒ‰ Key é¡ºåºæ‰«æï¼Œç±»ä¼¼KvGetä¸€æ ·å®ç°å³å¯ï¼›</p></li><li><p><code>KvCheckTxnStatus</code>ï¼šç”¨äºæ£€æŸ¥äº‹åŠ¡é”çš„çŠ¶æ€ï¼›</p></li><li><p><code>KvBatchRollback</code>ï¼šç”¨äºæ‰¹é‡å›æ»šæ•°æ®ï¼›</p></li><li><p><code>KvResolveLock</code>ï¼šä½¿ç”¨<code>KvCheckTxnStatus</code>æ£€æŸ¥é”çš„çŠ¶æ€åï¼Œå†ä½¿ç”¨<code>KvResolveLock</code>å›æ»šæˆ–è€…æäº¤ã€‚</p></li><li><p>æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œå³batch getæ“ä½œï¼Œäº‹åŠ¡T1è¦è¯»å–Aã€Bï¼Œæ˜¯å¦ä¼šå­˜åœ¨T1å·²ç»è¯»å–äº†Aï¼Œåœ¨è¯»å–Bä¹‹å‰ï¼ŒAï¼ŒBè¢«äº‹åŠ¡T2ä¿®æ”¹ï¼Œå¯¼è‡´è¯»åˆ°çš„æ•°æ®ä¸ä¸€è‡´å‘¢ï¼Ÿ
æˆ‘çš„ç†è§£æ˜¯ä¸ä¼šã€‚è€ƒè™‘ä¸¤ç§æƒ…å†µï¼š</p><ul><li><p>T1çš„tsçš„æ¯”T2çš„commit_tså°ï¼Œé‚£ä¹ˆT2çš„ä¿®æ”¹å¯¹T1æ˜¯ä¸å¯è§çš„ï¼›</p></li><li><p>T1çš„tsçš„æ¯”T2çš„commit_tså¤§ï¼Œé‚£ä¹ˆåœ¨T2çš„commit_tsä¹‹å‰ï¼ŒT2å·²ç»å®Œæˆäº†prewriteï¼ŒT1åº”è¯¥çœ‹åˆ°è¿™ä¸ªlockï¼ŒT1ç›´æ¥è¯»å–å¤±è´¥ï¼›</p></li></ul></li><li><p>å¦ä¸€ä¸ªé—®é¢˜ï¼Œäº‹åŠ¡ä¸­çš„è¯»åå†™ï¼Œå†™å…¥å€¼ä¾èµ–è¯»å…¥å€¼ï¼Œä¸å¯ä¸²è¡ŒåŒ–çš„ä¸åŒç‚¹</p><p>åˆå§‹A = 50</p><p>T1: read A , wrie A = A + 10</p><p>T2: write A = 70</p><p>å¦‚æœæ˜¯å¯ä¸²è¡ŒåŒ–ï¼Œé‚£ä¹ˆå¯èƒ½æ˜¯</p><ul><li>T1 -> T2: A = 70</li><li>T2 -> T1: A = 80</li></ul><p>ä½†æ˜¯percolatoræä¾›çš„snapshot isolationï¼Œå¯èƒ½å‡ºç°ï¼š</p><ul><li>T1 read Aï¼Œ T2 write Aï¼Œ T1 write Aï¼Œ A = 60</li></ul></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2022-05-21</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/tinykv-impl/index.md target=_blank>é˜…è¯»åŸå§‹æ–‡æ¡£</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="åˆ†äº«åˆ° Twitter" data-sharer=twitter data-url=https://waruto.top/posts/tinykv-impl/ data-title="TinyKV å®ç°æ€»ç»“" data-via=Jason210314><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/posts/mit-6.830-lab6-rollback-and-recovery/ class=prev rel=prev title="MIT 6.830 Lab6 Rollback And Recovery"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>MIT 6.830 Lab6 Rollback And Recovery</a>
<a href=/posts/tinysql-impl/ class=next rel=next title="TinySQL å®ç°æ€»ç»“">TinySQL å®ç°æ€»ç»“<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>ç”± <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.103.0">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/waruto210 target=_blank>waruto210</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://waruto.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:10},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"æ²¡æœ‰æ‰¾åˆ°ç»“æœ",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-164518488-1",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-164518488-1" async></script></body></html>